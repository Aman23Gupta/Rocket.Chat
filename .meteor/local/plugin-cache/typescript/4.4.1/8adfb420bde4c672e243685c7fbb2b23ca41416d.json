{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/server/lib/pushConfig.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/lib/pushConfig.ts","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/server/lib/pushConfig.ts","inputSourceMap":{"version":3,"file":"server/lib/pushConfig.ts","sourceRoot":"","sources":["server/lib/pushConfig.ts"],"names":[],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { TAPi18n } from 'meteor/rocketchat:tap-i18n';\n\nimport { getWorkspaceAccessToken } from '../../app/cloud/server';\nimport { hasRole } from '../../app/authorization/server';\nimport { settings } from '../../app/settings/server';\nimport { appTokensCollection, Push } from '../../app/push/server';\n\nMeteor.methods({\n\t// eslint-disable-next-line @typescript-eslint/camelcase\n\tpush_test() {\n\t\tconst user = Meteor.user();\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', {\n\t\t\t\tmethod: 'push_test',\n\t\t\t});\n\t\t}\n\n\t\tif (!hasRole(user._id, 'admin')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', {\n\t\t\t\tmethod: 'push_test',\n\t\t\t});\n\t\t}\n\n\t\tif (settings.get('Push_enable') !== true) {\n\t\t\tthrow new Meteor.Error('error-push-disabled', 'Push is disabled', {\n\t\t\t\tmethod: 'push_test',\n\t\t\t});\n\t\t}\n\n\t\tconst query = {\n\t\t\t$and: [\n\t\t\t\t{\n\t\t\t\t\tuserId: user._id,\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t$or: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t'token.apn': {\n\t\t\t\t\t\t\t\t$exists: true,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t'token.gcm': {\n\t\t\t\t\t\t\t\t$exists: true,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t},\n\t\t\t],\n\t\t};\n\n\t\tconst tokens = appTokensCollection.find(query).count();\n\n\t\tif (tokens === 0) {\n\t\t\tthrow new Meteor.Error('error-no-tokens-for-this-user', 'There are no tokens for this user', {\n\t\t\t\tmethod: 'push_test',\n\t\t\t});\n\t\t}\n\n\t\tPush.send({\n\t\t\tfrom: 'push',\n\t\t\ttitle: `@${user.username}`,\n\t\t\ttext: TAPi18n.__('This_is_a_push_test_messsage'),\n\t\t\tapn: {\n\t\t\t\ttext: `@${user.username}:\\n${TAPi18n.__('This_is_a_push_test_messsage')}`,\n\t\t\t},\n\t\t\tsound: 'default',\n\t\t\tuserId: user._id,\n\t\t});\n\n\t\treturn {\n\t\t\tmessage: 'Your_push_was_sent_to_s_devices',\n\t\t\tparams: [tokens],\n\t\t};\n\t},\n});\n\nsettings.watch<boolean>('Push_enable', async function (enabled) {\n\tif (!enabled) {\n\t\treturn;\n\t}\n\tconst gateways =\n\t\tsettings.get('Push_enable_gateway') && settings.get('Register_Server') && settings.get('Cloud_Service_Agree_PrivacyTerms')\n\t\t\t? settings.get<string>('Push_gateway').split('\\n')\n\t\t\t: undefined;\n\n\tlet apn:\n\t\t| {\n\t\t\t\tapiKey?: string;\n\t\t\t\tpassphrase: string;\n\t\t\t\tkey: string;\n\t\t\t\tcert: string;\n\t\t\t\tgateway?: string;\n\t\t  }\n\t\t| undefined;\n\tlet gcm:\n\t\t| {\n\t\t\t\tapiKey: string;\n\t\t\t\tprojectNumber: string;\n\t\t  }\n\t\t| undefined;\n\n\tif (!gateways) {\n\t\tgcm = {\n\t\t\tapiKey: settings.get('Push_gcm_api_key'),\n\t\t\tprojectNumber: settings.get('Push_gcm_project_number'),\n\t\t};\n\n\t\tapn = {\n\t\t\tpassphrase: settings.get('Push_apn_passphrase'),\n\t\t\tkey: settings.get('Push_apn_key'),\n\t\t\tcert: settings.get('Push_apn_cert'),\n\t\t};\n\n\t\tif (settings.get('Push_production') !== true) {\n\t\t\tapn = {\n\t\t\t\tpassphrase: settings.get('Push_apn_dev_passphrase'),\n\t\t\t\tkey: settings.get('Push_apn_dev_key'),\n\t\t\t\tcert: settings.get('Push_apn_dev_cert'),\n\t\t\t\tgateway: 'gateway.sandbox.push.apple.com',\n\t\t\t};\n\t\t}\n\n\t\tif (!apn.key || apn.key.trim() === '' || !apn.cert || apn.cert.trim() === '') {\n\t\t\tapn = undefined;\n\t\t}\n\n\t\tif (!gcm.apiKey || gcm.apiKey.trim() === '' || !gcm.projectNumber || gcm.projectNumber.trim() === '') {\n\t\t\tgcm = undefined;\n\t\t}\n\t}\n\n\tPush.configure({\n\t\tapn,\n\t\tgcm,\n\t\tproduction: settings.get('Push_production'),\n\t\tgateways,\n\t\tuniqueId: settings.get('uniqueID'),\n\t\tgetAuthorization() {\n\t\t\treturn `Bearer ${Promise.await(getWorkspaceAccessToken())}`;\n\t\t},\n\t});\n});\n"]},"targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/server/lib/pushConfig.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/lib/pushConfig.ts"}},"code":"let Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet TAPi18n;\nmodule.link(\"meteor/rocketchat:tap-i18n\", {\n  TAPi18n(v) {\n    TAPi18n = v;\n  }\n\n}, 1);\nlet getWorkspaceAccessToken;\nmodule.link(\"../../app/cloud/server\", {\n  getWorkspaceAccessToken(v) {\n    getWorkspaceAccessToken = v;\n  }\n\n}, 2);\nlet hasRole;\nmodule.link(\"../../app/authorization/server\", {\n  hasRole(v) {\n    hasRole = v;\n  }\n\n}, 3);\nlet settings;\nmodule.link(\"../../app/settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 4);\nlet appTokensCollection, Push;\nmodule.link(\"../../app/push/server\", {\n  appTokensCollection(v) {\n    appTokensCollection = v;\n  },\n\n  Push(v) {\n    Push = v;\n  }\n\n}, 5);\nMeteor.methods({\n  // eslint-disable-next-line @typescript-eslint/camelcase\n  push_test() {\n    const user = Meteor.user();\n\n    if (!user) {\n      throw new Meteor.Error('error-not-allowed', 'Not allowed', {\n        method: 'push_test'\n      });\n    }\n\n    if (!hasRole(user._id, 'admin')) {\n      throw new Meteor.Error('error-not-allowed', 'Not allowed', {\n        method: 'push_test'\n      });\n    }\n\n    if (settings.get('Push_enable') !== true) {\n      throw new Meteor.Error('error-push-disabled', 'Push is disabled', {\n        method: 'push_test'\n      });\n    }\n\n    const query = {\n      $and: [{\n        userId: user._id\n      }, {\n        $or: [{\n          'token.apn': {\n            $exists: true\n          }\n        }, {\n          'token.gcm': {\n            $exists: true\n          }\n        }]\n      }]\n    };\n    const tokens = appTokensCollection.find(query).count();\n\n    if (tokens === 0) {\n      throw new Meteor.Error('error-no-tokens-for-this-user', 'There are no tokens for this user', {\n        method: 'push_test'\n      });\n    }\n\n    Push.send({\n      from: 'push',\n      title: \"@\".concat(user.username),\n      text: TAPi18n.__('This_is_a_push_test_messsage'),\n      apn: {\n        text: \"@\".concat(user.username, \":\\n\").concat(TAPi18n.__('This_is_a_push_test_messsage'))\n      },\n      sound: 'default',\n      userId: user._id\n    });\n    return {\n      message: 'Your_push_was_sent_to_s_devices',\n      params: [tokens]\n    };\n  }\n\n});\nsettings.watch('Push_enable', function (enabled) {\n  return Promise.asyncApply(() => {\n    if (!enabled) {\n      return;\n    }\n\n    const gateways = settings.get('Push_enable_gateway') && settings.get('Register_Server') && settings.get('Cloud_Service_Agree_PrivacyTerms') ? settings.get('Push_gateway').split('\\n') : undefined;\n    let apn;\n    let gcm;\n\n    if (!gateways) {\n      gcm = {\n        apiKey: settings.get('Push_gcm_api_key'),\n        projectNumber: settings.get('Push_gcm_project_number')\n      };\n      apn = {\n        passphrase: settings.get('Push_apn_passphrase'),\n        key: settings.get('Push_apn_key'),\n        cert: settings.get('Push_apn_cert')\n      };\n\n      if (settings.get('Push_production') !== true) {\n        apn = {\n          passphrase: settings.get('Push_apn_dev_passphrase'),\n          key: settings.get('Push_apn_dev_key'),\n          cert: settings.get('Push_apn_dev_cert'),\n          gateway: 'gateway.sandbox.push.apple.com'\n        };\n      }\n\n      if (!apn.key || apn.key.trim() === '' || !apn.cert || apn.cert.trim() === '') {\n        apn = undefined;\n      }\n\n      if (!gcm.apiKey || gcm.apiKey.trim() === '' || !gcm.projectNumber || gcm.projectNumber.trim() === '') {\n        gcm = undefined;\n      }\n    }\n\n    Push.configure({\n      apn,\n      gcm,\n      production: settings.get('Push_production'),\n      gateways,\n      uniqueId: settings.get('uniqueID'),\n\n      getAuthorization() {\n        return \"Bearer \".concat(Promise.await(getWorkspaceAccessToken()));\n      }\n\n    });\n  });\n});","map":{"version":3,"sources":["server/lib/pushConfig.ts"],"names":[],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { TAPi18n } from 'meteor/rocketchat:tap-i18n';\n\nimport { getWorkspaceAccessToken } from '../../app/cloud/server';\nimport { hasRole } from '../../app/authorization/server';\nimport { settings } from '../../app/settings/server';\nimport { appTokensCollection, Push } from '../../app/push/server';\n\nMeteor.methods({\n\t// eslint-disable-next-line @typescript-eslint/camelcase\n\tpush_test() {\n\t\tconst user = Meteor.user();\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', {\n\t\t\t\tmethod: 'push_test',\n\t\t\t});\n\t\t}\n\n\t\tif (!hasRole(user._id, 'admin')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', {\n\t\t\t\tmethod: 'push_test',\n\t\t\t});\n\t\t}\n\n\t\tif (settings.get('Push_enable') !== true) {\n\t\t\tthrow new Meteor.Error('error-push-disabled', 'Push is disabled', {\n\t\t\t\tmethod: 'push_test',\n\t\t\t});\n\t\t}\n\n\t\tconst query = {\n\t\t\t$and: [\n\t\t\t\t{\n\t\t\t\t\tuserId: user._id,\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t$or: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t'token.apn': {\n\t\t\t\t\t\t\t\t$exists: true,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t'token.gcm': {\n\t\t\t\t\t\t\t\t$exists: true,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t},\n\t\t\t],\n\t\t};\n\n\t\tconst tokens = appTokensCollection.find(query).count();\n\n\t\tif (tokens === 0) {\n\t\t\tthrow new Meteor.Error('error-no-tokens-for-this-user', 'There are no tokens for this user', {\n\t\t\t\tmethod: 'push_test',\n\t\t\t});\n\t\t}\n\n\t\tPush.send({\n\t\t\tfrom: 'push',\n\t\t\ttitle: `@${user.username}`,\n\t\t\ttext: TAPi18n.__('This_is_a_push_test_messsage'),\n\t\t\tapn: {\n\t\t\t\ttext: `@${user.username}:\\n${TAPi18n.__('This_is_a_push_test_messsage')}`,\n\t\t\t},\n\t\t\tsound: 'default',\n\t\t\tuserId: user._id,\n\t\t});\n\n\t\treturn {\n\t\t\tmessage: 'Your_push_was_sent_to_s_devices',\n\t\t\tparams: [tokens],\n\t\t};\n\t},\n});\n\nsettings.watch<boolean>('Push_enable', async function (enabled) {\n\tif (!enabled) {\n\t\treturn;\n\t}\n\tconst gateways =\n\t\tsettings.get('Push_enable_gateway') && settings.get('Register_Server') && settings.get('Cloud_Service_Agree_PrivacyTerms')\n\t\t\t? settings.get<string>('Push_gateway').split('\\n')\n\t\t\t: undefined;\n\n\tlet apn:\n\t\t| {\n\t\t\t\tapiKey?: string;\n\t\t\t\tpassphrase: string;\n\t\t\t\tkey: string;\n\t\t\t\tcert: string;\n\t\t\t\tgateway?: string;\n\t\t  }\n\t\t| undefined;\n\tlet gcm:\n\t\t| {\n\t\t\t\tapiKey: string;\n\t\t\t\tprojectNumber: string;\n\t\t  }\n\t\t| undefined;\n\n\tif (!gateways) {\n\t\tgcm = {\n\t\t\tapiKey: settings.get('Push_gcm_api_key'),\n\t\t\tprojectNumber: settings.get('Push_gcm_project_number'),\n\t\t};\n\n\t\tapn = {\n\t\t\tpassphrase: settings.get('Push_apn_passphrase'),\n\t\t\tkey: settings.get('Push_apn_key'),\n\t\t\tcert: settings.get('Push_apn_cert'),\n\t\t};\n\n\t\tif (settings.get('Push_production') !== true) {\n\t\t\tapn = {\n\t\t\t\tpassphrase: settings.get('Push_apn_dev_passphrase'),\n\t\t\t\tkey: settings.get('Push_apn_dev_key'),\n\t\t\t\tcert: settings.get('Push_apn_dev_cert'),\n\t\t\t\tgateway: 'gateway.sandbox.push.apple.com',\n\t\t\t};\n\t\t}\n\n\t\tif (!apn.key || apn.key.trim() === '' || !apn.cert || apn.cert.trim() === '') {\n\t\t\tapn = undefined;\n\t\t}\n\n\t\tif (!gcm.apiKey || gcm.apiKey.trim() === '' || !gcm.projectNumber || gcm.projectNumber.trim() === '') {\n\t\t\tgcm = undefined;\n\t\t}\n\t}\n\n\tPush.configure({\n\t\tapn,\n\t\tgcm,\n\t\tproduction: settings.get('Push_production'),\n\t\tgateways,\n\t\tuniqueId: settings.get('uniqueID'),\n\t\tgetAuthorization() {\n\t\t\treturn `Bearer ${Promise.await(getWorkspaceAccessToken())}`;\n\t\t},\n\t});\n});\n"],"sourceRoot":""},"sourceType":"module","hash":"8adfb420bde4c672e243685c7fbb2b23ca41416d"}
