{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apps/server/bridges/http.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/apps/server/bridges/http.ts","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apps/server/bridges/http.ts","inputSourceMap":{"version":3,"file":"app/apps/server/bridges/http.ts","sourceRoot":"","sources":["app/apps/server/bridges/http.ts"],"names":[],"mappings":"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","sourcesContent":["import { fetch } from 'meteor/fetch';\nimport { HttpBridge } from '@rocket.chat/apps-engine/server/bridges/HttpBridge';\nimport { IHttpResponse } from '@rocket.chat/apps-engine/definition/accessors';\nimport { IHttpBridgeRequestInfo } from '@rocket.chat/apps-engine/server/bridges';\n\nimport { AppServerOrchestrator } from '../orchestrator';\nimport { getUnsafeAgent } from '../../../../server/lib/getUnsafeAgent';\n\nconst isGetOrHead = (method: string): boolean => ['GET', 'HEAD'].includes(method.toUpperCase());\n\nexport class AppHttpBridge extends HttpBridge {\n\t// eslint-disable-next-line no-empty-function\n\tconstructor(private readonly orch: AppServerOrchestrator) {\n\t\tsuper();\n\t}\n\n\tprotected async call(info: IHttpBridgeRequestInfo): Promise<IHttpResponse> {\n\t\t// begin comptability with old HTTP.call API\n\t\tconst url = new URL(info.url);\n\n\t\tconst { request, method } = info;\n\n\t\tconst { headers = {} } = request;\n\n\t\tlet { content } = request;\n\n\t\tif (!content && typeof request.data === 'object') {\n\t\t\tcontent = JSON.stringify(request.data);\n\t\t\theaders['Content-Type'] = 'application/json';\n\t\t}\n\n\t\tif (request.auth) {\n\t\t\tif (request.auth.indexOf(':') < 0) {\n\t\t\t\tthrow new Error('auth option should be of the form \"username:password\"');\n\t\t\t}\n\n\t\t\tconst base64 = Buffer.from(request.auth, 'ascii').toString('base64');\n\t\t\theaders.Authorization = `Basic ${base64}`;\n\t\t}\n\n\t\tlet paramsForBody;\n\n\t\tif (content || isGetOrHead(method)) {\n\t\t\tif (request.params) {\n\t\t\t\tObject.keys(request.params).forEach((key) => {\n\t\t\t\t\tif (request.params?.[key]) {\n\t\t\t\t\t\turl.searchParams.append(key, request.params?.[key]);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t} else {\n\t\t\tparamsForBody = request.params;\n\t\t}\n\n\t\tif (paramsForBody) {\n\t\t\tconst data = new URLSearchParams();\n\t\t\tObject.entries(paramsForBody).forEach(([key, value]) => {\n\t\t\t\tdata.append(key, value);\n\t\t\t});\n\t\t\tcontent = data.toString();\n\t\t\theaders['Content-Type'] = 'application/x-www-form-urlencoded';\n\t\t}\n\n\t\tif (isGetOrHead(method)) {\n\t\t\tcontent = undefined;\n\t\t}\n\n\t\t// end comptability with old HTTP.call API\n\n\t\tthis.orch.debugLog(`The App ${info.appId} is requesting from the outter webs:`, info);\n\n\t\ttry {\n\t\t\tconst response = await fetch(url.href, {\n\t\t\t\tmethod,\n\t\t\t\tbody: content,\n\t\t\t\theaders,\n\t\t\t\t...(((request.hasOwnProperty('strictSSL') && !request.strictSSL) ||\n\t\t\t\t\t(request.hasOwnProperty('rejectUnauthorized') && request.rejectUnauthorized)) && {\n\t\t\t\t\tagent: getUnsafeAgent(url.protocol === 'https:' ? 'https:' : 'http:'),\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tconst result: IHttpResponse = {\n\t\t\t\turl: info.url,\n\t\t\t\tmethod: info.method,\n\t\t\t\tstatusCode: response.status,\n\t\t\t\theaders: Object.fromEntries(response.headers as unknown as any),\n\t\t\t};\n\n\t\t\tconst body = Buffer.from(await response.arrayBuffer());\n\n\t\t\tif (request.encoding === null) {\n\t\t\t\t/**\n\t\t\t\t * The property `content` is not appropriately typed in the\n\t\t\t\t * Apps-engine definition, and we can't simply change it there\n\t\t\t\t * as it would be a breaking change. Thus, we're left with this\n\t\t\t\t * type assertion.\n\t\t\t\t */\n\t\t\t\tresult.content = body as any;\n\t\t\t} else {\n\t\t\t\tresult.content = body.toString(request.encoding);\n\t\t\t\tresult.data = ((): any => {\n\t\t\t\t\tconst contentType = (response.headers.get('content-type') || '').split(';')[0];\n\t\t\t\t\tif (!['application/json', 'text/javascript', 'application/javascript', 'application/x-javascript'].includes(contentType)) {\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\treturn JSON.parse(result.content);\n\t\t\t\t\t} catch {\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\t\t\t\t})();\n\t\t\t}\n\n\t\t\treturn result;\n\t\t} catch (e) {\n\t\t\treturn e.response;\n\t\t}\n\t}\n}\n"]},"targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apps/server/bridges/http.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/apps/server/bridges/http.ts"}},"code":"let _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n\n}, 0);\nmodule.export({\n  AppHttpBridge: () => AppHttpBridge\n});\nlet fetch;\nmodule.link(\"meteor/fetch\", {\n  fetch(v) {\n    fetch = v;\n  }\n\n}, 0);\nlet HttpBridge;\nmodule.link(\"@rocket.chat/apps-engine/server/bridges/HttpBridge\", {\n  HttpBridge(v) {\n    HttpBridge = v;\n  }\n\n}, 1);\nlet getUnsafeAgent;\nmodule.link(\"../../../../server/lib/getUnsafeAgent\", {\n  getUnsafeAgent(v) {\n    getUnsafeAgent = v;\n  }\n\n}, 2);\n\nconst isGetOrHead = method => ['GET', 'HEAD'].includes(method.toUpperCase());\n\nclass AppHttpBridge extends HttpBridge {\n  // eslint-disable-next-line no-empty-function\n  constructor(orch) {\n    super();\n    this.orch = void 0;\n    this.orch = orch;\n  }\n\n  call(info) {\n    return Promise.asyncApply(() => {\n      // begin comptability with old HTTP.call API\n      const url = new URL(info.url);\n      const {\n        request,\n        method\n      } = info;\n      const {\n        headers = {}\n      } = request;\n      let {\n        content\n      } = request;\n\n      if (!content && typeof request.data === 'object') {\n        content = JSON.stringify(request.data);\n        headers['Content-Type'] = 'application/json';\n      }\n\n      if (request.auth) {\n        if (request.auth.indexOf(':') < 0) {\n          throw new Error('auth option should be of the form \"username:password\"');\n        }\n\n        const base64 = Buffer.from(request.auth, 'ascii').toString('base64');\n        headers.Authorization = \"Basic \".concat(base64);\n      }\n\n      let paramsForBody;\n\n      if (content || isGetOrHead(method)) {\n        if (request.params) {\n          Object.keys(request.params).forEach(key => {\n            var _request$params;\n\n            if ((_request$params = request.params) !== null && _request$params !== void 0 && _request$params[key]) {\n              var _request$params2;\n\n              url.searchParams.append(key, (_request$params2 = request.params) === null || _request$params2 === void 0 ? void 0 : _request$params2[key]);\n            }\n          });\n        }\n      } else {\n        paramsForBody = request.params;\n      }\n\n      if (paramsForBody) {\n        const data = new URLSearchParams();\n        Object.entries(paramsForBody).forEach(_ref => {\n          let [key, value] = _ref;\n          data.append(key, value);\n        });\n        content = data.toString();\n        headers['Content-Type'] = 'application/x-www-form-urlencoded';\n      }\n\n      if (isGetOrHead(method)) {\n        content = undefined;\n      } // end comptability with old HTTP.call API\n\n\n      this.orch.debugLog(\"The App \".concat(info.appId, \" is requesting from the outter webs:\"), info);\n\n      try {\n        const response = Promise.await(fetch(url.href, _objectSpread({\n          method,\n          body: content,\n          headers\n        }, (request.hasOwnProperty('strictSSL') && !request.strictSSL || request.hasOwnProperty('rejectUnauthorized') && request.rejectUnauthorized) && {\n          agent: getUnsafeAgent(url.protocol === 'https:' ? 'https:' : 'http:')\n        })));\n        const result = {\n          url: info.url,\n          method: info.method,\n          statusCode: response.status,\n          headers: Object.fromEntries(response.headers)\n        };\n        const body = Buffer.from(Promise.await(response.arrayBuffer()));\n\n        if (request.encoding === null) {\n          /**\n           * The property `content` is not appropriately typed in the\n           * Apps-engine definition, and we can't simply change it there\n           * as it would be a breaking change. Thus, we're left with this\n           * type assertion.\n           */\n          result.content = body;\n        } else {\n          result.content = body.toString(request.encoding);\n\n          result.data = (() => {\n            const contentType = (response.headers.get('content-type') || '').split(';')[0];\n\n            if (!['application/json', 'text/javascript', 'application/javascript', 'application/x-javascript'].includes(contentType)) {\n              return null;\n            }\n\n            try {\n              return JSON.parse(result.content);\n            } catch (_unused) {\n              return null;\n            }\n          })();\n        }\n\n        return result;\n      } catch (e) {\n        return e.response;\n      }\n    });\n  }\n\n}","map":{"version":3,"sources":["app/apps/server/bridges/http.ts"],"names":[],"mappings":"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","sourcesContent":["import { fetch } from 'meteor/fetch';\nimport { HttpBridge } from '@rocket.chat/apps-engine/server/bridges/HttpBridge';\nimport { IHttpResponse } from '@rocket.chat/apps-engine/definition/accessors';\nimport { IHttpBridgeRequestInfo } from '@rocket.chat/apps-engine/server/bridges';\n\nimport { AppServerOrchestrator } from '../orchestrator';\nimport { getUnsafeAgent } from '../../../../server/lib/getUnsafeAgent';\n\nconst isGetOrHead = (method: string): boolean => ['GET', 'HEAD'].includes(method.toUpperCase());\n\nexport class AppHttpBridge extends HttpBridge {\n\t// eslint-disable-next-line no-empty-function\n\tconstructor(private readonly orch: AppServerOrchestrator) {\n\t\tsuper();\n\t}\n\n\tprotected async call(info: IHttpBridgeRequestInfo): Promise<IHttpResponse> {\n\t\t// begin comptability with old HTTP.call API\n\t\tconst url = new URL(info.url);\n\n\t\tconst { request, method } = info;\n\n\t\tconst { headers = {} } = request;\n\n\t\tlet { content } = request;\n\n\t\tif (!content && typeof request.data === 'object') {\n\t\t\tcontent = JSON.stringify(request.data);\n\t\t\theaders['Content-Type'] = 'application/json';\n\t\t}\n\n\t\tif (request.auth) {\n\t\t\tif (request.auth.indexOf(':') < 0) {\n\t\t\t\tthrow new Error('auth option should be of the form \"username:password\"');\n\t\t\t}\n\n\t\t\tconst base64 = Buffer.from(request.auth, 'ascii').toString('base64');\n\t\t\theaders.Authorization = `Basic ${base64}`;\n\t\t}\n\n\t\tlet paramsForBody;\n\n\t\tif (content || isGetOrHead(method)) {\n\t\t\tif (request.params) {\n\t\t\t\tObject.keys(request.params).forEach((key) => {\n\t\t\t\t\tif (request.params?.[key]) {\n\t\t\t\t\t\turl.searchParams.append(key, request.params?.[key]);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t} else {\n\t\t\tparamsForBody = request.params;\n\t\t}\n\n\t\tif (paramsForBody) {\n\t\t\tconst data = new URLSearchParams();\n\t\t\tObject.entries(paramsForBody).forEach(([key, value]) => {\n\t\t\t\tdata.append(key, value);\n\t\t\t});\n\t\t\tcontent = data.toString();\n\t\t\theaders['Content-Type'] = 'application/x-www-form-urlencoded';\n\t\t}\n\n\t\tif (isGetOrHead(method)) {\n\t\t\tcontent = undefined;\n\t\t}\n\n\t\t// end comptability with old HTTP.call API\n\n\t\tthis.orch.debugLog(`The App ${info.appId} is requesting from the outter webs:`, info);\n\n\t\ttry {\n\t\t\tconst response = await fetch(url.href, {\n\t\t\t\tmethod,\n\t\t\t\tbody: content,\n\t\t\t\theaders,\n\t\t\t\t...(((request.hasOwnProperty('strictSSL') && !request.strictSSL) ||\n\t\t\t\t\t(request.hasOwnProperty('rejectUnauthorized') && request.rejectUnauthorized)) && {\n\t\t\t\t\tagent: getUnsafeAgent(url.protocol === 'https:' ? 'https:' : 'http:'),\n\t\t\t\t}),\n\t\t\t});\n\n\t\t\tconst result: IHttpResponse = {\n\t\t\t\turl: info.url,\n\t\t\t\tmethod: info.method,\n\t\t\t\tstatusCode: response.status,\n\t\t\t\theaders: Object.fromEntries(response.headers as unknown as any),\n\t\t\t};\n\n\t\t\tconst body = Buffer.from(await response.arrayBuffer());\n\n\t\t\tif (request.encoding === null) {\n\t\t\t\t/**\n\t\t\t\t * The property `content` is not appropriately typed in the\n\t\t\t\t * Apps-engine definition, and we can't simply change it there\n\t\t\t\t * as it would be a breaking change. Thus, we're left with this\n\t\t\t\t * type assertion.\n\t\t\t\t */\n\t\t\t\tresult.content = body as any;\n\t\t\t} else {\n\t\t\t\tresult.content = body.toString(request.encoding);\n\t\t\t\tresult.data = ((): any => {\n\t\t\t\t\tconst contentType = (response.headers.get('content-type') || '').split(';')[0];\n\t\t\t\t\tif (!['application/json', 'text/javascript', 'application/javascript', 'application/x-javascript'].includes(contentType)) {\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\n\t\t\t\t\ttry {\n\t\t\t\t\t\treturn JSON.parse(result.content);\n\t\t\t\t\t} catch {\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\t\t\t\t})();\n\t\t\t}\n\n\t\t\treturn result;\n\t\t} catch (e) {\n\t\t\treturn e.response;\n\t\t}\n\t}\n}\n"],"sourceRoot":""},"sourceType":"module","hash":"18333678ecea509f32262f026865bea3344b3178"}
