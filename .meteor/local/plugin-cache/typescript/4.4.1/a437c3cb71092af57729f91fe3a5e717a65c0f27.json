{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apps/server/bridges/users.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/apps/server/bridges/users.ts","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apps/server/bridges/users.ts","inputSourceMap":{"version":3,"file":"app/apps/server/bridges/users.ts","sourceRoot":"","sources":["app/apps/server/bridges/users.ts"],"names":[],"mappings":"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","sourcesContent":["import { Random } from 'meteor/random';\nimport { UserPresence } from 'meteor/konecty:user-presence';\nimport { UserBridge } from '@rocket.chat/apps-engine/server/bridges/UserBridge';\nimport { IUserCreationOptions, IUser } from '@rocket.chat/apps-engine/definition/users';\n\nimport { setUserAvatar, checkUsernameAvailability, deleteUser } from '../../../lib/server/functions';\nimport { Users } from '../../../models/server';\nimport { Subscriptions, Users as UsersRaw } from '../../../models/server/raw';\nimport { AppServerOrchestrator } from '../orchestrator';\n\nexport class AppUserBridge extends UserBridge {\n\t// eslint-disable-next-line no-empty-function\n\tconstructor(private readonly orch: AppServerOrchestrator) {\n\t\tsuper();\n\t}\n\n\tprotected async getById(userId: string, appId: string): Promise<IUser> {\n\t\tthis.orch.debugLog(`The App ${appId} is getting the userId: \"${userId}\"`);\n\n\t\treturn this.orch.getConverters()?.get('users').convertById(userId);\n\t}\n\n\tprotected async getByUsername(username: string, appId: string): Promise<IUser> {\n\t\tthis.orch.debugLog(`The App ${appId} is getting the username: \"${username}\"`);\n\n\t\treturn this.orch.getConverters()?.get('users').convertByUsername(username);\n\t}\n\n\tprotected async getAppUser(appId?: string): Promise<IUser | undefined> {\n\t\tthis.orch.debugLog(`The App ${appId} is getting its assigned user`);\n\n\t\tconst user = Users.findOneByAppId(appId, {});\n\n\t\treturn this.orch.getConverters()?.get('users').convertToApp(user);\n\t}\n\n\tprotected async create(userDescriptor: Partial<IUser>, appId: string, options?: IUserCreationOptions): Promise<string> {\n\t\tthis.orch.debugLog(`The App ${appId} is requesting to create a new user.`);\n\t\tconst user = this.orch.getConverters()?.get('users').convertToRocketChat(userDescriptor);\n\n\t\tif (!user._id) {\n\t\t\tuser._id = Random.id();\n\t\t}\n\n\t\tif (!user.createdAt) {\n\t\t\tuser.createdAt = new Date();\n\t\t}\n\n\t\tswitch (user.type) {\n\t\t\tcase 'app':\n\t\t\t\tif (!checkUsernameAvailability(user.username)) {\n\t\t\t\t\tthrow new Error(`The username \"${user.username}\" is already being used. Rename or remove the user using it to install this App`);\n\t\t\t\t}\n\n\t\t\t\tUsers.insert(user);\n\n\t\t\t\tif (options?.avatarUrl) {\n\t\t\t\t\tsetUserAvatar(user, options.avatarUrl, '', 'local');\n\t\t\t\t}\n\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tthrow new Error('Creating normal users is currently not supported');\n\t\t}\n\n\t\treturn user._id;\n\t}\n\n\tprotected async remove(user: IUser & { id: string }, appId: string): Promise<boolean> {\n\t\tthis.orch.debugLog(`The App's user is being removed: ${appId}`);\n\n\t\t// It's actually not a problem if there is no App user to delete - just means we don't need to do anything more.\n\t\tif (!user) {\n\t\t\treturn true;\n\t\t}\n\n\t\ttry {\n\t\t\tdeleteUser(user.id);\n\t\t} catch (err) {\n\t\t\tthrow new Error(`Errors occurred while deleting an app user: ${err}`);\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tprotected async update(user: IUser & { id: string }, fields: Partial<IUser>, appId: string): Promise<boolean> {\n\t\tthis.orch.debugLog(`The App ${appId} is updating a user`);\n\n\t\tif (!user) {\n\t\t\tthrow new Error('User not provided');\n\t\t}\n\n\t\tif (!Object.keys(fields).length) {\n\t\t\treturn true;\n\t\t}\n\n\t\tconst { status } = fields;\n\t\tdelete fields.status;\n\n\t\tawait UsersRaw.update({ _id: user.id }, { $set: fields });\n\n\t\tif (status) {\n\t\t\tUserPresence.setDefaultStatus(user.id, status);\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tprotected async getActiveUserCount(): Promise<number> {\n\t\treturn Users.getActiveLocalUserCount();\n\t}\n\n\tprotected async getUserUnreadMessageCount(uid: string): Promise<number> {\n\t\treturn Subscriptions.getBadgeCount(uid);\n\t}\n}\n"]},"targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apps/server/bridges/users.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/apps/server/bridges/users.ts"}},"code":"module.export({\n  AppUserBridge: () => AppUserBridge\n});\nlet Random;\nmodule.link(\"meteor/random\", {\n  Random(v) {\n    Random = v;\n  }\n\n}, 0);\nlet UserPresence;\nmodule.link(\"meteor/konecty:user-presence\", {\n  UserPresence(v) {\n    UserPresence = v;\n  }\n\n}, 1);\nlet UserBridge;\nmodule.link(\"@rocket.chat/apps-engine/server/bridges/UserBridge\", {\n  UserBridge(v) {\n    UserBridge = v;\n  }\n\n}, 2);\nlet setUserAvatar, checkUsernameAvailability, deleteUser;\nmodule.link(\"../../../lib/server/functions\", {\n  setUserAvatar(v) {\n    setUserAvatar = v;\n  },\n\n  checkUsernameAvailability(v) {\n    checkUsernameAvailability = v;\n  },\n\n  deleteUser(v) {\n    deleteUser = v;\n  }\n\n}, 3);\nlet Users;\nmodule.link(\"../../../models/server\", {\n  Users(v) {\n    Users = v;\n  }\n\n}, 4);\nlet Subscriptions, UsersRaw;\nmodule.link(\"../../../models/server/raw\", {\n  Subscriptions(v) {\n    Subscriptions = v;\n  },\n\n  Users(v) {\n    UsersRaw = v;\n  }\n\n}, 5);\n\nclass AppUserBridge extends UserBridge {\n  // eslint-disable-next-line no-empty-function\n  constructor(orch) {\n    super();\n    this.orch = void 0;\n    this.orch = orch;\n  }\n\n  getById(userId, appId) {\n    return Promise.asyncApply(() => {\n      var _this$orch$getConvert;\n\n      this.orch.debugLog(\"The App \".concat(appId, \" is getting the userId: \\\"\").concat(userId, \"\\\"\"));\n      return (_this$orch$getConvert = this.orch.getConverters()) === null || _this$orch$getConvert === void 0 ? void 0 : _this$orch$getConvert.get('users').convertById(userId);\n    });\n  }\n\n  getByUsername(username, appId) {\n    return Promise.asyncApply(() => {\n      var _this$orch$getConvert2;\n\n      this.orch.debugLog(\"The App \".concat(appId, \" is getting the username: \\\"\").concat(username, \"\\\"\"));\n      return (_this$orch$getConvert2 = this.orch.getConverters()) === null || _this$orch$getConvert2 === void 0 ? void 0 : _this$orch$getConvert2.get('users').convertByUsername(username);\n    });\n  }\n\n  getAppUser(appId) {\n    return Promise.asyncApply(() => {\n      var _this$orch$getConvert3;\n\n      this.orch.debugLog(\"The App \".concat(appId, \" is getting its assigned user\"));\n      const user = Users.findOneByAppId(appId, {});\n      return (_this$orch$getConvert3 = this.orch.getConverters()) === null || _this$orch$getConvert3 === void 0 ? void 0 : _this$orch$getConvert3.get('users').convertToApp(user);\n    });\n  }\n\n  create(userDescriptor, appId, options) {\n    return Promise.asyncApply(() => {\n      var _this$orch$getConvert4;\n\n      this.orch.debugLog(\"The App \".concat(appId, \" is requesting to create a new user.\"));\n      const user = (_this$orch$getConvert4 = this.orch.getConverters()) === null || _this$orch$getConvert4 === void 0 ? void 0 : _this$orch$getConvert4.get('users').convertToRocketChat(userDescriptor);\n\n      if (!user._id) {\n        user._id = Random.id();\n      }\n\n      if (!user.createdAt) {\n        user.createdAt = new Date();\n      }\n\n      switch (user.type) {\n        case 'app':\n          if (!checkUsernameAvailability(user.username)) {\n            throw new Error(\"The username \\\"\".concat(user.username, \"\\\" is already being used. Rename or remove the user using it to install this App\"));\n          }\n\n          Users.insert(user);\n\n          if (options !== null && options !== void 0 && options.avatarUrl) {\n            setUserAvatar(user, options.avatarUrl, '', 'local');\n          }\n\n          break;\n\n        default:\n          throw new Error('Creating normal users is currently not supported');\n      }\n\n      return user._id;\n    });\n  }\n\n  remove(user, appId) {\n    return Promise.asyncApply(() => {\n      this.orch.debugLog(\"The App's user is being removed: \".concat(appId)); // It's actually not a problem if there is no App user to delete - just means we don't need to do anything more.\n\n      if (!user) {\n        return true;\n      }\n\n      try {\n        deleteUser(user.id);\n      } catch (err) {\n        throw new Error(\"Errors occurred while deleting an app user: \".concat(err));\n      }\n\n      return true;\n    });\n  }\n\n  update(user, fields, appId) {\n    return Promise.asyncApply(() => {\n      this.orch.debugLog(\"The App \".concat(appId, \" is updating a user\"));\n\n      if (!user) {\n        throw new Error('User not provided');\n      }\n\n      if (!Object.keys(fields).length) {\n        return true;\n      }\n\n      const {\n        status\n      } = fields;\n      delete fields.status;\n      Promise.await(UsersRaw.update({\n        _id: user.id\n      }, {\n        $set: fields\n      }));\n\n      if (status) {\n        UserPresence.setDefaultStatus(user.id, status);\n      }\n\n      return true;\n    });\n  }\n\n  getActiveUserCount() {\n    return Promise.asyncApply(() => {\n      return Users.getActiveLocalUserCount();\n    });\n  }\n\n  getUserUnreadMessageCount(uid) {\n    return Promise.asyncApply(() => {\n      return Subscriptions.getBadgeCount(uid);\n    });\n  }\n\n}","map":{"version":3,"sources":["app/apps/server/bridges/users.ts"],"names":[],"mappings":"AAAA,MAAA,CAAO,MAAP,CAAS;AAAM,EAAA,aAAQ,EAAA,MAAA;AAAd,CAAT;AAAuC,IAAA,MAAA;AAAA,MAAA,CAAA,IAAA,CAAA,eAAA,EAAA;AAAA,EAAA,MAAA,CAAA,CAAA,EAAA;AAAA,IAAA,MAAA,GAAA,CAAA;AAAA;;AAAA,CAAA,EAAA,CAAA;AAAA,IAAA,YAAA;AAAA,MAAA,CAAA,IAAA,CAAA,8BAAA,EAAA;AAAA,EAAA,YAAA,CAAA,CAAA,EAAA;AAAA,IAAA,YAAA,GAAA,CAAA;AAAA;;AAAA,CAAA,EAAA,CAAA;AAAA,IAAA,UAAA;AAAA,MAAA,CAAA,IAAA,CAAA,oDAAA,EAAA;AAAA,EAAA,UAAA,CAAA,CAAA,EAAA;AAAA,IAAA,UAAA,GAAA,CAAA;AAAA;;AAAA,CAAA,EAAA,CAAA;AAAA,IAAA,aAAA,EAAA,yBAAA,EAAA,UAAA;AAAA,MAAA,CAAA,IAAA,CAAA,+BAAA,EAAA;AAAA,EAAA,aAAA,CAAA,CAAA,EAAA;AAAA,IAAA,aAAA,GAAA,CAAA;AAAA,GAAA;;AAAA,EAAA,yBAAA,CAAA,CAAA,EAAA;AAAA,IAAA,yBAAA,GAAA,CAAA;AAAA,GAAA;;AAAA,EAAA,UAAA,CAAA,CAAA,EAAA;AAAA,IAAA,UAAA,GAAA,CAAA;AAAA;;AAAA,CAAA,EAAA,CAAA;AAAA,IAAA,KAAA;AAAA,MAAA,CAAA,IAAA,CAAA,wBAAA,EAAA;AAAA,EAAA,KAAA,CAAA,CAAA,EAAA;AAAA,IAAA,KAAA,GAAA,CAAA;AAAA;;AAAA,CAAA,EAAA,CAAA;AAAA,IAAA,aAAA,EAAA,QAAA;AAAA,MAAA,CAAA,IAAA,CAAA,4BAAA,EAAA;AAAA,EAAA,aAAA,CAAA,CAAA,EAAA;AAAA,IAAA,aAAA,GAAA,CAAA;AAAA,GAAA;;AAAA,EAAA,KAAA,CAAA,CAAA,EAAA;AAAA,IAAA,QAAA,GAAA,CAAA;AAAA;;AAAA,CAAA,EAAA,CAAA;;AAUjC,MAAO,aAAP,SAA6B,UAA7B,CAAuC;AAC5C;AACA,EAAA,WAAA,CAA6B,IAA7B,EAAwD;AACvD;AADuD,SAA3B,IAA2B;AAA3B,SAAA,IAAA,GAAA,IAAA;AAE5B;;AAEe,EAAA,OAAO,CAAC,MAAD,EAAiB,KAAjB;AAAA,oCAA8B;AAAA;;AACpD,WAAK,IAAL,CAAU,QAAV,mBAA8B,KAA9B,uCAA+D,MAA/D;AAEA,sCAAO,KAAK,IAAL,CAAU,aAAV,EAAP,0DAAO,sBAA2B,GAA3B,CAA+B,OAA/B,EAAwC,WAAxC,CAAoD,MAApD,CAAP;AACA,KAJsB;AAAA;;AAMP,EAAA,aAAa,CAAC,QAAD,EAAmB,KAAnB;AAAA,oCAAgC;AAAA;;AAC5D,WAAK,IAAL,CAAU,QAAV,mBAA8B,KAA9B,yCAAiE,QAAjE;AAEA,uCAAO,KAAK,IAAL,CAAU,aAAV,EAAP,2DAAO,uBAA2B,GAA3B,CAA+B,OAA/B,EAAwC,iBAAxC,CAA0D,QAA1D,CAAP;AACA,KAJ4B;AAAA;;AAMb,EAAA,UAAU,CAAC,KAAD;AAAA,oCAAe;AAAA;;AACxC,WAAK,IAAL,CAAU,QAAV,mBAA8B,KAA9B;AAEA,YAAM,IAAI,GAAG,KAAK,CAAC,cAAN,CAAqB,KAArB,EAA4B,EAA5B,CAAb;AAEA,uCAAO,KAAK,IAAL,CAAU,aAAV,EAAP,2DAAO,uBAA2B,GAA3B,CAA+B,OAA/B,EAAwC,YAAxC,CAAqD,IAArD,CAAP;AACA,KANyB;AAAA;;AAQV,EAAA,MAAM,CAAC,cAAD,EAAiC,KAAjC,EAAgD,OAAhD;AAAA,oCAA8E;AAAA;;AACnG,WAAK,IAAL,CAAU,QAAV,mBAA8B,KAA9B;AACA,YAAM,IAAI,6BAAG,KAAK,IAAL,CAAU,aAAV,EAAH,2DAAG,uBAA2B,GAA3B,CAA+B,OAA/B,EAAwC,mBAAxC,CAA4D,cAA5D,CAAb;;AAEA,UAAI,CAAC,IAAI,CAAC,GAAV,EAAe;AACd,QAAA,IAAI,CAAC,GAAL,GAAW,MAAM,CAAC,EAAP,EAAX;AACA;;AAED,UAAI,CAAC,IAAI,CAAC,SAAV,EAAqB;AACpB,QAAA,IAAI,CAAC,SAAL,GAAiB,IAAI,IAAJ,EAAjB;AACA;;AAED,cAAQ,IAAI,CAAC,IAAb;AACC,aAAK,KAAL;AACC,cAAI,CAAC,yBAAyB,CAAC,IAAI,CAAC,QAAN,CAA9B,EAA+C;AAC9C,kBAAM,IAAI,KAAJ,0BAA2B,IAAI,CAAC,QAAhC,sFAAN;AACA;;AAED,UAAA,KAAK,CAAC,MAAN,CAAa,IAAb;;AAEA,cAAI,OAAJ,aAAI,OAAJ,eAAI,OAAO,CAAE,SAAb,EAAwB;AACvB,YAAA,aAAa,CAAC,IAAD,EAAO,OAAO,CAAC,SAAf,EAA0B,EAA1B,EAA8B,OAA9B,CAAb;AACA;;AAED;;AAED;AACC,gBAAM,IAAI,KAAJ,CAAU,kDAAV,CAAN;AAfF;;AAkBA,aAAO,IAAI,CAAC,GAAZ;AACA,KA/BqB;AAAA;;AAiCN,EAAA,MAAM,CAAC,IAAD,EAA+B,KAA/B;AAAA,oCAA4C;AACjE,WAAK,IAAL,CAAU,QAAV,4CAAuD,KAAvD,GADiE,CAGjE;;AACA,UAAI,CAAC,IAAL,EAAW;AACV,eAAO,IAAP;AACA;;AAED,UAAI;AACH,QAAA,UAAU,CAAC,IAAI,CAAC,EAAN,CAAV;AACA,OAFD,CAEE,OAAO,GAAP,EAAY;AACb,cAAM,IAAI,KAAJ,uDAAyD,GAAzD,EAAN;AACA;;AAED,aAAO,IAAP;AACA,KAfqB;AAAA;;AAiBN,EAAA,MAAM,CAAC,IAAD,EAA+B,MAA/B,EAAuD,KAAvD;AAAA,oCAAoE;AACzF,WAAK,IAAL,CAAU,QAAV,mBAA8B,KAA9B;;AAEA,UAAI,CAAC,IAAL,EAAW;AACV,cAAM,IAAI,KAAJ,CAAU,mBAAV,CAAN;AACA;;AAED,UAAI,CAAC,MAAM,CAAC,IAAP,CAAY,MAAZ,EAAoB,MAAzB,EAAiC;AAChC,eAAO,IAAP;AACA;;AAED,YAAM;AAAE,QAAA;AAAF,UAAa,MAAnB;AACA,aAAO,MAAM,CAAC,MAAd;AAEA,oBAAM,QAAQ,CAAC,MAAT,CAAgB;AAAE,QAAA,GAAG,EAAE,IAAI,CAAC;AAAZ,OAAhB,EAAkC;AAAE,QAAA,IAAI,EAAE;AAAR,OAAlC,CAAN;;AAEA,UAAI,MAAJ,EAAY;AACX,QAAA,YAAY,CAAC,gBAAb,CAA8B,IAAI,CAAC,EAAnC,EAAuC,MAAvC;AACA;;AAED,aAAO,IAAP;AACA,KArBqB;AAAA;;AAuBN,EAAA,kBAAkB;AAAA,oCAAA;AACjC,aAAO,KAAK,CAAC,uBAAN,EAAP;AACA,KAFiC;AAAA;;AAIlB,EAAA,yBAAyB,CAAC,GAAD;AAAA,oCAAY;AACpD,aAAO,aAAa,CAAC,aAAd,CAA4B,GAA5B,CAAP;AACA,KAFwC;AAAA;;AAvGG","sourcesContent":["import { Random } from 'meteor/random';\nimport { UserPresence } from 'meteor/konecty:user-presence';\nimport { UserBridge } from '@rocket.chat/apps-engine/server/bridges/UserBridge';\nimport { IUserCreationOptions, IUser } from '@rocket.chat/apps-engine/definition/users';\n\nimport { setUserAvatar, checkUsernameAvailability, deleteUser } from '../../../lib/server/functions';\nimport { Users } from '../../../models/server';\nimport { Subscriptions, Users as UsersRaw } from '../../../models/server/raw';\nimport { AppServerOrchestrator } from '../orchestrator';\n\nexport class AppUserBridge extends UserBridge {\n\t// eslint-disable-next-line no-empty-function\n\tconstructor(private readonly orch: AppServerOrchestrator) {\n\t\tsuper();\n\t}\n\n\tprotected async getById(userId: string, appId: string): Promise<IUser> {\n\t\tthis.orch.debugLog(`The App ${appId} is getting the userId: \"${userId}\"`);\n\n\t\treturn this.orch.getConverters()?.get('users').convertById(userId);\n\t}\n\n\tprotected async getByUsername(username: string, appId: string): Promise<IUser> {\n\t\tthis.orch.debugLog(`The App ${appId} is getting the username: \"${username}\"`);\n\n\t\treturn this.orch.getConverters()?.get('users').convertByUsername(username);\n\t}\n\n\tprotected async getAppUser(appId?: string): Promise<IUser | undefined> {\n\t\tthis.orch.debugLog(`The App ${appId} is getting its assigned user`);\n\n\t\tconst user = Users.findOneByAppId(appId, {});\n\n\t\treturn this.orch.getConverters()?.get('users').convertToApp(user);\n\t}\n\n\tprotected async create(userDescriptor: Partial<IUser>, appId: string, options?: IUserCreationOptions): Promise<string> {\n\t\tthis.orch.debugLog(`The App ${appId} is requesting to create a new user.`);\n\t\tconst user = this.orch.getConverters()?.get('users').convertToRocketChat(userDescriptor);\n\n\t\tif (!user._id) {\n\t\t\tuser._id = Random.id();\n\t\t}\n\n\t\tif (!user.createdAt) {\n\t\t\tuser.createdAt = new Date();\n\t\t}\n\n\t\tswitch (user.type) {\n\t\t\tcase 'app':\n\t\t\t\tif (!checkUsernameAvailability(user.username)) {\n\t\t\t\t\tthrow new Error(`The username \"${user.username}\" is already being used. Rename or remove the user using it to install this App`);\n\t\t\t\t}\n\n\t\t\t\tUsers.insert(user);\n\n\t\t\t\tif (options?.avatarUrl) {\n\t\t\t\t\tsetUserAvatar(user, options.avatarUrl, '', 'local');\n\t\t\t\t}\n\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tthrow new Error('Creating normal users is currently not supported');\n\t\t}\n\n\t\treturn user._id;\n\t}\n\n\tprotected async remove(user: IUser & { id: string }, appId: string): Promise<boolean> {\n\t\tthis.orch.debugLog(`The App's user is being removed: ${appId}`);\n\n\t\t// It's actually not a problem if there is no App user to delete - just means we don't need to do anything more.\n\t\tif (!user) {\n\t\t\treturn true;\n\t\t}\n\n\t\ttry {\n\t\t\tdeleteUser(user.id);\n\t\t} catch (err) {\n\t\t\tthrow new Error(`Errors occurred while deleting an app user: ${err}`);\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tprotected async update(user: IUser & { id: string }, fields: Partial<IUser>, appId: string): Promise<boolean> {\n\t\tthis.orch.debugLog(`The App ${appId} is updating a user`);\n\n\t\tif (!user) {\n\t\t\tthrow new Error('User not provided');\n\t\t}\n\n\t\tif (!Object.keys(fields).length) {\n\t\t\treturn true;\n\t\t}\n\n\t\tconst { status } = fields;\n\t\tdelete fields.status;\n\n\t\tawait UsersRaw.update({ _id: user.id }, { $set: fields });\n\n\t\tif (status) {\n\t\t\tUserPresence.setDefaultStatus(user.id, status);\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tprotected async getActiveUserCount(): Promise<number> {\n\t\treturn Users.getActiveLocalUserCount();\n\t}\n\n\tprotected async getUserUnreadMessageCount(uid: string): Promise<number> {\n\t\treturn Subscriptions.getBadgeCount(uid);\n\t}\n}\n"],"sourceRoot":""},"sourceType":"module","hash":"a437c3cb71092af57729f91fe3a5e717a65c0f27"}
