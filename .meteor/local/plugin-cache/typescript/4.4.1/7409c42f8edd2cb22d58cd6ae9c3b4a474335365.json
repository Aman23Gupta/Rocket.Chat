{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/server/publications/settings/index.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/publications/settings/index.ts","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/server/publications/settings/index.ts","inputSourceMap":{"version":3,"file":"server/publications/settings/index.ts","sourceRoot":"","sources":["server/publications/settings/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\n\nimport { hasPermission, hasAtLeastOnePermission } from '../../../app/authorization/server';\nimport { getSettingPermissionId } from '../../../app/authorization/lib';\nimport { SettingsEvents } from '../../../app/settings/server';\nimport { Settings } from '../../../app/models/server/raw';\nimport { ISetting } from '../../../definition/ISetting';\n\nMeteor.methods({\n\tasync 'public-settings/get'(updatedAt) {\n\t\tif (updatedAt instanceof Date) {\n\t\t\tconst records = await Settings.findNotHiddenPublicUpdatedAfter(updatedAt).toArray();\n\t\t\tSettingsEvents.emit('fetch-settings', records);\n\n\t\t\treturn {\n\t\t\t\tupdate: records,\n\t\t\t\tremove: await Settings.trashFindDeletedAfter(\n\t\t\t\t\tupdatedAt,\n\t\t\t\t\t{\n\t\t\t\t\t\thidden: {\n\t\t\t\t\t\t\t$ne: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tpublic: true,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tprojection: {\n\t\t\t\t\t\t\t_id: 1,\n\t\t\t\t\t\t\t_deletedAt: 1,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t).toArray(),\n\t\t\t};\n\t\t}\n\n\t\tconst publicSettings = (await Settings.findNotHiddenPublic().toArray()) as ISetting[];\n\t\tSettingsEvents.emit('fetch-settings', publicSettings);\n\n\t\treturn publicSettings;\n\t},\n\tasync 'private-settings/get'(updatedAfter) {\n\t\tconst uid = Meteor.userId();\n\n\t\tif (!uid) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst privilegedSetting = hasAtLeastOnePermission(uid, ['view-privileged-setting', 'edit-privileged-setting']);\n\t\tconst manageSelectedSettings = privilegedSetting || hasPermission(uid, 'manage-selected-settings');\n\n\t\tif (!manageSelectedSettings) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst bypass = <T>(settings: T): T => settings;\n\n\t\tconst applyFilter = (fn: Function, args: any[]): any => fn(args);\n\n\t\tconst getAuthorizedSettingsFiltered = (settings: ISetting[]): ISetting[] =>\n\t\t\tsettings.filter((record) => hasPermission(uid, getSettingPermissionId(record._id)));\n\n\t\tconst getAuthorizedSettings = async (updatedAfter: Date, privilegedSetting: boolean): Promise<ISetting[]> =>\n\t\t\tapplyFilter(\n\t\t\t\tprivilegedSetting ? bypass : getAuthorizedSettingsFiltered,\n\t\t\t\tawait Settings.findNotHidden(updatedAfter && { updatedAfter }).toArray(),\n\t\t\t);\n\n\t\tif (!(updatedAfter instanceof Date)) {\n\t\t\t// this does not only imply an unfiltered setting range, it also identifies the caller's context:\n\t\t\t// If called *with* filter (see below), the user wants a collection as a result.\n\t\t\t// in this case, it shall only be a plain array\n\t\t\treturn getAuthorizedSettings(updatedAfter, privilegedSetting);\n\t\t}\n\n\t\treturn {\n\t\t\tupdate: await getAuthorizedSettings(updatedAfter, privilegedSetting),\n\t\t\tremove: await Settings.trashFindDeletedAfter(\n\t\t\t\tupdatedAfter,\n\t\t\t\t{\n\t\t\t\t\thidden: {\n\t\t\t\t\t\t$ne: true,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tprojection: {\n\t\t\t\t\t\t_id: 1,\n\t\t\t\t\t\t_deletedAt: 1,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t).toArray(),\n\t\t};\n\t},\n});\n"]},"targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/server/publications/settings/index.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/publications/settings/index.ts"}},"code":"let Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet hasPermission, hasAtLeastOnePermission;\nmodule.link(\"../../../app/authorization/server\", {\n  hasPermission(v) {\n    hasPermission = v;\n  },\n\n  hasAtLeastOnePermission(v) {\n    hasAtLeastOnePermission = v;\n  }\n\n}, 1);\nlet getSettingPermissionId;\nmodule.link(\"../../../app/authorization/lib\", {\n  getSettingPermissionId(v) {\n    getSettingPermissionId = v;\n  }\n\n}, 2);\nlet SettingsEvents;\nmodule.link(\"../../../app/settings/server\", {\n  SettingsEvents(v) {\n    SettingsEvents = v;\n  }\n\n}, 3);\nlet Settings;\nmodule.link(\"../../../app/models/server/raw\", {\n  Settings(v) {\n    Settings = v;\n  }\n\n}, 4);\nMeteor.methods({\n  'public-settings/get'(updatedAt) {\n    return Promise.asyncApply(() => {\n      if (updatedAt instanceof Date) {\n        const records = Promise.await(Settings.findNotHiddenPublicUpdatedAfter(updatedAt).toArray());\n        SettingsEvents.emit('fetch-settings', records);\n        return {\n          update: records,\n          remove: Promise.await(Settings.trashFindDeletedAfter(updatedAt, {\n            hidden: {\n              $ne: true\n            },\n            public: true\n          }, {\n            projection: {\n              _id: 1,\n              _deletedAt: 1\n            }\n          }).toArray())\n        };\n      }\n\n      const publicSettings = Promise.await(Settings.findNotHiddenPublic().toArray());\n      SettingsEvents.emit('fetch-settings', publicSettings);\n      return publicSettings;\n    });\n  },\n\n  'private-settings/get'(updatedAfter) {\n    return Promise.asyncApply(() => {\n      const uid = Meteor.userId();\n\n      if (!uid) {\n        return [];\n      }\n\n      const privilegedSetting = hasAtLeastOnePermission(uid, ['view-privileged-setting', 'edit-privileged-setting']);\n      const manageSelectedSettings = privilegedSetting || hasPermission(uid, 'manage-selected-settings');\n\n      if (!manageSelectedSettings) {\n        return [];\n      }\n\n      const bypass = settings => settings;\n\n      const applyFilter = (fn, args) => fn(args);\n\n      const getAuthorizedSettingsFiltered = settings => settings.filter(record => hasPermission(uid, getSettingPermissionId(record._id)));\n\n      const getAuthorizedSettings = (updatedAfter, privilegedSetting) => Promise.asyncApply(() => applyFilter(privilegedSetting ? bypass : getAuthorizedSettingsFiltered, Promise.await(Settings.findNotHidden(updatedAfter && {\n        updatedAfter\n      }).toArray())));\n\n      if (!(updatedAfter instanceof Date)) {\n        // this does not only imply an unfiltered setting range, it also identifies the caller's context:\n        // If called *with* filter (see below), the user wants a collection as a result.\n        // in this case, it shall only be a plain array\n        return getAuthorizedSettings(updatedAfter, privilegedSetting);\n      }\n\n      return {\n        update: Promise.await(getAuthorizedSettings(updatedAfter, privilegedSetting)),\n        remove: Promise.await(Settings.trashFindDeletedAfter(updatedAfter, {\n          hidden: {\n            $ne: true\n          }\n        }, {\n          projection: {\n            _id: 1,\n            _deletedAt: 1\n          }\n        }).toArray())\n      };\n    });\n  }\n\n});","map":{"version":3,"sources":["server/publications/settings/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\n\nimport { hasPermission, hasAtLeastOnePermission } from '../../../app/authorization/server';\nimport { getSettingPermissionId } from '../../../app/authorization/lib';\nimport { SettingsEvents } from '../../../app/settings/server';\nimport { Settings } from '../../../app/models/server/raw';\nimport { ISetting } from '../../../definition/ISetting';\n\nMeteor.methods({\n\tasync 'public-settings/get'(updatedAt) {\n\t\tif (updatedAt instanceof Date) {\n\t\t\tconst records = await Settings.findNotHiddenPublicUpdatedAfter(updatedAt).toArray();\n\t\t\tSettingsEvents.emit('fetch-settings', records);\n\n\t\t\treturn {\n\t\t\t\tupdate: records,\n\t\t\t\tremove: await Settings.trashFindDeletedAfter(\n\t\t\t\t\tupdatedAt,\n\t\t\t\t\t{\n\t\t\t\t\t\thidden: {\n\t\t\t\t\t\t\t$ne: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tpublic: true,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tprojection: {\n\t\t\t\t\t\t\t_id: 1,\n\t\t\t\t\t\t\t_deletedAt: 1,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t).toArray(),\n\t\t\t};\n\t\t}\n\n\t\tconst publicSettings = (await Settings.findNotHiddenPublic().toArray()) as ISetting[];\n\t\tSettingsEvents.emit('fetch-settings', publicSettings);\n\n\t\treturn publicSettings;\n\t},\n\tasync 'private-settings/get'(updatedAfter) {\n\t\tconst uid = Meteor.userId();\n\n\t\tif (!uid) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst privilegedSetting = hasAtLeastOnePermission(uid, ['view-privileged-setting', 'edit-privileged-setting']);\n\t\tconst manageSelectedSettings = privilegedSetting || hasPermission(uid, 'manage-selected-settings');\n\n\t\tif (!manageSelectedSettings) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst bypass = <T>(settings: T): T => settings;\n\n\t\tconst applyFilter = (fn: Function, args: any[]): any => fn(args);\n\n\t\tconst getAuthorizedSettingsFiltered = (settings: ISetting[]): ISetting[] =>\n\t\t\tsettings.filter((record) => hasPermission(uid, getSettingPermissionId(record._id)));\n\n\t\tconst getAuthorizedSettings = async (updatedAfter: Date, privilegedSetting: boolean): Promise<ISetting[]> =>\n\t\t\tapplyFilter(\n\t\t\t\tprivilegedSetting ? bypass : getAuthorizedSettingsFiltered,\n\t\t\t\tawait Settings.findNotHidden(updatedAfter && { updatedAfter }).toArray(),\n\t\t\t);\n\n\t\tif (!(updatedAfter instanceof Date)) {\n\t\t\t// this does not only imply an unfiltered setting range, it also identifies the caller's context:\n\t\t\t// If called *with* filter (see below), the user wants a collection as a result.\n\t\t\t// in this case, it shall only be a plain array\n\t\t\treturn getAuthorizedSettings(updatedAfter, privilegedSetting);\n\t\t}\n\n\t\treturn {\n\t\t\tupdate: await getAuthorizedSettings(updatedAfter, privilegedSetting),\n\t\t\tremove: await Settings.trashFindDeletedAfter(\n\t\t\t\tupdatedAfter,\n\t\t\t\t{\n\t\t\t\t\thidden: {\n\t\t\t\t\t\t$ne: true,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tprojection: {\n\t\t\t\t\t\t_id: 1,\n\t\t\t\t\t\t_deletedAt: 1,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t).toArray(),\n\t\t};\n\t},\n});\n"],"sourceRoot":""},"sourceType":"module","hash":"7409c42f8edd2cb22d58cd6ae9c3b4a474335365"}
