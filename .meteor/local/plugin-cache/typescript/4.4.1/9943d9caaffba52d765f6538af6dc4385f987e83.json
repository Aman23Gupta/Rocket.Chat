{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/federation/server/startup/settings.ts","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/federation/server/startup/settings.ts","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/federation/server/startup/settings.ts","inputSourceMap":{"version":3,"file":"app/federation/server/startup/settings.ts","sourceRoot":"","sources":["app/federation/server/startup/settings.ts"],"names":[],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\n\nimport { settingsRegistry, settings } from '../../../settings/server';\nimport { updateStatus, updateEnabled, isRegisteringOrEnabled } from '../functions/helpers';\nimport { getFederationDomain } from '../lib/getFederationDomain';\nimport { getFederationDiscoveryMethod } from '../lib/getFederationDiscoveryMethod';\nimport { registerWithHub } from '../lib/dns';\nimport { enableCallbacks, disableCallbacks } from '../lib/callbacks';\nimport { setupLogger } from '../lib/logger';\nimport { FederationKeys } from '../../../models/server/raw';\nimport { STATUS_ENABLED, STATUS_REGISTERING, STATUS_ERROR_REGISTERING, STATUS_DISABLED } from '../constants';\n\nMeteor.startup(async function () {\n\tconst federationPublicKey = await FederationKeys.getPublicKeyString();\n\n\tsettingsRegistry.addGroup('Federation', function () {\n\t\tthis.add('FEDERATION_Enabled', false, {\n\t\t\ttype: 'boolean',\n\t\t\ti18nLabel: 'Enabled',\n\t\t\ti18nDescription: 'FEDERATION_Enabled',\n\t\t\talert: 'FEDERATION_Enabled_Alert',\n\t\t\tpublic: true,\n\t\t});\n\n\t\tthis.add('FEDERATION_Status', 'Disabled', {\n\t\t\treadonly: true,\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'FEDERATION_Status',\n\t\t});\n\n\t\tthis.add('FEDERATION_Domain', '', {\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'FEDERATION_Domain',\n\t\t\ti18nDescription: 'FEDERATION_Domain_Description',\n\t\t\talert: 'FEDERATION_Domain_Alert',\n\t\t\t// disableReset: true,\n\t\t});\n\n\t\tthis.add('FEDERATION_Public_Key', federationPublicKey || '', {\n\t\t\treadonly: true,\n\t\t\ttype: 'string',\n\t\t\tmultiline: true,\n\t\t\ti18nLabel: 'FEDERATION_Public_Key',\n\t\t\ti18nDescription: 'FEDERATION_Public_Key_Description',\n\t\t});\n\n\t\tthis.add('FEDERATION_Discovery_Method', 'dns', {\n\t\t\ttype: 'select',\n\t\t\tvalues: [\n\t\t\t\t{\n\t\t\t\t\tkey: 'dns',\n\t\t\t\t\ti18nLabel: 'DNS',\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tkey: 'hub',\n\t\t\t\t\ti18nLabel: 'Hub',\n\t\t\t\t},\n\t\t\t],\n\t\t\ti18nLabel: 'FEDERATION_Discovery_Method',\n\t\t\ti18nDescription: 'FEDERATION_Discovery_Method_Description',\n\t\t\tpublic: true,\n\t\t});\n\n\t\tthis.add('FEDERATION_Test_Setup', 'FEDERATION_Test_Setup', {\n\t\t\ttype: 'action',\n\t\t\tactionText: 'FEDERATION_Test_Setup',\n\t\t});\n\t});\n});\n\nconst updateSettings = async function (): Promise<void> {\n\t// Get the key pair\n\n\tif (getFederationDiscoveryMethod() === 'hub' && !Promise.await(isRegisteringOrEnabled())) {\n\t\t// Register with hub\n\t\ttry {\n\t\t\tawait updateStatus(STATUS_REGISTERING);\n\n\t\t\tawait registerWithHub(getFederationDomain(), settings.get('Site_Url'), await FederationKeys.getPublicKeyString());\n\n\t\t\tawait updateStatus(STATUS_ENABLED);\n\t\t} catch (err) {\n\t\t\t// Disable federation\n\t\t\tawait updateEnabled(false);\n\n\t\t\tawait updateStatus(STATUS_ERROR_REGISTERING);\n\t\t}\n\t\treturn;\n\t}\n\tawait updateStatus(STATUS_ENABLED);\n};\n\n// Add settings listeners\nsettings.watch('FEDERATION_Enabled', function enableOrDisable(value) {\n\tsetupLogger.info(`Federation is ${value ? 'enabled' : 'disabled'}`);\n\n\tif (value) {\n\t\tPromise.await(updateSettings());\n\n\t\tenableCallbacks();\n\t} else {\n\t\tPromise.await(updateStatus(STATUS_DISABLED));\n\n\t\tdisableCallbacks();\n\t}\n\n\tvalue && updateSettings();\n});\n\nsettings.watchMultiple(['FEDERATION_Discovery_Method', 'FEDERATION_Domain'], updateSettings);\n"]},"targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/federation/server/startup/settings.ts","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/federation/server/startup/settings.ts"}},"code":"let Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet settingsRegistry, settings;\nmodule.link(\"../../../settings/server\", {\n  settingsRegistry(v) {\n    settingsRegistry = v;\n  },\n\n  settings(v) {\n    settings = v;\n  }\n\n}, 1);\nlet updateStatus, updateEnabled, isRegisteringOrEnabled;\nmodule.link(\"../functions/helpers\", {\n  updateStatus(v) {\n    updateStatus = v;\n  },\n\n  updateEnabled(v) {\n    updateEnabled = v;\n  },\n\n  isRegisteringOrEnabled(v) {\n    isRegisteringOrEnabled = v;\n  }\n\n}, 2);\nlet getFederationDomain;\nmodule.link(\"../lib/getFederationDomain\", {\n  getFederationDomain(v) {\n    getFederationDomain = v;\n  }\n\n}, 3);\nlet getFederationDiscoveryMethod;\nmodule.link(\"../lib/getFederationDiscoveryMethod\", {\n  getFederationDiscoveryMethod(v) {\n    getFederationDiscoveryMethod = v;\n  }\n\n}, 4);\nlet registerWithHub;\nmodule.link(\"../lib/dns\", {\n  registerWithHub(v) {\n    registerWithHub = v;\n  }\n\n}, 5);\nlet enableCallbacks, disableCallbacks;\nmodule.link(\"../lib/callbacks\", {\n  enableCallbacks(v) {\n    enableCallbacks = v;\n  },\n\n  disableCallbacks(v) {\n    disableCallbacks = v;\n  }\n\n}, 6);\nlet setupLogger;\nmodule.link(\"../lib/logger\", {\n  setupLogger(v) {\n    setupLogger = v;\n  }\n\n}, 7);\nlet FederationKeys;\nmodule.link(\"../../../models/server/raw\", {\n  FederationKeys(v) {\n    FederationKeys = v;\n  }\n\n}, 8);\nlet STATUS_ENABLED, STATUS_REGISTERING, STATUS_ERROR_REGISTERING, STATUS_DISABLED;\nmodule.link(\"../constants\", {\n  STATUS_ENABLED(v) {\n    STATUS_ENABLED = v;\n  },\n\n  STATUS_REGISTERING(v) {\n    STATUS_REGISTERING = v;\n  },\n\n  STATUS_ERROR_REGISTERING(v) {\n    STATUS_ERROR_REGISTERING = v;\n  },\n\n  STATUS_DISABLED(v) {\n    STATUS_DISABLED = v;\n  }\n\n}, 9);\nMeteor.startup(function () {\n  return Promise.asyncApply(() => {\n    const federationPublicKey = Promise.await(FederationKeys.getPublicKeyString());\n    settingsRegistry.addGroup('Federation', function () {\n      this.add('FEDERATION_Enabled', false, {\n        type: 'boolean',\n        i18nLabel: 'Enabled',\n        i18nDescription: 'FEDERATION_Enabled',\n        alert: 'FEDERATION_Enabled_Alert',\n        public: true\n      });\n      this.add('FEDERATION_Status', 'Disabled', {\n        readonly: true,\n        type: 'string',\n        i18nLabel: 'FEDERATION_Status'\n      });\n      this.add('FEDERATION_Domain', '', {\n        type: 'string',\n        i18nLabel: 'FEDERATION_Domain',\n        i18nDescription: 'FEDERATION_Domain_Description',\n        alert: 'FEDERATION_Domain_Alert' // disableReset: true,\n\n      });\n      this.add('FEDERATION_Public_Key', federationPublicKey || '', {\n        readonly: true,\n        type: 'string',\n        multiline: true,\n        i18nLabel: 'FEDERATION_Public_Key',\n        i18nDescription: 'FEDERATION_Public_Key_Description'\n      });\n      this.add('FEDERATION_Discovery_Method', 'dns', {\n        type: 'select',\n        values: [{\n          key: 'dns',\n          i18nLabel: 'DNS'\n        }, {\n          key: 'hub',\n          i18nLabel: 'Hub'\n        }],\n        i18nLabel: 'FEDERATION_Discovery_Method',\n        i18nDescription: 'FEDERATION_Discovery_Method_Description',\n        public: true\n      });\n      this.add('FEDERATION_Test_Setup', 'FEDERATION_Test_Setup', {\n        type: 'action',\n        actionText: 'FEDERATION_Test_Setup'\n      });\n    });\n  });\n});\n\nconst updateSettings = function () {\n  return Promise.asyncApply(() => {\n    // Get the key pair\n    if (getFederationDiscoveryMethod() === 'hub' && !Promise.await(isRegisteringOrEnabled())) {\n      // Register with hub\n      try {\n        Promise.await(updateStatus(STATUS_REGISTERING));\n        Promise.await(registerWithHub(getFederationDomain(), settings.get('Site_Url'), Promise.await(FederationKeys.getPublicKeyString())));\n        Promise.await(updateStatus(STATUS_ENABLED));\n      } catch (err) {\n        // Disable federation\n        Promise.await(updateEnabled(false));\n        Promise.await(updateStatus(STATUS_ERROR_REGISTERING));\n      }\n\n      return;\n    }\n\n    Promise.await(updateStatus(STATUS_ENABLED));\n  });\n}; // Add settings listeners\n\n\nsettings.watch('FEDERATION_Enabled', function enableOrDisable(value) {\n  setupLogger.info(\"Federation is \".concat(value ? 'enabled' : 'disabled'));\n\n  if (value) {\n    Promise.await(updateSettings());\n    enableCallbacks();\n  } else {\n    Promise.await(updateStatus(STATUS_DISABLED));\n    disableCallbacks();\n  }\n\n  value && updateSettings();\n});\nsettings.watchMultiple(['FEDERATION_Discovery_Method', 'FEDERATION_Domain'], updateSettings);","map":{"version":3,"sources":["app/federation/server/startup/settings.ts"],"names":[],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\n\nimport { settingsRegistry, settings } from '../../../settings/server';\nimport { updateStatus, updateEnabled, isRegisteringOrEnabled } from '../functions/helpers';\nimport { getFederationDomain } from '../lib/getFederationDomain';\nimport { getFederationDiscoveryMethod } from '../lib/getFederationDiscoveryMethod';\nimport { registerWithHub } from '../lib/dns';\nimport { enableCallbacks, disableCallbacks } from '../lib/callbacks';\nimport { setupLogger } from '../lib/logger';\nimport { FederationKeys } from '../../../models/server/raw';\nimport { STATUS_ENABLED, STATUS_REGISTERING, STATUS_ERROR_REGISTERING, STATUS_DISABLED } from '../constants';\n\nMeteor.startup(async function () {\n\tconst federationPublicKey = await FederationKeys.getPublicKeyString();\n\n\tsettingsRegistry.addGroup('Federation', function () {\n\t\tthis.add('FEDERATION_Enabled', false, {\n\t\t\ttype: 'boolean',\n\t\t\ti18nLabel: 'Enabled',\n\t\t\ti18nDescription: 'FEDERATION_Enabled',\n\t\t\talert: 'FEDERATION_Enabled_Alert',\n\t\t\tpublic: true,\n\t\t});\n\n\t\tthis.add('FEDERATION_Status', 'Disabled', {\n\t\t\treadonly: true,\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'FEDERATION_Status',\n\t\t});\n\n\t\tthis.add('FEDERATION_Domain', '', {\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'FEDERATION_Domain',\n\t\t\ti18nDescription: 'FEDERATION_Domain_Description',\n\t\t\talert: 'FEDERATION_Domain_Alert',\n\t\t\t// disableReset: true,\n\t\t});\n\n\t\tthis.add('FEDERATION_Public_Key', federationPublicKey || '', {\n\t\t\treadonly: true,\n\t\t\ttype: 'string',\n\t\t\tmultiline: true,\n\t\t\ti18nLabel: 'FEDERATION_Public_Key',\n\t\t\ti18nDescription: 'FEDERATION_Public_Key_Description',\n\t\t});\n\n\t\tthis.add('FEDERATION_Discovery_Method', 'dns', {\n\t\t\ttype: 'select',\n\t\t\tvalues: [\n\t\t\t\t{\n\t\t\t\t\tkey: 'dns',\n\t\t\t\t\ti18nLabel: 'DNS',\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tkey: 'hub',\n\t\t\t\t\ti18nLabel: 'Hub',\n\t\t\t\t},\n\t\t\t],\n\t\t\ti18nLabel: 'FEDERATION_Discovery_Method',\n\t\t\ti18nDescription: 'FEDERATION_Discovery_Method_Description',\n\t\t\tpublic: true,\n\t\t});\n\n\t\tthis.add('FEDERATION_Test_Setup', 'FEDERATION_Test_Setup', {\n\t\t\ttype: 'action',\n\t\t\tactionText: 'FEDERATION_Test_Setup',\n\t\t});\n\t});\n});\n\nconst updateSettings = async function (): Promise<void> {\n\t// Get the key pair\n\n\tif (getFederationDiscoveryMethod() === 'hub' && !Promise.await(isRegisteringOrEnabled())) {\n\t\t// Register with hub\n\t\ttry {\n\t\t\tawait updateStatus(STATUS_REGISTERING);\n\n\t\t\tawait registerWithHub(getFederationDomain(), settings.get('Site_Url'), await FederationKeys.getPublicKeyString());\n\n\t\t\tawait updateStatus(STATUS_ENABLED);\n\t\t} catch (err) {\n\t\t\t// Disable federation\n\t\t\tawait updateEnabled(false);\n\n\t\t\tawait updateStatus(STATUS_ERROR_REGISTERING);\n\t\t}\n\t\treturn;\n\t}\n\tawait updateStatus(STATUS_ENABLED);\n};\n\n// Add settings listeners\nsettings.watch('FEDERATION_Enabled', function enableOrDisable(value) {\n\tsetupLogger.info(`Federation is ${value ? 'enabled' : 'disabled'}`);\n\n\tif (value) {\n\t\tPromise.await(updateSettings());\n\n\t\tenableCallbacks();\n\t} else {\n\t\tPromise.await(updateStatus(STATUS_DISABLED));\n\n\t\tdisableCallbacks();\n\t}\n\n\tvalue && updateSettings();\n});\n\nsettings.watchMultiple(['FEDERATION_Discovery_Method', 'FEDERATION_Domain'], updateSettings);\n"],"sourceRoot":""},"sourceType":"module","hash":"9943d9caaffba52d765f6538af6dc4385f987e83"}
