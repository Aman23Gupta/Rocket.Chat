{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/livechat/server/roomAccessValidator.compatibility.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/livechat/server/roomAccessValidator.compatibility.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/livechat/server/roomAccessValidator.compatibility.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/livechat/server/roomAccessValidator.compatibility.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/livechat/server/roomAccessValidator.compatibility.js"}},"code":"let _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n\n}, 0);\nmodule.export({\n  validators: () => validators\n});\nlet hasPermission, hasRole;\nmodule.link(\"../../authorization/server\", {\n  hasPermission(v) {\n    hasPermission = v;\n  },\n\n  hasRole(v) {\n    hasRole = v;\n  }\n\n}, 0);\nlet LivechatDepartment, LivechatDepartmentAgents, LivechatInquiry, LivechatRooms;\nmodule.link(\"../../models/server\", {\n  LivechatDepartment(v) {\n    LivechatDepartment = v;\n  },\n\n  LivechatDepartmentAgents(v) {\n    LivechatDepartmentAgents = v;\n  },\n\n  LivechatInquiry(v) {\n    LivechatInquiry = v;\n  },\n\n  LivechatRooms(v) {\n    LivechatRooms = v;\n  }\n\n}, 1);\nlet RoutingManager;\nmodule.link(\"./lib/RoutingManager\", {\n  RoutingManager(v) {\n    RoutingManager = v;\n  }\n\n}, 2);\nconst validators = [function (room, user) {\n  if (!(user !== null && user !== void 0 && user._id)) {\n    return false;\n  }\n\n  return hasPermission(user._id, 'view-livechat-rooms');\n}, function (room, user) {\n  if (!(user !== null && user !== void 0 && user._id)) {\n    return false;\n  }\n\n  const {\n    _id: userId\n  } = user;\n  const {\n    servedBy: {\n      _id: agentId\n    } = {}\n  } = room;\n  return userId === agentId || !room.open && hasPermission(user._id, 'view-livechat-room-closed-by-another-agent');\n}, function (room, user, extraData) {\n  if (extraData && extraData.rid) {\n    room = LivechatRooms.findOneById(extraData.rid);\n  }\n\n  return extraData && extraData.visitorToken && room.v && room.v.token === extraData.visitorToken;\n}, function (room, user) {\n  if (!(user !== null && user !== void 0 && user._id)) {\n    return false;\n  }\n\n  const {\n    previewRoom\n  } = RoutingManager.getConfig();\n\n  if (!previewRoom) {\n    return;\n  }\n\n  let departmentIds;\n\n  if (!hasRole(user._id, 'livechat-manager')) {\n    const departmentAgents = LivechatDepartmentAgents.findByAgentId(user._id).fetch().map(d => d.departmentId);\n    departmentIds = LivechatDepartment.find({\n      _id: {\n        $in: departmentAgents\n      },\n      enabled: true\n    }).fetch().map(d => d._id);\n  }\n\n  const filter = {\n    rid: room._id,\n    $or: [{\n      $and: [{\n        defaultAgent: {\n          $exists: true\n        }\n      }, {\n        'defaultAgent.agentId': user._id\n      }]\n    }, _objectSpread({}, departmentIds && departmentIds.length > 0 && {\n      department: {\n        $in: departmentIds\n      }\n    })]\n  };\n  const inquiry = LivechatInquiry.findOne(filter, {\n    fields: {\n      status: 1\n    }\n  });\n  return inquiry && inquiry.status === 'queued';\n}, function (room, user) {\n  if (!room.departmentId || room.open || !(user !== null && user !== void 0 && user._id)) {\n    return;\n  }\n\n  const agentOfDepartment = LivechatDepartmentAgents.findOneByAgentIdAndDepartmentId(user._id, room.departmentId);\n\n  if (!agentOfDepartment) {\n    return;\n  }\n\n  return hasPermission(user._id, 'view-livechat-room-closed-same-department');\n}];","map":{"version":3,"sources":["app/livechat/server/roomAccessValidator.compatibility.js"],"names":["_objectSpread","module","link","default","v","export","validators","hasPermission","hasRole","LivechatDepartment","LivechatDepartmentAgents","LivechatInquiry","LivechatRooms","RoutingManager","room","user","_id","userId","servedBy","agentId","open","extraData","rid","findOneById","visitorToken","token","previewRoom","getConfig","departmentIds","departmentAgents","findByAgentId","fetch","map","d","departmentId","find","$in","enabled","filter","$or","$and","defaultAgent","$exists","length","department","inquiry","findOne","fields","status","agentOfDepartment","findOneByAgentIdAndDepartmentId"],"mappings":"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","sourcesContent":["import { hasPermission, hasRole } from '../../authorization/server';\nimport { LivechatDepartment, LivechatDepartmentAgents, LivechatInquiry, LivechatRooms } from '../../models/server';\nimport { RoutingManager } from './lib/RoutingManager';\n\nexport const validators = [\n\tfunction (room, user) {\n\t\tif (!user?._id) {\n\t\t\treturn false;\n\t\t}\n\t\treturn hasPermission(user._id, 'view-livechat-rooms');\n\t},\n\tfunction (room, user) {\n\t\tif (!user?._id) {\n\t\t\treturn false;\n\t\t}\n\t\tconst { _id: userId } = user;\n\t\tconst { servedBy: { _id: agentId } = {} } = room;\n\t\treturn userId === agentId || (!room.open && hasPermission(user._id, 'view-livechat-room-closed-by-another-agent'));\n\t},\n\tfunction (room, user, extraData) {\n\t\tif (extraData && extraData.rid) {\n\t\t\troom = LivechatRooms.findOneById(extraData.rid);\n\t\t}\n\t\treturn extraData && extraData.visitorToken && room.v && room.v.token === extraData.visitorToken;\n\t},\n\tfunction (room, user) {\n\t\tif (!user?._id) {\n\t\t\treturn false;\n\t\t}\n\t\tconst { previewRoom } = RoutingManager.getConfig();\n\t\tif (!previewRoom) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet departmentIds;\n\t\tif (!hasRole(user._id, 'livechat-manager')) {\n\t\t\tconst departmentAgents = LivechatDepartmentAgents.findByAgentId(user._id)\n\t\t\t\t.fetch()\n\t\t\t\t.map((d) => d.departmentId);\n\t\t\tdepartmentIds = LivechatDepartment.find({ _id: { $in: departmentAgents }, enabled: true })\n\t\t\t\t.fetch()\n\t\t\t\t.map((d) => d._id);\n\t\t}\n\n\t\tconst filter = {\n\t\t\trid: room._id,\n\t\t\t$or: [\n\t\t\t\t{\n\t\t\t\t\t$and: [{ defaultAgent: { $exists: true } }, { 'defaultAgent.agentId': user._id }],\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t...(departmentIds && departmentIds.length > 0 && { department: { $in: departmentIds } }),\n\t\t\t\t},\n\t\t\t],\n\t\t};\n\n\t\tconst inquiry = LivechatInquiry.findOne(filter, { fields: { status: 1 } });\n\t\treturn inquiry && inquiry.status === 'queued';\n\t},\n\tfunction (room, user) {\n\t\tif (!room.departmentId || room.open || !user?._id) {\n\t\t\treturn;\n\t\t}\n\t\tconst agentOfDepartment = LivechatDepartmentAgents.findOneByAgentIdAndDepartmentId(user._id, room.departmentId);\n\t\tif (!agentOfDepartment) {\n\t\t\treturn;\n\t\t}\n\t\treturn hasPermission(user._id, 'view-livechat-room-closed-same-department');\n\t},\n];\n"]},"sourceType":"module","hash":"b372d2e126b1ae103c520efce1847a0622a20e02"}
