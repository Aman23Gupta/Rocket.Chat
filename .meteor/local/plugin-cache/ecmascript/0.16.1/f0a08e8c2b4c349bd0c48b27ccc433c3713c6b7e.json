{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apple/server/tokenHandler.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/apple/server/tokenHandler.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apple/server/tokenHandler.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apple/server/tokenHandler.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/apple/server/tokenHandler.js"}},"code":"module.export({\n  handleIdentityToken: () => handleIdentityToken\n});\nlet jws;\nmodule.link(\"jsrsasign\", {\n  jws(v) {\n    jws = v;\n  }\n\n}, 0);\nlet NodeRSA;\nmodule.link(\"node-rsa\", {\n  default(v) {\n    NodeRSA = v;\n  }\n\n}, 1);\nlet HTTP;\nmodule.link(\"meteor/http\", {\n  HTTP(v) {\n    HTTP = v;\n  }\n\n}, 2);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 3);\nlet Accounts;\nmodule.link(\"meteor/accounts-base\", {\n  Accounts(v) {\n    Accounts = v;\n  }\n\n}, 4);\nlet Match, check;\nmodule.link(\"meteor/check\", {\n  Match(v) {\n    Match = v;\n  },\n\n  check(v) {\n    check = v;\n  }\n\n}, 5);\n\nconst isValidAppleJWT = (identityToken, header) => {\n  const applePublicKeys = HTTP.get('https://appleid.apple.com/auth/keys').data.keys;\n  const {\n    kid\n  } = header;\n  const key = applePublicKeys.find(k => k.kid === kid);\n  const pubKey = new NodeRSA();\n  pubKey.importKey({\n    n: Buffer.from(key.n, 'base64'),\n    e: Buffer.from(key.e, 'base64')\n  }, 'components-public');\n  const userKey = pubKey.exportKey(['public']);\n\n  try {\n    return jws.JWS.verify(identityToken, userKey, {\n      typ: 'JWT',\n      alg: 'RS256'\n    });\n  } catch (_unused) {\n    return false;\n  }\n};\n\nconst handleIdentityToken = _ref => {\n  let {\n    identityToken,\n    fullName = {},\n    email\n  } = _ref;\n  check(identityToken, String);\n  check(fullName, Match.Maybe(Object));\n  check(email, Match.Maybe(String));\n  const decodedToken = jws.JWS.parse(identityToken);\n\n  if (!isValidAppleJWT(identityToken, decodedToken.headerObj)) {\n    return {\n      type: 'apple',\n      error: new Meteor.Error(Accounts.LoginCancelledError.numericError, 'identityToken is a invalid JWT')\n    };\n  }\n\n  const profile = {};\n  const {\n    givenName,\n    familyName\n  } = fullName;\n\n  if (givenName && familyName) {\n    profile.name = \"\".concat(givenName, \" \").concat(familyName);\n  }\n\n  const {\n    iss,\n    iat,\n    exp\n  } = decodedToken.payloadObj;\n\n  if (!iss) {\n    return {\n      type: 'apple',\n      error: new Meteor.Error(Accounts.LoginCancelledError.numericError, 'Insufficient data in auth response token')\n    };\n  } // Collect basic auth provider details\n\n\n  const serviceData = {\n    id: iss,\n    did: iss.split(':').pop(),\n    issuedAt: new Date(iat * 1000),\n    expiresAt: new Date(exp * 1000)\n  };\n\n  if (email) {\n    serviceData.email = email;\n  }\n\n  return {\n    serviceData,\n    options: {\n      profile\n    }\n  };\n};","map":{"version":3,"sources":["app/apple/server/tokenHandler.js"],"names":["module","export","handleIdentityToken","jws","link","v","NodeRSA","default","HTTP","Meteor","Accounts","Match","check","isValidAppleJWT","identityToken","header","applePublicKeys","get","data","keys","kid","key","find","k","pubKey","importKey","n","Buffer","from","e","userKey","exportKey","JWS","verify","typ","alg","fullName","email","String","Maybe","Object","decodedToken","parse","headerObj","type","error","Error","LoginCancelledError","numericError","profile","givenName","familyName","name","iss","iat","exp","payloadObj","serviceData","id","did","split","pop","issuedAt","Date","expiresAt","options"],"mappings":"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","sourcesContent":["import { jws } from 'jsrsasign';\nimport NodeRSA from 'node-rsa';\nimport { HTTP } from 'meteor/http';\nimport { Meteor } from 'meteor/meteor';\nimport { Accounts } from 'meteor/accounts-base';\nimport { Match, check } from 'meteor/check';\n\nconst isValidAppleJWT = (identityToken, header) => {\n\tconst applePublicKeys = HTTP.get('https://appleid.apple.com/auth/keys').data.keys;\n\tconst { kid } = header;\n\n\tconst key = applePublicKeys.find((k) => k.kid === kid);\n\n\tconst pubKey = new NodeRSA();\n\tpubKey.importKey({ n: Buffer.from(key.n, 'base64'), e: Buffer.from(key.e, 'base64') }, 'components-public');\n\tconst userKey = pubKey.exportKey(['public']);\n\n\ttry {\n\t\treturn jws.JWS.verify(identityToken, userKey, {\n\t\t\ttyp: 'JWT',\n\t\t\talg: 'RS256',\n\t\t});\n\t} catch {\n\t\treturn false;\n\t}\n};\n\nexport const handleIdentityToken = ({ identityToken, fullName = {}, email }) => {\n\tcheck(identityToken, String);\n\tcheck(fullName, Match.Maybe(Object));\n\tcheck(email, Match.Maybe(String));\n\n\tconst decodedToken = jws.JWS.parse(identityToken);\n\n\tif (!isValidAppleJWT(identityToken, decodedToken.headerObj)) {\n\t\treturn {\n\t\t\ttype: 'apple',\n\t\t\terror: new Meteor.Error(Accounts.LoginCancelledError.numericError, 'identityToken is a invalid JWT'),\n\t\t};\n\t}\n\n\tconst profile = {};\n\n\tconst { givenName, familyName } = fullName;\n\tif (givenName && familyName) {\n\t\tprofile.name = `${givenName} ${familyName}`;\n\t}\n\n\tconst { iss, iat, exp } = decodedToken.payloadObj;\n\n\tif (!iss) {\n\t\treturn {\n\t\t\ttype: 'apple',\n\t\t\terror: new Meteor.Error(Accounts.LoginCancelledError.numericError, 'Insufficient data in auth response token'),\n\t\t};\n\t}\n\n\t// Collect basic auth provider details\n\tconst serviceData = {\n\t\tid: iss,\n\t\tdid: iss.split(':').pop(),\n\t\tissuedAt: new Date(iat * 1000),\n\t\texpiresAt: new Date(exp * 1000),\n\t};\n\n\tif (email) {\n\t\tserviceData.email = email;\n\t}\n\n\treturn {\n\t\tserviceData,\n\t\toptions: { profile },\n\t};\n};\n"]},"sourceType":"module","hash":"f0a08e8c2b4c349bd0c48b27ccc433c3713c6b7e"}
