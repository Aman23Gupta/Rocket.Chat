{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/packages/github-oauth/github_server.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"packages/github-oauth/github_server.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/packages/github-oauth/github_server.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/packages/github-oauth/github_server.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/github-oauth/github_server.js"}},"code":"Github = {};\nOAuth.registerService('github', 2, null, query => {\n  const accessTokenCall = Meteor.wrapAsync(getAccessToken);\n  const accessToken = accessTokenCall(query);\n  const identityCall = Meteor.wrapAsync(getIdentity);\n  const identity = identityCall(accessToken);\n  const emailsCall = Meteor.wrapAsync(getEmails);\n  const emails = emailsCall(accessToken);\n  const primaryEmail = emails.find(email => email.primary);\n  return {\n    serviceData: {\n      id: identity.id,\n      accessToken: OAuth.sealSecret(accessToken),\n      email: identity.email || primaryEmail && primaryEmail.email || '',\n      username: identity.login,\n      emails\n    },\n    options: {\n      profile: {\n        name: identity.name\n      }\n    }\n  };\n}); // http://developer.github.com/v3/#user-agent-required\n\nlet userAgent = 'Meteor';\nif (Meteor.release) userAgent += \"/\".concat(Meteor.release);\n\nconst getAccessToken = (query, callback) => Promise.asyncApply(() => {\n  const config = ServiceConfiguration.configurations.findOne({\n    service: 'github'\n  });\n  if (!config) throw new ServiceConfiguration.ConfigError();\n  let response;\n\n  try {\n    const content = new URLSearchParams({\n      client_id: config.clientId,\n      client_secret: config.secret,\n      code: query.code,\n      redirect_uri: OAuth._redirectUri('github', config)\n    });\n    const request = Promise.await(fetch(\"https://github.com/login/oauth/access_token?\".concat(content.toString()), {\n      method: 'POST',\n      headers: {\n        Accept: 'application/json',\n        'User-Agent': userAgent\n      }\n    }));\n    response = Promise.await(request.json());\n  } catch (err) {\n    throw Object.assign(new Error(\"Failed to complete OAuth handshake with Github. \".concat(err.message)), {\n      response: err.response\n    });\n  }\n\n  if (response.error) {\n    callback(response.error); // if the http response was a json object with an error attribute\n\n    throw new Error(\"Failed to complete OAuth handshake with GitHub. \".concat(response.error));\n  } else {\n    callback(null, response.access_token);\n    return response.access_token;\n  }\n});\n\nconst getIdentity = (accessToken, callback) => Promise.asyncApply(() => {\n  try {\n    const request = Promise.await(fetch('https://api.github.com/user', {\n      method: 'GET',\n      headers: {\n        Accept: 'application/json',\n        'User-Agent': userAgent,\n        Authorization: \"token \".concat(accessToken)\n      } // http://developer.github.com/v3/#user-agent-required\n\n    }));\n    const response = Promise.await(request.json());\n    callback(null, response);\n    return response;\n  } catch (err) {\n    callback(err.message);\n    throw Object.assign(new Error(\"Failed to fetch identity from Github. \".concat(err.message)), {\n      response: err.response\n    });\n  }\n});\n\nconst getEmails = (accessToken, callback) => Promise.asyncApply(() => {\n  try {\n    const request = Promise.await(fetch('https://api.github.com/user/emails', {\n      method: 'GET',\n      headers: {\n        'User-Agent': userAgent,\n        Accept: 'application/json',\n        Authorization: \"token \".concat(accessToken)\n      } // http://developer.github.com/v3/#user-agent-required\n\n    }));\n    const response = Promise.await(request.json());\n    callback(null, response);\n    return response;\n  } catch (err) {\n    callback(err.message, []);\n    return [];\n  }\n});\n\nGithub.retrieveCredential = (credentialToken, credentialSecret) => OAuth.retrieveCredential(credentialToken, credentialSecret);","map":{"version":3,"sources":["packages/github-oauth/github_server.js"],"names":["Github","OAuth","registerService","query","accessTokenCall","Meteor","wrapAsync","getAccessToken","accessToken","identityCall","getIdentity","identity","emailsCall","getEmails","emails","primaryEmail","find","email","primary","serviceData","id","sealSecret","username","login","options","profile","name","userAgent","release","callback","config","ServiceConfiguration","configurations","findOne","service","ConfigError","response","content","URLSearchParams","client_id","clientId","client_secret","secret","code","redirect_uri","_redirectUri","request","fetch","toString","method","headers","Accept","json","err","Object","assign","Error","message","error","access_token","Authorization","retrieveCredential","credentialToken","credentialSecret"],"mappings":"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","sourcesContent":["Github = {};\n\nOAuth.registerService('github', 2, null, (query) => {\n  const accessTokenCall = Meteor.wrapAsync(getAccessToken);\n  const accessToken = accessTokenCall(query);\n  const identityCall = Meteor.wrapAsync(getIdentity);\n  const identity = identityCall(accessToken);\n  const emailsCall = Meteor.wrapAsync(getEmails);\n  const emails = emailsCall(accessToken);\n  const primaryEmail = emails.find((email) => email.primary);\n\n  return {\n    serviceData: {\n      id: identity.id,\n      accessToken: OAuth.sealSecret(accessToken),\n      email: identity.email || (primaryEmail && primaryEmail.email) || '',\n      username: identity.login,\n      emails\n    },\n    options: { profile: { name: identity.name } }\n  };\n});\n\n// http://developer.github.com/v3/#user-agent-required\nlet userAgent = 'Meteor';\nif (Meteor.release) userAgent += `/${Meteor.release}`;\n\nconst getAccessToken = async (query, callback) => {\n  const config = ServiceConfiguration.configurations.findOne({\n    service: 'github'\n  });\n  if (!config) throw new ServiceConfiguration.ConfigError();\n\n  let response;\n  try {\n    const content = new URLSearchParams({\n      client_id: config.clientId,\n      client_secret: config.secret,\n      code: query.code,\n      redirect_uri: OAuth._redirectUri(\n        'github',\n        config\n      )\n    });\n    const request = await fetch(\n      `https://github.com/login/oauth/access_token?${content.toString()}`,\n      {\n        method: 'POST',\n        headers: {\n          Accept: 'application/json',\n          'User-Agent': userAgent\n        }\n      }\n    );\n    response = await request.json();\n  } catch (err) {\n    throw Object.assign(\n      new Error(\n        `Failed to complete OAuth handshake with Github. ${err.message}`\n      ),\n      { response: err.response }\n    );\n  }\n  if (response.error) {\n    callback(response.error);\n    // if the http response was a json object with an error attribute\n    throw new Error(\n      `Failed to complete OAuth handshake with GitHub. ${response.error}`\n    );\n  } else {\n    callback(null, response.access_token);\n    return response.access_token;\n  }\n};\n\nconst getIdentity = async (accessToken, callback) => {\n  try {\n    const request = await fetch('https://api.github.com/user', {\n      method: 'GET',\n      headers: {\n        Accept: 'application/json',\n        'User-Agent': userAgent,\n        Authorization: `token ${accessToken}`\n      } // http://developer.github.com/v3/#user-agent-required\n    });\n    const response = await request.json();\n    callback(null, response);\n    return response;\n  } catch (err) {\n    callback(err.message);\n    throw Object.assign(\n      new Error(`Failed to fetch identity from Github. ${err.message}`),\n      { response: err.response }\n    );\n  }\n};\n\nconst getEmails = async (accessToken, callback) => {\n  try {\n    const request = await fetch('https://api.github.com/user/emails', {\n      method: 'GET',\n      headers: {\n        'User-Agent': userAgent,\n        Accept: 'application/json',\n        Authorization: `token ${accessToken}`\n      } // http://developer.github.com/v3/#user-agent-required\n    });\n    const response = await request.json();\n    callback(null, response);\n    return response;\n  } catch (err) {\n    callback(err.message, []);\n    return [];\n  }\n};\n\nGithub.retrieveCredential = (credentialToken, credentialSecret) =>\n  OAuth.retrieveCredential(credentialToken, credentialSecret);\n"]},"sourceType":"module","hash":"36f38335f8933f3d66ee14dbeef5d2189ca3acb5"}
