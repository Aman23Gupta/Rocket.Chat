{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/ee/app/livechat-enterprise/server/lib/VisitorInactivityMonitor.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"ee/app/livechat-enterprise/server/lib/VisitorInactivityMonitor.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/ee/app/livechat-enterprise/server/lib/VisitorInactivityMonitor.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/ee/app/livechat-enterprise/server/lib/VisitorInactivityMonitor.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"ee/app/livechat-enterprise/server/lib/VisitorInactivityMonitor.js"}},"code":"module.export({\n  VisitorInactivityMonitor: () => VisitorInactivityMonitor\n});\nlet SyncedCron;\nmodule.link(\"meteor/littledata:synced-cron\", {\n  SyncedCron(v) {\n    SyncedCron = v;\n  }\n\n}, 0);\nlet TAPi18n;\nmodule.link(\"meteor/rocketchat:tap-i18n\", {\n  TAPi18n(v) {\n    TAPi18n = v;\n  }\n\n}, 1);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 2);\nlet settings;\nmodule.link(\"../../../../../app/settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 3);\nlet LivechatRooms, LivechatDepartment, Users, LivechatVisitors;\nmodule.link(\"../../../../../app/models/server\", {\n  LivechatRooms(v) {\n    LivechatRooms = v;\n  },\n\n  LivechatDepartment(v) {\n    LivechatDepartment = v;\n  },\n\n  Users(v) {\n    Users = v;\n  },\n\n  LivechatVisitors(v) {\n    LivechatVisitors = v;\n  }\n\n}, 4);\nlet Livechat;\nmodule.link(\"../../../../../app/livechat/server/lib/Livechat\", {\n  Livechat(v) {\n    Livechat = v;\n  }\n\n}, 5);\nlet LivechatEnterprise;\nmodule.link(\"./LivechatEnterprise\", {\n  LivechatEnterprise(v) {\n    LivechatEnterprise = v;\n  }\n\n}, 6);\n\nclass VisitorInactivityMonitor {\n  constructor() {\n    this._started = false;\n    this._name = 'Omnichannel Visitor Inactivity Monitor';\n    this.messageCache = new Map();\n  }\n\n  start() {\n    this._startMonitoring();\n\n    this._initializeMessageCache();\n\n    this.user = Users.findOneById('rocket.cat');\n  }\n\n  _startMonitoring() {\n    if (this.isRunning()) {\n      return;\n    }\n\n    const everyMinute = '* * * * *';\n    SyncedCron.add({\n      name: this._name,\n      schedule: parser => parser.cron(everyMinute),\n      job: () => {\n        this.handleAbandonedRooms();\n      }\n    });\n    this._started = true;\n  }\n\n  stop() {\n    if (!this.isRunning()) {\n      return;\n    }\n\n    SyncedCron.remove(this._name);\n    this._started = false;\n  }\n\n  isRunning() {\n    return this._started;\n  }\n\n  _initializeMessageCache() {\n    this.messageCache.clear();\n    this.messageCache.set('default', settings.get('Livechat_abandoned_rooms_closed_custom_message') || TAPi18n.__('Closed_automatically'));\n  }\n\n  _getDepartmentAbandonedCustomMessage(departmentId) {\n    if (this.messageCache.has('departmentId')) {\n      return this.messageCache.get('departmentId');\n    }\n\n    const department = LivechatDepartment.findOneById(departmentId);\n\n    if (!department) {\n      return;\n    }\n\n    this.messageCache.set(department._id, department.abandonedRoomsCloseCustomMessage);\n    return department.abandonedRoomsCloseCustomMessage;\n  }\n\n  closeRooms(room) {\n    let comment = this.messageCache.get('default');\n\n    if (room.departmentId) {\n      comment = this._getDepartmentAbandonedCustomMessage(room.departmentId) || comment;\n    }\n\n    Livechat.closeRoom({\n      comment,\n      room,\n      user: this.user\n    });\n  }\n\n  placeRoomOnHold(room) {\n    const timeout = settings.get('Livechat_visitor_inactivity_timeout');\n    const {\n      v: {\n        _id: visitorId\n      } = {}\n    } = room;\n    const visitor = LivechatVisitors.findOneById(visitorId);\n\n    if (!visitor) {\n      throw new Meteor.Error('error-invalid_visitor', 'Visitor Not found');\n    }\n\n    const guest = visitor.name || visitor.username;\n\n    const comment = TAPi18n.__('Omnichannel_On_Hold_due_to_inactivity', {\n      guest,\n      timeout\n    });\n\n    LivechatEnterprise.placeRoomOnHold(room, comment, this.user) && LivechatRooms.unsetPredictedVisitorAbandonmentByRoomId(room._id);\n  }\n\n  handleAbandonedRooms() {\n    const action = settings.get('Livechat_abandoned_rooms_action');\n\n    if (!action || action === 'none') {\n      return;\n    }\n\n    LivechatRooms.findAbandonedOpenRooms(new Date()).forEach(room => {\n      switch (action) {\n        case 'close':\n          {\n            this.closeRooms(room);\n            break;\n          }\n\n        case 'on-hold':\n          {\n            this.placeRoomOnHold(room);\n            break;\n          }\n      }\n    });\n\n    this._initializeMessageCache();\n  }\n\n}","map":{"version":3,"sources":["ee/app/livechat-enterprise/server/lib/VisitorInactivityMonitor.js"],"names":["module","export","VisitorInactivityMonitor","SyncedCron","link","v","TAPi18n","Meteor","settings","LivechatRooms","LivechatDepartment","Users","LivechatVisitors","Livechat","LivechatEnterprise","constructor","_started","_name","messageCache","Map","start","_startMonitoring","_initializeMessageCache","user","findOneById","isRunning","everyMinute","add","name","schedule","parser","cron","job","handleAbandonedRooms","stop","remove","clear","set","get","__","_getDepartmentAbandonedCustomMessage","departmentId","has","department","_id","abandonedRoomsCloseCustomMessage","closeRooms","room","comment","closeRoom","placeRoomOnHold","timeout","visitorId","visitor","Error","guest","username","unsetPredictedVisitorAbandonmentByRoomId","action","findAbandonedOpenRooms","Date","forEach"],"mappings":"AAAAA,MAAM,CAACC,MAAP,CAAc;AAACC,EAAAA,wBAAwB,EAAC,MAAIA;AAA9B,CAAd;AAAuE,IAAIC,UAAJ;AAAeH,MAAM,CAACI,IAAP,CAAY,+BAAZ,EAA4C;AAACD,EAAAA,UAAU,CAACE,CAAD,EAAG;AAACF,IAAAA,UAAU,GAACE,CAAX;AAAa;;AAA5B,CAA5C,EAA0E,CAA1E;AAA6E,IAAIC,OAAJ;AAAYN,MAAM,CAACI,IAAP,CAAY,4BAAZ,EAAyC;AAACE,EAAAA,OAAO,CAACD,CAAD,EAAG;AAACC,IAAAA,OAAO,GAACD,CAAR;AAAU;;AAAtB,CAAzC,EAAiE,CAAjE;AAAoE,IAAIE,MAAJ;AAAWP,MAAM,CAACI,IAAP,CAAY,eAAZ,EAA4B;AAACG,EAAAA,MAAM,CAACF,CAAD,EAAG;AAACE,IAAAA,MAAM,GAACF,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqD,IAAIG,QAAJ;AAAaR,MAAM,CAACI,IAAP,CAAY,oCAAZ,EAAiD;AAACI,EAAAA,QAAQ,CAACH,CAAD,EAAG;AAACG,IAAAA,QAAQ,GAACH,CAAT;AAAW;;AAAxB,CAAjD,EAA2E,CAA3E;AAA8E,IAAII,aAAJ,EAAkBC,kBAAlB,EAAqCC,KAArC,EAA2CC,gBAA3C;AAA4DZ,MAAM,CAACI,IAAP,CAAY,kCAAZ,EAA+C;AAACK,EAAAA,aAAa,CAACJ,CAAD,EAAG;AAACI,IAAAA,aAAa,GAACJ,CAAd;AAAgB,GAAlC;;AAAmCK,EAAAA,kBAAkB,CAACL,CAAD,EAAG;AAACK,IAAAA,kBAAkB,GAACL,CAAnB;AAAqB,GAA9E;;AAA+EM,EAAAA,KAAK,CAACN,CAAD,EAAG;AAACM,IAAAA,KAAK,GAACN,CAAN;AAAQ,GAAhG;;AAAiGO,EAAAA,gBAAgB,CAACP,CAAD,EAAG;AAACO,IAAAA,gBAAgB,GAACP,CAAjB;AAAmB;;AAAxI,CAA/C,EAAyL,CAAzL;AAA4L,IAAIQ,QAAJ;AAAab,MAAM,CAACI,IAAP,CAAY,iDAAZ,EAA8D;AAACS,EAAAA,QAAQ,CAACR,CAAD,EAAG;AAACQ,IAAAA,QAAQ,GAACR,CAAT;AAAW;;AAAxB,CAA9D,EAAwF,CAAxF;AAA2F,IAAIS,kBAAJ;AAAuBd,MAAM,CAACI,IAAP,CAAY,sBAAZ,EAAmC;AAACU,EAAAA,kBAAkB,CAACT,CAAD,EAAG;AAACS,IAAAA,kBAAkB,GAACT,CAAnB;AAAqB;;AAA5C,CAAnC,EAAiF,CAAjF;;AAS9vB,MAAMH,wBAAN,CAA+B;AACrCa,EAAAA,WAAW,GAAG;AACb,SAAKC,QAAL,GAAgB,KAAhB;AACA,SAAKC,KAAL,GAAa,wCAAb;AACA,SAAKC,YAAL,GAAoB,IAAIC,GAAJ,EAApB;AACA;;AAEDC,EAAAA,KAAK,GAAG;AACP,SAAKC,gBAAL;;AACA,SAAKC,uBAAL;;AACA,SAAKC,IAAL,GAAYZ,KAAK,CAACa,WAAN,CAAkB,YAAlB,CAAZ;AACA;;AAEDH,EAAAA,gBAAgB,GAAG;AAClB,QAAI,KAAKI,SAAL,EAAJ,EAAsB;AACrB;AACA;;AACD,UAAMC,WAAW,GAAG,WAApB;AACAvB,IAAAA,UAAU,CAACwB,GAAX,CAAe;AACdC,MAAAA,IAAI,EAAE,KAAKX,KADG;AAEdY,MAAAA,QAAQ,EAAGC,MAAD,IAAYA,MAAM,CAACC,IAAP,CAAYL,WAAZ,CAFR;AAGdM,MAAAA,GAAG,EAAE,MAAM;AACV,aAAKC,oBAAL;AACA;AALa,KAAf;AAOA,SAAKjB,QAAL,GAAgB,IAAhB;AACA;;AAEDkB,EAAAA,IAAI,GAAG;AACN,QAAI,CAAC,KAAKT,SAAL,EAAL,EAAuB;AACtB;AACA;;AAEDtB,IAAAA,UAAU,CAACgC,MAAX,CAAkB,KAAKlB,KAAvB;AAEA,SAAKD,QAAL,GAAgB,KAAhB;AACA;;AAEDS,EAAAA,SAAS,GAAG;AACX,WAAO,KAAKT,QAAZ;AACA;;AAEDM,EAAAA,uBAAuB,GAAG;AACzB,SAAKJ,YAAL,CAAkBkB,KAAlB;AACA,SAAKlB,YAAL,CAAkBmB,GAAlB,CAAsB,SAAtB,EAAiC7B,QAAQ,CAAC8B,GAAT,CAAa,gDAAb,KAAkEhC,OAAO,CAACiC,EAAR,CAAW,sBAAX,CAAnG;AACA;;AAEDC,EAAAA,oCAAoC,CAACC,YAAD,EAAe;AAClD,QAAI,KAAKvB,YAAL,CAAkBwB,GAAlB,CAAsB,cAAtB,CAAJ,EAA2C;AAC1C,aAAO,KAAKxB,YAAL,CAAkBoB,GAAlB,CAAsB,cAAtB,CAAP;AACA;;AACD,UAAMK,UAAU,GAAGjC,kBAAkB,CAACc,WAAnB,CAA+BiB,YAA/B,CAAnB;;AACA,QAAI,CAACE,UAAL,EAAiB;AAChB;AACA;;AACD,SAAKzB,YAAL,CAAkBmB,GAAlB,CAAsBM,UAAU,CAACC,GAAjC,EAAsCD,UAAU,CAACE,gCAAjD;AACA,WAAOF,UAAU,CAACE,gCAAlB;AACA;;AAEDC,EAAAA,UAAU,CAACC,IAAD,EAAO;AAChB,QAAIC,OAAO,GAAG,KAAK9B,YAAL,CAAkBoB,GAAlB,CAAsB,SAAtB,CAAd;;AACA,QAAIS,IAAI,CAACN,YAAT,EAAuB;AACtBO,MAAAA,OAAO,GAAG,KAAKR,oCAAL,CAA0CO,IAAI,CAACN,YAA/C,KAAgEO,OAA1E;AACA;;AACDnC,IAAAA,QAAQ,CAACoC,SAAT,CAAmB;AAClBD,MAAAA,OADkB;AAElBD,MAAAA,IAFkB;AAGlBxB,MAAAA,IAAI,EAAE,KAAKA;AAHO,KAAnB;AAKA;;AAED2B,EAAAA,eAAe,CAACH,IAAD,EAAO;AACrB,UAAMI,OAAO,GAAG3C,QAAQ,CAAC8B,GAAT,CAAa,qCAAb,CAAhB;AAEA,UAAM;AAAEjC,MAAAA,CAAC,EAAE;AAAEuC,QAAAA,GAAG,EAAEQ;AAAP,UAAqB;AAA1B,QAAiCL,IAAvC;AACA,UAAMM,OAAO,GAAGzC,gBAAgB,CAACY,WAAjB,CAA6B4B,SAA7B,CAAhB;;AACA,QAAI,CAACC,OAAL,EAAc;AACb,YAAM,IAAI9C,MAAM,CAAC+C,KAAX,CAAiB,uBAAjB,EAA0C,mBAA1C,CAAN;AACA;;AAED,UAAMC,KAAK,GAAGF,OAAO,CAACzB,IAAR,IAAgByB,OAAO,CAACG,QAAtC;;AACA,UAAMR,OAAO,GAAG1C,OAAO,CAACiC,EAAR,CAAW,uCAAX,EAAoD;AAAEgB,MAAAA,KAAF;AAASJ,MAAAA;AAAT,KAApD,CAAhB;;AAEArC,IAAAA,kBAAkB,CAACoC,eAAnB,CAAmCH,IAAnC,EAAyCC,OAAzC,EAAkD,KAAKzB,IAAvD,KAAgEd,aAAa,CAACgD,wCAAd,CAAuDV,IAAI,CAACH,GAA5D,CAAhE;AACA;;AAEDX,EAAAA,oBAAoB,GAAG;AACtB,UAAMyB,MAAM,GAAGlD,QAAQ,CAAC8B,GAAT,CAAa,iCAAb,CAAf;;AACA,QAAI,CAACoB,MAAD,IAAWA,MAAM,KAAK,MAA1B,EAAkC;AACjC;AACA;;AACDjD,IAAAA,aAAa,CAACkD,sBAAd,CAAqC,IAAIC,IAAJ,EAArC,EAAiDC,OAAjD,CAA0Dd,IAAD,IAAU;AAClE,cAAQW,MAAR;AACC,aAAK,OAAL;AAAc;AACb,iBAAKZ,UAAL,CAAgBC,IAAhB;AACA;AACA;;AACD,aAAK,SAAL;AAAgB;AACf,iBAAKG,eAAL,CAAqBH,IAArB;AACA;AACA;AARF;AAUA,KAXD;;AAYA,SAAKzB,uBAAL;AACA;;AAxGoC","sourcesContent":["import { SyncedCron } from 'meteor/littledata:synced-cron';\nimport { TAPi18n } from 'meteor/rocketchat:tap-i18n';\nimport { Meteor } from 'meteor/meteor';\n\nimport { settings } from '../../../../../app/settings/server';\nimport { LivechatRooms, LivechatDepartment, Users, LivechatVisitors } from '../../../../../app/models/server';\nimport { Livechat } from '../../../../../app/livechat/server/lib/Livechat';\nimport { LivechatEnterprise } from './LivechatEnterprise';\n\nexport class VisitorInactivityMonitor {\n\tconstructor() {\n\t\tthis._started = false;\n\t\tthis._name = 'Omnichannel Visitor Inactivity Monitor';\n\t\tthis.messageCache = new Map();\n\t}\n\n\tstart() {\n\t\tthis._startMonitoring();\n\t\tthis._initializeMessageCache();\n\t\tthis.user = Users.findOneById('rocket.cat');\n\t}\n\n\t_startMonitoring() {\n\t\tif (this.isRunning()) {\n\t\t\treturn;\n\t\t}\n\t\tconst everyMinute = '* * * * *';\n\t\tSyncedCron.add({\n\t\t\tname: this._name,\n\t\t\tschedule: (parser) => parser.cron(everyMinute),\n\t\t\tjob: () => {\n\t\t\t\tthis.handleAbandonedRooms();\n\t\t\t},\n\t\t});\n\t\tthis._started = true;\n\t}\n\n\tstop() {\n\t\tif (!this.isRunning()) {\n\t\t\treturn;\n\t\t}\n\n\t\tSyncedCron.remove(this._name);\n\n\t\tthis._started = false;\n\t}\n\n\tisRunning() {\n\t\treturn this._started;\n\t}\n\n\t_initializeMessageCache() {\n\t\tthis.messageCache.clear();\n\t\tthis.messageCache.set('default', settings.get('Livechat_abandoned_rooms_closed_custom_message') || TAPi18n.__('Closed_automatically'));\n\t}\n\n\t_getDepartmentAbandonedCustomMessage(departmentId) {\n\t\tif (this.messageCache.has('departmentId')) {\n\t\t\treturn this.messageCache.get('departmentId');\n\t\t}\n\t\tconst department = LivechatDepartment.findOneById(departmentId);\n\t\tif (!department) {\n\t\t\treturn;\n\t\t}\n\t\tthis.messageCache.set(department._id, department.abandonedRoomsCloseCustomMessage);\n\t\treturn department.abandonedRoomsCloseCustomMessage;\n\t}\n\n\tcloseRooms(room) {\n\t\tlet comment = this.messageCache.get('default');\n\t\tif (room.departmentId) {\n\t\t\tcomment = this._getDepartmentAbandonedCustomMessage(room.departmentId) || comment;\n\t\t}\n\t\tLivechat.closeRoom({\n\t\t\tcomment,\n\t\t\troom,\n\t\t\tuser: this.user,\n\t\t});\n\t}\n\n\tplaceRoomOnHold(room) {\n\t\tconst timeout = settings.get('Livechat_visitor_inactivity_timeout');\n\n\t\tconst { v: { _id: visitorId } = {} } = room;\n\t\tconst visitor = LivechatVisitors.findOneById(visitorId);\n\t\tif (!visitor) {\n\t\t\tthrow new Meteor.Error('error-invalid_visitor', 'Visitor Not found');\n\t\t}\n\n\t\tconst guest = visitor.name || visitor.username;\n\t\tconst comment = TAPi18n.__('Omnichannel_On_Hold_due_to_inactivity', { guest, timeout });\n\n\t\tLivechatEnterprise.placeRoomOnHold(room, comment, this.user) && LivechatRooms.unsetPredictedVisitorAbandonmentByRoomId(room._id);\n\t}\n\n\thandleAbandonedRooms() {\n\t\tconst action = settings.get('Livechat_abandoned_rooms_action');\n\t\tif (!action || action === 'none') {\n\t\t\treturn;\n\t\t}\n\t\tLivechatRooms.findAbandonedOpenRooms(new Date()).forEach((room) => {\n\t\t\tswitch (action) {\n\t\t\t\tcase 'close': {\n\t\t\t\t\tthis.closeRooms(room);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'on-hold': {\n\t\t\t\t\tthis.placeRoomOnHold(room);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\tthis._initializeMessageCache();\n\t}\n}\n"]},"sourceType":"module","hash":"8b1becb3bb4cc8b99a5f28cc620410df25052fa1"}
