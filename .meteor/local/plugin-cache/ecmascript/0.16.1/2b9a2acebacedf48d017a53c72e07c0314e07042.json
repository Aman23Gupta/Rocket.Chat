{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/importer/server/methods/uploadImportFile.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/importer/server/methods/uploadImportFile.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/importer/server/methods/uploadImportFile.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/importer/server/methods/uploadImportFile.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/importer/server/methods/uploadImportFile.js"}},"code":"let Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet RocketChatFile;\nmodule.link(\"../../../file\", {\n  RocketChatFile(v) {\n    RocketChatFile = v;\n  }\n\n}, 1);\nlet RocketChatImportFileInstance;\nmodule.link(\"../startup/store\", {\n  RocketChatImportFileInstance(v) {\n    RocketChatImportFileInstance = v;\n  }\n\n}, 2);\nlet hasPermission;\nmodule.link(\"../../../authorization\", {\n  hasPermission(v) {\n    hasPermission = v;\n  }\n\n}, 3);\nlet ProgressStep;\nmodule.link(\"../../lib/ImporterProgressStep\", {\n  ProgressStep(v) {\n    ProgressStep = v;\n  }\n\n}, 4);\nlet Importers;\nmodule.link(\"..\", {\n  Importers(v) {\n    Importers = v;\n  }\n\n}, 5);\nMeteor.methods({\n  uploadImportFile(binaryContent, contentType, fileName, importerKey) {\n    const userId = Meteor.userId();\n\n    if (!userId) {\n      throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n        method: 'uploadImportFile'\n      });\n    }\n\n    if (!hasPermission(userId, 'run-import')) {\n      throw new Meteor.Error('error-action-not-allowed', 'Importing is not allowed', {\n        method: 'uploadImportFile'\n      });\n    }\n\n    const importer = Importers.get(importerKey);\n\n    if (!importer) {\n      throw new Meteor.Error('error-importer-not-defined', \"The importer (\".concat(importerKey, \") has no import class defined.\"), {\n        method: 'uploadImportFile'\n      });\n    }\n\n    importer.instance = new importer.importer(importer); // eslint-disable-line new-cap\n\n    const date = new Date();\n    const dateStr = \"\".concat(date.getUTCFullYear()).concat(date.getUTCMonth()).concat(date.getUTCDate()).concat(date.getUTCHours()).concat(date.getUTCMinutes()).concat(date.getUTCSeconds());\n    const newFileName = \"\".concat(dateStr, \"_\").concat(userId, \"_\").concat(fileName); // Store the file name and content type on the imports collection\n\n    importer.instance.startFileUpload(newFileName, contentType); // Save the file on the File Store\n\n    const file = Buffer.from(binaryContent, 'base64');\n    const readStream = RocketChatFile.bufferToStream(file);\n    const writeStream = RocketChatImportFileInstance.createWriteStream(newFileName, contentType);\n    writeStream.on('end', Meteor.bindEnvironment(() => {\n      importer.instance.updateProgress(ProgressStep.FILE_LOADED);\n    }));\n    readStream.pipe(writeStream);\n  }\n\n});","map":{"version":3,"sources":["app/importer/server/methods/uploadImportFile.js"],"names":["Meteor","module","link","v","RocketChatFile","RocketChatImportFileInstance","hasPermission","ProgressStep","Importers","methods","uploadImportFile","binaryContent","contentType","fileName","importerKey","userId","Error","method","importer","get","instance","date","Date","dateStr","getUTCFullYear","getUTCMonth","getUTCDate","getUTCHours","getUTCMinutes","getUTCSeconds","newFileName","startFileUpload","file","Buffer","from","readStream","bufferToStream","writeStream","createWriteStream","on","bindEnvironment","updateProgress","FILE_LOADED","pipe"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\n\nimport { RocketChatFile } from '../../../file';\nimport { RocketChatImportFileInstance } from '../startup/store';\nimport { hasPermission } from '../../../authorization';\nimport { ProgressStep } from '../../lib/ImporterProgressStep';\nimport { Importers } from '..';\n\nMeteor.methods({\n\tuploadImportFile(binaryContent, contentType, fileName, importerKey) {\n\t\tconst userId = Meteor.userId();\n\n\t\tif (!userId) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'uploadImportFile' });\n\t\t}\n\n\t\tif (!hasPermission(userId, 'run-import')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Importing is not allowed', {\n\t\t\t\tmethod: 'uploadImportFile',\n\t\t\t});\n\t\t}\n\n\t\tconst importer = Importers.get(importerKey);\n\t\tif (!importer) {\n\t\t\tthrow new Meteor.Error('error-importer-not-defined', `The importer (${importerKey}) has no import class defined.`, {\n\t\t\t\tmethod: 'uploadImportFile',\n\t\t\t});\n\t\t}\n\n\t\timporter.instance = new importer.importer(importer); // eslint-disable-line new-cap\n\n\t\tconst date = new Date();\n\t\tconst dateStr = `${date.getUTCFullYear()}${date.getUTCMonth()}${date.getUTCDate()}${date.getUTCHours()}${date.getUTCMinutes()}${date.getUTCSeconds()}`;\n\t\tconst newFileName = `${dateStr}_${userId}_${fileName}`;\n\n\t\t// Store the file name and content type on the imports collection\n\t\timporter.instance.startFileUpload(newFileName, contentType);\n\n\t\t// Save the file on the File Store\n\t\tconst file = Buffer.from(binaryContent, 'base64');\n\t\tconst readStream = RocketChatFile.bufferToStream(file);\n\t\tconst writeStream = RocketChatImportFileInstance.createWriteStream(newFileName, contentType);\n\n\t\twriteStream.on(\n\t\t\t'end',\n\t\t\tMeteor.bindEnvironment(() => {\n\t\t\t\timporter.instance.updateProgress(ProgressStep.FILE_LOADED);\n\t\t\t}),\n\t\t);\n\n\t\treadStream.pipe(writeStream);\n\t},\n});\n"]},"sourceType":"module","hash":"2b9a2acebacedf48d017a53c72e07c0314e07042"}
