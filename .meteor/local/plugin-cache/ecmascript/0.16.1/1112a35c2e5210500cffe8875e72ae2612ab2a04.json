{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/importer/server/methods/getImportFileData.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/importer/server/methods/getImportFileData.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/importer/server/methods/getImportFileData.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/importer/server/methods/getImportFileData.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/importer/server/methods/getImportFileData.js"}},"code":"let path;\nmodule.link(\"path\", {\n  default(v) {\n    path = v;\n  }\n\n}, 0);\nlet fs;\nmodule.link(\"fs\", {\n  default(v) {\n    fs = v;\n  }\n\n}, 1);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 2);\nlet RocketChatImportFileInstance;\nmodule.link(\"../startup/store\", {\n  RocketChatImportFileInstance(v) {\n    RocketChatImportFileInstance = v;\n  }\n\n}, 3);\nlet hasPermission;\nmodule.link(\"../../../authorization\", {\n  hasPermission(v) {\n    hasPermission = v;\n  }\n\n}, 4);\nlet Imports;\nmodule.link(\"../../../models\", {\n  Imports(v) {\n    Imports = v;\n  }\n\n}, 5);\nlet ProgressStep;\nmodule.link(\"../../lib/ImporterProgressStep\", {\n  ProgressStep(v) {\n    ProgressStep = v;\n  }\n\n}, 6);\nlet Importers;\nmodule.link(\"..\", {\n  Importers(v) {\n    Importers = v;\n  }\n\n}, 7);\nMeteor.methods({\n  getImportFileData() {\n    const userId = Meteor.userId();\n\n    if (!userId) {\n      throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n        method: 'getImportFileData'\n      });\n    }\n\n    if (!hasPermission(userId, 'run-import')) {\n      throw new Meteor.Error('error-action-not-allowed', 'Importing is not allowed', {\n        method: 'getImportFileData'\n      });\n    }\n\n    const operation = Imports.findLastImport();\n\n    if (!operation) {\n      throw new Meteor.Error('error-operation-not-found', 'Import Operation Not Found', {\n        method: 'getImportFileData'\n      });\n    }\n\n    const {\n      importerKey\n    } = operation;\n    const importer = Importers.get(importerKey);\n\n    if (!importer) {\n      throw new Meteor.Error('error-importer-not-defined', \"The importer (\".concat(importerKey, \") has no import class defined.\"), {\n        method: 'getImportFileData'\n      });\n    }\n\n    importer.instance = new importer.importer(importer, operation); // eslint-disable-line new-cap\n\n    const waitingSteps = [ProgressStep.DOWNLOADING_FILE, ProgressStep.PREPARING_CHANNELS, ProgressStep.PREPARING_MESSAGES, ProgressStep.PREPARING_USERS, ProgressStep.PREPARING_STARTED];\n\n    if (waitingSteps.indexOf(importer.instance.progress.step) >= 0) {\n      if (importer.instance.importRecord && importer.instance.importRecord.valid) {\n        return {\n          waiting: true\n        };\n      }\n\n      throw new Meteor.Error('error-import-operation-invalid', 'Invalid Import Operation', {\n        method: 'getImportFileData'\n      });\n    }\n\n    const readySteps = [ProgressStep.USER_SELECTION, ProgressStep.DONE, ProgressStep.CANCELLED, ProgressStep.ERROR];\n\n    if (readySteps.indexOf(importer.instance.progress.step) >= 0) {\n      return importer.instance.buildSelection();\n    }\n\n    const fileName = importer.instance.importRecord.file;\n    const fullFilePath = fs.existsSync(fileName) ? fileName : path.join(RocketChatImportFileInstance.absolutePath, fileName);\n    const promise = importer.instance.prepareUsingLocalFile(fullFilePath);\n\n    if (promise && promise instanceof Promise) {\n      Promise.await(promise);\n    }\n\n    return importer.instance.buildSelection();\n  }\n\n});","map":{"version":3,"sources":["app/importer/server/methods/getImportFileData.js"],"names":["path","module","link","default","v","fs","Meteor","RocketChatImportFileInstance","hasPermission","Imports","ProgressStep","Importers","methods","getImportFileData","userId","Error","method","operation","findLastImport","importerKey","importer","get","instance","waitingSteps","DOWNLOADING_FILE","PREPARING_CHANNELS","PREPARING_MESSAGES","PREPARING_USERS","PREPARING_STARTED","indexOf","progress","step","importRecord","valid","waiting","readySteps","USER_SELECTION","DONE","CANCELLED","ERROR","buildSelection","fileName","file","fullFilePath","existsSync","join","absolutePath","promise","prepareUsingLocalFile","Promise","await"],"mappings":"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","sourcesContent":["import path from 'path';\nimport fs from 'fs';\n\nimport { Meteor } from 'meteor/meteor';\n\nimport { RocketChatImportFileInstance } from '../startup/store';\nimport { hasPermission } from '../../../authorization';\nimport { Imports } from '../../../models';\nimport { ProgressStep } from '../../lib/ImporterProgressStep';\nimport { Importers } from '..';\n\nMeteor.methods({\n\tgetImportFileData() {\n\t\tconst userId = Meteor.userId();\n\n\t\tif (!userId) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'getImportFileData' });\n\t\t}\n\n\t\tif (!hasPermission(userId, 'run-import')) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Importing is not allowed', {\n\t\t\t\tmethod: 'getImportFileData',\n\t\t\t});\n\t\t}\n\n\t\tconst operation = Imports.findLastImport();\n\t\tif (!operation) {\n\t\t\tthrow new Meteor.Error('error-operation-not-found', 'Import Operation Not Found', {\n\t\t\t\tmethod: 'getImportFileData',\n\t\t\t});\n\t\t}\n\n\t\tconst { importerKey } = operation;\n\n\t\tconst importer = Importers.get(importerKey);\n\t\tif (!importer) {\n\t\t\tthrow new Meteor.Error('error-importer-not-defined', `The importer (${importerKey}) has no import class defined.`, {\n\t\t\t\tmethod: 'getImportFileData',\n\t\t\t});\n\t\t}\n\n\t\timporter.instance = new importer.importer(importer, operation); // eslint-disable-line new-cap\n\n\t\tconst waitingSteps = [\n\t\t\tProgressStep.DOWNLOADING_FILE,\n\t\t\tProgressStep.PREPARING_CHANNELS,\n\t\t\tProgressStep.PREPARING_MESSAGES,\n\t\t\tProgressStep.PREPARING_USERS,\n\t\t\tProgressStep.PREPARING_STARTED,\n\t\t];\n\n\t\tif (waitingSteps.indexOf(importer.instance.progress.step) >= 0) {\n\t\t\tif (importer.instance.importRecord && importer.instance.importRecord.valid) {\n\t\t\t\treturn { waiting: true };\n\t\t\t}\n\t\t\tthrow new Meteor.Error('error-import-operation-invalid', 'Invalid Import Operation', {\n\t\t\t\tmethod: 'getImportFileData',\n\t\t\t});\n\t\t}\n\n\t\tconst readySteps = [ProgressStep.USER_SELECTION, ProgressStep.DONE, ProgressStep.CANCELLED, ProgressStep.ERROR];\n\n\t\tif (readySteps.indexOf(importer.instance.progress.step) >= 0) {\n\t\t\treturn importer.instance.buildSelection();\n\t\t}\n\n\t\tconst fileName = importer.instance.importRecord.file;\n\t\tconst fullFilePath = fs.existsSync(fileName) ? fileName : path.join(RocketChatImportFileInstance.absolutePath, fileName);\n\t\tconst promise = importer.instance.prepareUsingLocalFile(fullFilePath);\n\n\t\tif (promise && promise instanceof Promise) {\n\t\t\tPromise.await(promise);\n\t\t}\n\n\t\treturn importer.instance.buildSelection();\n\t},\n});\n"]},"sourceType":"module","hash":"1112a35c2e5210500cffe8875e72ae2612ab2a04"}
