{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apps/server/converters/messages.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/apps/server/converters/messages.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apps/server/converters/messages.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apps/server/converters/messages.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/apps/server/converters/messages.js"}},"code":"module.export({\n  AppMessagesConverter: () => AppMessagesConverter\n});\nlet Random;\nmodule.link(\"meteor/random\", {\n  Random(v) {\n    Random = v;\n  }\n\n}, 0);\nlet Messages, Rooms, Users;\nmodule.link(\"../../../models\", {\n  Messages(v) {\n    Messages = v;\n  },\n\n  Rooms(v) {\n    Rooms = v;\n  },\n\n  Users(v) {\n    Users = v;\n  }\n\n}, 1);\nlet transformMappedData;\nmodule.link(\"../../lib/misc/transformMappedData\", {\n  transformMappedData(v) {\n    transformMappedData = v;\n  }\n\n}, 2);\n\nclass AppMessagesConverter {\n  constructor(orch) {\n    this.orch = orch;\n  }\n\n  convertById(msgId) {\n    const msg = Messages.findOneById(msgId);\n    return this.convertMessage(msg);\n  }\n\n  convertMessage(msgObj) {\n    if (!msgObj) {\n      return undefined;\n    }\n\n    const map = {\n      id: '_id',\n      threadId: 'tmid',\n      reactions: 'reactions',\n      parseUrls: 'parseUrls',\n      text: 'msg',\n      createdAt: 'ts',\n      updatedAt: '_updatedAt',\n      editedAt: 'editedAt',\n      emoji: 'emoji',\n      avatarUrl: 'avatar',\n      alias: 'alias',\n      file: 'file',\n      customFields: 'customFields',\n      groupable: 'groupable',\n      token: 'token',\n      blocks: 'blocks',\n      room: message => {\n        const result = this.orch.getConverters().get('rooms').convertById(message.rid);\n        delete message.rid;\n        return result;\n      },\n      editor: message => {\n        const {\n          editedBy\n        } = message;\n        delete message.editedBy;\n\n        if (!editedBy) {\n          return undefined;\n        }\n\n        return this.orch.getConverters().get('users').convertById(editedBy._id);\n      },\n      attachments: message => {\n        const result = this._convertAttachmentsToApp(message.attachments);\n\n        delete message.attachments;\n        return result;\n      },\n      sender: message => {\n        if (!message.u || !message.u._id) {\n          return undefined;\n        }\n\n        let user = this.orch.getConverters().get('users').convertById(message.u._id); // When the sender of the message is a Guest (livechat) and not a user\n\n        if (!user) {\n          user = this.orch.getConverters().get('users').convertToApp(message.u);\n        }\n\n        delete message.u;\n        return user;\n      }\n    };\n    return transformMappedData(msgObj, map);\n  }\n\n  convertAppMessage(message) {\n    if (!message || !message.room) {\n      return undefined;\n    }\n\n    const room = Rooms.findOneById(message.room.id);\n\n    if (!room) {\n      throw new Error('Invalid room provided on the message.');\n    }\n\n    let u;\n\n    if (message.sender && message.sender.id) {\n      const user = Users.findOneById(message.sender.id);\n\n      if (user) {\n        u = {\n          _id: user._id,\n          username: user.username,\n          name: user.name\n        };\n      } else {\n        u = {\n          _id: message.sender.id,\n          username: message.sender.username,\n          name: message.sender.name\n        };\n      }\n    }\n\n    let editedBy;\n\n    if (message.editor) {\n      const editor = Users.findOneById(message.editor.id);\n      editedBy = {\n        _id: editor._id,\n        username: editor.username\n      };\n    }\n\n    const attachments = this._convertAppAttachments(message.attachments);\n\n    const newMessage = {\n      _id: message.id || Random.id(),\n      tmid: message.threadId,\n      rid: room._id,\n      u,\n      msg: message.text,\n      ts: message.createdAt || new Date(),\n      _updatedAt: message.updatedAt || new Date(),\n      editedBy,\n      editedAt: message.editedAt,\n      emoji: message.emoji,\n      avatar: message.avatarUrl,\n      alias: message.alias,\n      customFields: message.customFields,\n      groupable: message.groupable,\n      attachments,\n      reactions: message.reactions,\n      parseUrls: message.parseUrls,\n      blocks: message.blocks,\n      token: message.token\n    };\n    return Object.assign(newMessage, message._unmappedProperties_);\n  }\n\n  _convertAppAttachments(attachments) {\n    if (typeof attachments === 'undefined' || !Array.isArray(attachments)) {\n      return undefined;\n    }\n\n    return attachments.map(attachment => Object.assign({\n      collapsed: attachment.collapsed,\n      color: attachment.color,\n      text: attachment.text,\n      ts: attachment.timestamp ? attachment.timestamp.toJSON() : attachment.timestamp,\n      message_link: attachment.timestampLink,\n      thumb_url: attachment.thumbnailUrl,\n      author_name: attachment.author ? attachment.author.name : undefined,\n      author_link: attachment.author ? attachment.author.link : undefined,\n      author_icon: attachment.author ? attachment.author.icon : undefined,\n      title: attachment.title ? attachment.title.value : undefined,\n      title_link: attachment.title ? attachment.title.link : undefined,\n      title_link_download: attachment.title ? attachment.title.displayDownloadLink : undefined,\n      image_dimensions: attachment.imageDimensions,\n      image_preview: attachment.imagePreview,\n      image_url: attachment.imageUrl,\n      image_type: attachment.imageType,\n      image_size: attachment.imageSize,\n      audio_url: attachment.audioUrl,\n      audio_type: attachment.audioType,\n      audio_size: attachment.audioSize,\n      video_url: attachment.videoUrl,\n      video_type: attachment.videoType,\n      video_size: attachment.videoSize,\n      fields: attachment.fields,\n      button_alignment: attachment.actionButtonsAlignment,\n      actions: attachment.actions,\n      type: attachment.type,\n      description: attachment.description\n    }, attachment._unmappedProperties_));\n  }\n\n  _convertAttachmentsToApp(attachments) {\n    if (typeof attachments === 'undefined' || !Array.isArray(attachments)) {\n      return undefined;\n    }\n\n    const map = {\n      collapsed: 'collapsed',\n      color: 'color',\n      text: 'text',\n      timestampLink: 'message_link',\n      thumbnailUrl: 'thumb_url',\n      imageDimensions: 'image_dimensions',\n      imagePreview: 'image_preview',\n      imageUrl: 'image_url',\n      imageType: 'image_type',\n      imageSize: 'image_size',\n      audioUrl: 'audio_url',\n      audioType: 'audio_type',\n      audioSize: 'audio_size',\n      videoUrl: 'video_url',\n      videoType: 'video_type',\n      videoSize: 'video_size',\n      fields: 'fields',\n      actionButtonsAlignment: 'button_alignment',\n      actions: 'actions',\n      type: 'type',\n      description: 'description',\n      author: attachment => {\n        const {\n          author_name: name,\n          author_link: link,\n          author_icon: icon\n        } = attachment;\n        delete attachment.author_name;\n        delete attachment.author_link;\n        delete attachment.author_icon;\n        return {\n          name,\n          link,\n          icon\n        };\n      },\n      title: attachment => {\n        const {\n          title: value,\n          title_link: link,\n          title_link_download: displayDownloadLink\n        } = attachment;\n        delete attachment.title;\n        delete attachment.title_link;\n        delete attachment.title_link_download;\n        return {\n          value,\n          link,\n          displayDownloadLink\n        };\n      },\n      timestamp: attachment => {\n        const result = new Date(attachment.ts);\n        delete attachment.ts;\n        return result;\n      }\n    };\n    return attachments.map(attachment => transformMappedData(attachment, map));\n  }\n\n}","map":{"version":3,"sources":["app/apps/server/converters/messages.js"],"names":["module","export","AppMessagesConverter","Random","link","v","Messages","Rooms","Users","transformMappedData","constructor","orch","convertById","msgId","msg","findOneById","convertMessage","msgObj","undefined","map","id","threadId","reactions","parseUrls","text","createdAt","updatedAt","editedAt","emoji","avatarUrl","alias","file","customFields","groupable","token","blocks","room","message","result","getConverters","get","rid","editor","editedBy","_id","attachments","_convertAttachmentsToApp","sender","u","user","convertToApp","convertAppMessage","Error","username","name","_convertAppAttachments","newMessage","tmid","ts","Date","_updatedAt","avatar","Object","assign","_unmappedProperties_","Array","isArray","attachment","collapsed","color","timestamp","toJSON","message_link","timestampLink","thumb_url","thumbnailUrl","author_name","author","author_link","author_icon","icon","title","value","title_link","title_link_download","displayDownloadLink","image_dimensions","imageDimensions","image_preview","imagePreview","image_url","imageUrl","image_type","imageType","image_size","imageSize","audio_url","audioUrl","audio_type","audioType","audio_size","audioSize","video_url","videoUrl","video_type","videoType","video_size","videoSize","fields","button_alignment","actionButtonsAlignment","actions","type","description"],"mappings":"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","sourcesContent":["import { Random } from 'meteor/random';\n\nimport { Messages, Rooms, Users } from '../../../models';\nimport { transformMappedData } from '../../lib/misc/transformMappedData';\n\nexport class AppMessagesConverter {\n\tconstructor(orch) {\n\t\tthis.orch = orch;\n\t}\n\n\tconvertById(msgId) {\n\t\tconst msg = Messages.findOneById(msgId);\n\n\t\treturn this.convertMessage(msg);\n\t}\n\n\tconvertMessage(msgObj) {\n\t\tif (!msgObj) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst map = {\n\t\t\tid: '_id',\n\t\t\tthreadId: 'tmid',\n\t\t\treactions: 'reactions',\n\t\t\tparseUrls: 'parseUrls',\n\t\t\ttext: 'msg',\n\t\t\tcreatedAt: 'ts',\n\t\t\tupdatedAt: '_updatedAt',\n\t\t\teditedAt: 'editedAt',\n\t\t\temoji: 'emoji',\n\t\t\tavatarUrl: 'avatar',\n\t\t\talias: 'alias',\n\t\t\tfile: 'file',\n\t\t\tcustomFields: 'customFields',\n\t\t\tgroupable: 'groupable',\n\t\t\ttoken: 'token',\n\t\t\tblocks: 'blocks',\n\t\t\troom: (message) => {\n\t\t\t\tconst result = this.orch.getConverters().get('rooms').convertById(message.rid);\n\t\t\t\tdelete message.rid;\n\t\t\t\treturn result;\n\t\t\t},\n\t\t\teditor: (message) => {\n\t\t\t\tconst { editedBy } = message;\n\t\t\t\tdelete message.editedBy;\n\n\t\t\t\tif (!editedBy) {\n\t\t\t\t\treturn undefined;\n\t\t\t\t}\n\n\t\t\t\treturn this.orch.getConverters().get('users').convertById(editedBy._id);\n\t\t\t},\n\t\t\tattachments: (message) => {\n\t\t\t\tconst result = this._convertAttachmentsToApp(message.attachments);\n\t\t\t\tdelete message.attachments;\n\t\t\t\treturn result;\n\t\t\t},\n\t\t\tsender: (message) => {\n\t\t\t\tif (!message.u || !message.u._id) {\n\t\t\t\t\treturn undefined;\n\t\t\t\t}\n\n\t\t\t\tlet user = this.orch.getConverters().get('users').convertById(message.u._id);\n\n\t\t\t\t// When the sender of the message is a Guest (livechat) and not a user\n\t\t\t\tif (!user) {\n\t\t\t\t\tuser = this.orch.getConverters().get('users').convertToApp(message.u);\n\t\t\t\t}\n\n\t\t\t\tdelete message.u;\n\n\t\t\t\treturn user;\n\t\t\t},\n\t\t};\n\n\t\treturn transformMappedData(msgObj, map);\n\t}\n\n\tconvertAppMessage(message) {\n\t\tif (!message || !message.room) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst room = Rooms.findOneById(message.room.id);\n\n\t\tif (!room) {\n\t\t\tthrow new Error('Invalid room provided on the message.');\n\t\t}\n\n\t\tlet u;\n\t\tif (message.sender && message.sender.id) {\n\t\t\tconst user = Users.findOneById(message.sender.id);\n\n\t\t\tif (user) {\n\t\t\t\tu = {\n\t\t\t\t\t_id: user._id,\n\t\t\t\t\tusername: user.username,\n\t\t\t\t\tname: user.name,\n\t\t\t\t};\n\t\t\t} else {\n\t\t\t\tu = {\n\t\t\t\t\t_id: message.sender.id,\n\t\t\t\t\tusername: message.sender.username,\n\t\t\t\t\tname: message.sender.name,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\tlet editedBy;\n\t\tif (message.editor) {\n\t\t\tconst editor = Users.findOneById(message.editor.id);\n\t\t\teditedBy = {\n\t\t\t\t_id: editor._id,\n\t\t\t\tusername: editor.username,\n\t\t\t};\n\t\t}\n\n\t\tconst attachments = this._convertAppAttachments(message.attachments);\n\n\t\tconst newMessage = {\n\t\t\t_id: message.id || Random.id(),\n\t\t\ttmid: message.threadId,\n\t\t\trid: room._id,\n\t\t\tu,\n\t\t\tmsg: message.text,\n\t\t\tts: message.createdAt || new Date(),\n\t\t\t_updatedAt: message.updatedAt || new Date(),\n\t\t\teditedBy,\n\t\t\teditedAt: message.editedAt,\n\t\t\temoji: message.emoji,\n\t\t\tavatar: message.avatarUrl,\n\t\t\talias: message.alias,\n\t\t\tcustomFields: message.customFields,\n\t\t\tgroupable: message.groupable,\n\t\t\tattachments,\n\t\t\treactions: message.reactions,\n\t\t\tparseUrls: message.parseUrls,\n\t\t\tblocks: message.blocks,\n\t\t\ttoken: message.token,\n\t\t};\n\n\t\treturn Object.assign(newMessage, message._unmappedProperties_);\n\t}\n\n\t_convertAppAttachments(attachments) {\n\t\tif (typeof attachments === 'undefined' || !Array.isArray(attachments)) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\treturn attachments.map((attachment) =>\n\t\t\tObject.assign(\n\t\t\t\t{\n\t\t\t\t\tcollapsed: attachment.collapsed,\n\t\t\t\t\tcolor: attachment.color,\n\t\t\t\t\ttext: attachment.text,\n\t\t\t\t\tts: attachment.timestamp ? attachment.timestamp.toJSON() : attachment.timestamp,\n\t\t\t\t\tmessage_link: attachment.timestampLink,\n\t\t\t\t\tthumb_url: attachment.thumbnailUrl,\n\t\t\t\t\tauthor_name: attachment.author ? attachment.author.name : undefined,\n\t\t\t\t\tauthor_link: attachment.author ? attachment.author.link : undefined,\n\t\t\t\t\tauthor_icon: attachment.author ? attachment.author.icon : undefined,\n\t\t\t\t\ttitle: attachment.title ? attachment.title.value : undefined,\n\t\t\t\t\ttitle_link: attachment.title ? attachment.title.link : undefined,\n\t\t\t\t\ttitle_link_download: attachment.title ? attachment.title.displayDownloadLink : undefined,\n\t\t\t\t\timage_dimensions: attachment.imageDimensions,\n\t\t\t\t\timage_preview: attachment.imagePreview,\n\t\t\t\t\timage_url: attachment.imageUrl,\n\t\t\t\t\timage_type: attachment.imageType,\n\t\t\t\t\timage_size: attachment.imageSize,\n\t\t\t\t\taudio_url: attachment.audioUrl,\n\t\t\t\t\taudio_type: attachment.audioType,\n\t\t\t\t\taudio_size: attachment.audioSize,\n\t\t\t\t\tvideo_url: attachment.videoUrl,\n\t\t\t\t\tvideo_type: attachment.videoType,\n\t\t\t\t\tvideo_size: attachment.videoSize,\n\t\t\t\t\tfields: attachment.fields,\n\t\t\t\t\tbutton_alignment: attachment.actionButtonsAlignment,\n\t\t\t\t\tactions: attachment.actions,\n\t\t\t\t\ttype: attachment.type,\n\t\t\t\t\tdescription: attachment.description,\n\t\t\t\t},\n\t\t\t\tattachment._unmappedProperties_,\n\t\t\t),\n\t\t);\n\t}\n\n\t_convertAttachmentsToApp(attachments) {\n\t\tif (typeof attachments === 'undefined' || !Array.isArray(attachments)) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst map = {\n\t\t\tcollapsed: 'collapsed',\n\t\t\tcolor: 'color',\n\t\t\ttext: 'text',\n\t\t\ttimestampLink: 'message_link',\n\t\t\tthumbnailUrl: 'thumb_url',\n\t\t\timageDimensions: 'image_dimensions',\n\t\t\timagePreview: 'image_preview',\n\t\t\timageUrl: 'image_url',\n\t\t\timageType: 'image_type',\n\t\t\timageSize: 'image_size',\n\t\t\taudioUrl: 'audio_url',\n\t\t\taudioType: 'audio_type',\n\t\t\taudioSize: 'audio_size',\n\t\t\tvideoUrl: 'video_url',\n\t\t\tvideoType: 'video_type',\n\t\t\tvideoSize: 'video_size',\n\t\t\tfields: 'fields',\n\t\t\tactionButtonsAlignment: 'button_alignment',\n\t\t\tactions: 'actions',\n\t\t\ttype: 'type',\n\t\t\tdescription: 'description',\n\t\t\tauthor: (attachment) => {\n\t\t\t\tconst { author_name: name, author_link: link, author_icon: icon } = attachment;\n\n\t\t\t\tdelete attachment.author_name;\n\t\t\t\tdelete attachment.author_link;\n\t\t\t\tdelete attachment.author_icon;\n\n\t\t\t\treturn { name, link, icon };\n\t\t\t},\n\t\t\ttitle: (attachment) => {\n\t\t\t\tconst { title: value, title_link: link, title_link_download: displayDownloadLink } = attachment;\n\n\t\t\t\tdelete attachment.title;\n\t\t\t\tdelete attachment.title_link;\n\t\t\t\tdelete attachment.title_link_download;\n\n\t\t\t\treturn { value, link, displayDownloadLink };\n\t\t\t},\n\t\t\ttimestamp: (attachment) => {\n\t\t\t\tconst result = new Date(attachment.ts);\n\t\t\t\tdelete attachment.ts;\n\t\t\t\treturn result;\n\t\t\t},\n\t\t};\n\n\t\treturn attachments.map((attachment) => transformMappedData(attachment, map));\n\t}\n}\n"]},"sourceType":"module","hash":"e15481793a5f3740c62a67940ebeed7434d22ee8"}
