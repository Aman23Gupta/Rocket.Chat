{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/ee/app/livechat-enterprise/server/lib/LivechatEnterprise.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"ee/app/livechat-enterprise/server/lib/LivechatEnterprise.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/ee/app/livechat-enterprise/server/lib/LivechatEnterprise.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/ee/app/livechat-enterprise/server/lib/LivechatEnterprise.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"ee/app/livechat-enterprise/server/lib/LivechatEnterprise.js"}},"code":"module.export({\n  LivechatEnterprise: () => LivechatEnterprise\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet Match, check;\nmodule.link(\"meteor/check\", {\n  Match(v) {\n    Match = v;\n  },\n\n  check(v) {\n    check = v;\n  }\n\n}, 1);\nlet Users;\nmodule.link(\"../../../../../app/models\", {\n  Users(v) {\n    Users = v;\n  }\n\n}, 2);\nlet LivechatInquiry, OmnichannelQueue;\nmodule.link(\"../../../../../app/models/server/raw\", {\n  LivechatInquiry(v) {\n    LivechatInquiry = v;\n  },\n\n  OmnichannelQueue(v) {\n    OmnichannelQueue = v;\n  }\n\n}, 3);\nlet LivechatUnit;\nmodule.link(\"../../../models/server/models/LivechatUnit\", {\n  default(v) {\n    LivechatUnit = v;\n  }\n\n}, 4);\nlet LivechatTag;\nmodule.link(\"../../../models/server/models/LivechatTag\", {\n  default(v) {\n    LivechatTag = v;\n  }\n\n}, 5);\nlet LivechatRooms, Subscriptions, Messages;\nmodule.link(\"../../../../../app/models/server\", {\n  LivechatRooms(v) {\n    LivechatRooms = v;\n  },\n\n  Subscriptions(v) {\n    Subscriptions = v;\n  },\n\n  Messages(v) {\n    Messages = v;\n  }\n\n}, 6);\nlet LivechatPriority;\nmodule.link(\"../../../models/server/models/LivechatPriority\", {\n  default(v) {\n    LivechatPriority = v;\n  }\n\n}, 7);\nlet addUserRoles, removeUserFromRoles;\nmodule.link(\"../../../../../app/authorization/server\", {\n  addUserRoles(v) {\n    addUserRoles = v;\n  },\n\n  removeUserFromRoles(v) {\n    removeUserFromRoles = v;\n  }\n\n}, 8);\nlet processWaitingQueue, removePriorityFromRooms, updateInquiryQueuePriority, updatePriorityInquiries, updateRoomPriorityHistory;\nmodule.link(\"./Helper\", {\n  processWaitingQueue(v) {\n    processWaitingQueue = v;\n  },\n\n  removePriorityFromRooms(v) {\n    removePriorityFromRooms = v;\n  },\n\n  updateInquiryQueuePriority(v) {\n    updateInquiryQueuePriority = v;\n  },\n\n  updatePriorityInquiries(v) {\n    updatePriorityInquiries = v;\n  },\n\n  updateRoomPriorityHistory(v) {\n    updateRoomPriorityHistory = v;\n  }\n\n}, 9);\nlet RoutingManager;\nmodule.link(\"../../../../../app/livechat/server/lib/RoutingManager\", {\n  RoutingManager(v) {\n    RoutingManager = v;\n  }\n\n}, 10);\nlet settings;\nmodule.link(\"../../../../../app/settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 11);\nlet logger, queueLogger;\nmodule.link(\"./logger\", {\n  logger(v) {\n    logger = v;\n  },\n\n  queueLogger(v) {\n    queueLogger = v;\n  }\n\n}, 12);\nlet callbacks;\nmodule.link(\"../../../../../lib/callbacks\", {\n  callbacks(v) {\n    callbacks = v;\n  }\n\n}, 13);\nlet AutoCloseOnHoldScheduler;\nmodule.link(\"./AutoCloseOnHoldScheduler\", {\n  AutoCloseOnHoldScheduler(v) {\n    AutoCloseOnHoldScheduler = v;\n  }\n\n}, 14);\nconst LivechatEnterprise = {\n  addMonitor(username) {\n    check(username, String);\n    const user = Users.findOneByUsername(username, {\n      fields: {\n        _id: 1,\n        username: 1\n      }\n    });\n\n    if (!user) {\n      throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n        method: 'livechat:addMonitor'\n      });\n    }\n\n    if (addUserRoles(user._id, 'livechat-monitor')) {\n      return user;\n    }\n\n    return false;\n  },\n\n  removeMonitor(username) {\n    check(username, String);\n    const user = Users.findOneByUsername(username, {\n      fields: {\n        _id: 1\n      }\n    });\n\n    if (!user) {\n      throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n        method: 'livechat:removeMonitor'\n      });\n    }\n\n    if (removeUserFromRoles(user._id, 'livechat-monitor')) {\n      return true;\n    }\n\n    return false;\n  },\n\n  removeUnit(_id) {\n    check(_id, String);\n    const unit = LivechatUnit.findOneById(_id, {\n      fields: {\n        _id: 1\n      }\n    });\n\n    if (!unit) {\n      throw new Meteor.Error('unit-not-found', 'Unit not found', {\n        method: 'livechat:removeUnit'\n      });\n    }\n\n    return LivechatUnit.removeById(_id);\n  },\n\n  saveUnit(_id, unitData, unitMonitors, unitDepartments) {\n    check(_id, Match.Maybe(String));\n    check(unitData, {\n      name: String,\n      visibility: String,\n      enabled: Match.Optional(Boolean),\n      description: Match.Optional(String),\n      email: Match.Optional(String),\n      showOnOfflineForm: Match.Optional(Boolean)\n    });\n    check(unitMonitors, [Match.ObjectIncluding({\n      monitorId: String,\n      username: String\n    })]);\n    check(unitDepartments, [Match.ObjectIncluding({\n      departmentId: String\n    })]);\n    let ancestors = [];\n\n    if (_id) {\n      const unit = LivechatUnit.findOneById(_id);\n\n      if (!unit) {\n        throw new Meteor.Error('error-unit-not-found', 'Unit not found', {\n          method: 'livechat:saveUnit'\n        });\n      }\n\n      ancestors = unit.ancestors;\n    }\n\n    return LivechatUnit.createOrUpdateUnit(_id, unitData, ancestors, unitMonitors, unitDepartments);\n  },\n\n  removeTag(_id) {\n    check(_id, String);\n    const tag = LivechatTag.findOneById(_id, {\n      fields: {\n        _id: 1\n      }\n    });\n\n    if (!tag) {\n      throw new Meteor.Error('tag-not-found', 'Tag not found', {\n        method: 'livechat:removeTag'\n      });\n    }\n\n    return LivechatTag.removeById(_id);\n  },\n\n  saveTag(_id, tagData, tagDepartments) {\n    check(_id, Match.Maybe(String));\n    check(tagData, {\n      name: String,\n      description: Match.Optional(String)\n    });\n    check(tagDepartments, [String]);\n    return LivechatTag.createOrUpdateTag(_id, tagData, tagDepartments);\n  },\n\n  savePriority(_id, priorityData) {\n    check(_id, Match.Maybe(String));\n    check(priorityData, {\n      name: String,\n      description: Match.Optional(String),\n      dueTimeInMinutes: String\n    });\n\n    const oldPriority = _id && LivechatPriority.findOneById(_id, {\n      fields: {\n        dueTimeInMinutes: 1\n      }\n    });\n\n    const priority = LivechatPriority.createOrUpdatePriority(_id, priorityData);\n\n    if (!oldPriority) {\n      return priority;\n    }\n\n    const {\n      dueTimeInMinutes: oldDueTimeInMinutes\n    } = oldPriority;\n    const {\n      dueTimeInMinutes\n    } = priority;\n\n    if (oldDueTimeInMinutes !== dueTimeInMinutes) {\n      updatePriorityInquiries(priority);\n    }\n\n    return priority;\n  },\n\n  removePriority(_id) {\n    check(_id, String);\n    const priority = LivechatPriority.findOneById(_id, {\n      fields: {\n        _id: 1\n      }\n    });\n\n    if (!priority) {\n      throw new Meteor.Error('error-invalid-priority', 'Invalid priority', {\n        method: 'livechat:removePriority'\n      });\n    }\n\n    const removed = LivechatPriority.removeById(_id);\n\n    if (removed) {\n      removePriorityFromRooms(_id);\n    }\n\n    return removed;\n  },\n\n  updateRoomPriority(roomId, user, priority) {\n    updateInquiryQueuePriority(roomId, priority);\n    updateRoomPriorityHistory(roomId, user, priority);\n  },\n\n  placeRoomOnHold(room, comment, onHoldBy) {\n    logger.debug(\"Attempting to place room \".concat(room._id, \" on hold by user \").concat(onHoldBy === null || onHoldBy === void 0 ? void 0 : onHoldBy._id));\n    const {\n      _id: roomId,\n      onHold\n    } = room;\n\n    if (!roomId || onHold) {\n      logger.debug(\"Room \".concat(roomId, \" invalid or already on hold. Skipping\"));\n      return false;\n    }\n\n    LivechatRooms.setOnHold(roomId);\n    Subscriptions.setOnHold(roomId);\n    Messages.createOnHoldHistoryWithRoomIdMessageAndUser(roomId, comment, onHoldBy);\n    Meteor.defer(() => {\n      callbacks.run('livechat:afterOnHold', room);\n    });\n    logger.debug(\"Room \".concat(room._id, \" set on hold succesfully\"));\n    return true;\n  },\n\n  releaseOnHoldChat(room) {\n    return Promise.asyncApply(() => {\n      const {\n        _id: roomId,\n        onHold\n      } = room;\n\n      if (!roomId || !onHold) {\n        return;\n      }\n\n      Promise.await(AutoCloseOnHoldScheduler.unscheduleRoom(roomId));\n      LivechatRooms.unsetAllOnHoldFieldsByRoomId(roomId);\n      Subscriptions.unsetOnHold(roomId);\n    });\n  }\n\n};\nconst DEFAULT_RACE_TIMEOUT = 5000;\nlet queueDelayTimeout = DEFAULT_RACE_TIMEOUT;\nconst queueWorker = {\n  running: false,\n  queues: [],\n\n  start() {\n    return Promise.asyncApply(() => {\n      queueLogger.debug('Starting queue');\n\n      if (this.running) {\n        queueLogger.debug('Queue already running');\n        return;\n      }\n\n      const activeQueues = Promise.await(this.getActiveQueues());\n      queueLogger.debug(\"Active queues: \".concat(activeQueues.length));\n      Promise.await(OmnichannelQueue.initQueue());\n      this.running = true;\n      return this.execute();\n    });\n  },\n\n  stop() {\n    return Promise.asyncApply(() => {\n      queueLogger.debug('Stopping queue');\n      this.running = false;\n      return OmnichannelQueue.stopQueue();\n    });\n  },\n\n  getActiveQueues() {\n    return Promise.asyncApply(() => {\n      // undefined = public queue(without department)\n      return [undefined].concat(Promise.await(LivechatInquiry.getDistinctQueuedDepartments()));\n    });\n  },\n\n  nextQueue() {\n    return Promise.asyncApply(() => {\n      if (!this.queues.length) {\n        queueLogger.debug('No more registered queues. Refreshing');\n        this.queues = Promise.await(this.getActiveQueues());\n      }\n\n      return this.queues.shift();\n    });\n  },\n\n  execute() {\n    return Promise.asyncApply(() => {\n      if (!this.running) {\n        queueLogger.debug('Queue stopped. Cannot execute');\n        return;\n      }\n\n      const queue = Promise.await(this.nextQueue());\n      queueLogger.debug(\"Executing queue \".concat(queue || 'Public', \" with timeout of \").concat(queueDelayTimeout));\n      setTimeout(this.checkQueue.bind(this, queue), queueDelayTimeout);\n    });\n  },\n\n  checkQueue(queue) {\n    return Promise.asyncApply(() => {\n      queueLogger.debug(\"Processing items for queue \".concat(queue || 'Public'));\n\n      try {\n        if (Promise.await(OmnichannelQueue.lockQueue())) {\n          Promise.await(processWaitingQueue(queue));\n          queueLogger.debug(\"Queue \".concat(queue || 'Public', \" processed. Unlocking\"));\n          Promise.await(OmnichannelQueue.unlockQueue());\n        } else {\n          queueLogger.debug('Queue locked. Waiting');\n        }\n      } catch (e) {\n        queueLogger.error({\n          msg: \"Error processing queue \".concat(queue || 'public'),\n          err: e\n        });\n      } finally {\n        this.execute();\n      }\n    });\n  }\n\n};\nlet omnichannelIsEnabled = false;\n\nfunction shouldQueueStart() {\n  if (!omnichannelIsEnabled) {\n    queueWorker.stop();\n    return;\n  }\n\n  const routingSupportsAutoAssign = RoutingManager.getConfig().autoAssignAgent;\n  queueLogger.debug(\"Routing method \".concat(RoutingManager.methodName, \" supports auto assignment: \").concat(routingSupportsAutoAssign, \". \").concat(routingSupportsAutoAssign ? 'Starting' : 'Stopping', \" queue\"));\n  routingSupportsAutoAssign ? queueWorker.start() : queueWorker.stop();\n}\n\nRoutingManager.startQueue = shouldQueueStart;\nsettings.watch('Livechat_enabled', enabled => {\n  omnichannelIsEnabled = enabled;\n  omnichannelIsEnabled && RoutingManager.isMethodSet() ? shouldQueueStart() : queueWorker.stop();\n});\nsettings.watch('Omnichannel_queue_delay_timeout', timeout => {\n  queueDelayTimeout = timeout < 1 ? DEFAULT_RACE_TIMEOUT : timeout * 1000;\n});","map":{"version":3,"sources":["ee/app/livechat-enterprise/server/lib/LivechatEnterprise.js"],"names":["module","export","LivechatEnterprise","Meteor","link","v","Match","check","Users","LivechatInquiry","OmnichannelQueue","LivechatUnit","default","LivechatTag","LivechatRooms","Subscriptions","Messages","LivechatPriority","addUserRoles","removeUserFromRoles","processWaitingQueue","removePriorityFromRooms","updateInquiryQueuePriority","updatePriorityInquiries","updateRoomPriorityHistory","RoutingManager","settings","logger","queueLogger","callbacks","AutoCloseOnHoldScheduler","addMonitor","username","String","user","findOneByUsername","fields","_id","Error","method","removeMonitor","removeUnit","unit","findOneById","removeById","saveUnit","unitData","unitMonitors","unitDepartments","Maybe","name","visibility","enabled","Optional","Boolean","description","email","showOnOfflineForm","ObjectIncluding","monitorId","departmentId","ancestors","createOrUpdateUnit","removeTag","tag","saveTag","tagData","tagDepartments","createOrUpdateTag","savePriority","priorityData","dueTimeInMinutes","oldPriority","priority","createOrUpdatePriority","oldDueTimeInMinutes","removePriority","removed","updateRoomPriority","roomId","placeRoomOnHold","room","comment","onHoldBy","debug","onHold","setOnHold","createOnHoldHistoryWithRoomIdMessageAndUser","defer","run","releaseOnHoldChat","unscheduleRoom","unsetAllOnHoldFieldsByRoomId","unsetOnHold","DEFAULT_RACE_TIMEOUT","queueDelayTimeout","queueWorker","running","queues","start","activeQueues","getActiveQueues","length","initQueue","execute","stop","stopQueue","undefined","concat","getDistinctQueuedDepartments","nextQueue","shift","queue","setTimeout","checkQueue","bind","lockQueue","unlockQueue","e","error","msg","err","omnichannelIsEnabled","shouldQueueStart","routingSupportsAutoAssign","getConfig","autoAssignAgent","methodName","startQueue","watch","isMethodSet","timeout"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { Match, check } from 'meteor/check';\n\nimport { Users } from '../../../../../app/models';\nimport { LivechatInquiry, OmnichannelQueue } from '../../../../../app/models/server/raw';\nimport LivechatUnit from '../../../models/server/models/LivechatUnit';\nimport LivechatTag from '../../../models/server/models/LivechatTag';\nimport { LivechatRooms, Subscriptions, Messages } from '../../../../../app/models/server';\nimport LivechatPriority from '../../../models/server/models/LivechatPriority';\nimport { addUserRoles, removeUserFromRoles } from '../../../../../app/authorization/server';\nimport {\n\tprocessWaitingQueue,\n\tremovePriorityFromRooms,\n\tupdateInquiryQueuePriority,\n\tupdatePriorityInquiries,\n\tupdateRoomPriorityHistory,\n} from './Helper';\nimport { RoutingManager } from '../../../../../app/livechat/server/lib/RoutingManager';\nimport { settings } from '../../../../../app/settings/server';\nimport { logger, queueLogger } from './logger';\nimport { callbacks } from '../../../../../lib/callbacks';\nimport { AutoCloseOnHoldScheduler } from './AutoCloseOnHoldScheduler';\n\nexport const LivechatEnterprise = {\n\taddMonitor(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'livechat:addMonitor',\n\t\t\t});\n\t\t}\n\n\t\tif (addUserRoles(user._id, 'livechat-monitor')) {\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveMonitor(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = Users.findOneByUsername(username, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'livechat:removeMonitor',\n\t\t\t});\n\t\t}\n\n\t\tif (removeUserFromRoles(user._id, 'livechat-monitor')) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveUnit(_id) {\n\t\tcheck(_id, String);\n\n\t\tconst unit = LivechatUnit.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!unit) {\n\t\t\tthrow new Meteor.Error('unit-not-found', 'Unit not found', { method: 'livechat:removeUnit' });\n\t\t}\n\n\t\treturn LivechatUnit.removeById(_id);\n\t},\n\n\tsaveUnit(_id, unitData, unitMonitors, unitDepartments) {\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(unitData, {\n\t\t\tname: String,\n\t\t\tvisibility: String,\n\t\t\tenabled: Match.Optional(Boolean),\n\t\t\tdescription: Match.Optional(String),\n\t\t\temail: Match.Optional(String),\n\t\t\tshowOnOfflineForm: Match.Optional(Boolean),\n\t\t});\n\n\t\tcheck(unitMonitors, [\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tmonitorId: String,\n\t\t\t\tusername: String,\n\t\t\t}),\n\t\t]);\n\n\t\tcheck(unitDepartments, [\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tdepartmentId: String,\n\t\t\t}),\n\t\t]);\n\n\t\tlet ancestors = [];\n\t\tif (_id) {\n\t\t\tconst unit = LivechatUnit.findOneById(_id);\n\t\t\tif (!unit) {\n\t\t\t\tthrow new Meteor.Error('error-unit-not-found', 'Unit not found', {\n\t\t\t\t\tmethod: 'livechat:saveUnit',\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tancestors = unit.ancestors;\n\t\t}\n\n\t\treturn LivechatUnit.createOrUpdateUnit(_id, unitData, ancestors, unitMonitors, unitDepartments);\n\t},\n\n\tremoveTag(_id) {\n\t\tcheck(_id, String);\n\n\t\tconst tag = LivechatTag.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!tag) {\n\t\t\tthrow new Meteor.Error('tag-not-found', 'Tag not found', { method: 'livechat:removeTag' });\n\t\t}\n\n\t\treturn LivechatTag.removeById(_id);\n\t},\n\n\tsaveTag(_id, tagData, tagDepartments) {\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(tagData, {\n\t\t\tname: String,\n\t\t\tdescription: Match.Optional(String),\n\t\t});\n\n\t\tcheck(tagDepartments, [String]);\n\n\t\treturn LivechatTag.createOrUpdateTag(_id, tagData, tagDepartments);\n\t},\n\n\tsavePriority(_id, priorityData) {\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(priorityData, {\n\t\t\tname: String,\n\t\t\tdescription: Match.Optional(String),\n\t\t\tdueTimeInMinutes: String,\n\t\t});\n\n\t\tconst oldPriority = _id && LivechatPriority.findOneById(_id, { fields: { dueTimeInMinutes: 1 } });\n\t\tconst priority = LivechatPriority.createOrUpdatePriority(_id, priorityData);\n\t\tif (!oldPriority) {\n\t\t\treturn priority;\n\t\t}\n\n\t\tconst { dueTimeInMinutes: oldDueTimeInMinutes } = oldPriority;\n\t\tconst { dueTimeInMinutes } = priority;\n\n\t\tif (oldDueTimeInMinutes !== dueTimeInMinutes) {\n\t\t\tupdatePriorityInquiries(priority);\n\t\t}\n\n\t\treturn priority;\n\t},\n\n\tremovePriority(_id) {\n\t\tcheck(_id, String);\n\n\t\tconst priority = LivechatPriority.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!priority) {\n\t\t\tthrow new Meteor.Error('error-invalid-priority', 'Invalid priority', {\n\t\t\t\tmethod: 'livechat:removePriority',\n\t\t\t});\n\t\t}\n\t\tconst removed = LivechatPriority.removeById(_id);\n\t\tif (removed) {\n\t\t\tremovePriorityFromRooms(_id);\n\t\t}\n\t\treturn removed;\n\t},\n\n\tupdateRoomPriority(roomId, user, priority) {\n\t\tupdateInquiryQueuePriority(roomId, priority);\n\t\tupdateRoomPriorityHistory(roomId, user, priority);\n\t},\n\n\tplaceRoomOnHold(room, comment, onHoldBy) {\n\t\tlogger.debug(`Attempting to place room ${room._id} on hold by user ${onHoldBy?._id}`);\n\t\tconst { _id: roomId, onHold } = room;\n\t\tif (!roomId || onHold) {\n\t\t\tlogger.debug(`Room ${roomId} invalid or already on hold. Skipping`);\n\t\t\treturn false;\n\t\t}\n\t\tLivechatRooms.setOnHold(roomId);\n\t\tSubscriptions.setOnHold(roomId);\n\n\t\tMessages.createOnHoldHistoryWithRoomIdMessageAndUser(roomId, comment, onHoldBy);\n\t\tMeteor.defer(() => {\n\t\t\tcallbacks.run('livechat:afterOnHold', room);\n\t\t});\n\n\t\tlogger.debug(`Room ${room._id} set on hold succesfully`);\n\t\treturn true;\n\t},\n\n\tasync releaseOnHoldChat(room) {\n\t\tconst { _id: roomId, onHold } = room;\n\t\tif (!roomId || !onHold) {\n\t\t\treturn;\n\t\t}\n\n\t\tawait AutoCloseOnHoldScheduler.unscheduleRoom(roomId);\n\t\tLivechatRooms.unsetAllOnHoldFieldsByRoomId(roomId);\n\t\tSubscriptions.unsetOnHold(roomId);\n\t},\n};\n\nconst DEFAULT_RACE_TIMEOUT = 5000;\nlet queueDelayTimeout = DEFAULT_RACE_TIMEOUT;\n\nconst queueWorker = {\n\trunning: false,\n\tqueues: [],\n\tasync start() {\n\t\tqueueLogger.debug('Starting queue');\n\t\tif (this.running) {\n\t\t\tqueueLogger.debug('Queue already running');\n\t\t\treturn;\n\t\t}\n\n\t\tconst activeQueues = await this.getActiveQueues();\n\t\tqueueLogger.debug(`Active queues: ${activeQueues.length}`);\n\n\t\tawait OmnichannelQueue.initQueue();\n\t\tthis.running = true;\n\t\treturn this.execute();\n\t},\n\tasync stop() {\n\t\tqueueLogger.debug('Stopping queue');\n\t\tthis.running = false;\n\t\treturn OmnichannelQueue.stopQueue();\n\t},\n\tasync getActiveQueues() {\n\t\t// undefined = public queue(without department)\n\t\treturn [undefined].concat(await LivechatInquiry.getDistinctQueuedDepartments());\n\t},\n\tasync nextQueue() {\n\t\tif (!this.queues.length) {\n\t\t\tqueueLogger.debug('No more registered queues. Refreshing');\n\t\t\tthis.queues = await this.getActiveQueues();\n\t\t}\n\n\t\treturn this.queues.shift();\n\t},\n\tasync execute() {\n\t\tif (!this.running) {\n\t\t\tqueueLogger.debug('Queue stopped. Cannot execute');\n\t\t\treturn;\n\t\t}\n\n\t\tconst queue = await this.nextQueue();\n\t\tqueueLogger.debug(`Executing queue ${queue || 'Public'} with timeout of ${queueDelayTimeout}`);\n\n\t\tsetTimeout(this.checkQueue.bind(this, queue), queueDelayTimeout);\n\t},\n\n\tasync checkQueue(queue) {\n\t\tqueueLogger.debug(`Processing items for queue ${queue || 'Public'}`);\n\t\ttry {\n\t\t\tif (await OmnichannelQueue.lockQueue()) {\n\t\t\t\tawait processWaitingQueue(queue);\n\t\t\t\tqueueLogger.debug(`Queue ${queue || 'Public'} processed. Unlocking`);\n\t\t\t\tawait OmnichannelQueue.unlockQueue();\n\t\t\t} else {\n\t\t\t\tqueueLogger.debug('Queue locked. Waiting');\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tqueueLogger.error({\n\t\t\t\tmsg: `Error processing queue ${queue || 'public'}`,\n\t\t\t\terr: e,\n\t\t\t});\n\t\t} finally {\n\t\t\tthis.execute();\n\t\t}\n\t},\n};\n\nlet omnichannelIsEnabled = false;\nfunction shouldQueueStart() {\n\tif (!omnichannelIsEnabled) {\n\t\tqueueWorker.stop();\n\t\treturn;\n\t}\n\n\tconst routingSupportsAutoAssign = RoutingManager.getConfig().autoAssignAgent;\n\tqueueLogger.debug(\n\t\t`Routing method ${RoutingManager.methodName} supports auto assignment: ${routingSupportsAutoAssign}. ${\n\t\t\troutingSupportsAutoAssign ? 'Starting' : 'Stopping'\n\t\t} queue`,\n\t);\n\n\troutingSupportsAutoAssign ? queueWorker.start() : queueWorker.stop();\n}\n\nRoutingManager.startQueue = shouldQueueStart;\n\nsettings.watch('Livechat_enabled', (enabled) => {\n\tomnichannelIsEnabled = enabled;\n\tomnichannelIsEnabled && RoutingManager.isMethodSet() ? shouldQueueStart() : queueWorker.stop();\n});\n\nsettings.watch('Omnichannel_queue_delay_timeout', (timeout) => {\n\tqueueDelayTimeout = timeout < 1 ? DEFAULT_RACE_TIMEOUT : timeout * 1000;\n});\n"]},"sourceType":"module","hash":"8eabb3675f46c6ae8225377eeae36985e4cdc54a"}
