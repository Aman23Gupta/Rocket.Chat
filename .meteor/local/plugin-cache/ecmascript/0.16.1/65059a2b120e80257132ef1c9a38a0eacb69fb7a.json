{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/assets/server/assets.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/assets/server/assets.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/assets/server/assets.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/assets/server/assets.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/assets/server/assets.js"}},"code":"module.export({\n  RocketChatAssets: () => RocketChatAssets\n});\nlet crypto;\nmodule.link(\"crypto\", {\n  default(v) {\n    crypto = v;\n  }\n\n}, 0);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 1);\nlet WebApp, WebAppInternals;\nmodule.link(\"meteor/webapp\", {\n  WebApp(v) {\n    WebApp = v;\n  },\n\n  WebAppInternals(v) {\n    WebAppInternals = v;\n  }\n\n}, 2);\nlet WebAppHashing;\nmodule.link(\"meteor/webapp-hashing\", {\n  WebAppHashing(v) {\n    WebAppHashing = v;\n  }\n\n}, 3);\n\nlet _;\n\nmodule.link(\"underscore\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 4);\nlet sizeOf;\nmodule.link(\"image-size\", {\n  default(v) {\n    sizeOf = v;\n  }\n\n}, 5);\nlet sharp;\nmodule.link(\"sharp\", {\n  default(v) {\n    sharp = v;\n  }\n\n}, 6);\nlet settings, settingsRegistry;\nmodule.link(\"../../settings/server\", {\n  settings(v) {\n    settings = v;\n  },\n\n  settingsRegistry(v) {\n    settingsRegistry = v;\n  }\n\n}, 7);\nlet getURL;\nmodule.link(\"../../utils/lib/getURL\", {\n  getURL(v) {\n    getURL = v;\n  }\n\n}, 8);\nlet mime;\nmodule.link(\"../../utils/lib/mimeTypes\", {\n  mime(v) {\n    mime = v;\n  }\n\n}, 9);\nlet hasPermission;\nmodule.link(\"../../authorization\", {\n  hasPermission(v) {\n    hasPermission = v;\n  }\n\n}, 10);\nlet RocketChatFile;\nmodule.link(\"../../file\", {\n  RocketChatFile(v) {\n    RocketChatFile = v;\n  }\n\n}, 11);\nlet Settings;\nmodule.link(\"../../models/server\", {\n  Settings(v) {\n    Settings = v;\n  }\n\n}, 12);\nconst RocketChatAssetsInstance = new RocketChatFile.GridFS({\n  name: 'assets'\n});\nconst assets = {\n  logo: {\n    label: 'logo (svg, png, jpg)',\n    defaultUrl: 'images/logo/logo.svg',\n    constraints: {\n      type: 'image',\n      extensions: ['svg', 'png', 'jpg', 'jpeg']\n    },\n    wizard: {\n      step: 3,\n      order: 2\n    }\n  },\n  background: {\n    label: 'login background (svg, png, jpg)',\n    constraints: {\n      type: 'image',\n      extensions: ['svg', 'png', 'jpg', 'jpeg']\n    }\n  },\n  favicon_ico: {\n    label: 'favicon (ico)',\n    defaultUrl: 'favicon.ico',\n    constraints: {\n      type: 'image',\n      extensions: ['ico']\n    }\n  },\n  favicon: {\n    label: 'favicon (svg)',\n    defaultUrl: 'images/logo/icon.svg',\n    constraints: {\n      type: 'image',\n      extensions: ['svg']\n    }\n  },\n  favicon_16: {\n    label: 'favicon 16x16 (png)',\n    defaultUrl: 'images/logo/favicon-16x16.png',\n    constraints: {\n      type: 'image',\n      extensions: ['png'],\n      width: 16,\n      height: 16\n    }\n  },\n  favicon_32: {\n    label: 'favicon 32x32 (png)',\n    defaultUrl: 'images/logo/favicon-32x32.png',\n    constraints: {\n      type: 'image',\n      extensions: ['png'],\n      width: 32,\n      height: 32\n    }\n  },\n  favicon_192: {\n    label: 'android-chrome 192x192 (png)',\n    defaultUrl: 'images/logo/android-chrome-192x192.png',\n    constraints: {\n      type: 'image',\n      extensions: ['png'],\n      width: 192,\n      height: 192\n    }\n  },\n  favicon_512: {\n    label: 'android-chrome 512x512 (png)',\n    defaultUrl: 'images/logo/android-chrome-512x512.png',\n    constraints: {\n      type: 'image',\n      extensions: ['png'],\n      width: 512,\n      height: 512\n    }\n  },\n  touchicon_180: {\n    label: 'apple-touch-icon 180x180 (png)',\n    defaultUrl: 'images/logo/apple-touch-icon.png',\n    constraints: {\n      type: 'image',\n      extensions: ['png'],\n      width: 180,\n      height: 180\n    }\n  },\n  touchicon_180_pre: {\n    label: 'apple-touch-icon-precomposed 180x180 (png)',\n    defaultUrl: 'images/logo/apple-touch-icon-precomposed.png',\n    constraints: {\n      type: 'image',\n      extensions: ['png'],\n      width: 180,\n      height: 180\n    }\n  },\n  tile_70: {\n    label: 'mstile 70x70 (png)',\n    defaultUrl: 'images/logo/mstile-70x70.png',\n    constraints: {\n      type: 'image',\n      extensions: ['png'],\n      width: 70,\n      height: 70\n    }\n  },\n  tile_144: {\n    label: 'mstile 144x144 (png)',\n    defaultUrl: 'images/logo/mstile-144x144.png',\n    constraints: {\n      type: 'image',\n      extensions: ['png'],\n      width: 144,\n      height: 144\n    }\n  },\n  tile_150: {\n    label: 'mstile 150x150 (png)',\n    defaultUrl: 'images/logo/mstile-150x150.png',\n    constraints: {\n      type: 'image',\n      extensions: ['png'],\n      width: 150,\n      height: 150\n    }\n  },\n  tile_310_square: {\n    label: 'mstile 310x310 (png)',\n    defaultUrl: 'images/logo/mstile-310x310.png',\n    constraints: {\n      type: 'image',\n      extensions: ['png'],\n      width: 310,\n      height: 310\n    }\n  },\n  tile_310_wide: {\n    label: 'mstile 310x150 (png)',\n    defaultUrl: 'images/logo/mstile-310x150.png',\n    constraints: {\n      type: 'image',\n      extensions: ['png'],\n      width: 310,\n      height: 150\n    }\n  },\n  safari_pinned: {\n    label: 'safari pinned tab (svg)',\n    defaultUrl: 'images/logo/safari-pinned-tab.svg',\n    constraints: {\n      type: 'image',\n      extensions: ['svg']\n    }\n  }\n};\nconst RocketChatAssets = new class {\n  get mime() {\n    return mime;\n  }\n\n  get assets() {\n    return assets;\n  }\n\n  setAsset(binaryContent, contentType, asset) {\n    if (!assets[asset]) {\n      throw new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n        function: 'RocketChat.Assets.setAsset'\n      });\n    }\n\n    const extension = mime.extension(contentType);\n\n    if (assets[asset].constraints.extensions.includes(extension) === false) {\n      throw new Meteor.Error(contentType, \"Invalid file type: \".concat(contentType), {\n        function: 'RocketChat.Assets.setAsset',\n        errorTitle: 'error-invalid-file-type'\n      });\n    }\n\n    const file = Buffer.from(binaryContent, 'binary');\n\n    if (assets[asset].constraints.width || assets[asset].constraints.height) {\n      const dimensions = sizeOf(file);\n\n      if (assets[asset].constraints.width && assets[asset].constraints.width !== dimensions.width) {\n        throw new Meteor.Error('error-invalid-file-width', 'Invalid file width', {\n          function: 'Invalid file width'\n        });\n      }\n\n      if (assets[asset].constraints.height && assets[asset].constraints.height !== dimensions.height) {\n        throw new Meteor.Error('error-invalid-file-height');\n      }\n    }\n\n    const rs = RocketChatFile.bufferToStream(file);\n    RocketChatAssetsInstance.deleteFile(asset);\n    const ws = RocketChatAssetsInstance.createWriteStream(asset, contentType);\n    ws.on('end', Meteor.bindEnvironment(function () {\n      return Meteor.setTimeout(function () {\n        const key = \"Assets_\".concat(asset);\n        const value = {\n          url: \"assets/\".concat(asset, \".\").concat(extension),\n          defaultUrl: assets[asset].defaultUrl\n        };\n        Settings.updateValueById(key, value);\n        return RocketChatAssets.processAsset(key, value);\n      }, 200);\n    }));\n    rs.pipe(ws);\n  }\n\n  unsetAsset(asset) {\n    if (!assets[asset]) {\n      throw new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n        function: 'RocketChat.Assets.unsetAsset'\n      });\n    }\n\n    RocketChatAssetsInstance.deleteFile(asset);\n    const key = \"Assets_\".concat(asset);\n    const value = {\n      defaultUrl: assets[asset].defaultUrl\n    };\n    Settings.updateValueById(key, value);\n    RocketChatAssets.processAsset(key, value);\n  }\n\n  refreshClients() {\n    return process.emit('message', {\n      refresh: 'client'\n    });\n  }\n\n  processAsset(settingKey, settingValue) {\n    if (settingKey.indexOf('Assets_') !== 0) {\n      return;\n    }\n\n    const assetKey = settingKey.replace(/^Assets_/, '');\n    const assetValue = assets[assetKey];\n\n    if (!assetValue) {\n      return;\n    }\n\n    if (!settingValue || !settingValue.url) {\n      assetValue.cache = undefined;\n      return;\n    }\n\n    const file = RocketChatAssetsInstance.getFileSync(assetKey);\n\n    if (!file) {\n      assetValue.cache = undefined;\n      return;\n    }\n\n    const hash = crypto.createHash('sha1').update(file.buffer).digest('hex');\n    const extension = settingValue.url.split('.').pop();\n    assetValue.cache = {\n      path: \"assets/\".concat(assetKey, \".\").concat(extension),\n      cacheable: false,\n      sourceMapUrl: undefined,\n      where: 'client',\n      type: 'asset',\n      content: file.buffer,\n      extension,\n      url: \"/assets/\".concat(assetKey, \".\").concat(extension, \"?\").concat(hash),\n      size: file.length,\n      uploadDate: file.uploadDate,\n      contentType: file.contentType,\n      hash\n    };\n    return assetValue.cache;\n  }\n\n  getURL(assetName) {\n    let options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {\n      cdn: false,\n      full: true\n    };\n    const asset = settings.get(assetName);\n    const url = asset.url || asset.defaultUrl;\n    return getURL(url, options);\n  }\n\n}();\nsettingsRegistry.addGroup('Assets');\nsettingsRegistry.add('Assets_SvgFavicon_Enable', true, {\n  type: 'boolean',\n  group: 'Assets',\n  i18nLabel: 'Enable_Svg_Favicon'\n});\n\nfunction addAssetToSetting(asset, value) {\n  const key = \"Assets_\".concat(asset);\n  settingsRegistry.add(key, {\n    defaultUrl: value.defaultUrl\n  }, {\n    type: 'asset',\n    group: 'Assets',\n    fileConstraints: value.constraints,\n    i18nLabel: value.label,\n    asset,\n    public: true,\n    wizard: value.wizard\n  });\n  const currentValue = settings.get(key);\n\n  if (typeof currentValue === 'object' && currentValue.defaultUrl !== assets[asset].defaultUrl) {\n    currentValue.defaultUrl = assets[asset].defaultUrl;\n    Settings.updateValueById(key, currentValue);\n  }\n}\n\nfor (const key of Object.keys(assets)) {\n  const value = assets[key];\n  addAssetToSetting(key, value);\n}\n\nsettings.watchByRegex(/^Assets_/, (key, value) => RocketChatAssets.processAsset(key, value));\nMeteor.startup(function () {\n  return Meteor.setTimeout(function () {\n    return process.emit('message', {\n      refresh: 'client'\n    });\n  }, 200);\n});\nconst {\n  calculateClientHash\n} = WebAppHashing;\n\nWebAppHashing.calculateClientHash = function (manifest, includeFilter, runtimeConfigOverride) {\n  for (const key of Object.keys(assets)) {\n    const value = assets[key];\n\n    if (!value.cache && !value.defaultUrl) {\n      continue;\n    }\n\n    let cache = {};\n\n    if (value.cache) {\n      cache = {\n        path: value.cache.path,\n        cacheable: value.cache.cacheable,\n        sourceMapUrl: value.cache.sourceMapUrl,\n        where: value.cache.where,\n        type: value.cache.type,\n        url: value.cache.url,\n        size: value.cache.size,\n        hash: value.cache.hash\n      };\n    } else {\n      const extension = value.defaultUrl.split('.').pop();\n      cache = {\n        path: \"assets/\".concat(key, \".\").concat(extension),\n        cacheable: false,\n        sourceMapUrl: undefined,\n        where: 'client',\n        type: 'asset',\n        url: \"/assets/\".concat(key, \".\").concat(extension, \"?v3\"),\n        hash: 'v3'\n      };\n    }\n\n    const manifestItem = _.findWhere(manifest, {\n      path: key\n    });\n\n    if (manifestItem) {\n      const index = manifest.indexOf(manifestItem);\n      manifest[index] = cache;\n    } else {\n      manifest.push(cache);\n    }\n  }\n\n  return calculateClientHash.call(this, manifest, includeFilter, runtimeConfigOverride);\n};\n\nMeteor.methods({\n  refreshClients() {\n    if (!Meteor.userId()) {\n      throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n        method: 'refreshClients'\n      });\n    }\n\n    const _hasPermission = hasPermission(Meteor.userId(), 'manage-assets');\n\n    if (!_hasPermission) {\n      throw new Meteor.Error('error-action-not-allowed', 'Managing assets not allowed', {\n        method: 'refreshClients',\n        action: 'Managing_assets'\n      });\n    }\n\n    return RocketChatAssets.refreshClients();\n  },\n\n  unsetAsset(asset) {\n    if (!Meteor.userId()) {\n      throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n        method: 'unsetAsset'\n      });\n    }\n\n    const _hasPermission = hasPermission(Meteor.userId(), 'manage-assets');\n\n    if (!_hasPermission) {\n      throw new Meteor.Error('error-action-not-allowed', 'Managing assets not allowed', {\n        method: 'unsetAsset',\n        action: 'Managing_assets'\n      });\n    }\n\n    return RocketChatAssets.unsetAsset(asset);\n  },\n\n  setAsset(binaryContent, contentType, asset) {\n    if (!Meteor.userId()) {\n      throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n        method: 'setAsset'\n      });\n    }\n\n    const _hasPermission = hasPermission(Meteor.userId(), 'manage-assets');\n\n    if (!_hasPermission) {\n      throw new Meteor.Error('error-action-not-allowed', 'Managing assets not allowed', {\n        method: 'setAsset',\n        action: 'Managing_assets'\n      });\n    }\n\n    RocketChatAssets.setAsset(binaryContent, contentType, asset);\n  }\n\n});\nWebApp.connectHandlers.use('/assets/', Meteor.bindEnvironment(function (req, res, next) {\n  const params = {\n    asset: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, '')).replace(/\\.[^.]*$/, '')\n  };\n  const file = assets[params.asset] && assets[params.asset].cache;\n  const format = req.url.replace(/.*\\.([a-z]+)(?:$|\\?.*)/i, '$1');\n\n  if (assets[params.asset] && Array.isArray(assets[params.asset].constraints.extensions) && !assets[params.asset].constraints.extensions.includes(format)) {\n    res.writeHead(403);\n    return res.end();\n  }\n\n  if (!file) {\n    const defaultUrl = assets[params.asset] && assets[params.asset].defaultUrl;\n\n    if (defaultUrl) {\n      const assetUrl = format && ['png', 'svg'].includes(format) ? defaultUrl.replace(/(svg|png)$/, format) : defaultUrl;\n      req.url = \"/\".concat(assetUrl);\n      WebAppInternals.staticFilesMiddleware(WebAppInternals.staticFilesByArch, req, res, next);\n    } else {\n      res.writeHead(404);\n      res.end();\n    }\n\n    return;\n  }\n\n  const reqModifiedHeader = req.headers['if-modified-since'];\n\n  if (reqModifiedHeader) {\n    if (reqModifiedHeader === (file.uploadDate && file.uploadDate.toUTCString())) {\n      res.setHeader('Last-Modified', reqModifiedHeader);\n      res.writeHead(304);\n      res.end();\n      return;\n    }\n  }\n\n  res.setHeader('Cache-Control', 'public, max-age=0');\n  res.setHeader('Expires', '-1');\n\n  if (format && format !== file.extension && ['png', 'jpg', 'jpeg'].includes(format)) {\n    res.setHeader('Content-Type', \"image/\".concat(format));\n    sharp(file.content).toFormat(format).pipe(res);\n    return;\n  }\n\n  res.setHeader('Last-Modified', file.uploadDate && file.uploadDate.toUTCString() || new Date().toUTCString());\n  res.setHeader('Content-Type', file.contentType);\n  res.setHeader('Content-Length', file.size);\n  res.writeHead(200);\n  res.end(file.content);\n}));","map":{"version":3,"sources":["app/assets/server/assets.js"],"names":["module","export","RocketChatAssets","crypto","link","default","v","Meteor","WebApp","WebAppInternals","WebAppHashing","_","sizeOf","sharp","settings","settingsRegistry","getURL","mime","hasPermission","RocketChatFile","Settings","RocketChatAssetsInstance","GridFS","name","assets","logo","label","defaultUrl","constraints","type","extensions","wizard","step","order","background","favicon_ico","favicon","favicon_16","width","height","favicon_32","favicon_192","favicon_512","touchicon_180","touchicon_180_pre","tile_70","tile_144","tile_150","tile_310_square","tile_310_wide","safari_pinned","setAsset","binaryContent","contentType","asset","Error","function","extension","includes","errorTitle","file","Buffer","from","dimensions","rs","bufferToStream","deleteFile","ws","createWriteStream","on","bindEnvironment","setTimeout","key","value","url","updateValueById","processAsset","pipe","unsetAsset","refreshClients","process","emit","refresh","settingKey","settingValue","indexOf","assetKey","replace","assetValue","cache","undefined","getFileSync","hash","createHash","update","buffer","digest","split","pop","path","cacheable","sourceMapUrl","where","content","size","length","uploadDate","assetName","options","cdn","full","get","addGroup","add","group","i18nLabel","addAssetToSetting","fileConstraints","public","currentValue","Object","keys","watchByRegex","startup","calculateClientHash","manifest","includeFilter","runtimeConfigOverride","manifestItem","findWhere","index","push","call","methods","userId","method","_hasPermission","action","connectHandlers","use","req","res","next","params","decodeURIComponent","format","Array","isArray","writeHead","end","assetUrl","staticFilesMiddleware","staticFilesByArch","reqModifiedHeader","headers","toUTCString","setHeader","toFormat","Date"],"mappings":"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","sourcesContent":["import crypto from 'crypto';\n\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp, WebAppInternals } from 'meteor/webapp';\nimport { WebAppHashing } from 'meteor/webapp-hashing';\nimport _ from 'underscore';\nimport sizeOf from 'image-size';\nimport sharp from 'sharp';\n\nimport { settings, settingsRegistry } from '../../settings/server';\nimport { getURL } from '../../utils/lib/getURL';\nimport { mime } from '../../utils/lib/mimeTypes';\nimport { hasPermission } from '../../authorization';\nimport { RocketChatFile } from '../../file';\nimport { Settings } from '../../models/server';\n\nconst RocketChatAssetsInstance = new RocketChatFile.GridFS({\n\tname: 'assets',\n});\n\nconst assets = {\n\tlogo: {\n\t\tlabel: 'logo (svg, png, jpg)',\n\t\tdefaultUrl: 'images/logo/logo.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t},\n\t\twizard: {\n\t\t\tstep: 3,\n\t\t\torder: 2,\n\t\t},\n\t},\n\tbackground: {\n\t\tlabel: 'login background (svg, png, jpg)',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg'],\n\t\t},\n\t},\n\tfavicon_ico: {\n\t\tlabel: 'favicon (ico)',\n\t\tdefaultUrl: 'favicon.ico',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['ico'],\n\t\t},\n\t},\n\tfavicon: {\n\t\tlabel: 'favicon (svg)',\n\t\tdefaultUrl: 'images/logo/icon.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg'],\n\t\t},\n\t},\n\tfavicon_16: {\n\t\tlabel: 'favicon 16x16 (png)',\n\t\tdefaultUrl: 'images/logo/favicon-16x16.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 16,\n\t\t\theight: 16,\n\t\t},\n\t},\n\tfavicon_32: {\n\t\tlabel: 'favicon 32x32 (png)',\n\t\tdefaultUrl: 'images/logo/favicon-32x32.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 32,\n\t\t\theight: 32,\n\t\t},\n\t},\n\tfavicon_192: {\n\t\tlabel: 'android-chrome 192x192 (png)',\n\t\tdefaultUrl: 'images/logo/android-chrome-192x192.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 192,\n\t\t\theight: 192,\n\t\t},\n\t},\n\tfavicon_512: {\n\t\tlabel: 'android-chrome 512x512 (png)',\n\t\tdefaultUrl: 'images/logo/android-chrome-512x512.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 512,\n\t\t\theight: 512,\n\t\t},\n\t},\n\ttouchicon_180: {\n\t\tlabel: 'apple-touch-icon 180x180 (png)',\n\t\tdefaultUrl: 'images/logo/apple-touch-icon.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 180,\n\t\t\theight: 180,\n\t\t},\n\t},\n\ttouchicon_180_pre: {\n\t\tlabel: 'apple-touch-icon-precomposed 180x180 (png)',\n\t\tdefaultUrl: 'images/logo/apple-touch-icon-precomposed.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 180,\n\t\t\theight: 180,\n\t\t},\n\t},\n\ttile_70: {\n\t\tlabel: 'mstile 70x70 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-70x70.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 70,\n\t\t\theight: 70,\n\t\t},\n\t},\n\ttile_144: {\n\t\tlabel: 'mstile 144x144 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-144x144.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 144,\n\t\t\theight: 144,\n\t\t},\n\t},\n\ttile_150: {\n\t\tlabel: 'mstile 150x150 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-150x150.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 150,\n\t\t\theight: 150,\n\t\t},\n\t},\n\ttile_310_square: {\n\t\tlabel: 'mstile 310x310 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-310x310.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 310,\n\t\t\theight: 310,\n\t\t},\n\t},\n\ttile_310_wide: {\n\t\tlabel: 'mstile 310x150 (png)',\n\t\tdefaultUrl: 'images/logo/mstile-310x150.png',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['png'],\n\t\t\twidth: 310,\n\t\t\theight: 150,\n\t\t},\n\t},\n\tsafari_pinned: {\n\t\tlabel: 'safari pinned tab (svg)',\n\t\tdefaultUrl: 'images/logo/safari-pinned-tab.svg',\n\t\tconstraints: {\n\t\t\ttype: 'image',\n\t\t\textensions: ['svg'],\n\t\t},\n\t},\n};\n\nexport const RocketChatAssets = new (class {\n\tget mime() {\n\t\treturn mime;\n\t}\n\n\tget assets() {\n\t\treturn assets;\n\t}\n\n\tsetAsset(binaryContent, contentType, asset) {\n\t\tif (!assets[asset]) {\n\t\t\tthrow new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n\t\t\t\tfunction: 'RocketChat.Assets.setAsset',\n\t\t\t});\n\t\t}\n\n\t\tconst extension = mime.extension(contentType);\n\t\tif (assets[asset].constraints.extensions.includes(extension) === false) {\n\t\t\tthrow new Meteor.Error(contentType, `Invalid file type: ${contentType}`, {\n\t\t\t\tfunction: 'RocketChat.Assets.setAsset',\n\t\t\t\terrorTitle: 'error-invalid-file-type',\n\t\t\t});\n\t\t}\n\n\t\tconst file = Buffer.from(binaryContent, 'binary');\n\t\tif (assets[asset].constraints.width || assets[asset].constraints.height) {\n\t\t\tconst dimensions = sizeOf(file);\n\t\t\tif (assets[asset].constraints.width && assets[asset].constraints.width !== dimensions.width) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-file-width', 'Invalid file width', {\n\t\t\t\t\tfunction: 'Invalid file width',\n\t\t\t\t});\n\t\t\t}\n\t\t\tif (assets[asset].constraints.height && assets[asset].constraints.height !== dimensions.height) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-file-height');\n\t\t\t}\n\t\t}\n\n\t\tconst rs = RocketChatFile.bufferToStream(file);\n\t\tRocketChatAssetsInstance.deleteFile(asset);\n\n\t\tconst ws = RocketChatAssetsInstance.createWriteStream(asset, contentType);\n\t\tws.on(\n\t\t\t'end',\n\t\t\tMeteor.bindEnvironment(function () {\n\t\t\t\treturn Meteor.setTimeout(function () {\n\t\t\t\t\tconst key = `Assets_${asset}`;\n\t\t\t\t\tconst value = {\n\t\t\t\t\t\turl: `assets/${asset}.${extension}`,\n\t\t\t\t\t\tdefaultUrl: assets[asset].defaultUrl,\n\t\t\t\t\t};\n\n\t\t\t\t\tSettings.updateValueById(key, value);\n\t\t\t\t\treturn RocketChatAssets.processAsset(key, value);\n\t\t\t\t}, 200);\n\t\t\t}),\n\t\t);\n\n\t\trs.pipe(ws);\n\t}\n\n\tunsetAsset(asset) {\n\t\tif (!assets[asset]) {\n\t\t\tthrow new Meteor.Error('error-invalid-asset', 'Invalid asset', {\n\t\t\t\tfunction: 'RocketChat.Assets.unsetAsset',\n\t\t\t});\n\t\t}\n\n\t\tRocketChatAssetsInstance.deleteFile(asset);\n\t\tconst key = `Assets_${asset}`;\n\t\tconst value = {\n\t\t\tdefaultUrl: assets[asset].defaultUrl,\n\t\t};\n\n\t\tSettings.updateValueById(key, value);\n\t\tRocketChatAssets.processAsset(key, value);\n\t}\n\n\trefreshClients() {\n\t\treturn process.emit('message', {\n\t\t\trefresh: 'client',\n\t\t});\n\t}\n\n\tprocessAsset(settingKey, settingValue) {\n\t\tif (settingKey.indexOf('Assets_') !== 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst assetKey = settingKey.replace(/^Assets_/, '');\n\t\tconst assetValue = assets[assetKey];\n\n\t\tif (!assetValue) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!settingValue || !settingValue.url) {\n\t\t\tassetValue.cache = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tconst file = RocketChatAssetsInstance.getFileSync(assetKey);\n\t\tif (!file) {\n\t\t\tassetValue.cache = undefined;\n\t\t\treturn;\n\t\t}\n\n\t\tconst hash = crypto.createHash('sha1').update(file.buffer).digest('hex');\n\t\tconst extension = settingValue.url.split('.').pop();\n\n\t\tassetValue.cache = {\n\t\t\tpath: `assets/${assetKey}.${extension}`,\n\t\t\tcacheable: false,\n\t\t\tsourceMapUrl: undefined,\n\t\t\twhere: 'client',\n\t\t\ttype: 'asset',\n\t\t\tcontent: file.buffer,\n\t\t\textension,\n\t\t\turl: `/assets/${assetKey}.${extension}?${hash}`,\n\t\t\tsize: file.length,\n\t\t\tuploadDate: file.uploadDate,\n\t\t\tcontentType: file.contentType,\n\t\t\thash,\n\t\t};\n\n\t\treturn assetValue.cache;\n\t}\n\n\tgetURL(assetName, options = { cdn: false, full: true }) {\n\t\tconst asset = settings.get(assetName);\n\t\tconst url = asset.url || asset.defaultUrl;\n\n\t\treturn getURL(url, options);\n\t}\n})();\n\nsettingsRegistry.addGroup('Assets');\n\nsettingsRegistry.add('Assets_SvgFavicon_Enable', true, {\n\ttype: 'boolean',\n\tgroup: 'Assets',\n\ti18nLabel: 'Enable_Svg_Favicon',\n});\n\nfunction addAssetToSetting(asset, value) {\n\tconst key = `Assets_${asset}`;\n\n\tsettingsRegistry.add(\n\t\tkey,\n\t\t{\n\t\t\tdefaultUrl: value.defaultUrl,\n\t\t},\n\t\t{\n\t\t\ttype: 'asset',\n\t\t\tgroup: 'Assets',\n\t\t\tfileConstraints: value.constraints,\n\t\t\ti18nLabel: value.label,\n\t\t\tasset,\n\t\t\tpublic: true,\n\t\t\twizard: value.wizard,\n\t\t},\n\t);\n\n\tconst currentValue = settings.get(key);\n\n\tif (typeof currentValue === 'object' && currentValue.defaultUrl !== assets[asset].defaultUrl) {\n\t\tcurrentValue.defaultUrl = assets[asset].defaultUrl;\n\t\tSettings.updateValueById(key, currentValue);\n\t}\n}\n\nfor (const key of Object.keys(assets)) {\n\tconst value = assets[key];\n\taddAssetToSetting(key, value);\n}\n\nsettings.watchByRegex(/^Assets_/, (key, value) => RocketChatAssets.processAsset(key, value));\n\nMeteor.startup(function () {\n\treturn Meteor.setTimeout(function () {\n\t\treturn process.emit('message', {\n\t\t\trefresh: 'client',\n\t\t});\n\t}, 200);\n});\n\nconst { calculateClientHash } = WebAppHashing;\n\nWebAppHashing.calculateClientHash = function (manifest, includeFilter, runtimeConfigOverride) {\n\tfor (const key of Object.keys(assets)) {\n\t\tconst value = assets[key];\n\t\tif (!value.cache && !value.defaultUrl) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tlet cache = {};\n\t\tif (value.cache) {\n\t\t\tcache = {\n\t\t\t\tpath: value.cache.path,\n\t\t\t\tcacheable: value.cache.cacheable,\n\t\t\t\tsourceMapUrl: value.cache.sourceMapUrl,\n\t\t\t\twhere: value.cache.where,\n\t\t\t\ttype: value.cache.type,\n\t\t\t\turl: value.cache.url,\n\t\t\t\tsize: value.cache.size,\n\t\t\t\thash: value.cache.hash,\n\t\t\t};\n\t\t} else {\n\t\t\tconst extension = value.defaultUrl.split('.').pop();\n\t\t\tcache = {\n\t\t\t\tpath: `assets/${key}.${extension}`,\n\t\t\t\tcacheable: false,\n\t\t\t\tsourceMapUrl: undefined,\n\t\t\t\twhere: 'client',\n\t\t\t\ttype: 'asset',\n\t\t\t\turl: `/assets/${key}.${extension}?v3`,\n\t\t\t\thash: 'v3',\n\t\t\t};\n\t\t}\n\n\t\tconst manifestItem = _.findWhere(manifest, {\n\t\t\tpath: key,\n\t\t});\n\n\t\tif (manifestItem) {\n\t\t\tconst index = manifest.indexOf(manifestItem);\n\t\t\tmanifest[index] = cache;\n\t\t} else {\n\t\t\tmanifest.push(cache);\n\t\t}\n\t}\n\n\treturn calculateClientHash.call(this, manifest, includeFilter, runtimeConfigOverride);\n};\n\nMeteor.methods({\n\trefreshClients() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'refreshClients',\n\t\t\t});\n\t\t}\n\n\t\tconst _hasPermission = hasPermission(Meteor.userId(), 'manage-assets');\n\t\tif (!_hasPermission) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Managing assets not allowed', {\n\t\t\t\tmethod: 'refreshClients',\n\t\t\t\taction: 'Managing_assets',\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChatAssets.refreshClients();\n\t},\n\n\tunsetAsset(asset) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'unsetAsset',\n\t\t\t});\n\t\t}\n\n\t\tconst _hasPermission = hasPermission(Meteor.userId(), 'manage-assets');\n\t\tif (!_hasPermission) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Managing assets not allowed', {\n\t\t\t\tmethod: 'unsetAsset',\n\t\t\t\taction: 'Managing_assets',\n\t\t\t});\n\t\t}\n\n\t\treturn RocketChatAssets.unsetAsset(asset);\n\t},\n\n\tsetAsset(binaryContent, contentType, asset) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'setAsset',\n\t\t\t});\n\t\t}\n\n\t\tconst _hasPermission = hasPermission(Meteor.userId(), 'manage-assets');\n\t\tif (!_hasPermission) {\n\t\t\tthrow new Meteor.Error('error-action-not-allowed', 'Managing assets not allowed', {\n\t\t\t\tmethod: 'setAsset',\n\t\t\t\taction: 'Managing_assets',\n\t\t\t});\n\t\t}\n\n\t\tRocketChatAssets.setAsset(binaryContent, contentType, asset);\n\t},\n});\n\nWebApp.connectHandlers.use(\n\t'/assets/',\n\tMeteor.bindEnvironment(function (req, res, next) {\n\t\tconst params = {\n\t\t\tasset: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, '')).replace(/\\.[^.]*$/, ''),\n\t\t};\n\n\t\tconst file = assets[params.asset] && assets[params.asset].cache;\n\n\t\tconst format = req.url.replace(/.*\\.([a-z]+)(?:$|\\?.*)/i, '$1');\n\n\t\tif (\n\t\t\tassets[params.asset] &&\n\t\t\tArray.isArray(assets[params.asset].constraints.extensions) &&\n\t\t\t!assets[params.asset].constraints.extensions.includes(format)\n\t\t) {\n\t\t\tres.writeHead(403);\n\t\t\treturn res.end();\n\t\t}\n\t\tif (!file) {\n\t\t\tconst defaultUrl = assets[params.asset] && assets[params.asset].defaultUrl;\n\t\t\tif (defaultUrl) {\n\t\t\t\tconst assetUrl = format && ['png', 'svg'].includes(format) ? defaultUrl.replace(/(svg|png)$/, format) : defaultUrl;\n\t\t\t\treq.url = `/${assetUrl}`;\n\t\t\t\tWebAppInternals.staticFilesMiddleware(WebAppInternals.staticFilesByArch, req, res, next);\n\t\t\t} else {\n\t\t\t\tres.writeHead(404);\n\t\t\t\tres.end();\n\t\t\t}\n\n\t\t\treturn;\n\t\t}\n\n\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\tif (reqModifiedHeader) {\n\t\t\tif (reqModifiedHeader === (file.uploadDate && file.uploadDate.toUTCString())) {\n\t\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\t\tres.writeHead(304);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tres.setHeader('Cache-Control', 'public, max-age=0');\n\t\tres.setHeader('Expires', '-1');\n\n\t\tif (format && format !== file.extension && ['png', 'jpg', 'jpeg'].includes(format)) {\n\t\t\tres.setHeader('Content-Type', `image/${format}`);\n\t\t\tsharp(file.content).toFormat(format).pipe(res);\n\t\t\treturn;\n\t\t}\n\n\t\tres.setHeader('Last-Modified', (file.uploadDate && file.uploadDate.toUTCString()) || new Date().toUTCString());\n\t\tres.setHeader('Content-Type', file.contentType);\n\t\tres.setHeader('Content-Length', file.size);\n\t\tres.writeHead(200);\n\t\tres.end(file.content);\n\t}),\n);\n"]},"sourceType":"module","hash":"65059a2b120e80257132ef1c9a38a0eacb69fb7a"}
