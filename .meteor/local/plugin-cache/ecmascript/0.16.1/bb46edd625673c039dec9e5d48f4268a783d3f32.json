{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/server/configuration/accounts_meld.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/configuration/accounts_meld.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/server/configuration/accounts_meld.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/server/configuration/accounts_meld.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/configuration/accounts_meld.js"}},"code":"let _;\n\nmodule.link(\"underscore\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 0);\nlet Accounts;\nmodule.link(\"meteor/accounts-base\", {\n  Accounts(v) {\n    Accounts = v;\n  }\n\n}, 1);\nlet Users;\nmodule.link(\"../../app/models\", {\n  Users(v) {\n    Users = v;\n  }\n\n}, 2);\nconst orig_updateOrCreateUserFromExternalService = Accounts.updateOrCreateUserFromExternalService;\n\nAccounts.updateOrCreateUserFromExternalService = function (serviceName) {\n  let serviceData = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n  const services = ['facebook', 'github', 'gitlab', 'google', 'meteor-developer', 'linkedin', 'twitter', 'apple'];\n\n  for (var _len = arguments.length, args = new Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {\n    args[_key - 2] = arguments[_key];\n  }\n\n  if (services.includes(serviceName) === false && serviceData._OAuthCustom !== true) {\n    return orig_updateOrCreateUserFromExternalService.apply(this, [serviceName, serviceData, ...args]);\n  }\n\n  if (serviceName === 'meteor-developer') {\n    if (Array.isArray(serviceData.emails)) {\n      const primaryEmail = serviceData.emails.sort(a => a.primary !== true).filter(item => item.verified === true)[0];\n      serviceData.email = primaryEmail && primaryEmail.address;\n    }\n  }\n\n  if (serviceName === 'linkedin') {\n    serviceData.email = serviceData.emailAddress;\n  }\n\n  if (serviceData.email) {\n    const user = Users.findOneByEmailAddress(serviceData.email);\n\n    if (user != null) {\n      var _user$services;\n\n      const findQuery = {\n        address: serviceData.email,\n        verified: true\n      };\n\n      if ((_user$services = user.services) !== null && _user$services !== void 0 && _user$services.password && !_.findWhere(user.emails, findQuery)) {\n        Users.resetPasswordAndSetRequirePasswordChange(user._id, true, 'This_email_has_already_been_used_and_has_not_been_verified__Please_change_your_password');\n      }\n\n      Users.setServiceId(user._id, serviceName, serviceData.id);\n      Users.setEmailVerified(user._id, serviceData.email);\n    }\n  }\n\n  return orig_updateOrCreateUserFromExternalService.apply(this, [serviceName, serviceData, ...args]);\n};","map":{"version":3,"sources":["server/configuration/accounts_meld.js"],"names":["_","module","link","default","v","Accounts","Users","orig_updateOrCreateUserFromExternalService","updateOrCreateUserFromExternalService","serviceName","serviceData","services","args","includes","_OAuthCustom","apply","Array","isArray","emails","primaryEmail","sort","a","primary","filter","item","verified","email","address","emailAddress","user","findOneByEmailAddress","findQuery","password","findWhere","resetPasswordAndSetRequirePasswordChange","_id","setServiceId","id","setEmailVerified"],"mappings":"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","sourcesContent":["import _ from 'underscore';\nimport { Accounts } from 'meteor/accounts-base';\n\nimport { Users } from '../../app/models';\n\nconst orig_updateOrCreateUserFromExternalService = Accounts.updateOrCreateUserFromExternalService;\n\nAccounts.updateOrCreateUserFromExternalService = function (serviceName, serviceData = {}, ...args /* , options*/) {\n\tconst services = ['facebook', 'github', 'gitlab', 'google', 'meteor-developer', 'linkedin', 'twitter', 'apple'];\n\n\tif (services.includes(serviceName) === false && serviceData._OAuthCustom !== true) {\n\t\treturn orig_updateOrCreateUserFromExternalService.apply(this, [serviceName, serviceData, ...args]);\n\t}\n\n\tif (serviceName === 'meteor-developer') {\n\t\tif (Array.isArray(serviceData.emails)) {\n\t\t\tconst primaryEmail = serviceData.emails.sort((a) => a.primary !== true).filter((item) => item.verified === true)[0];\n\t\t\tserviceData.email = primaryEmail && primaryEmail.address;\n\t\t}\n\t}\n\n\tif (serviceName === 'linkedin') {\n\t\tserviceData.email = serviceData.emailAddress;\n\t}\n\n\tif (serviceData.email) {\n\t\tconst user = Users.findOneByEmailAddress(serviceData.email);\n\t\tif (user != null) {\n\t\t\tconst findQuery = {\n\t\t\t\taddress: serviceData.email,\n\t\t\t\tverified: true,\n\t\t\t};\n\n\t\t\tif (user.services?.password && !_.findWhere(user.emails, findQuery)) {\n\t\t\t\tUsers.resetPasswordAndSetRequirePasswordChange(\n\t\t\t\t\tuser._id,\n\t\t\t\t\ttrue,\n\t\t\t\t\t'This_email_has_already_been_used_and_has_not_been_verified__Please_change_your_password',\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tUsers.setServiceId(user._id, serviceName, serviceData.id);\n\t\t\tUsers.setEmailVerified(user._id, serviceData.email);\n\t\t}\n\t}\n\n\treturn orig_updateOrCreateUserFromExternalService.apply(this, [serviceName, serviceData, ...args]);\n};\n"]},"sourceType":"module","hash":"bb46edd625673c039dec9e5d48f4268a783d3f32"}
