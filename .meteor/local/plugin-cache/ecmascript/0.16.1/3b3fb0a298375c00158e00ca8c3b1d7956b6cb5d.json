{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/client/views/room/contextualBar/Call/Jitsi/CallJitsiWithData.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"client/views/room/contextualBar/Call/Jitsi/CallJitsiWithData.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/client/views/room/contextualBar/Call/Jitsi/CallJitsiWithData.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/client/views/room/contextualBar/Call/Jitsi/CallJitsiWithData.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"client/views/room/contextualBar/Call/Jitsi/CallJitsiWithData.js"}},"code":"let Skeleton;\nmodule.link(\"@rocket.chat/fuselage\", {\n  Skeleton(v) {\n    Skeleton = v;\n  }\n\n}, 0);\nlet useMutableCallback, useSafely;\nmodule.link(\"@rocket.chat/fuselage-hooks\", {\n  useMutableCallback(v) {\n    useMutableCallback = v;\n  },\n\n  useSafely(v) {\n    useSafely = v;\n  }\n\n}, 1);\nlet clear;\nmodule.link(\"@rocket.chat/memo\", {\n  clear(v) {\n    clear = v;\n  }\n\n}, 2);\nlet React, useRef, useEffect, useState, useMemo, useLayoutEffect, memo;\nmodule.link(\"react\", {\n  default(v) {\n    React = v;\n  },\n\n  useRef(v) {\n    useRef = v;\n  },\n\n  useEffect(v) {\n    useEffect = v;\n  },\n\n  useState(v) {\n    useState = v;\n  },\n\n  useMemo(v) {\n    useMemo = v;\n  },\n\n  useLayoutEffect(v) {\n    useLayoutEffect = v;\n  },\n\n  memo(v) {\n    memo = v;\n  }\n\n}, 3);\nlet HEARTBEAT, TIMEOUT, DEBOUNCE;\nmodule.link(\"../../../../../../app/videobridge/constants\", {\n  HEARTBEAT(v) {\n    HEARTBEAT = v;\n  },\n\n  TIMEOUT(v) {\n    TIMEOUT = v;\n  },\n\n  DEBOUNCE(v) {\n    DEBOUNCE = v;\n  }\n\n}, 4);\nlet useConnectionStatus;\nmodule.link(\"../../../../../contexts/ConnectionStatusContext\", {\n  useConnectionStatus(v) {\n    useConnectionStatus = v;\n  }\n\n}, 5);\nlet useSetModal;\nmodule.link(\"../../../../../contexts/ModalContext\", {\n  useSetModal(v) {\n    useSetModal = v;\n  }\n\n}, 6);\nlet useMethod;\nmodule.link(\"../../../../../contexts/ServerContext\", {\n  useMethod(v) {\n    useMethod = v;\n  }\n\n}, 7);\nlet useSettings;\nmodule.link(\"../../../../../contexts/SettingsContext\", {\n  useSettings(v) {\n    useSettings = v;\n  }\n\n}, 8);\nlet useToastMessageDispatch;\nmodule.link(\"../../../../../contexts/ToastMessagesContext\", {\n  useToastMessageDispatch(v) {\n    useToastMessageDispatch = v;\n  }\n\n}, 9);\nlet useTranslation;\nmodule.link(\"../../../../../contexts/TranslationContext\", {\n  useTranslation(v) {\n    useTranslation = v;\n  }\n\n}, 10);\nlet useUser;\nmodule.link(\"../../../../../contexts/UserContext\", {\n  useUser(v) {\n    useUser = v;\n  }\n\n}, 11);\nlet useRoom;\nmodule.link(\"../../../contexts/RoomContext\", {\n  useRoom(v) {\n    useRoom = v;\n  }\n\n}, 12);\nlet useTabBarClose;\nmodule.link(\"../../../providers/ToolboxProvider\", {\n  useTabBarClose(v) {\n    useTabBarClose = v;\n  }\n\n}, 13);\nlet CallJitsi;\nmodule.link(\"./CallJitsi\", {\n  default(v) {\n    CallJitsi = v;\n  }\n\n}, 14);\nlet CallModal;\nmodule.link(\"./components/CallModal\", {\n  default(v) {\n    CallModal = v;\n  }\n\n}, 15);\nlet JitsiBridge;\nmodule.link(\"./lib/JitsiBridge\", {\n  JitsiBridge(v) {\n    JitsiBridge = v;\n  }\n\n}, 16);\nmodule.link(\"./CallJitsi\", {\n  default: \"CallJitsi\"\n}, 17);\nconst querySettings = {\n  _id: ['Jitsi_Open_New_Window', 'Jitsi_Domain', 'Jitsi_URL_Room_Hash', 'uniqueID', 'Jitsi_URL_Room_Prefix', 'Jitsi_URL_Room_Suffix', 'Jitsi_Chrome_Extension', 'Jitsi_SSL', 'Jitsi_Enabled_TokenAuth']\n};\n\nconst CallJitsiWithData = _ref => {\n  let {\n    rid\n  } = _ref;\n  const user = useUser();\n  const {\n    connected\n  } = useConnectionStatus();\n  const [accessToken, setAccessToken] = useSafely(useState());\n  const [accepted, setAccepted] = useState(false);\n  const room = useRoom();\n  const setModal = useSetModal();\n  const handleClose = useTabBarClose();\n  const closeModal = useMutableCallback(() => setModal(null));\n  const generateAccessToken = useMethod('jitsi:generateAccessToken');\n  const updateTimeout = useMethod('jitsi:updateTimeout');\n  const dispatchToastMessage = useToastMessageDispatch();\n  const t = useTranslation();\n  const handleCancel = useMutableCallback(() => {\n    closeModal();\n    handleClose();\n  });\n  const ref = useRef();\n  const {\n    Jitsi_Open_New_Window: openNewWindow,\n    Jitsi_Domain: domain,\n    Jitsi_SSL: ssl,\n    Jitsi_Chrome_Extension: desktopSharingChromeExtId,\n    Jitsi_URL_Room_Hash: useHashName,\n    uniqueID,\n    Jitsi_URL_Room_Prefix: prefix,\n    Jitsi_URL_Room_Suffix: sufix,\n    Jitsi_Enabled_TokenAuth: isEnabledTokenAuth\n  } = Object.fromEntries(useSettings(querySettings).map(_ref2 => {\n    let {\n      _id,\n      value\n    } = _ref2;\n    return [_id, value];\n  }));\n  useEffect(() => {\n    let ignore = false;\n\n    if (!isEnabledTokenAuth) {\n      setAccessToken();\n      return;\n    }\n\n    (async () => {\n      const accessToken = await generateAccessToken(rid);\n      !ignore && setAccessToken(accessToken);\n    })();\n\n    return () => {\n      ignore = true;\n    };\n  }, [generateAccessToken, isEnabledTokenAuth, rid, setAccessToken]);\n  useLayoutEffect(() => {\n    if (!connected) {\n      handleClose();\n    }\n  }, [connected, handleClose]);\n  const rname = useHashName ? uniqueID + rid : encodeURIComponent(room.t === 'd' ? room.usernames.join(' x ') : room.name);\n  const jitsi = useMemo(() => {\n    if (isEnabledTokenAuth && !accessToken) {\n      return;\n    }\n\n    const jitsiRoomName = prefix + rname + sufix;\n    return new JitsiBridge({\n      openNewWindow,\n      ssl,\n      domain,\n      jitsiRoomName,\n      accessToken,\n      desktopSharingChromeExtId,\n      name: user.name || user.username\n    }, HEARTBEAT);\n  }, [accessToken, desktopSharingChromeExtId, domain, isEnabledTokenAuth, openNewWindow, prefix, rname, ssl, sufix, user.name, user.username]);\n  const testAndHandleTimeout = useMutableCallback(() => {\n    if (jitsi.openNewWindow) {\n      var _jitsi$window;\n\n      if ((_jitsi$window = jitsi.window) !== null && _jitsi$window !== void 0 && _jitsi$window.closed) {\n        return jitsi.dispose();\n      }\n\n      try {\n        return updateTimeout(rid, false);\n      } catch (error) {\n        dispatchToastMessage({\n          type: 'error',\n          message: t(error.reason)\n        });\n        clear();\n        handleClose();\n        return jitsi.dispose();\n      }\n    }\n\n    if (new Date() - new Date(room.jitsiTimeout) > TIMEOUT) {\n      return jitsi.dispose();\n    }\n\n    if (new Date() - new Date(room.jitsiTimeout) + TIMEOUT > DEBOUNCE) {\n      try {\n        return updateTimeout(rid, false);\n      } catch (error) {\n        dispatchToastMessage({\n          type: 'error',\n          message: t(error.reason)\n        });\n        clear();\n        handleClose();\n        return jitsi.dispose();\n      }\n    }\n  });\n  useEffect(() => {\n    if (!accepted || !jitsi) {\n      return;\n    }\n\n    const clear = () => {\n      jitsi.off('HEARTBEAT', testAndHandleTimeout);\n      jitsi.dispose();\n    };\n\n    try {\n      if (jitsi.needsStart) {\n        jitsi.start(ref.current);\n        updateTimeout(rid, true);\n      } else {\n        updateTimeout(rid, false);\n      }\n    } catch (error) {\n      dispatchToastMessage({\n        type: 'error',\n        message: t(error.reason)\n      });\n      clear();\n      handleClose();\n    }\n\n    jitsi.on('HEARTBEAT', testAndHandleTimeout);\n    return () => {\n      if (!jitsi.openNewWindow) clear();\n    };\n  }, [accepted, jitsi, rid, testAndHandleTimeout, updateTimeout, dispatchToastMessage, handleClose, t]);\n  const handleYes = useMutableCallback(() => {\n    if (jitsi) {\n      jitsi.needsStart = true;\n    }\n\n    setAccepted(true);\n\n    if (openNewWindow) {\n      handleClose();\n    }\n  });\n  useLayoutEffect(() => {\n    if (!accepted) {\n      setModal(() => /*#__PURE__*/React.createElement(CallModal, {\n        handleYes: handleYes,\n        handleCancel: handleCancel\n      }));\n      return;\n    }\n\n    closeModal();\n  }, [accepted, closeModal, handleCancel, handleYes, setModal]);\n  return /*#__PURE__*/React.createElement(CallJitsi, {\n    handleClose: handleClose,\n    openNewWindow: openNewWindow,\n    refContent: ref\n  }, !accepted && /*#__PURE__*/React.createElement(Skeleton, null));\n};\n\nmodule.exportDefault( /*#__PURE__*/memo(CallJitsiWithData));","map":{"version":3,"sources":["client/views/room/contextualBar/Call/Jitsi/CallJitsiWithData.js"],"names":["Skeleton","module","link","v","useMutableCallback","useSafely","clear","React","useRef","useEffect","useState","useMemo","useLayoutEffect","memo","default","HEARTBEAT","TIMEOUT","DEBOUNCE","useConnectionStatus","useSetModal","useMethod","useSettings","useToastMessageDispatch","useTranslation","useUser","useRoom","useTabBarClose","CallJitsi","CallModal","JitsiBridge","querySettings","_id","CallJitsiWithData","rid","user","connected","accessToken","setAccessToken","accepted","setAccepted","room","setModal","handleClose","closeModal","generateAccessToken","updateTimeout","dispatchToastMessage","t","handleCancel","ref","Jitsi_Open_New_Window","openNewWindow","Jitsi_Domain","domain","Jitsi_SSL","ssl","Jitsi_Chrome_Extension","desktopSharingChromeExtId","Jitsi_URL_Room_Hash","useHashName","uniqueID","Jitsi_URL_Room_Prefix","prefix","Jitsi_URL_Room_Suffix","sufix","Jitsi_Enabled_TokenAuth","isEnabledTokenAuth","Object","fromEntries","map","value","ignore","rname","encodeURIComponent","usernames","join","name","jitsi","jitsiRoomName","username","testAndHandleTimeout","window","closed","dispose","error","type","message","reason","Date","jitsiTimeout","off","needsStart","start","current","on","handleYes","exportDefault"],"mappings":"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","sourcesContent":["import { Skeleton } from '@rocket.chat/fuselage';\nimport { useMutableCallback, useSafely } from '@rocket.chat/fuselage-hooks';\nimport { clear } from '@rocket.chat/memo';\nimport React, { useRef, useEffect, useState, useMemo, useLayoutEffect, memo } from 'react';\n\nimport { HEARTBEAT, TIMEOUT, DEBOUNCE } from '../../../../../../app/videobridge/constants';\nimport { useConnectionStatus } from '../../../../../contexts/ConnectionStatusContext';\nimport { useSetModal } from '../../../../../contexts/ModalContext';\nimport { useMethod } from '../../../../../contexts/ServerContext';\nimport { useSettings } from '../../../../../contexts/SettingsContext';\nimport { useToastMessageDispatch } from '../../../../../contexts/ToastMessagesContext';\nimport { useTranslation } from '../../../../../contexts/TranslationContext';\nimport { useUser } from '../../../../../contexts/UserContext';\nimport { useRoom } from '../../../contexts/RoomContext';\nimport { useTabBarClose } from '../../../providers/ToolboxProvider';\nimport CallJitsi from './CallJitsi';\nimport CallModal from './components/CallModal';\nimport { JitsiBridge } from './lib/JitsiBridge';\n\nexport { default as CallJitsi } from './CallJitsi';\n\nconst querySettings = {\n\t_id: [\n\t\t'Jitsi_Open_New_Window',\n\t\t'Jitsi_Domain',\n\t\t'Jitsi_URL_Room_Hash',\n\t\t'uniqueID',\n\t\t'Jitsi_URL_Room_Prefix',\n\t\t'Jitsi_URL_Room_Suffix',\n\t\t'Jitsi_Chrome_Extension',\n\t\t'Jitsi_SSL',\n\t\t'Jitsi_Enabled_TokenAuth',\n\t],\n};\n\nconst CallJitsiWithData = ({ rid }) => {\n\tconst user = useUser();\n\tconst { connected } = useConnectionStatus();\n\tconst [accessToken, setAccessToken] = useSafely(useState());\n\tconst [accepted, setAccepted] = useState(false);\n\tconst room = useRoom();\n\tconst setModal = useSetModal();\n\tconst handleClose = useTabBarClose();\n\tconst closeModal = useMutableCallback(() => setModal(null));\n\tconst generateAccessToken = useMethod('jitsi:generateAccessToken');\n\tconst updateTimeout = useMethod('jitsi:updateTimeout');\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst t = useTranslation();\n\n\tconst handleCancel = useMutableCallback(() => {\n\t\tcloseModal();\n\t\thandleClose();\n\t});\n\n\tconst ref = useRef();\n\n\tconst {\n\t\tJitsi_Open_New_Window: openNewWindow,\n\t\tJitsi_Domain: domain,\n\t\tJitsi_SSL: ssl,\n\t\tJitsi_Chrome_Extension: desktopSharingChromeExtId,\n\t\tJitsi_URL_Room_Hash: useHashName,\n\t\tuniqueID,\n\t\tJitsi_URL_Room_Prefix: prefix,\n\t\tJitsi_URL_Room_Suffix: sufix,\n\t\tJitsi_Enabled_TokenAuth: isEnabledTokenAuth,\n\t} = Object.fromEntries(useSettings(querySettings).map(({ _id, value }) => [_id, value]));\n\n\tuseEffect(() => {\n\t\tlet ignore = false;\n\t\tif (!isEnabledTokenAuth) {\n\t\t\tsetAccessToken();\n\t\t\treturn;\n\t\t}\n\t\t(async () => {\n\t\t\tconst accessToken = await generateAccessToken(rid);\n\t\t\t!ignore && setAccessToken(accessToken);\n\t\t})();\n\t\treturn () => {\n\t\t\tignore = true;\n\t\t};\n\t}, [generateAccessToken, isEnabledTokenAuth, rid, setAccessToken]);\n\n\tuseLayoutEffect(() => {\n\t\tif (!connected) {\n\t\t\thandleClose();\n\t\t}\n\t}, [connected, handleClose]);\n\n\tconst rname = useHashName ? uniqueID + rid : encodeURIComponent(room.t === 'd' ? room.usernames.join(' x ') : room.name);\n\n\tconst jitsi = useMemo(() => {\n\t\tif (isEnabledTokenAuth && !accessToken) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst jitsiRoomName = prefix + rname + sufix;\n\n\t\treturn new JitsiBridge(\n\t\t\t{\n\t\t\t\topenNewWindow,\n\t\t\t\tssl,\n\t\t\t\tdomain,\n\t\t\t\tjitsiRoomName,\n\t\t\t\taccessToken,\n\t\t\t\tdesktopSharingChromeExtId,\n\t\t\t\tname: user.name || user.username,\n\t\t\t},\n\t\t\tHEARTBEAT,\n\t\t);\n\t}, [\n\t\taccessToken,\n\t\tdesktopSharingChromeExtId,\n\t\tdomain,\n\t\tisEnabledTokenAuth,\n\t\topenNewWindow,\n\t\tprefix,\n\t\trname,\n\t\tssl,\n\t\tsufix,\n\t\tuser.name,\n\t\tuser.username,\n\t]);\n\n\tconst testAndHandleTimeout = useMutableCallback(() => {\n\t\tif (jitsi.openNewWindow) {\n\t\t\tif (jitsi.window?.closed) {\n\t\t\t\treturn jitsi.dispose();\n\t\t\t}\n\t\t\ttry {\n\t\t\t\treturn updateTimeout(rid, false);\n\t\t\t} catch (error) {\n\t\t\t\tdispatchToastMessage({ type: 'error', message: t(error.reason) });\n\t\t\t\tclear();\n\t\t\t\thandleClose();\n\t\t\t\treturn jitsi.dispose();\n\t\t\t}\n\t\t}\n\t\tif (new Date() - new Date(room.jitsiTimeout) > TIMEOUT) {\n\t\t\treturn jitsi.dispose();\n\t\t}\n\n\t\tif (new Date() - new Date(room.jitsiTimeout) + TIMEOUT > DEBOUNCE) {\n\t\t\ttry {\n\t\t\t\treturn updateTimeout(rid, false);\n\t\t\t} catch (error) {\n\t\t\t\tdispatchToastMessage({ type: 'error', message: t(error.reason) });\n\t\t\t\tclear();\n\t\t\t\thandleClose();\n\t\t\t\treturn jitsi.dispose();\n\t\t\t}\n\t\t}\n\t});\n\n\tuseEffect(() => {\n\t\tif (!accepted || !jitsi) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst clear = () => {\n\t\t\tjitsi.off('HEARTBEAT', testAndHandleTimeout);\n\t\t\tjitsi.dispose();\n\t\t};\n\n\t\ttry {\n\t\t\tif (jitsi.needsStart) {\n\t\t\t\tjitsi.start(ref.current);\n\t\t\t\tupdateTimeout(rid, true);\n\t\t\t} else {\n\t\t\t\tupdateTimeout(rid, false);\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tdispatchToastMessage({ type: 'error', message: t(error.reason) });\n\t\t\tclear();\n\t\t\thandleClose();\n\t\t}\n\t\tjitsi.on('HEARTBEAT', testAndHandleTimeout);\n\n\t\treturn () => {\n\t\t\tif (!jitsi.openNewWindow) clear();\n\t\t};\n\t}, [accepted, jitsi, rid, testAndHandleTimeout, updateTimeout, dispatchToastMessage, handleClose, t]);\n\n\tconst handleYes = useMutableCallback(() => {\n\t\tif (jitsi) {\n\t\t\tjitsi.needsStart = true;\n\t\t}\n\n\t\tsetAccepted(true);\n\n\t\tif (openNewWindow) {\n\t\t\thandleClose();\n\t\t}\n\t});\n\n\tuseLayoutEffect(() => {\n\t\tif (!accepted) {\n\t\t\tsetModal(() => <CallModal handleYes={handleYes} handleCancel={handleCancel} />);\n\t\t\treturn;\n\t\t}\n\t\tcloseModal();\n\t}, [accepted, closeModal, handleCancel, handleYes, setModal]);\n\n\treturn (\n\t\t<CallJitsi handleClose={handleClose} openNewWindow={openNewWindow} refContent={ref}>\n\t\t\t{!accepted && <Skeleton />}\n\t\t</CallJitsi>\n\t);\n};\n\nexport default memo(CallJitsiWithData);\n"]},"sourceType":"module","hash":"3b3fb0a298375c00158e00ca8c3b1d7956b6cb5d"}
