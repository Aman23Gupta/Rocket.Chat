{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/emoji-custom/server/startup/emoji-custom.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/emoji-custom/server/startup/emoji-custom.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/emoji-custom/server/startup/emoji-custom.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/emoji-custom/server/startup/emoji-custom.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/emoji-custom/server/startup/emoji-custom.js"}},"code":"module.export({\n  RocketChatFileEmojiCustomInstance: () => RocketChatFileEmojiCustomInstance\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet WebApp;\nmodule.link(\"meteor/webapp\", {\n  WebApp(v) {\n    WebApp = v;\n  }\n\n}, 1);\n\nlet _;\n\nmodule.link(\"underscore\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 2);\nlet settings;\nmodule.link(\"../../../settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 3);\nlet SystemLogger;\nmodule.link(\"../../../../server/lib/logger/system\", {\n  SystemLogger(v) {\n    SystemLogger = v;\n  }\n\n}, 4);\nlet RocketChatFile;\nmodule.link(\"../../../file\", {\n  RocketChatFile(v) {\n    RocketChatFile = v;\n  }\n\n}, 5);\nlet RocketChatFileEmojiCustomInstance;\nMeteor.startup(function () {\n  let storeType = 'GridFS';\n\n  if (settings.get('EmojiUpload_Storage_Type')) {\n    storeType = settings.get('EmojiUpload_Storage_Type');\n  }\n\n  const RocketChatStore = RocketChatFile[storeType];\n\n  if (RocketChatStore == null) {\n    throw new Error(\"Invalid RocketChatStore type [\".concat(storeType, \"]\"));\n  }\n\n  SystemLogger.info(\"Using \".concat(storeType, \" for custom emoji storage\"));\n  let path = '~/uploads';\n\n  if (settings.get('EmojiUpload_FileSystemPath') != null) {\n    if (settings.get('EmojiUpload_FileSystemPath').trim() !== '') {\n      path = settings.get('EmojiUpload_FileSystemPath');\n    }\n  }\n\n  module.runSetters(RocketChatFileEmojiCustomInstance = new RocketChatStore({\n    name: 'custom_emoji',\n    absolutePath: path\n  }), [\"RocketChatFileEmojiCustomInstance\"]);\n  return WebApp.connectHandlers.use('/emoji-custom/', Meteor.bindEnvironment(function (req, res\n  /* , next*/\n  ) {\n    const params = {\n      emoji: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, ''))\n    };\n\n    if (_.isEmpty(params.emoji)) {\n      res.writeHead(403);\n      res.write('Forbidden');\n      res.end();\n      return;\n    }\n\n    const file = RocketChatFileEmojiCustomInstance.getFileWithReadStream(encodeURIComponent(params.emoji));\n    res.setHeader('Content-Disposition', 'inline');\n\n    if (file == null) {\n      // use code from username initials renderer until file upload is complete\n      res.setHeader('Content-Type', 'image/svg+xml');\n      res.setHeader('Cache-Control', 'public, max-age=0');\n      res.setHeader('Expires', '-1');\n      res.setHeader('Last-Modified', 'Thu, 01 Jan 2015 00:00:00 GMT');\n      const reqModifiedHeader = req.headers['if-modified-since'];\n\n      if (reqModifiedHeader != null) {\n        if (reqModifiedHeader === 'Thu, 01 Jan 2015 00:00:00 GMT') {\n          res.writeHead(304);\n          res.end();\n          return;\n        }\n      }\n\n      const color = '#000';\n      const initials = '?';\n      const svg = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\" standalone=\\\"no\\\"?>\\n<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" pointer-events=\\\"none\\\" width=\\\"50\\\" height=\\\"50\\\" style=\\\"width: 50px; height: 50px; background-color: \".concat(color, \";\\\">\\n\\t<text text-anchor=\\\"middle\\\" y=\\\"50%\\\" x=\\\"50%\\\" dy=\\\"0.36em\\\" pointer-events=\\\"auto\\\" fill=\\\"#ffffff\\\" font-family=\\\"Helvetica, Arial, Lucida Grande, sans-serif\\\" style=\\\"font-weight: 400; font-size: 28px;\\\">\\n\\t\\t\").concat(initials, \"\\n\\t</text>\\n</svg>\");\n      res.write(svg);\n      res.end();\n      return;\n    }\n\n    let fileUploadDate = undefined;\n\n    if (file.uploadDate != null) {\n      fileUploadDate = file.uploadDate.toUTCString();\n    }\n\n    const reqModifiedHeader = req.headers['if-modified-since'];\n\n    if (reqModifiedHeader != null) {\n      if (reqModifiedHeader === fileUploadDate) {\n        res.setHeader('Last-Modified', reqModifiedHeader);\n        res.writeHead(304);\n        res.end();\n        return;\n      }\n    }\n\n    res.setHeader('Cache-Control', 'public, max-age=0');\n    res.setHeader('Expires', '-1');\n\n    if (fileUploadDate != null) {\n      res.setHeader('Last-Modified', fileUploadDate);\n    } else {\n      res.setHeader('Last-Modified', new Date().toUTCString());\n    }\n\n    if (/^svg$/i.test(params.emoji.split('.').pop())) {\n      res.setHeader('Content-Type', 'image/svg+xml');\n    } else if (/^png$/i.test(params.emoji.split('.').pop())) {\n      res.setHeader('Content-Type', 'image/png');\n    } else {\n      res.setHeader('Content-Type', 'image/jpeg');\n    }\n\n    res.setHeader('Content-Length', file.length);\n    file.readStream.pipe(res);\n  }));\n});","map":{"version":3,"sources":["app/emoji-custom/server/startup/emoji-custom.js"],"names":["module","export","RocketChatFileEmojiCustomInstance","Meteor","link","v","WebApp","_","default","settings","SystemLogger","RocketChatFile","startup","storeType","get","RocketChatStore","Error","info","path","trim","name","absolutePath","connectHandlers","use","bindEnvironment","req","res","params","emoji","decodeURIComponent","url","replace","isEmpty","writeHead","write","end","file","getFileWithReadStream","encodeURIComponent","setHeader","reqModifiedHeader","headers","color","initials","svg","fileUploadDate","undefined","uploadDate","toUTCString","Date","test","split","pop","length","readStream","pipe"],"mappings":"AAAAA,MAAM,CAACC,MAAP,CAAc;AAACC,EAAAA,iCAAiC,EAAC,MAAIA;AAAvC,CAAd;AAAyF,IAAIC,MAAJ;AAAWH,MAAM,CAACI,IAAP,CAAY,eAAZ,EAA4B;AAACD,EAAAA,MAAM,CAACE,CAAD,EAAG;AAACF,IAAAA,MAAM,GAACE,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqD,IAAIC,MAAJ;AAAWN,MAAM,CAACI,IAAP,CAAY,eAAZ,EAA4B;AAACE,EAAAA,MAAM,CAACD,CAAD,EAAG;AAACC,IAAAA,MAAM,GAACD,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;;AAAqD,IAAIE,CAAJ;;AAAMP,MAAM,CAACI,IAAP,CAAY,YAAZ,EAAyB;AAACI,EAAAA,OAAO,CAACH,CAAD,EAAG;AAACE,IAAAA,CAAC,GAACF,CAAF;AAAI;;AAAhB,CAAzB,EAA2C,CAA3C;AAA8C,IAAII,QAAJ;AAAaT,MAAM,CAACI,IAAP,CAAY,0BAAZ,EAAuC;AAACK,EAAAA,QAAQ,CAACJ,CAAD,EAAG;AAACI,IAAAA,QAAQ,GAACJ,CAAT;AAAW;;AAAxB,CAAvC,EAAiE,CAAjE;AAAoE,IAAIK,YAAJ;AAAiBV,MAAM,CAACI,IAAP,CAAY,sCAAZ,EAAmD;AAACM,EAAAA,YAAY,CAACL,CAAD,EAAG;AAACK,IAAAA,YAAY,GAACL,CAAb;AAAe;;AAAhC,CAAnD,EAAqF,CAArF;AAAwF,IAAIM,cAAJ;AAAmBX,MAAM,CAACI,IAAP,CAAY,eAAZ,EAA4B;AAACO,EAAAA,cAAc,CAACN,CAAD,EAAG;AAACM,IAAAA,cAAc,GAACN,CAAf;AAAiB;;AAApC,CAA5B,EAAkE,CAAlE;AAQnd,IAAIH,iCAAJ;AAEPC,MAAM,CAACS,OAAP,CAAe,YAAY;AAC1B,MAAIC,SAAS,GAAG,QAAhB;;AAEA,MAAIJ,QAAQ,CAACK,GAAT,CAAa,0BAAb,CAAJ,EAA8C;AAC7CD,IAAAA,SAAS,GAAGJ,QAAQ,CAACK,GAAT,CAAa,0BAAb,CAAZ;AACA;;AAED,QAAMC,eAAe,GAAGJ,cAAc,CAACE,SAAD,CAAtC;;AAEA,MAAIE,eAAe,IAAI,IAAvB,EAA6B;AAC5B,UAAM,IAAIC,KAAJ,yCAA2CH,SAA3C,OAAN;AACA;;AAEDH,EAAAA,YAAY,CAACO,IAAb,iBAA2BJ,SAA3B;AAEA,MAAIK,IAAI,GAAG,WAAX;;AACA,MAAIT,QAAQ,CAACK,GAAT,CAAa,4BAAb,KAA8C,IAAlD,EAAwD;AACvD,QAAIL,QAAQ,CAACK,GAAT,CAAa,4BAAb,EAA2CK,IAA3C,OAAsD,EAA1D,EAA8D;AAC7DD,MAAAA,IAAI,GAAGT,QAAQ,CAACK,GAAT,CAAa,4BAAb,CAAP;AACA;AACD;;AAED,oBAAAZ,iCAAiC,GAAG,IAAIa,eAAJ,CAAoB;AACvDK,IAAAA,IAAI,EAAE,cADiD;AAEvDC,IAAAA,YAAY,EAAEH;AAFyC,GAApB,CAApC;AAKA,SAAOZ,MAAM,CAACgB,eAAP,CAAuBC,GAAvB,CACN,gBADM,EAENpB,MAAM,CAACqB,eAAP,CAAuB,UAAUC,GAAV,EAAeC;AAAI;AAAnB,IAAgC;AACtD,UAAMC,MAAM,GAAG;AAAEC,MAAAA,KAAK,EAAEC,kBAAkB,CAACJ,GAAG,CAACK,GAAJ,CAAQC,OAAR,CAAgB,KAAhB,EAAuB,EAAvB,EAA2BA,OAA3B,CAAmC,OAAnC,EAA4C,EAA5C,CAAD;AAA3B,KAAf;;AAEA,QAAIxB,CAAC,CAACyB,OAAF,CAAUL,MAAM,CAACC,KAAjB,CAAJ,EAA6B;AAC5BF,MAAAA,GAAG,CAACO,SAAJ,CAAc,GAAd;AACAP,MAAAA,GAAG,CAACQ,KAAJ,CAAU,WAAV;AACAR,MAAAA,GAAG,CAACS,GAAJ;AACA;AACA;;AAED,UAAMC,IAAI,GAAGlC,iCAAiC,CAACmC,qBAAlC,CAAwDC,kBAAkB,CAACX,MAAM,CAACC,KAAR,CAA1E,CAAb;AAEAF,IAAAA,GAAG,CAACa,SAAJ,CAAc,qBAAd,EAAqC,QAArC;;AAEA,QAAIH,IAAI,IAAI,IAAZ,EAAkB;AACjB;AACAV,MAAAA,GAAG,CAACa,SAAJ,CAAc,cAAd,EAA8B,eAA9B;AACAb,MAAAA,GAAG,CAACa,SAAJ,CAAc,eAAd,EAA+B,mBAA/B;AACAb,MAAAA,GAAG,CAACa,SAAJ,CAAc,SAAd,EAAyB,IAAzB;AACAb,MAAAA,GAAG,CAACa,SAAJ,CAAc,eAAd,EAA+B,+BAA/B;AAEA,YAAMC,iBAAiB,GAAGf,GAAG,CAACgB,OAAJ,CAAY,mBAAZ,CAA1B;;AACA,UAAID,iBAAiB,IAAI,IAAzB,EAA+B;AAC9B,YAAIA,iBAAiB,KAAK,+BAA1B,EAA2D;AAC1Dd,UAAAA,GAAG,CAACO,SAAJ,CAAc,GAAd;AACAP,UAAAA,GAAG,CAACS,GAAJ;AACA;AACA;AACD;;AAED,YAAMO,KAAK,GAAG,MAAd;AACA,YAAMC,QAAQ,GAAG,GAAjB;AAEA,YAAMC,GAAG,6NAC8HF,KAD9H,4OAGTC,QAHS,wBAAT;AAOAjB,MAAAA,GAAG,CAACQ,KAAJ,CAAUU,GAAV;AACAlB,MAAAA,GAAG,CAACS,GAAJ;AACA;AACA;;AAED,QAAIU,cAAc,GAAGC,SAArB;;AACA,QAAIV,IAAI,CAACW,UAAL,IAAmB,IAAvB,EAA6B;AAC5BF,MAAAA,cAAc,GAAGT,IAAI,CAACW,UAAL,CAAgBC,WAAhB,EAAjB;AACA;;AAED,UAAMR,iBAAiB,GAAGf,GAAG,CAACgB,OAAJ,CAAY,mBAAZ,CAA1B;;AACA,QAAID,iBAAiB,IAAI,IAAzB,EAA+B;AAC9B,UAAIA,iBAAiB,KAAKK,cAA1B,EAA0C;AACzCnB,QAAAA,GAAG,CAACa,SAAJ,CAAc,eAAd,EAA+BC,iBAA/B;AACAd,QAAAA,GAAG,CAACO,SAAJ,CAAc,GAAd;AACAP,QAAAA,GAAG,CAACS,GAAJ;AACA;AACA;AACD;;AAEDT,IAAAA,GAAG,CAACa,SAAJ,CAAc,eAAd,EAA+B,mBAA/B;AACAb,IAAAA,GAAG,CAACa,SAAJ,CAAc,SAAd,EAAyB,IAAzB;;AACA,QAAIM,cAAc,IAAI,IAAtB,EAA4B;AAC3BnB,MAAAA,GAAG,CAACa,SAAJ,CAAc,eAAd,EAA+BM,cAA/B;AACA,KAFD,MAEO;AACNnB,MAAAA,GAAG,CAACa,SAAJ,CAAc,eAAd,EAA+B,IAAIU,IAAJ,GAAWD,WAAX,EAA/B;AACA;;AACD,QAAI,SAASE,IAAT,CAAcvB,MAAM,CAACC,KAAP,CAAauB,KAAb,CAAmB,GAAnB,EAAwBC,GAAxB,EAAd,CAAJ,EAAkD;AACjD1B,MAAAA,GAAG,CAACa,SAAJ,CAAc,cAAd,EAA8B,eAA9B;AACA,KAFD,MAEO,IAAI,SAASW,IAAT,CAAcvB,MAAM,CAACC,KAAP,CAAauB,KAAb,CAAmB,GAAnB,EAAwBC,GAAxB,EAAd,CAAJ,EAAkD;AACxD1B,MAAAA,GAAG,CAACa,SAAJ,CAAc,cAAd,EAA8B,WAA9B;AACA,KAFM,MAEA;AACNb,MAAAA,GAAG,CAACa,SAAJ,CAAc,cAAd,EAA8B,YAA9B;AACA;;AACDb,IAAAA,GAAG,CAACa,SAAJ,CAAc,gBAAd,EAAgCH,IAAI,CAACiB,MAArC;AAEAjB,IAAAA,IAAI,CAACkB,UAAL,CAAgBC,IAAhB,CAAqB7B,GAArB;AACA,GA7ED,CAFM,CAAP;AAiFA,CA5GD","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\nimport _ from 'underscore';\n\nimport { settings } from '../../../settings/server';\nimport { SystemLogger } from '../../../../server/lib/logger/system';\nimport { RocketChatFile } from '../../../file';\n\nexport let RocketChatFileEmojiCustomInstance;\n\nMeteor.startup(function () {\n\tlet storeType = 'GridFS';\n\n\tif (settings.get('EmojiUpload_Storage_Type')) {\n\t\tstoreType = settings.get('EmojiUpload_Storage_Type');\n\t}\n\n\tconst RocketChatStore = RocketChatFile[storeType];\n\n\tif (RocketChatStore == null) {\n\t\tthrow new Error(`Invalid RocketChatStore type [${storeType}]`);\n\t}\n\n\tSystemLogger.info(`Using ${storeType} for custom emoji storage`);\n\n\tlet path = '~/uploads';\n\tif (settings.get('EmojiUpload_FileSystemPath') != null) {\n\t\tif (settings.get('EmojiUpload_FileSystemPath').trim() !== '') {\n\t\t\tpath = settings.get('EmojiUpload_FileSystemPath');\n\t\t}\n\t}\n\n\tRocketChatFileEmojiCustomInstance = new RocketChatStore({\n\t\tname: 'custom_emoji',\n\t\tabsolutePath: path,\n\t});\n\n\treturn WebApp.connectHandlers.use(\n\t\t'/emoji-custom/',\n\t\tMeteor.bindEnvironment(function (req, res /* , next*/) {\n\t\t\tconst params = { emoji: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, '')) };\n\n\t\t\tif (_.isEmpty(params.emoji)) {\n\t\t\t\tres.writeHead(403);\n\t\t\t\tres.write('Forbidden');\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst file = RocketChatFileEmojiCustomInstance.getFileWithReadStream(encodeURIComponent(params.emoji));\n\n\t\t\tres.setHeader('Content-Disposition', 'inline');\n\n\t\t\tif (file == null) {\n\t\t\t\t// use code from username initials renderer until file upload is complete\n\t\t\t\tres.setHeader('Content-Type', 'image/svg+xml');\n\t\t\t\tres.setHeader('Cache-Control', 'public, max-age=0');\n\t\t\t\tres.setHeader('Expires', '-1');\n\t\t\t\tres.setHeader('Last-Modified', 'Thu, 01 Jan 2015 00:00:00 GMT');\n\n\t\t\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\t\t\tif (reqModifiedHeader != null) {\n\t\t\t\t\tif (reqModifiedHeader === 'Thu, 01 Jan 2015 00:00:00 GMT') {\n\t\t\t\t\t\tres.writeHead(304);\n\t\t\t\t\t\tres.end();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst color = '#000';\n\t\t\t\tconst initials = '?';\n\n\t\t\t\tconst svg = `<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\n<svg xmlns=\"http://www.w3.org/2000/svg\" pointer-events=\"none\" width=\"50\" height=\"50\" style=\"width: 50px; height: 50px; background-color: ${color};\">\n\t<text text-anchor=\"middle\" y=\"50%\" x=\"50%\" dy=\"0.36em\" pointer-events=\"auto\" fill=\"#ffffff\" font-family=\"Helvetica, Arial, Lucida Grande, sans-serif\" style=\"font-weight: 400; font-size: 28px;\">\n\t\t${initials}\n\t</text>\n</svg>`;\n\n\t\t\t\tres.write(svg);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet fileUploadDate = undefined;\n\t\t\tif (file.uploadDate != null) {\n\t\t\t\tfileUploadDate = file.uploadDate.toUTCString();\n\t\t\t}\n\n\t\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\t\tif (reqModifiedHeader != null) {\n\t\t\t\tif (reqModifiedHeader === fileUploadDate) {\n\t\t\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\t\t\tres.writeHead(304);\n\t\t\t\t\tres.end();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tres.setHeader('Cache-Control', 'public, max-age=0');\n\t\t\tres.setHeader('Expires', '-1');\n\t\t\tif (fileUploadDate != null) {\n\t\t\t\tres.setHeader('Last-Modified', fileUploadDate);\n\t\t\t} else {\n\t\t\t\tres.setHeader('Last-Modified', new Date().toUTCString());\n\t\t\t}\n\t\t\tif (/^svg$/i.test(params.emoji.split('.').pop())) {\n\t\t\t\tres.setHeader('Content-Type', 'image/svg+xml');\n\t\t\t} else if (/^png$/i.test(params.emoji.split('.').pop())) {\n\t\t\t\tres.setHeader('Content-Type', 'image/png');\n\t\t\t} else {\n\t\t\t\tres.setHeader('Content-Type', 'image/jpeg');\n\t\t\t}\n\t\t\tres.setHeader('Content-Length', file.length);\n\n\t\t\tfile.readStream.pipe(res);\n\t\t}),\n\t);\n});\n"]},"sourceType":"module","hash":"bad7f5d7e405772f9c7b9298969d7a34e68c74e6"}
