{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/authentication/server/startup/index.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/authentication/server/startup/index.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/authentication/server/startup/index.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/authentication/server/startup/index.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/authentication/server/startup/index.js"}},"code":"module.export({\n  MAX_RESUME_LOGIN_TOKENS: () => MAX_RESUME_LOGIN_TOKENS\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet Match;\nmodule.link(\"meteor/check\", {\n  Match(v) {\n    Match = v;\n  }\n\n}, 1);\nlet Accounts;\nmodule.link(\"meteor/accounts-base\", {\n  Accounts(v) {\n    Accounts = v;\n  }\n\n}, 2);\nlet TAPi18n;\nmodule.link(\"meteor/rocketchat:tap-i18n\", {\n  TAPi18n(v) {\n    TAPi18n = v;\n  }\n\n}, 3);\n\nlet _;\n\nmodule.link(\"underscore\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 4);\nlet escapeRegExp, escapeHTML;\nmodule.link(\"@rocket.chat/string-helpers\", {\n  escapeRegExp(v) {\n    escapeRegExp = v;\n  },\n\n  escapeHTML(v) {\n    escapeHTML = v;\n  }\n\n}, 5);\nlet Mailer;\nmodule.link(\"../../../mailer/server/api\", {\n  \"*\"(v) {\n    Mailer = v;\n  }\n\n}, 6);\nlet settings;\nmodule.link(\"../../../settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 7);\nlet callbacks;\nmodule.link(\"../../../../lib/callbacks\", {\n  callbacks(v) {\n    callbacks = v;\n  }\n\n}, 8);\nlet Users, Settings;\nmodule.link(\"../../../models/server\", {\n  Users(v) {\n    Users = v;\n  },\n\n  Settings(v) {\n    Settings = v;\n  }\n\n}, 9);\nlet Roles, UsersRaw;\nmodule.link(\"../../../models/server/raw\", {\n  Roles(v) {\n    Roles = v;\n  },\n\n  Users(v) {\n    UsersRaw = v;\n  }\n\n}, 10);\nlet addUserRoles;\nmodule.link(\"../../../authorization/server\", {\n  addUserRoles(v) {\n    addUserRoles = v;\n  }\n\n}, 11);\nlet getAvatarSuggestionForUser;\nmodule.link(\"../../../lib/server/functions/getAvatarSuggestionForUser\", {\n  getAvatarSuggestionForUser(v) {\n    getAvatarSuggestionForUser = v;\n  }\n\n}, 12);\nlet isValidAttemptByUser, isValidLoginAttemptByIp;\nmodule.link(\"../lib/restrictLoginAttempts\", {\n  isValidAttemptByUser(v) {\n    isValidAttemptByUser = v;\n  },\n\n  isValidLoginAttemptByIp(v) {\n    isValidLoginAttemptByIp = v;\n  }\n\n}, 13);\nmodule.link(\"./settings\");\nlet getClientAddress;\nmodule.link(\"../../../../server/lib/getClientAddress\", {\n  getClientAddress(v) {\n    getClientAddress = v;\n  }\n\n}, 14);\nlet getNewUserRoles;\nmodule.link(\"../../../../server/services/user/lib/getNewUserRoles\", {\n  getNewUserRoles(v) {\n    getNewUserRoles = v;\n  }\n\n}, 15);\nAccounts.config({\n  forbidClientAccountCreation: true\n});\nMeteor.startup(() => {\n  settings.watchMultiple(['Accounts_LoginExpiration', 'Site_Name', 'From_Email'], () => {\n    Accounts._options.loginExpirationInDays = settings.get('Accounts_LoginExpiration');\n    Accounts.emailTemplates.siteName = settings.get('Site_Name');\n    Accounts.emailTemplates.from = \"\".concat(settings.get('Site_Name'), \" <\").concat(settings.get('From_Email'), \">\");\n  });\n});\nAccounts.emailTemplates.userToActivate = {\n  subject() {\n    const subject = TAPi18n.__('Accounts_Admin_Email_Approval_Needed_Subject_Default');\n\n    const siteName = settings.get('Site_Name');\n    return \"[\".concat(siteName, \"] \").concat(subject);\n  },\n\n  html() {\n    let options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    const email = options.reason ? 'Accounts_Admin_Email_Approval_Needed_With_Reason_Default' : 'Accounts_Admin_Email_Approval_Needed_Default';\n    return Mailer.replace(TAPi18n.__(email), {\n      name: escapeHTML(options.name),\n      email: escapeHTML(options.email),\n      reason: escapeHTML(options.reason)\n    });\n  }\n\n};\nAccounts.emailTemplates.userActivated = {\n  subject(_ref) {\n    let {\n      active,\n      username\n    } = _ref;\n    const activated = username ? 'Activated' : 'Approved';\n    const action = active ? activated : 'Deactivated';\n    const subject = \"Accounts_Email_\".concat(action, \"_Subject\");\n    const siteName = settings.get('Site_Name');\n    return \"[\".concat(siteName, \"] \").concat(TAPi18n.__(subject));\n  },\n\n  html(_ref2) {\n    let {\n      active,\n      name,\n      username\n    } = _ref2;\n    const activated = username ? 'Activated' : 'Approved';\n    const action = active ? activated : 'Deactivated';\n    return Mailer.replace(TAPi18n.__(\"Accounts_Email_\".concat(action)), {\n      name: escapeHTML(name)\n    });\n  }\n\n};\nlet verifyEmailTemplate = '';\nlet enrollAccountTemplate = '';\nlet resetPasswordTemplate = '';\nMeteor.startup(() => {\n  Mailer.getTemplateWrapped('Verification_Email', value => {\n    verifyEmailTemplate = value;\n  });\n  Mailer.getTemplateWrapped('Accounts_Enrollment_Email', value => {\n    enrollAccountTemplate = value;\n  });\n  Mailer.getTemplateWrapped('Forgot_Password_Email', value => {\n    resetPasswordTemplate = value;\n  });\n});\n\nAccounts.emailTemplates.verifyEmail.html = function (userModel, url) {\n  return Mailer.replace(verifyEmailTemplate, {\n    Verification_Url: url,\n    name: userModel.name\n  });\n};\n\nAccounts.emailTemplates.verifyEmail.subject = function () {\n  const subject = settings.get('Verification_Email_Subject');\n  return Mailer.replace(subject || '');\n};\n\nAccounts.urls.resetPassword = function (token) {\n  return Meteor.absoluteUrl(\"reset-password/\".concat(token));\n};\n\nAccounts.emailTemplates.resetPassword.subject = function (userModel) {\n  return Mailer.replace(settings.get('Forgot_Password_Email_Subject') || '', {\n    name: userModel.name\n  });\n};\n\nAccounts.emailTemplates.resetPassword.html = function (userModel, url) {\n  return Mailer.replacekey(Mailer.replace(resetPasswordTemplate, {\n    name: userModel.name\n  }), 'Forgot_Password_Url', url);\n};\n\nAccounts.emailTemplates.enrollAccount.subject = function (user) {\n  const subject = settings.get('Accounts_Enrollment_Email_Subject');\n  return Mailer.replace(subject, user);\n};\n\nAccounts.emailTemplates.enrollAccount.html = function () {\n  let user = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n  return Mailer.replace(enrollAccountTemplate, {\n    name: escapeHTML(user.name),\n    email: user.emails && user.emails[0] && escapeHTML(user.emails[0].address)\n  });\n};\n\nconst getLinkedInName = _ref3 => {\n  let {\n    firstName,\n    lastName\n  } = _ref3;\n  const {\n    preferredLocale,\n    localized: firstNameLocalized\n  } = firstName;\n  const {\n    localized: lastNameLocalized\n  } = lastName; // LinkedIn new format\n\n  if (preferredLocale && firstNameLocalized && preferredLocale.language && preferredLocale.country) {\n    const locale = \"\".concat(preferredLocale.language, \"_\").concat(preferredLocale.country);\n\n    if (firstNameLocalized[locale] && lastNameLocalized[locale]) {\n      return \"\".concat(firstNameLocalized[locale], \" \").concat(lastNameLocalized[locale]);\n    }\n\n    if (firstNameLocalized[locale]) {\n      return firstNameLocalized[locale];\n    }\n  } // LinkedIn old format\n\n\n  if (!lastName) {\n    return firstName;\n  }\n\n  return \"\".concat(firstName, \" \").concat(lastName);\n};\n\nAccounts.onCreateUser(function (options) {\n  let user = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n  callbacks.run('beforeCreateUser', options, user);\n  user.status = 'offline';\n  user.active = user.active !== undefined ? user.active : !settings.get('Accounts_ManuallyApproveNewUsers');\n\n  if (!user.name) {\n    if (options.profile) {\n      if (options.profile.name) {\n        user.name = options.profile.name;\n      } else if (options.profile.firstName) {\n        // LinkedIn format\n        user.name = getLinkedInName(options.profile);\n      }\n    }\n  }\n\n  if (user.services) {\n    const verified = settings.get('Accounts_Verify_Email_For_External_Accounts');\n\n    for (const service of Object.values(user.services)) {\n      if (!user.name) {\n        user.name = service.name || service.username;\n      }\n\n      if (!user.emails && service.email) {\n        user.emails = [{\n          address: service.email,\n          verified\n        }];\n      }\n    }\n  }\n\n  if (!user.active) {\n    const destinations = [];\n    const usersInRole = Promise.await(Roles.findUsersInRole('admin'));\n    Promise.await(usersInRole.toArray()).forEach(adminUser => {\n      if (Array.isArray(adminUser.emails)) {\n        adminUser.emails.forEach(email => {\n          destinations.push(\"\".concat(adminUser.name, \"<\").concat(email.address, \">\"));\n        });\n      }\n    });\n    const email = {\n      to: destinations,\n      from: settings.get('From_Email'),\n      subject: Accounts.emailTemplates.userToActivate.subject(),\n      html: Accounts.emailTemplates.userToActivate.html(options)\n    };\n    Mailer.send(email);\n  }\n\n  callbacks.run('onCreateUser', options, user);\n  return user;\n});\nAccounts.insertUserDoc = _.wrap(Accounts.insertUserDoc, function (insertUserDoc, options, user) {\n  var _user;\n\n  const noRoles = !((_user = user) !== null && _user !== void 0 && _user.hasOwnProperty('globalRoles'));\n  const globalRoles = [];\n\n  if (Match.test(user.globalRoles, [String]) && user.globalRoles.length > 0) {\n    globalRoles.push(...user.globalRoles);\n  }\n\n  delete user.globalRoles;\n\n  if (user.services && !user.services.password) {\n    const defaultAuthServiceRoles = String(settings.get('Accounts_Registration_AuthenticationServices_Default_Roles')).split(',');\n\n    if (defaultAuthServiceRoles.length > 0) {\n      globalRoles.push(...defaultAuthServiceRoles.map(s => s.trim()));\n    }\n  }\n\n  const roles = getNewUserRoles(globalRoles);\n\n  if (!user.type) {\n    user.type = 'user';\n  }\n\n  if (settings.get('Accounts_TwoFactorAuthentication_By_Email_Auto_Opt_In')) {\n    user.services = user.services || {};\n    user.services.email2fa = {\n      enabled: true,\n      changedAt: new Date()\n    };\n  }\n\n  const _id = insertUserDoc.call(Accounts, options, user);\n\n  user = Meteor.users.findOne({\n    _id\n  });\n\n  if (user.username) {\n    if (options.joinDefaultChannels !== false && user.joinDefaultChannels !== false) {\n      Meteor.runAsUser(_id, function () {\n        return Meteor.call('joinDefaultChannels', options.joinDefaultChannelsSilenced);\n      });\n    }\n\n    if (user.type !== 'visitor') {\n      Meteor.defer(function () {\n        return callbacks.run('afterCreateUser', user);\n      });\n    }\n\n    if (settings.get('Accounts_SetDefaultAvatar') === true) {\n      const avatarSuggestions = Promise.await(getAvatarSuggestionForUser(user));\n      Object.keys(avatarSuggestions).some(service => {\n        const avatarData = avatarSuggestions[service];\n\n        if (service !== 'gravatar') {\n          Meteor.runAsUser(_id, function () {\n            return Meteor.call('setAvatarFromService', avatarData.blob, '', service);\n          });\n          return true;\n        }\n\n        return false;\n      });\n    }\n  }\n\n  if (noRoles || roles.length === 0) {\n    const hasAdmin = Users.findOne({\n      roles: 'admin',\n      type: 'user'\n    }, {\n      fields: {\n        _id: 1\n      }\n    });\n\n    if (hasAdmin) {\n      roles.push('user');\n    } else {\n      roles.push('admin');\n\n      if (settings.get('Show_Setup_Wizard') === 'pending') {\n        Settings.updateValueById('Show_Setup_Wizard', 'in_progress');\n      }\n    }\n  }\n\n  addUserRoles(_id, roles);\n  return _id;\n});\nAccounts.validateLoginAttempt(function (login) {\n  login = callbacks.run('beforeValidateLogin', login);\n\n  if (!Promise.await(isValidLoginAttemptByIp(getClientAddress(login.connection)))) {\n    throw new Meteor.Error('error-login-blocked-for-ip', 'Login has been temporarily blocked For IP', {\n      function: 'Accounts.validateLoginAttempt'\n    });\n  }\n\n  if (!Promise.await(isValidAttemptByUser(login))) {\n    throw new Meteor.Error('error-login-blocked-for-user', 'Login has been temporarily blocked For User', {\n      function: 'Accounts.validateLoginAttempt'\n    });\n  }\n\n  if (login.allowed !== true) {\n    return login.allowed;\n  }\n\n  if (login.user.type === 'visitor') {\n    return true;\n  }\n\n  if (login.user.type === 'app') {\n    throw new Meteor.Error('error-app-user-is-not-allowed-to-login', 'App user is not allowed to login', {\n      function: 'Accounts.validateLoginAttempt'\n    });\n  }\n\n  if (!!login.user.active !== true) {\n    throw new Meteor.Error('error-user-is-not-activated', 'User is not activated', {\n      function: 'Accounts.validateLoginAttempt'\n    });\n  }\n\n  if (!login.user.roles || !Array.isArray(login.user.roles)) {\n    throw new Meteor.Error('error-user-has-no-roles', 'User has no roles', {\n      function: 'Accounts.validateLoginAttempt'\n    });\n  }\n\n  if (login.user.roles.includes('admin') === false && login.type === 'password' && settings.get('Accounts_EmailVerification') === true) {\n    const validEmail = login.user.emails.filter(email => email.verified === true);\n\n    if (validEmail.length === 0) {\n      throw new Meteor.Error('error-invalid-email', 'Invalid email __email__');\n    }\n  }\n\n  login = callbacks.run('onValidateLogin', login);\n  Users.updateLastLoginById(login.user._id);\n  Meteor.defer(function () {\n    return callbacks.run('afterValidateLogin', login);\n  });\n  return true;\n});\nAccounts.validateNewUser(function (user) {\n  if (user.type === 'visitor') {\n    return true;\n  }\n\n  if (settings.get('Accounts_Registration_AuthenticationServices_Enabled') === false && settings.get('LDAP_Enable') === false && !(user.services && user.services.password)) {\n    throw new Meteor.Error('registration-disabled-authentication-services', 'User registration is disabled for authentication services');\n  }\n\n  return true;\n});\nAccounts.validateNewUser(function (user) {\n  var _domainWhiteList;\n\n  if (user.type === 'visitor') {\n    return true;\n  }\n\n  let domainWhiteList = settings.get('Accounts_AllowedDomainsList');\n\n  if (_.isEmpty((_domainWhiteList = domainWhiteList) === null || _domainWhiteList === void 0 ? void 0 : _domainWhiteList.trim())) {\n    return true;\n  }\n\n  domainWhiteList = domainWhiteList.split(',').map(domain => domain.trim());\n\n  if (user.emails && user.emails.length > 0) {\n    const email = user.emails[0].address;\n    const inWhiteList = domainWhiteList.some(domain => email.match(\"@\".concat(escapeRegExp(domain), \"$\")));\n\n    if (inWhiteList === false) {\n      throw new Meteor.Error('error-invalid-domain');\n    }\n  }\n\n  return true;\n});\nconst MAX_RESUME_LOGIN_TOKENS = parseInt(process.env.MAX_RESUME_LOGIN_TOKENS) || 50;\nAccounts.onLogin(_ref4 => Promise.asyncApply(() => {\n  let {\n    user\n  } = _ref4;\n\n  if (!user || !user.services || !user.services.resume || !user.services.resume.loginTokens) {\n    return;\n  }\n\n  if (user.services.resume.loginTokens.length < MAX_RESUME_LOGIN_TOKENS) {\n    return;\n  }\n\n  const {\n    tokens\n  } = Promise.await(UsersRaw.findAllResumeTokensByUserId(user._id))[0];\n\n  if (tokens.length >= MAX_RESUME_LOGIN_TOKENS) {\n    const oldestDate = tokens.reverse()[MAX_RESUME_LOGIN_TOKENS - 1];\n    Users.removeOlderResumeTokensByUserId(user._id, oldestDate.when);\n  }\n}));","map":{"version":3,"sources":["app/authentication/server/startup/index.js"],"names":["module","export","MAX_RESUME_LOGIN_TOKENS","Meteor","link","v","Match","Accounts","TAPi18n","_","default","escapeRegExp","escapeHTML","Mailer","settings","callbacks","Users","Settings","Roles","UsersRaw","addUserRoles","getAvatarSuggestionForUser","isValidAttemptByUser","isValidLoginAttemptByIp","getClientAddress","getNewUserRoles","config","forbidClientAccountCreation","startup","watchMultiple","_options","loginExpirationInDays","get","emailTemplates","siteName","from","userToActivate","subject","__","html","options","email","reason","replace","name","userActivated","active","username","activated","action","verifyEmailTemplate","enrollAccountTemplate","resetPasswordTemplate","getTemplateWrapped","value","verifyEmail","userModel","url","Verification_Url","urls","resetPassword","token","absoluteUrl","replacekey","enrollAccount","user","emails","address","getLinkedInName","firstName","lastName","preferredLocale","localized","firstNameLocalized","lastNameLocalized","language","country","locale","onCreateUser","run","status","undefined","profile","services","verified","service","Object","values","destinations","usersInRole","Promise","await","findUsersInRole","toArray","forEach","adminUser","Array","isArray","push","to","send","insertUserDoc","wrap","noRoles","hasOwnProperty","globalRoles","test","String","length","password","defaultAuthServiceRoles","split","map","s","trim","roles","type","email2fa","enabled","changedAt","Date","_id","call","users","findOne","joinDefaultChannels","runAsUser","joinDefaultChannelsSilenced","defer","avatarSuggestions","keys","some","avatarData","blob","hasAdmin","fields","updateValueById","validateLoginAttempt","login","connection","Error","function","allowed","includes","validEmail","filter","updateLastLoginById","validateNewUser","domainWhiteList","isEmpty","domain","inWhiteList","match","parseInt","process","env","onLogin","resume","loginTokens","tokens","findAllResumeTokensByUserId","oldestDate","reverse","removeOlderResumeTokensByUserId","when"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { Match } from 'meteor/check';\nimport { Accounts } from 'meteor/accounts-base';\nimport { TAPi18n } from 'meteor/rocketchat:tap-i18n';\nimport _ from 'underscore';\nimport { escapeRegExp, escapeHTML } from '@rocket.chat/string-helpers';\n\nimport * as Mailer from '../../../mailer/server/api';\nimport { settings } from '../../../settings/server';\nimport { callbacks } from '../../../../lib/callbacks';\nimport { Users, Settings } from '../../../models/server';\nimport { Roles, Users as UsersRaw } from '../../../models/server/raw';\nimport { addUserRoles } from '../../../authorization/server';\nimport { getAvatarSuggestionForUser } from '../../../lib/server/functions/getAvatarSuggestionForUser';\nimport { isValidAttemptByUser, isValidLoginAttemptByIp } from '../lib/restrictLoginAttempts';\nimport './settings';\nimport { getClientAddress } from '../../../../server/lib/getClientAddress';\nimport { getNewUserRoles } from '../../../../server/services/user/lib/getNewUserRoles';\n\nAccounts.config({\n\tforbidClientAccountCreation: true,\n});\n\nMeteor.startup(() => {\n\tsettings.watchMultiple(['Accounts_LoginExpiration', 'Site_Name', 'From_Email'], () => {\n\t\tAccounts._options.loginExpirationInDays = settings.get('Accounts_LoginExpiration');\n\n\t\tAccounts.emailTemplates.siteName = settings.get('Site_Name');\n\n\t\tAccounts.emailTemplates.from = `${settings.get('Site_Name')} <${settings.get('From_Email')}>`;\n\t});\n});\n\nAccounts.emailTemplates.userToActivate = {\n\tsubject() {\n\t\tconst subject = TAPi18n.__('Accounts_Admin_Email_Approval_Needed_Subject_Default');\n\t\tconst siteName = settings.get('Site_Name');\n\n\t\treturn `[${siteName}] ${subject}`;\n\t},\n\n\thtml(options = {}) {\n\t\tconst email = options.reason\n\t\t\t? 'Accounts_Admin_Email_Approval_Needed_With_Reason_Default'\n\t\t\t: 'Accounts_Admin_Email_Approval_Needed_Default';\n\n\t\treturn Mailer.replace(TAPi18n.__(email), {\n\t\t\tname: escapeHTML(options.name),\n\t\t\temail: escapeHTML(options.email),\n\t\t\treason: escapeHTML(options.reason),\n\t\t});\n\t},\n};\n\nAccounts.emailTemplates.userActivated = {\n\tsubject({ active, username }) {\n\t\tconst activated = username ? 'Activated' : 'Approved';\n\t\tconst action = active ? activated : 'Deactivated';\n\t\tconst subject = `Accounts_Email_${action}_Subject`;\n\t\tconst siteName = settings.get('Site_Name');\n\n\t\treturn `[${siteName}] ${TAPi18n.__(subject)}`;\n\t},\n\n\thtml({ active, name, username }) {\n\t\tconst activated = username ? 'Activated' : 'Approved';\n\t\tconst action = active ? activated : 'Deactivated';\n\n\t\treturn Mailer.replace(TAPi18n.__(`Accounts_Email_${action}`), {\n\t\t\tname: escapeHTML(name),\n\t\t});\n\t},\n};\n\nlet verifyEmailTemplate = '';\nlet enrollAccountTemplate = '';\nlet resetPasswordTemplate = '';\nMeteor.startup(() => {\n\tMailer.getTemplateWrapped('Verification_Email', (value) => {\n\t\tverifyEmailTemplate = value;\n\t});\n\tMailer.getTemplateWrapped('Accounts_Enrollment_Email', (value) => {\n\t\tenrollAccountTemplate = value;\n\t});\n\tMailer.getTemplateWrapped('Forgot_Password_Email', (value) => {\n\t\tresetPasswordTemplate = value;\n\t});\n});\n\nAccounts.emailTemplates.verifyEmail.html = function (userModel, url) {\n\treturn Mailer.replace(verifyEmailTemplate, { Verification_Url: url, name: userModel.name });\n};\n\nAccounts.emailTemplates.verifyEmail.subject = function () {\n\tconst subject = settings.get('Verification_Email_Subject');\n\treturn Mailer.replace(subject || '');\n};\n\nAccounts.urls.resetPassword = function (token) {\n\treturn Meteor.absoluteUrl(`reset-password/${token}`);\n};\n\nAccounts.emailTemplates.resetPassword.subject = function (userModel) {\n\treturn Mailer.replace(settings.get('Forgot_Password_Email_Subject') || '', {\n\t\tname: userModel.name,\n\t});\n};\n\nAccounts.emailTemplates.resetPassword.html = function (userModel, url) {\n\treturn Mailer.replacekey(\n\t\tMailer.replace(resetPasswordTemplate, {\n\t\t\tname: userModel.name,\n\t\t}),\n\t\t'Forgot_Password_Url',\n\t\turl,\n\t);\n};\n\nAccounts.emailTemplates.enrollAccount.subject = function (user) {\n\tconst subject = settings.get('Accounts_Enrollment_Email_Subject');\n\treturn Mailer.replace(subject, user);\n};\n\nAccounts.emailTemplates.enrollAccount.html = function (user = {} /* , url*/) {\n\treturn Mailer.replace(enrollAccountTemplate, {\n\t\tname: escapeHTML(user.name),\n\t\temail: user.emails && user.emails[0] && escapeHTML(user.emails[0].address),\n\t});\n};\n\nconst getLinkedInName = ({ firstName, lastName }) => {\n\tconst { preferredLocale, localized: firstNameLocalized } = firstName;\n\tconst { localized: lastNameLocalized } = lastName;\n\n\t// LinkedIn new format\n\tif (preferredLocale && firstNameLocalized && preferredLocale.language && preferredLocale.country) {\n\t\tconst locale = `${preferredLocale.language}_${preferredLocale.country}`;\n\n\t\tif (firstNameLocalized[locale] && lastNameLocalized[locale]) {\n\t\t\treturn `${firstNameLocalized[locale]} ${lastNameLocalized[locale]}`;\n\t\t}\n\t\tif (firstNameLocalized[locale]) {\n\t\t\treturn firstNameLocalized[locale];\n\t\t}\n\t}\n\n\t// LinkedIn old format\n\tif (!lastName) {\n\t\treturn firstName;\n\t}\n\treturn `${firstName} ${lastName}`;\n};\n\nAccounts.onCreateUser(function (options, user = {}) {\n\tcallbacks.run('beforeCreateUser', options, user);\n\n\tuser.status = 'offline';\n\tuser.active = user.active !== undefined ? user.active : !settings.get('Accounts_ManuallyApproveNewUsers');\n\n\tif (!user.name) {\n\t\tif (options.profile) {\n\t\t\tif (options.profile.name) {\n\t\t\t\tuser.name = options.profile.name;\n\t\t\t} else if (options.profile.firstName) {\n\t\t\t\t// LinkedIn format\n\t\t\t\tuser.name = getLinkedInName(options.profile);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (user.services) {\n\t\tconst verified = settings.get('Accounts_Verify_Email_For_External_Accounts');\n\n\t\tfor (const service of Object.values(user.services)) {\n\t\t\tif (!user.name) {\n\t\t\t\tuser.name = service.name || service.username;\n\t\t\t}\n\n\t\t\tif (!user.emails && service.email) {\n\t\t\t\tuser.emails = [\n\t\t\t\t\t{\n\t\t\t\t\t\taddress: service.email,\n\t\t\t\t\t\tverified,\n\t\t\t\t\t},\n\t\t\t\t];\n\t\t\t}\n\t\t}\n\t}\n\n\tif (!user.active) {\n\t\tconst destinations = [];\n\t\tconst usersInRole = Promise.await(Roles.findUsersInRole('admin'));\n\t\tPromise.await(usersInRole.toArray()).forEach((adminUser) => {\n\t\t\tif (Array.isArray(adminUser.emails)) {\n\t\t\t\tadminUser.emails.forEach((email) => {\n\t\t\t\t\tdestinations.push(`${adminUser.name}<${email.address}>`);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tconst email = {\n\t\t\tto: destinations,\n\t\t\tfrom: settings.get('From_Email'),\n\t\t\tsubject: Accounts.emailTemplates.userToActivate.subject(),\n\t\t\thtml: Accounts.emailTemplates.userToActivate.html(options),\n\t\t};\n\n\t\tMailer.send(email);\n\t}\n\n\tcallbacks.run('onCreateUser', options, user);\n\treturn user;\n});\n\nAccounts.insertUserDoc = _.wrap(Accounts.insertUserDoc, function (insertUserDoc, options, user) {\n\tconst noRoles = !user?.hasOwnProperty('globalRoles');\n\n\tconst globalRoles = [];\n\n\tif (Match.test(user.globalRoles, [String]) && user.globalRoles.length > 0) {\n\t\tglobalRoles.push(...user.globalRoles);\n\t}\n\n\tdelete user.globalRoles;\n\n\tif (user.services && !user.services.password) {\n\t\tconst defaultAuthServiceRoles = String(settings.get('Accounts_Registration_AuthenticationServices_Default_Roles')).split(',');\n\t\tif (defaultAuthServiceRoles.length > 0) {\n\t\t\tglobalRoles.push(...defaultAuthServiceRoles.map((s) => s.trim()));\n\t\t}\n\t}\n\n\tconst roles = getNewUserRoles(globalRoles);\n\n\tif (!user.type) {\n\t\tuser.type = 'user';\n\t}\n\n\tif (settings.get('Accounts_TwoFactorAuthentication_By_Email_Auto_Opt_In')) {\n\t\tuser.services = user.services || {};\n\t\tuser.services.email2fa = {\n\t\t\tenabled: true,\n\t\t\tchangedAt: new Date(),\n\t\t};\n\t}\n\n\tconst _id = insertUserDoc.call(Accounts, options, user);\n\n\tuser = Meteor.users.findOne({\n\t\t_id,\n\t});\n\n\tif (user.username) {\n\t\tif (options.joinDefaultChannels !== false && user.joinDefaultChannels !== false) {\n\t\t\tMeteor.runAsUser(_id, function () {\n\t\t\t\treturn Meteor.call('joinDefaultChannels', options.joinDefaultChannelsSilenced);\n\t\t\t});\n\t\t}\n\n\t\tif (user.type !== 'visitor') {\n\t\t\tMeteor.defer(function () {\n\t\t\t\treturn callbacks.run('afterCreateUser', user);\n\t\t\t});\n\t\t}\n\t\tif (settings.get('Accounts_SetDefaultAvatar') === true) {\n\t\t\tconst avatarSuggestions = Promise.await(getAvatarSuggestionForUser(user));\n\t\t\tObject.keys(avatarSuggestions).some((service) => {\n\t\t\t\tconst avatarData = avatarSuggestions[service];\n\t\t\t\tif (service !== 'gravatar') {\n\t\t\t\t\tMeteor.runAsUser(_id, function () {\n\t\t\t\t\t\treturn Meteor.call('setAvatarFromService', avatarData.blob, '', service);\n\t\t\t\t\t});\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t});\n\t\t}\n\t}\n\n\tif (noRoles || roles.length === 0) {\n\t\tconst hasAdmin = Users.findOne(\n\t\t\t{\n\t\t\t\troles: 'admin',\n\t\t\t\ttype: 'user',\n\t\t\t},\n\t\t\t{\n\t\t\t\tfields: {\n\t\t\t\t\t_id: 1,\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\n\t\tif (hasAdmin) {\n\t\t\troles.push('user');\n\t\t} else {\n\t\t\troles.push('admin');\n\t\t\tif (settings.get('Show_Setup_Wizard') === 'pending') {\n\t\t\t\tSettings.updateValueById('Show_Setup_Wizard', 'in_progress');\n\t\t\t}\n\t\t}\n\t}\n\n\taddUserRoles(_id, roles);\n\n\treturn _id;\n});\n\nAccounts.validateLoginAttempt(function (login) {\n\tlogin = callbacks.run('beforeValidateLogin', login);\n\n\tif (!Promise.await(isValidLoginAttemptByIp(getClientAddress(login.connection)))) {\n\t\tthrow new Meteor.Error('error-login-blocked-for-ip', 'Login has been temporarily blocked For IP', {\n\t\t\tfunction: 'Accounts.validateLoginAttempt',\n\t\t});\n\t}\n\n\tif (!Promise.await(isValidAttemptByUser(login))) {\n\t\tthrow new Meteor.Error('error-login-blocked-for-user', 'Login has been temporarily blocked For User', {\n\t\t\tfunction: 'Accounts.validateLoginAttempt',\n\t\t});\n\t}\n\n\tif (login.allowed !== true) {\n\t\treturn login.allowed;\n\t}\n\n\tif (login.user.type === 'visitor') {\n\t\treturn true;\n\t}\n\n\tif (login.user.type === 'app') {\n\t\tthrow new Meteor.Error('error-app-user-is-not-allowed-to-login', 'App user is not allowed to login', {\n\t\t\tfunction: 'Accounts.validateLoginAttempt',\n\t\t});\n\t}\n\n\tif (!!login.user.active !== true) {\n\t\tthrow new Meteor.Error('error-user-is-not-activated', 'User is not activated', {\n\t\t\tfunction: 'Accounts.validateLoginAttempt',\n\t\t});\n\t}\n\n\tif (!login.user.roles || !Array.isArray(login.user.roles)) {\n\t\tthrow new Meteor.Error('error-user-has-no-roles', 'User has no roles', {\n\t\t\tfunction: 'Accounts.validateLoginAttempt',\n\t\t});\n\t}\n\n\tif (login.user.roles.includes('admin') === false && login.type === 'password' && settings.get('Accounts_EmailVerification') === true) {\n\t\tconst validEmail = login.user.emails.filter((email) => email.verified === true);\n\t\tif (validEmail.length === 0) {\n\t\t\tthrow new Meteor.Error('error-invalid-email', 'Invalid email __email__');\n\t\t}\n\t}\n\n\tlogin = callbacks.run('onValidateLogin', login);\n\n\tUsers.updateLastLoginById(login.user._id);\n\tMeteor.defer(function () {\n\t\treturn callbacks.run('afterValidateLogin', login);\n\t});\n\n\treturn true;\n});\n\nAccounts.validateNewUser(function (user) {\n\tif (user.type === 'visitor') {\n\t\treturn true;\n\t}\n\n\tif (\n\t\tsettings.get('Accounts_Registration_AuthenticationServices_Enabled') === false &&\n\t\tsettings.get('LDAP_Enable') === false &&\n\t\t!(user.services && user.services.password)\n\t) {\n\t\tthrow new Meteor.Error('registration-disabled-authentication-services', 'User registration is disabled for authentication services');\n\t}\n\n\treturn true;\n});\n\nAccounts.validateNewUser(function (user) {\n\tif (user.type === 'visitor') {\n\t\treturn true;\n\t}\n\n\tlet domainWhiteList = settings.get('Accounts_AllowedDomainsList');\n\tif (_.isEmpty(domainWhiteList?.trim())) {\n\t\treturn true;\n\t}\n\n\tdomainWhiteList = domainWhiteList.split(',').map((domain) => domain.trim());\n\n\tif (user.emails && user.emails.length > 0) {\n\t\tconst email = user.emails[0].address;\n\t\tconst inWhiteList = domainWhiteList.some((domain) => email.match(`@${escapeRegExp(domain)}$`));\n\n\t\tif (inWhiteList === false) {\n\t\t\tthrow new Meteor.Error('error-invalid-domain');\n\t\t}\n\t}\n\n\treturn true;\n});\n\nexport const MAX_RESUME_LOGIN_TOKENS = parseInt(process.env.MAX_RESUME_LOGIN_TOKENS) || 50;\n\nAccounts.onLogin(async ({ user }) => {\n\tif (!user || !user.services || !user.services.resume || !user.services.resume.loginTokens) {\n\t\treturn;\n\t}\n\tif (user.services.resume.loginTokens.length < MAX_RESUME_LOGIN_TOKENS) {\n\t\treturn;\n\t}\n\tconst { tokens } = (await UsersRaw.findAllResumeTokensByUserId(user._id))[0];\n\tif (tokens.length >= MAX_RESUME_LOGIN_TOKENS) {\n\t\tconst oldestDate = tokens.reverse()[MAX_RESUME_LOGIN_TOKENS - 1];\n\t\tUsers.removeOlderResumeTokensByUserId(user._id, oldestDate.when);\n\t}\n});\n"]},"sourceType":"module","hash":"0750c71cda11ea233cfaca37aeffe35f6281e08d"}
