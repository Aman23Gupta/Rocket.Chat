{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/threads/server/hooks/aftersavemessage.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/threads/server/hooks/aftersavemessage.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/threads/server/hooks/aftersavemessage.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/threads/server/hooks/aftersavemessage.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/threads/server/hooks/aftersavemessage.js"}},"code":"module.export({\n  processThreads: () => processThreads\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet Messages;\nmodule.link(\"../../../models/server\", {\n  Messages(v) {\n    Messages = v;\n  }\n\n}, 1);\nlet callbacks;\nmodule.link(\"../../../../lib/callbacks\", {\n  callbacks(v) {\n    callbacks = v;\n  }\n\n}, 2);\nlet settings;\nmodule.link(\"../../../settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 3);\nlet reply;\nmodule.link(\"../functions\", {\n  reply(v) {\n    reply = v;\n  }\n\n}, 4);\nlet updateThreadUsersSubscriptions, getMentions;\nmodule.link(\"../../../lib/server/lib/notifyUsersOnMessage\", {\n  updateThreadUsersSubscriptions(v) {\n    updateThreadUsersSubscriptions = v;\n  },\n\n  getMentions(v) {\n    getMentions = v;\n  }\n\n}, 5);\nlet sendMessageNotifications;\nmodule.link(\"../../../lib/server/lib/sendNotificationsOnMessage\", {\n  sendMessageNotifications(v) {\n    sendMessageNotifications = v;\n  }\n\n}, 6);\n\nfunction notifyUsersOnReply(message, replies, room) {\n  // skips this callback if the message was edited\n  if (message.editedAt) {\n    return message;\n  }\n\n  updateThreadUsersSubscriptions(message, room, replies);\n  return message;\n}\n\nconst metaData = (message, parentMessage, followers) => {\n  reply({\n    tmid: message.tmid\n  }, message, parentMessage, followers);\n  return message;\n};\n\nconst notification = (message, room, replies) => {\n  // skips this callback if the message was edited\n  if (message.editedAt) {\n    return message;\n  } // will send a notification to everyone who replied/followed the thread except the owner of the message\n\n\n  sendMessageNotifications(message, room, replies);\n  return message;\n};\n\nconst processThreads = (message, room) => {\n  if (!message.tmid) {\n    return message;\n  }\n\n  const parentMessage = Messages.findOneById(message.tmid);\n\n  if (!parentMessage) {\n    return message;\n  }\n\n  const {\n    mentionIds\n  } = getMentions(message);\n  const replies = [...new Set([...((!parentMessage.tcount ? [parentMessage.u._id] : parentMessage.replies) || []), ...(!parentMessage.tcount && room.t === 'd' ? room.uids : []), ...mentionIds])].filter(userId => userId !== message.u._id);\n  notifyUsersOnReply(message, replies, room);\n  metaData(message, parentMessage, replies);\n  notification(message, room, replies);\n  return message;\n};\n\nMeteor.startup(function () {\n  settings.watch('Threads_enabled', function (value) {\n    if (!value) {\n      callbacks.remove('afterSaveMessage', 'threads-after-save-message');\n      return;\n    }\n\n    callbacks.add('afterSaveMessage', processThreads, callbacks.priority.LOW, 'threads-after-save-message');\n  });\n});","map":{"version":3,"sources":["app/threads/server/hooks/aftersavemessage.js"],"names":["module","export","processThreads","Meteor","link","v","Messages","callbacks","settings","reply","updateThreadUsersSubscriptions","getMentions","sendMessageNotifications","notifyUsersOnReply","message","replies","room","editedAt","metaData","parentMessage","followers","tmid","notification","findOneById","mentionIds","Set","tcount","u","_id","t","uids","filter","userId","startup","watch","value","remove","add","priority","LOW"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\n\nimport { Messages } from '../../../models/server';\nimport { callbacks } from '../../../../lib/callbacks';\nimport { settings } from '../../../settings/server';\nimport { reply } from '../functions';\nimport { updateThreadUsersSubscriptions, getMentions } from '../../../lib/server/lib/notifyUsersOnMessage';\nimport { sendMessageNotifications } from '../../../lib/server/lib/sendNotificationsOnMessage';\n\nfunction notifyUsersOnReply(message, replies, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\tupdateThreadUsersSubscriptions(message, room, replies);\n\n\treturn message;\n}\n\nconst metaData = (message, parentMessage, followers) => {\n\treply({ tmid: message.tmid }, message, parentMessage, followers);\n\n\treturn message;\n};\n\nconst notification = (message, room, replies) => {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\t// will send a notification to everyone who replied/followed the thread except the owner of the message\n\tsendMessageNotifications(message, room, replies);\n\n\treturn message;\n};\n\nexport const processThreads = (message, room) => {\n\tif (!message.tmid) {\n\t\treturn message;\n\t}\n\n\tconst parentMessage = Messages.findOneById(message.tmid);\n\tif (!parentMessage) {\n\t\treturn message;\n\t}\n\n\tconst { mentionIds } = getMentions(message);\n\n\tconst replies = [\n\t\t...new Set([\n\t\t\t...((!parentMessage.tcount ? [parentMessage.u._id] : parentMessage.replies) || []),\n\t\t\t...(!parentMessage.tcount && room.t === 'd' ? room.uids : []),\n\t\t\t...mentionIds,\n\t\t]),\n\t].filter((userId) => userId !== message.u._id);\n\n\tnotifyUsersOnReply(message, replies, room);\n\tmetaData(message, parentMessage, replies);\n\tnotification(message, room, replies);\n\n\treturn message;\n};\n\nMeteor.startup(function () {\n\tsettings.watch('Threads_enabled', function (value) {\n\t\tif (!value) {\n\t\t\tcallbacks.remove('afterSaveMessage', 'threads-after-save-message');\n\t\t\treturn;\n\t\t}\n\t\tcallbacks.add('afterSaveMessage', processThreads, callbacks.priority.LOW, 'threads-after-save-message');\n\t});\n});\n"]},"sourceType":"module","hash":"b1488fda4d8d3e6a6a39e6207d43bbaf768e4104"}
