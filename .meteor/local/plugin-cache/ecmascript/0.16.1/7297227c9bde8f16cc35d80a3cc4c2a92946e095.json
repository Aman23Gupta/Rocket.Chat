{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/file-upload/server/lib/proxy.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/file-upload/server/lib/proxy.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/file-upload/server/lib/proxy.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/file-upload/server/lib/proxy.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/file-upload/server/lib/proxy.js"}},"code":"let http;\nmodule.link(\"http\", {\n  default(v) {\n    http = v;\n  }\n\n}, 0);\nlet URL;\nmodule.link(\"url\", {\n  default(v) {\n    URL = v;\n  }\n\n}, 1);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 2);\nlet WebApp;\nmodule.link(\"meteor/webapp\", {\n  WebApp(v) {\n    WebApp = v;\n  }\n\n}, 3);\nlet UploadFS;\nmodule.link(\"meteor/jalik:ufs\", {\n  UploadFS(v) {\n    UploadFS = v;\n  }\n\n}, 4);\nlet InstanceStatus;\nmodule.link(\"meteor/konecty:multiple-instances-status\", {\n  InstanceStatus(v) {\n    InstanceStatus = v;\n  }\n\n}, 5);\nlet Logger;\nmodule.link(\"../../../logger\", {\n  Logger(v) {\n    Logger = v;\n  }\n\n}, 6);\nlet isDocker;\nmodule.link(\"../../../utils\", {\n  isDocker(v) {\n    isDocker = v;\n  }\n\n}, 7);\nconst logger = new Logger('UploadProxy');\nWebApp.connectHandlers.stack.unshift({\n  route: '',\n  handle: Meteor.bindEnvironment(function (req, res, next) {\n    // Quick check to see if request should be catch\n    if (!req.url.includes(\"/\".concat(UploadFS.config.storesPath, \"/\"))) {\n      return next();\n    }\n\n    logger.debug({\n      msg: 'Upload URL:',\n      url: req.url\n    });\n\n    if (req.method !== 'POST') {\n      return next();\n    } // Remove store path\n\n\n    const parsedUrl = URL.parse(req.url);\n    const path = parsedUrl.pathname.substr(UploadFS.config.storesPath.length + 1); // Get store\n\n    const regExp = new RegExp('^/([^/?]+)/([^/?]+)$');\n    const match = regExp.exec(path); // Request is not valid\n\n    if (match === null) {\n      res.writeHead(400);\n      res.end();\n      return;\n    } // Get store\n\n\n    const store = UploadFS.getStore(match[1]);\n\n    if (!store) {\n      res.writeHead(404);\n      res.end();\n      return;\n    } // Get file\n\n\n    const fileId = match[2];\n    const file = store.getCollection().findOne({\n      _id: fileId\n    });\n\n    if (file === undefined) {\n      res.writeHead(404);\n      res.end();\n      return;\n    }\n\n    if (file.instanceId === InstanceStatus.id()) {\n      logger.debug('Correct instance');\n      return next();\n    } // Proxy to other instance\n\n\n    const instance = InstanceStatus.getCollection().findOne({\n      _id: file.instanceId\n    });\n\n    if (instance == null) {\n      res.writeHead(404);\n      res.end();\n      return;\n    }\n\n    if (instance.extraInformation.host === process.env.INSTANCE_IP && isDocker() === false) {\n      instance.extraInformation.host = 'localhost';\n    }\n\n    logger.debug(\"Wrong instance, proxing to \".concat(instance.extraInformation.host, \":\").concat(instance.extraInformation.port));\n    const options = {\n      hostname: instance.extraInformation.host,\n      port: instance.extraInformation.port,\n      path: req.originalUrl,\n      method: 'POST'\n    };\n    logger.warn('UFS proxy middleware is deprecated as this upload method is not being used by Web/Mobile Clients. See this: https://docs.rocket.chat/api/rest-api/methods/rooms/upload');\n    const proxy = http.request(options, function (proxy_res) {\n      proxy_res.pipe(res, {\n        end: true\n      });\n    });\n    req.pipe(proxy, {\n      end: true\n    });\n  })\n});","map":{"version":3,"sources":["app/file-upload/server/lib/proxy.js"],"names":["http","module","link","default","v","URL","Meteor","WebApp","UploadFS","InstanceStatus","Logger","isDocker","logger","connectHandlers","stack","unshift","route","handle","bindEnvironment","req","res","next","url","includes","config","storesPath","debug","msg","method","parsedUrl","parse","path","pathname","substr","length","regExp","RegExp","match","exec","writeHead","end","store","getStore","fileId","file","getCollection","findOne","_id","undefined","instanceId","id","instance","extraInformation","host","process","env","INSTANCE_IP","port","options","hostname","originalUrl","warn","proxy","request","proxy_res","pipe"],"mappings":"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","sourcesContent":["import http from 'http';\nimport URL from 'url';\n\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\nimport { UploadFS } from 'meteor/jalik:ufs';\nimport { InstanceStatus } from 'meteor/konecty:multiple-instances-status';\n\nimport { Logger } from '../../../logger';\nimport { isDocker } from '../../../utils';\n\nconst logger = new Logger('UploadProxy');\n\nWebApp.connectHandlers.stack.unshift({\n\troute: '',\n\thandle: Meteor.bindEnvironment(function (req, res, next) {\n\t\t// Quick check to see if request should be catch\n\t\tif (!req.url.includes(`/${UploadFS.config.storesPath}/`)) {\n\t\t\treturn next();\n\t\t}\n\n\t\tlogger.debug({ msg: 'Upload URL:', url: req.url });\n\n\t\tif (req.method !== 'POST') {\n\t\t\treturn next();\n\t\t}\n\n\t\t// Remove store path\n\t\tconst parsedUrl = URL.parse(req.url);\n\t\tconst path = parsedUrl.pathname.substr(UploadFS.config.storesPath.length + 1);\n\n\t\t// Get store\n\t\tconst regExp = new RegExp('^/([^/?]+)/([^/?]+)$');\n\t\tconst match = regExp.exec(path);\n\n\t\t// Request is not valid\n\t\tif (match === null) {\n\t\t\tres.writeHead(400);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get store\n\t\tconst store = UploadFS.getStore(match[1]);\n\t\tif (!store) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get file\n\t\tconst fileId = match[2];\n\t\tconst file = store.getCollection().findOne({ _id: fileId });\n\t\tif (file === undefined) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tif (file.instanceId === InstanceStatus.id()) {\n\t\t\tlogger.debug('Correct instance');\n\t\t\treturn next();\n\t\t}\n\n\t\t// Proxy to other instance\n\t\tconst instance = InstanceStatus.getCollection().findOne({ _id: file.instanceId });\n\n\t\tif (instance == null) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tif (instance.extraInformation.host === process.env.INSTANCE_IP && isDocker() === false) {\n\t\t\tinstance.extraInformation.host = 'localhost';\n\t\t}\n\n\t\tlogger.debug(`Wrong instance, proxing to ${instance.extraInformation.host}:${instance.extraInformation.port}`);\n\n\t\tconst options = {\n\t\t\thostname: instance.extraInformation.host,\n\t\t\tport: instance.extraInformation.port,\n\t\t\tpath: req.originalUrl,\n\t\t\tmethod: 'POST',\n\t\t};\n\n\t\tlogger.warn(\n\t\t\t'UFS proxy middleware is deprecated as this upload method is not being used by Web/Mobile Clients. See this: https://docs.rocket.chat/api/rest-api/methods/rooms/upload',\n\t\t);\n\t\tconst proxy = http.request(options, function (proxy_res) {\n\t\t\tproxy_res.pipe(res, {\n\t\t\t\tend: true,\n\t\t\t});\n\t\t});\n\n\t\treq.pipe(proxy, {\n\t\t\tend: true,\n\t\t});\n\t}),\n});\n"]},"sourceType":"module","hash":"7297227c9bde8f16cc35d80a3cc4c2a92946e095"}
