{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/lib/server/methods/sendMessage.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/lib/server/methods/sendMessage.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/lib/server/methods/sendMessage.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/lib/server/methods/sendMessage.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/lib/server/methods/sendMessage.js"}},"code":"module.export({\n  executeSendMessage: () => executeSendMessage\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet check;\nmodule.link(\"meteor/check\", {\n  check(v) {\n    check = v;\n  }\n\n}, 1);\nlet TAPi18n;\nmodule.link(\"meteor/rocketchat:tap-i18n\", {\n  TAPi18n(v) {\n    TAPi18n = v;\n  }\n\n}, 2);\nlet moment;\nmodule.link(\"moment\", {\n  default(v) {\n    moment = v;\n  }\n\n}, 3);\nlet hasPermission;\nmodule.link(\"../../../authorization\", {\n  hasPermission(v) {\n    hasPermission = v;\n  }\n\n}, 4);\nlet metrics;\nmodule.link(\"../../../metrics\", {\n  metrics(v) {\n    metrics = v;\n  }\n\n}, 5);\nlet settings;\nmodule.link(\"../../../settings\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 6);\nlet messageProperties;\nmodule.link(\"../../../ui-utils\", {\n  messageProperties(v) {\n    messageProperties = v;\n  }\n\n}, 7);\nlet Users, Messages;\nmodule.link(\"../../../models\", {\n  Users(v) {\n    Users = v;\n  },\n\n  Messages(v) {\n    Messages = v;\n  }\n\n}, 8);\nlet sendMessage;\nmodule.link(\"../functions\", {\n  sendMessage(v) {\n    sendMessage = v;\n  }\n\n}, 9);\nlet RateLimiter;\nmodule.link(\"../lib\", {\n  RateLimiter(v) {\n    RateLimiter = v;\n  }\n\n}, 10);\nlet canSendMessage;\nmodule.link(\"../../../authorization/server\", {\n  canSendMessage(v) {\n    canSendMessage = v;\n  }\n\n}, 11);\nlet SystemLogger;\nmodule.link(\"../../../../server/lib/logger/system\", {\n  SystemLogger(v) {\n    SystemLogger = v;\n  }\n\n}, 12);\nlet api;\nmodule.link(\"../../../../server/sdk/api\", {\n  api(v) {\n    api = v;\n  }\n\n}, 13);\n\nfunction executeSendMessage(uid, message) {\n  if (message.tshow && !message.tmid) {\n    throw new Meteor.Error('invalid-params', 'tshow provided but missing tmid', {\n      method: 'sendMessage'\n    });\n  }\n\n  if (message.tmid && !settings.get('Threads_enabled')) {\n    throw new Meteor.Error('error-not-allowed', 'not-allowed', {\n      method: 'sendMessage'\n    });\n  }\n\n  if (message.ts) {\n    const tsDiff = Math.abs(moment(message.ts).diff());\n\n    if (tsDiff > 60000) {\n      throw new Meteor.Error('error-message-ts-out-of-sync', 'Message timestamp is out of sync', {\n        method: 'sendMessage',\n        message_ts: message.ts,\n        server_ts: new Date().getTime()\n      });\n    } else if (tsDiff > 10000) {\n      message.ts = new Date();\n    }\n  } else {\n    message.ts = new Date();\n  }\n\n  if (message.msg) {\n    const adjustedMessage = messageProperties.messageWithoutEmojiShortnames(message.msg);\n\n    if (messageProperties.length(adjustedMessage) > settings.get('Message_MaxAllowedSize')) {\n      throw new Meteor.Error('error-message-size-exceeded', 'Message size exceeds Message_MaxAllowedSize', {\n        method: 'sendMessage'\n      });\n    }\n  }\n\n  const user = Users.findOneById(uid, {\n    fields: {\n      username: 1,\n      type: 1,\n      name: 1\n    }\n  });\n  let {\n    rid\n  } = message; // do not allow nested threads\n\n  if (message.tmid) {\n    const parentMessage = Messages.findOneById(message.tmid);\n    message.tmid = parentMessage.tmid || message.tmid;\n    rid = parentMessage.rid;\n  }\n\n  if (!rid) {\n    throw new Error(\"The 'rid' property on the message object is missing.\");\n  }\n\n  try {\n    const room = canSendMessage(rid, {\n      uid,\n      username: user.username,\n      type: user.type\n    });\n    metrics.messagesSent.inc(); // TODO This line needs to be moved to it's proper place. See the comments on: https://github.com/RocketChat/Rocket.Chat/pull/5736\n\n    return sendMessage(user, message, room, false);\n  } catch (error) {\n    SystemLogger.error('Error sending message:', error);\n    const errorMessage = typeof error === 'string' ? error : error.error || error.message;\n    api.broadcast('notify.ephemeralMessage', uid, message.rid, {\n      msg: TAPi18n.__(errorMessage, {}, user.language)\n    });\n\n    if (typeof error === 'string') {\n      throw new Error(error);\n    }\n\n    throw error;\n  }\n}\n\nMeteor.methods({\n  sendMessage(message) {\n    check(message, Object);\n    const uid = Meteor.userId();\n\n    if (!uid) {\n      throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n        method: 'sendMessage'\n      });\n    }\n\n    try {\n      return executeSendMessage(uid, message);\n    } catch (error) {\n      if ((error.error || error.message) === 'error-not-allowed') {\n        throw new Meteor.Error(error.error || error.message, error.reason, {\n          method: 'sendMessage'\n        });\n      }\n    }\n  }\n\n}); // Limit a user, who does not have the \"bot\" role, to sending 5 msgs/second\n\nRateLimiter.limitMethod('sendMessage', 5, 1000, {\n  userId(userId) {\n    return !hasPermission(userId, 'send-many-messages');\n  }\n\n});","map":{"version":3,"sources":["app/lib/server/methods/sendMessage.js"],"names":["module","export","executeSendMessage","Meteor","link","v","check","TAPi18n","moment","default","hasPermission","metrics","settings","messageProperties","Users","Messages","sendMessage","RateLimiter","canSendMessage","SystemLogger","api","uid","message","tshow","tmid","Error","method","get","ts","tsDiff","Math","abs","diff","message_ts","server_ts","Date","getTime","msg","adjustedMessage","messageWithoutEmojiShortnames","length","user","findOneById","fields","username","type","name","rid","parentMessage","room","messagesSent","inc","error","errorMessage","broadcast","__","language","methods","Object","userId","reason","limitMethod"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { check } from 'meteor/check';\nimport { TAPi18n } from 'meteor/rocketchat:tap-i18n';\nimport moment from 'moment';\n\nimport { hasPermission } from '../../../authorization';\nimport { metrics } from '../../../metrics';\nimport { settings } from '../../../settings';\nimport { messageProperties } from '../../../ui-utils';\nimport { Users, Messages } from '../../../models';\nimport { sendMessage } from '../functions';\nimport { RateLimiter } from '../lib';\nimport { canSendMessage } from '../../../authorization/server';\nimport { SystemLogger } from '../../../../server/lib/logger/system';\nimport { api } from '../../../../server/sdk/api';\n\nexport function executeSendMessage(uid, message) {\n\tif (message.tshow && !message.tmid) {\n\t\tthrow new Meteor.Error('invalid-params', 'tshow provided but missing tmid', {\n\t\t\tmethod: 'sendMessage',\n\t\t});\n\t}\n\n\tif (message.tmid && !settings.get('Threads_enabled')) {\n\t\tthrow new Meteor.Error('error-not-allowed', 'not-allowed', {\n\t\t\tmethod: 'sendMessage',\n\t\t});\n\t}\n\n\tif (message.ts) {\n\t\tconst tsDiff = Math.abs(moment(message.ts).diff());\n\t\tif (tsDiff > 60000) {\n\t\t\tthrow new Meteor.Error('error-message-ts-out-of-sync', 'Message timestamp is out of sync', {\n\t\t\t\tmethod: 'sendMessage',\n\t\t\t\tmessage_ts: message.ts,\n\t\t\t\tserver_ts: new Date().getTime(),\n\t\t\t});\n\t\t} else if (tsDiff > 10000) {\n\t\t\tmessage.ts = new Date();\n\t\t}\n\t} else {\n\t\tmessage.ts = new Date();\n\t}\n\n\tif (message.msg) {\n\t\tconst adjustedMessage = messageProperties.messageWithoutEmojiShortnames(message.msg);\n\n\t\tif (messageProperties.length(adjustedMessage) > settings.get('Message_MaxAllowedSize')) {\n\t\t\tthrow new Meteor.Error('error-message-size-exceeded', 'Message size exceeds Message_MaxAllowedSize', {\n\t\t\t\tmethod: 'sendMessage',\n\t\t\t});\n\t\t}\n\t}\n\n\tconst user = Users.findOneById(uid, {\n\t\tfields: {\n\t\t\tusername: 1,\n\t\t\ttype: 1,\n\t\t\tname: 1,\n\t\t},\n\t});\n\tlet { rid } = message;\n\n\t// do not allow nested threads\n\tif (message.tmid) {\n\t\tconst parentMessage = Messages.findOneById(message.tmid);\n\t\tmessage.tmid = parentMessage.tmid || message.tmid;\n\t\trid = parentMessage.rid;\n\t}\n\n\tif (!rid) {\n\t\tthrow new Error(\"The 'rid' property on the message object is missing.\");\n\t}\n\n\ttry {\n\t\tconst room = canSendMessage(rid, { uid, username: user.username, type: user.type });\n\n\t\tmetrics.messagesSent.inc(); // TODO This line needs to be moved to it's proper place. See the comments on: https://github.com/RocketChat/Rocket.Chat/pull/5736\n\t\treturn sendMessage(user, message, room, false);\n\t} catch (error) {\n\t\tSystemLogger.error('Error sending message:', error);\n\n\t\tconst errorMessage = typeof error === 'string' ? error : error.error || error.message;\n\t\tapi.broadcast('notify.ephemeralMessage', uid, message.rid, {\n\t\t\tmsg: TAPi18n.__(errorMessage, {}, user.language),\n\t\t});\n\n\t\tif (typeof error === 'string') {\n\t\t\tthrow new Error(error);\n\t\t}\n\n\t\tthrow error;\n\t}\n}\n\nMeteor.methods({\n\tsendMessage(message) {\n\t\tcheck(message, Object);\n\n\t\tconst uid = Meteor.userId();\n\t\tif (!uid) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'sendMessage',\n\t\t\t});\n\t\t}\n\n\t\ttry {\n\t\t\treturn executeSendMessage(uid, message);\n\t\t} catch (error) {\n\t\t\tif ((error.error || error.message) === 'error-not-allowed') {\n\t\t\t\tthrow new Meteor.Error(error.error || error.message, error.reason, {\n\t\t\t\t\tmethod: 'sendMessage',\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t},\n});\n// Limit a user, who does not have the \"bot\" role, to sending 5 msgs/second\nRateLimiter.limitMethod('sendMessage', 5, 1000, {\n\tuserId(userId) {\n\t\treturn !hasPermission(userId, 'send-many-messages');\n\t},\n});\n"]},"sourceType":"module","hash":"58534b207162843506ef2c7667f99484c0e90c5e"}
