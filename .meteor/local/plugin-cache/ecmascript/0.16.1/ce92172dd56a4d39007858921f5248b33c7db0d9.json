{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/lib/server/functions/createRoom.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/lib/server/functions/createRoom.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/lib/server/functions/createRoom.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/lib/server/functions/createRoom.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/lib/server/functions/createRoom.js"}},"code":"const _excluded = [\"teamId\"];\n\nlet _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n\n}, 0);\n\nlet _objectWithoutProperties;\n\nmodule.link(\"@babel/runtime/helpers/objectWithoutProperties\", {\n  default(v) {\n    _objectWithoutProperties = v;\n  }\n\n}, 1);\nmodule.export({\n  createRoom: () => createRoom\n});\nlet AppsEngineException;\nmodule.link(\"@rocket.chat/apps-engine/definition/exceptions\", {\n  AppsEngineException(v) {\n    AppsEngineException = v;\n  }\n\n}, 0);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 1);\n\nlet _;\n\nmodule.link(\"underscore\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 2);\nlet s;\nmodule.link(\"underscore.string\", {\n  default(v) {\n    s = v;\n  }\n\n}, 3);\nlet Apps;\nmodule.link(\"../../../apps/server\", {\n  Apps(v) {\n    Apps = v;\n  }\n\n}, 4);\nlet addUserRoles;\nmodule.link(\"../../../authorization\", {\n  addUserRoles(v) {\n    addUserRoles = v;\n  }\n\n}, 5);\nlet callbacks;\nmodule.link(\"../../../../lib/callbacks\", {\n  callbacks(v) {\n    callbacks = v;\n  }\n\n}, 6);\nlet Rooms, Subscriptions, Users;\nmodule.link(\"../../../models\", {\n  Rooms(v) {\n    Rooms = v;\n  },\n\n  Subscriptions(v) {\n    Subscriptions = v;\n  },\n\n  Users(v) {\n    Users = v;\n  }\n\n}, 7);\nlet getValidRoomName;\nmodule.link(\"../../../utils\", {\n  getValidRoomName(v) {\n    getValidRoomName = v;\n  }\n\n}, 8);\nlet createDirectRoom;\nmodule.link(\"./createDirectRoom\", {\n  createDirectRoom(v) {\n    createDirectRoom = v;\n  }\n\n}, 9);\nlet Team;\nmodule.link(\"../../../../server/sdk\", {\n  Team(v) {\n    Team = v;\n  }\n\n}, 10);\n\nconst createRoom = function (type, name, owner) {\n  let members = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : [];\n  let readOnly = arguments.length > 4 ? arguments[4] : undefined;\n\n  let _ref = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : {};\n\n  let options = arguments.length > 6 && arguments[6] !== undefined ? arguments[6] : {};\n\n  let {\n    teamId\n  } = _ref,\n      extraData = _objectWithoutProperties(_ref, _excluded);\n\n  callbacks.run('beforeCreateRoom', {\n    type,\n    name,\n    owner,\n    members,\n    readOnly,\n    extraData,\n    options\n  });\n\n  if (type === 'd') {\n    return createDirectRoom(members, extraData, options);\n  }\n\n  name = s.trim(name);\n  owner = s.trim(owner);\n  members = [].concat(members);\n\n  if (!name) {\n    throw new Meteor.Error('error-invalid-name', 'Invalid name', {\n      function: 'RocketChat.createRoom'\n    });\n  }\n\n  owner = Users.findOneByUsernameIgnoringCase(owner, {\n    fields: {\n      username: 1\n    }\n  });\n\n  if (!owner) {\n    throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n      function: 'RocketChat.createRoom'\n    });\n  }\n\n  if (!_.contains(members, owner.username)) {\n    members.push(owner.username);\n  }\n\n  if (extraData.broadcast) {\n    readOnly = true;\n    delete extraData.reactWhenReadOnly;\n  }\n\n  const now = new Date();\n  const validRoomNameOptions = {};\n\n  if (options.nameValidationRegex) {\n    validRoomNameOptions.nameValidationRegex = options.nameValidationRegex;\n  }\n\n  let room = _objectSpread(_objectSpread({\n    fname: name\n  }, extraData), {}, {\n    name: getValidRoomName(name, null, validRoomNameOptions),\n    t: type,\n    msgs: 0,\n    usersCount: 0,\n    u: {\n      _id: owner._id,\n      username: owner.username\n    },\n    ts: now,\n    ro: readOnly === true\n  });\n\n  if (teamId) {\n    const team = Promise.await(Team.getOneById(teamId, {\n      projection: {\n        _id: 1\n      }\n    }));\n\n    if (team) {\n      room.teamId = team._id;\n    }\n  }\n\n  room._USERNAMES = members;\n  const prevent = Promise.await(Apps.triggerEvent('IPreRoomCreatePrevent', room).catch(error => {\n    if (error instanceof AppsEngineException) {\n      throw new Meteor.Error('error-app-prevented', error.message);\n    }\n\n    throw error;\n  }));\n\n  if (prevent) {\n    throw new Meteor.Error('error-app-prevented', 'A Rocket.Chat App prevented the room creation.');\n  }\n\n  let result;\n  result = Promise.await(Apps.triggerEvent('IPreRoomCreateExtend', room));\n  result = Promise.await(Apps.triggerEvent('IPreRoomCreateModify', result));\n\n  if (typeof result === 'object') {\n    Object.assign(room, result);\n  }\n\n  delete room._USERNAMES;\n\n  if (type === 'c') {\n    callbacks.run('beforeCreateChannel', owner, room);\n  }\n\n  room = Rooms.createWithFullRoomData(room);\n\n  for (const username of members) {\n    const member = Users.findOneByUsername(username, {\n      fields: {\n        'username': 1,\n        'settings.preferences': 1\n      }\n    });\n\n    if (!member) {\n      continue;\n    }\n\n    const extra = options.subscriptionExtra || {};\n    extra.open = true;\n\n    if (room.prid) {\n      extra.prid = room.prid;\n    }\n\n    if (username === owner.username) {\n      extra.ls = now;\n    }\n\n    Subscriptions.createWithRoomAndUser(room, member, extra);\n  }\n\n  addUserRoles(owner._id, ['owner'], room._id);\n\n  if (type === 'c') {\n    Meteor.defer(() => {\n      callbacks.run('afterCreateChannel', owner, room);\n    });\n  } else if (type === 'p') {\n    Meteor.defer(() => {\n      callbacks.run('afterCreatePrivateGroup', owner, room);\n    });\n  }\n\n  Meteor.defer(() => {\n    callbacks.run('afterCreateRoom', owner, room);\n  });\n  Apps.triggerEvent('IPostRoomCreate', room);\n  return _objectSpread({\n    rid: room._id\n  }, room);\n};","map":{"version":3,"sources":["app/lib/server/functions/createRoom.js"],"names":["_objectSpread","module","link","default","v","_objectWithoutProperties","export","createRoom","AppsEngineException","Meteor","_","s","Apps","addUserRoles","callbacks","Rooms","Subscriptions","Users","getValidRoomName","createDirectRoom","Team","type","name","owner","members","readOnly","options","teamId","extraData","run","trim","concat","Error","function","findOneByUsernameIgnoringCase","fields","username","contains","push","broadcast","reactWhenReadOnly","now","Date","validRoomNameOptions","nameValidationRegex","room","fname","t","msgs","usersCount","u","_id","ts","ro","team","Promise","await","getOneById","projection","_USERNAMES","prevent","triggerEvent","catch","error","message","result","Object","assign","createWithFullRoomData","member","findOneByUsername","extra","subscriptionExtra","open","prid","ls","createWithRoomAndUser","defer","rid"],"mappings":"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","sourcesContent":["import { AppsEngineException } from '@rocket.chat/apps-engine/definition/exceptions';\nimport { Meteor } from 'meteor/meteor';\nimport _ from 'underscore';\nimport s from 'underscore.string';\n\nimport { Apps } from '../../../apps/server';\nimport { addUserRoles } from '../../../authorization';\nimport { callbacks } from '../../../../lib/callbacks';\nimport { Rooms, Subscriptions, Users } from '../../../models';\nimport { getValidRoomName } from '../../../utils';\nimport { createDirectRoom } from './createDirectRoom';\nimport { Team } from '../../../../server/sdk';\n\nexport const createRoom = function (type, name, owner, members = [], readOnly, { teamId, ...extraData } = {}, options = {}) {\n\tcallbacks.run('beforeCreateRoom', { type, name, owner, members, readOnly, extraData, options });\n\n\tif (type === 'd') {\n\t\treturn createDirectRoom(members, extraData, options);\n\t}\n\n\tname = s.trim(name);\n\towner = s.trim(owner);\n\tmembers = [].concat(members);\n\n\tif (!name) {\n\t\tthrow new Meteor.Error('error-invalid-name', 'Invalid name', {\n\t\t\tfunction: 'RocketChat.createRoom',\n\t\t});\n\t}\n\n\towner = Users.findOneByUsernameIgnoringCase(owner, { fields: { username: 1 } });\n\n\tif (!owner) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\tfunction: 'RocketChat.createRoom',\n\t\t});\n\t}\n\n\tif (!_.contains(members, owner.username)) {\n\t\tmembers.push(owner.username);\n\t}\n\n\tif (extraData.broadcast) {\n\t\treadOnly = true;\n\t\tdelete extraData.reactWhenReadOnly;\n\t}\n\n\tconst now = new Date();\n\n\tconst validRoomNameOptions = {};\n\n\tif (options.nameValidationRegex) {\n\t\tvalidRoomNameOptions.nameValidationRegex = options.nameValidationRegex;\n\t}\n\n\tlet room = {\n\t\tfname: name,\n\t\t...extraData,\n\t\tname: getValidRoomName(name, null, validRoomNameOptions),\n\t\tt: type,\n\t\tmsgs: 0,\n\t\tusersCount: 0,\n\t\tu: {\n\t\t\t_id: owner._id,\n\t\t\tusername: owner.username,\n\t\t},\n\t\tts: now,\n\t\tro: readOnly === true,\n\t};\n\n\tif (teamId) {\n\t\tconst team = Promise.await(Team.getOneById(teamId, { projection: { _id: 1 } }));\n\t\tif (team) {\n\t\t\troom.teamId = team._id;\n\t\t}\n\t}\n\n\troom._USERNAMES = members;\n\n\tconst prevent = Promise.await(\n\t\tApps.triggerEvent('IPreRoomCreatePrevent', room).catch((error) => {\n\t\t\tif (error instanceof AppsEngineException) {\n\t\t\t\tthrow new Meteor.Error('error-app-prevented', error.message);\n\t\t\t}\n\n\t\t\tthrow error;\n\t\t}),\n\t);\n\n\tif (prevent) {\n\t\tthrow new Meteor.Error('error-app-prevented', 'A Rocket.Chat App prevented the room creation.');\n\t}\n\n\tlet result;\n\tresult = Promise.await(Apps.triggerEvent('IPreRoomCreateExtend', room));\n\tresult = Promise.await(Apps.triggerEvent('IPreRoomCreateModify', result));\n\n\tif (typeof result === 'object') {\n\t\tObject.assign(room, result);\n\t}\n\n\tdelete room._USERNAMES;\n\n\tif (type === 'c') {\n\t\tcallbacks.run('beforeCreateChannel', owner, room);\n\t}\n\troom = Rooms.createWithFullRoomData(room);\n\n\tfor (const username of members) {\n\t\tconst member = Users.findOneByUsername(username, {\n\t\t\tfields: { 'username': 1, 'settings.preferences': 1 },\n\t\t});\n\t\tif (!member) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst extra = options.subscriptionExtra || {};\n\n\t\textra.open = true;\n\n\t\tif (room.prid) {\n\t\t\textra.prid = room.prid;\n\t\t}\n\n\t\tif (username === owner.username) {\n\t\t\textra.ls = now;\n\t\t}\n\n\t\tSubscriptions.createWithRoomAndUser(room, member, extra);\n\t}\n\n\taddUserRoles(owner._id, ['owner'], room._id);\n\n\tif (type === 'c') {\n\t\tMeteor.defer(() => {\n\t\t\tcallbacks.run('afterCreateChannel', owner, room);\n\t\t});\n\t} else if (type === 'p') {\n\t\tMeteor.defer(() => {\n\t\t\tcallbacks.run('afterCreatePrivateGroup', owner, room);\n\t\t});\n\t}\n\tMeteor.defer(() => {\n\t\tcallbacks.run('afterCreateRoom', owner, room);\n\t});\n\n\tApps.triggerEvent('IPostRoomCreate', room);\n\n\treturn {\n\t\trid: room._id, // backwards compatible\n\t\t...room,\n\t};\n};\n"]},"sourceType":"module","hash":"ce92172dd56a4d39007858921f5248b33c7db0d9"}
