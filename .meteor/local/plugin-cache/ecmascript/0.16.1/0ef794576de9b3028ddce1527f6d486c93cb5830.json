{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/lib/server/functions/setUsername.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/lib/server/functions/setUsername.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/lib/server/functions/setUsername.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/lib/server/functions/setUsername.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/lib/server/functions/setUsername.js"}},"code":"module.export({\n  _setUsername: () => _setUsername,\n  setUsername: () => setUsername\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet s;\nmodule.link(\"underscore.string\", {\n  default(v) {\n    s = v;\n  }\n\n}, 1);\nlet Accounts;\nmodule.link(\"meteor/accounts-base\", {\n  Accounts(v) {\n    Accounts = v;\n  }\n\n}, 2);\nlet settings;\nmodule.link(\"../../../settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 3);\nlet Users;\nmodule.link(\"../../../models/server\", {\n  Users(v) {\n    Users = v;\n  }\n\n}, 4);\nlet Invites;\nmodule.link(\"../../../models/server/raw\", {\n  Invites(v) {\n    Invites = v;\n  }\n\n}, 5);\nlet hasPermission;\nmodule.link(\"../../../authorization\", {\n  hasPermission(v) {\n    hasPermission = v;\n  }\n\n}, 6);\nlet RateLimiter;\nmodule.link(\"../lib\", {\n  RateLimiter(v) {\n    RateLimiter = v;\n  }\n\n}, 7);\nlet addUserToRoom;\nmodule.link(\"./addUserToRoom\", {\n  addUserToRoom(v) {\n    addUserToRoom = v;\n  }\n\n}, 8);\nlet api;\nmodule.link(\"../../../../server/sdk/api\", {\n  api(v) {\n    api = v;\n  }\n\n}, 9);\nlet checkUsernameAvailability, setUserAvatar;\nmodule.link(\".\", {\n  checkUsernameAvailability(v) {\n    checkUsernameAvailability = v;\n  },\n\n  setUserAvatar(v) {\n    setUserAvatar = v;\n  }\n\n}, 10);\nlet getAvatarSuggestionForUser;\nmodule.link(\"./getAvatarSuggestionForUser\", {\n  getAvatarSuggestionForUser(v) {\n    getAvatarSuggestionForUser = v;\n  }\n\n}, 11);\nlet SystemLogger;\nmodule.link(\"../../../../server/lib/logger/system\", {\n  SystemLogger(v) {\n    SystemLogger = v;\n  }\n\n}, 12);\n\nconst _setUsername = function (userId, u, fullUser) {\n  const username = s.trim(u);\n\n  if (!userId || !username) {\n    return false;\n  }\n\n  let nameValidation;\n\n  try {\n    nameValidation = new RegExp(\"^\".concat(settings.get('UTF8_User_Names_Validation'), \"$\"));\n  } catch (error) {\n    nameValidation = new RegExp('^[0-9a-zA-Z-_.]+$');\n  }\n\n  if (!nameValidation.test(username)) {\n    return false;\n  }\n\n  const user = fullUser || Users.findOneById(userId); // User already has desired username, return\n\n  if (user.username === username) {\n    return user;\n  }\n\n  const previousUsername = user.username; // Check username availability or if the user already owns a different casing of the name\n\n  if (!previousUsername || !(username.toLowerCase() === previousUsername.toLowerCase())) {\n    if (!checkUsernameAvailability(username)) {\n      return false;\n    }\n  } // If first time setting username, send Enrollment Email\n\n\n  try {\n    if (!previousUsername && user.emails && user.emails.length > 0 && settings.get('Accounts_Enrollment_Email')) {\n      Meteor.defer(() => {\n        Accounts.sendEnrollmentEmail(user._id);\n      });\n    }\n  } catch (e) {\n    SystemLogger.error(e);\n  } // Set new username*\n\n\n  Users.setUsername(user._id, username);\n  user.username = username;\n\n  if (!previousUsername && settings.get('Accounts_SetDefaultAvatar') === true) {\n    const avatarSuggestions = Promise.await(getAvatarSuggestionForUser(user));\n    let gravatar;\n    Object.keys(avatarSuggestions).some(service => {\n      const avatarData = avatarSuggestions[service];\n\n      if (service !== 'gravatar') {\n        setUserAvatar(user, avatarData.blob, avatarData.contentType, service);\n        gravatar = null;\n        return true;\n      }\n\n      gravatar = avatarData;\n      return false;\n    });\n\n    if (gravatar != null) {\n      setUserAvatar(user, gravatar.blob, gravatar.contentType, 'gravatar');\n    }\n  } // If it's the first username and the user has an invite Token, then join the invite room\n\n\n  if (!previousUsername && user.inviteToken) {\n    const inviteData = Promise.await(Invites.findOneById(user.inviteToken));\n\n    if (inviteData && inviteData.rid) {\n      addUserToRoom(inviteData.rid, user);\n    }\n  }\n\n  api.broadcast('user.nameChanged', {\n    _id: user._id,\n    name: user.name,\n    username: user.username\n  });\n  return user;\n};\n\nconst setUsername = RateLimiter.limitFunction(_setUsername, 1, 60000, {\n  0() {\n    return !Meteor.userId() || !hasPermission(Meteor.userId(), 'edit-other-user-info');\n  }\n\n});","map":{"version":3,"sources":["app/lib/server/functions/setUsername.js"],"names":["module","export","_setUsername","setUsername","Meteor","link","v","s","default","Accounts","settings","Users","Invites","hasPermission","RateLimiter","addUserToRoom","api","checkUsernameAvailability","setUserAvatar","getAvatarSuggestionForUser","SystemLogger","userId","u","fullUser","username","trim","nameValidation","RegExp","get","error","test","user","findOneById","previousUsername","toLowerCase","emails","length","defer","sendEnrollmentEmail","_id","e","avatarSuggestions","Promise","await","gravatar","Object","keys","some","service","avatarData","blob","contentType","inviteToken","inviteData","rid","broadcast","name","limitFunction"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport s from 'underscore.string';\nimport { Accounts } from 'meteor/accounts-base';\n\nimport { settings } from '../../../settings/server';\nimport { Users } from '../../../models/server';\nimport { Invites } from '../../../models/server/raw';\nimport { hasPermission } from '../../../authorization';\nimport { RateLimiter } from '../lib';\nimport { addUserToRoom } from './addUserToRoom';\nimport { api } from '../../../../server/sdk/api';\nimport { checkUsernameAvailability, setUserAvatar } from '.';\nimport { getAvatarSuggestionForUser } from './getAvatarSuggestionForUser';\nimport { SystemLogger } from '../../../../server/lib/logger/system';\n\nexport const _setUsername = function (userId, u, fullUser) {\n\tconst username = s.trim(u);\n\tif (!userId || !username) {\n\t\treturn false;\n\t}\n\tlet nameValidation;\n\ttry {\n\t\tnameValidation = new RegExp(`^${settings.get('UTF8_User_Names_Validation')}$`);\n\t} catch (error) {\n\t\tnameValidation = new RegExp('^[0-9a-zA-Z-_.]+$');\n\t}\n\tif (!nameValidation.test(username)) {\n\t\treturn false;\n\t}\n\tconst user = fullUser || Users.findOneById(userId);\n\t// User already has desired username, return\n\tif (user.username === username) {\n\t\treturn user;\n\t}\n\tconst previousUsername = user.username;\n\t// Check username availability or if the user already owns a different casing of the name\n\tif (!previousUsername || !(username.toLowerCase() === previousUsername.toLowerCase())) {\n\t\tif (!checkUsernameAvailability(username)) {\n\t\t\treturn false;\n\t\t}\n\t}\n\t// If first time setting username, send Enrollment Email\n\ttry {\n\t\tif (!previousUsername && user.emails && user.emails.length > 0 && settings.get('Accounts_Enrollment_Email')) {\n\t\t\tMeteor.defer(() => {\n\t\t\t\tAccounts.sendEnrollmentEmail(user._id);\n\t\t\t});\n\t\t}\n\t} catch (e) {\n\t\tSystemLogger.error(e);\n\t}\n\t// Set new username*\n\tUsers.setUsername(user._id, username);\n\tuser.username = username;\n\tif (!previousUsername && settings.get('Accounts_SetDefaultAvatar') === true) {\n\t\tconst avatarSuggestions = Promise.await(getAvatarSuggestionForUser(user));\n\t\tlet gravatar;\n\t\tObject.keys(avatarSuggestions).some((service) => {\n\t\t\tconst avatarData = avatarSuggestions[service];\n\t\t\tif (service !== 'gravatar') {\n\t\t\t\tsetUserAvatar(user, avatarData.blob, avatarData.contentType, service);\n\t\t\t\tgravatar = null;\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tgravatar = avatarData;\n\t\t\treturn false;\n\t\t});\n\t\tif (gravatar != null) {\n\t\t\tsetUserAvatar(user, gravatar.blob, gravatar.contentType, 'gravatar');\n\t\t}\n\t}\n\n\t// If it's the first username and the user has an invite Token, then join the invite room\n\tif (!previousUsername && user.inviteToken) {\n\t\tconst inviteData = Promise.await(Invites.findOneById(user.inviteToken));\n\t\tif (inviteData && inviteData.rid) {\n\t\t\taddUserToRoom(inviteData.rid, user);\n\t\t}\n\t}\n\n\tapi.broadcast('user.nameChanged', {\n\t\t_id: user._id,\n\t\tname: user.name,\n\t\tusername: user.username,\n\t});\n\n\treturn user;\n};\n\nexport const setUsername = RateLimiter.limitFunction(_setUsername, 1, 60000, {\n\t0() {\n\t\treturn !Meteor.userId() || !hasPermission(Meteor.userId(), 'edit-other-user-info');\n\t},\n});\n"]},"sourceType":"module","hash":"0ef794576de9b3028ddce1527f6d486c93cb5830"}
