{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/mail-messages/server/functions/sendMail.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/mail-messages/server/functions/sendMail.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/mail-messages/server/functions/sendMail.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/mail-messages/server/functions/sendMail.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/mail-messages/server/functions/sendMail.js"}},"code":"module.export({\n  sendMail: () => sendMail\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet EJSON;\nmodule.link(\"meteor/ejson\", {\n  EJSON(v) {\n    EJSON = v;\n  }\n\n}, 1);\nlet FlowRouter;\nmodule.link(\"meteor/kadira:flow-router\", {\n  FlowRouter(v) {\n    FlowRouter = v;\n  }\n\n}, 2);\nlet escapeHTML;\nmodule.link(\"@rocket.chat/string-helpers\", {\n  escapeHTML(v) {\n    escapeHTML = v;\n  }\n\n}, 3);\nlet placeholders;\nmodule.link(\"../../../utils/server\", {\n  placeholders(v) {\n    placeholders = v;\n  }\n\n}, 4);\nlet SystemLogger;\nmodule.link(\"../../../../server/lib/logger/system\", {\n  SystemLogger(v) {\n    SystemLogger = v;\n  }\n\n}, 5);\nlet Mailer;\nmodule.link(\"../../../mailer\", {\n  \"*\"(v) {\n    Mailer = v;\n  }\n\n}, 6);\n\nconst sendMail = function (from, subject, body, dryrun, query) {\n  Mailer.checkAddressFormatAndThrow(from, 'Mailer.sendMail');\n\n  if (body.indexOf('[unsubscribe]') === -1) {\n    throw new Meteor.Error('error-missing-unsubscribe-link', 'You must provide the [unsubscribe] link.', {\n      function: 'Mailer.sendMail'\n    });\n  }\n\n  let userQuery = {\n    'mailer.unsubscribed': {\n      $exists: 0\n    }\n  };\n\n  if (query) {\n    userQuery = {\n      $and: [userQuery, EJSON.parse(query)]\n    };\n  }\n\n  if (dryrun) {\n    return Meteor.users.find({\n      'emails.address': from\n    }).forEach(user => {\n      const email = \"\".concat(user.name, \" <\").concat(user.emails[0].address, \">\");\n      const html = placeholders.replace(body, {\n        unsubscribe: Meteor.absoluteUrl(FlowRouter.path('mailer/unsubscribe/:_id/:createdAt', {\n          _id: user._id,\n          createdAt: user.createdAt.getTime()\n        })),\n        name: user.name,\n        email\n      });\n      SystemLogger.debug(\"Sending email to \".concat(email));\n      return Mailer.send({\n        to: email,\n        from,\n        subject,\n        html\n      });\n    });\n  }\n\n  return Meteor.users.find(userQuery).forEach(function (user) {\n    if (user && user.emails && Array.isArray(user.emails) && user.emails.length) {\n      const email = \"\".concat(user.name, \" <\").concat(user.emails[0].address, \">\");\n      const html = placeholders.replace(body, {\n        unsubscribe: Meteor.absoluteUrl(FlowRouter.path('mailer/unsubscribe/:_id/:createdAt', {\n          _id: user._id,\n          createdAt: user.createdAt.getTime()\n        })),\n        name: escapeHTML(user.name),\n        email: escapeHTML(email)\n      });\n      SystemLogger.debug(\"Sending email to \".concat(email));\n      return Mailer.send({\n        to: email,\n        from,\n        subject,\n        html\n      });\n    }\n  });\n};","map":{"version":3,"sources":["app/mail-messages/server/functions/sendMail.js"],"names":["module","export","sendMail","Meteor","link","v","EJSON","FlowRouter","escapeHTML","placeholders","SystemLogger","Mailer","from","subject","body","dryrun","query","checkAddressFormatAndThrow","indexOf","Error","function","userQuery","$exists","$and","parse","users","find","forEach","user","email","name","emails","address","html","replace","unsubscribe","absoluteUrl","path","_id","createdAt","getTime","debug","send","to","Array","isArray","length"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { EJSON } from 'meteor/ejson';\nimport { FlowRouter } from 'meteor/kadira:flow-router';\nimport { escapeHTML } from '@rocket.chat/string-helpers';\n\nimport { placeholders } from '../../../utils/server';\nimport { SystemLogger } from '../../../../server/lib/logger/system';\nimport * as Mailer from '../../../mailer';\n\nexport const sendMail = function (from, subject, body, dryrun, query) {\n\tMailer.checkAddressFormatAndThrow(from, 'Mailer.sendMail');\n\tif (body.indexOf('[unsubscribe]') === -1) {\n\t\tthrow new Meteor.Error('error-missing-unsubscribe-link', 'You must provide the [unsubscribe] link.', {\n\t\t\tfunction: 'Mailer.sendMail',\n\t\t});\n\t}\n\n\tlet userQuery = { 'mailer.unsubscribed': { $exists: 0 } };\n\tif (query) {\n\t\tuserQuery = { $and: [userQuery, EJSON.parse(query)] };\n\t}\n\n\tif (dryrun) {\n\t\treturn Meteor.users\n\t\t\t.find({\n\t\t\t\t'emails.address': from,\n\t\t\t})\n\t\t\t.forEach((user) => {\n\t\t\t\tconst email = `${user.name} <${user.emails[0].address}>`;\n\t\t\t\tconst html = placeholders.replace(body, {\n\t\t\t\t\tunsubscribe: Meteor.absoluteUrl(\n\t\t\t\t\t\tFlowRouter.path('mailer/unsubscribe/:_id/:createdAt', {\n\t\t\t\t\t\t\t_id: user._id,\n\t\t\t\t\t\t\tcreatedAt: user.createdAt.getTime(),\n\t\t\t\t\t\t}),\n\t\t\t\t\t),\n\t\t\t\t\tname: user.name,\n\t\t\t\t\temail,\n\t\t\t\t});\n\n\t\t\t\tSystemLogger.debug(`Sending email to ${email}`);\n\t\t\t\treturn Mailer.send({\n\t\t\t\t\tto: email,\n\t\t\t\t\tfrom,\n\t\t\t\t\tsubject,\n\t\t\t\t\thtml,\n\t\t\t\t});\n\t\t\t});\n\t}\n\treturn Meteor.users.find(userQuery).forEach(function (user) {\n\t\tif (user && user.emails && Array.isArray(user.emails) && user.emails.length) {\n\t\t\tconst email = `${user.name} <${user.emails[0].address}>`;\n\n\t\t\tconst html = placeholders.replace(body, {\n\t\t\t\tunsubscribe: Meteor.absoluteUrl(\n\t\t\t\t\tFlowRouter.path('mailer/unsubscribe/:_id/:createdAt', {\n\t\t\t\t\t\t_id: user._id,\n\t\t\t\t\t\tcreatedAt: user.createdAt.getTime(),\n\t\t\t\t\t}),\n\t\t\t\t),\n\t\t\t\tname: escapeHTML(user.name),\n\t\t\t\temail: escapeHTML(email),\n\t\t\t});\n\t\t\tSystemLogger.debug(`Sending email to ${email}`);\n\t\t\treturn Mailer.send({\n\t\t\t\tto: email,\n\t\t\t\tfrom,\n\t\t\t\tsubject,\n\t\t\t\thtml,\n\t\t\t});\n\t\t}\n\t});\n};\n"]},"sourceType":"module","hash":"b7ce5f901f088db219a5f917bb56e1ecf20913de"}
