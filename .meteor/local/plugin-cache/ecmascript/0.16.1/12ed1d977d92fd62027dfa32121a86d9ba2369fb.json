{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/cloud/server/index.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/cloud/server/index.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/cloud/server/index.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/cloud/server/index.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/cloud/server/index.js"}},"code":"module.export({\n  getWorkspaceAccessToken: () => getWorkspaceAccessToken,\n  getWorkspaceAccessTokenWithScope: () => getWorkspaceAccessTokenWithScope,\n  getWorkspaceLicense: () => getWorkspaceLicense,\n  getWorkspaceKey: () => getWorkspaceKey,\n  getUserCloudAccessToken: () => getUserCloudAccessToken\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet SyncedCron;\nmodule.link(\"meteor/littledata:synced-cron\", {\n  SyncedCron(v) {\n    SyncedCron = v;\n  }\n\n}, 1);\nmodule.link(\"./methods\");\nlet getWorkspaceAccessToken;\nmodule.link(\"./functions/getWorkspaceAccessToken\", {\n  getWorkspaceAccessToken(v) {\n    getWorkspaceAccessToken = v;\n  }\n\n}, 2);\nlet getWorkspaceAccessTokenWithScope;\nmodule.link(\"./functions/getWorkspaceAccessTokenWithScope\", {\n  getWorkspaceAccessTokenWithScope(v) {\n    getWorkspaceAccessTokenWithScope = v;\n  }\n\n}, 3);\nlet getWorkspaceLicense;\nmodule.link(\"./functions/getWorkspaceLicense\", {\n  getWorkspaceLicense(v) {\n    getWorkspaceLicense = v;\n  }\n\n}, 4);\nlet getUserCloudAccessToken;\nmodule.link(\"./functions/getUserCloudAccessToken\", {\n  getUserCloudAccessToken(v) {\n    getUserCloudAccessToken = v;\n  }\n\n}, 5);\nlet retrieveRegistrationStatus;\nmodule.link(\"./functions/retrieveRegistrationStatus\", {\n  retrieveRegistrationStatus(v) {\n    retrieveRegistrationStatus = v;\n  }\n\n}, 6);\nlet getWorkspaceKey;\nmodule.link(\"./functions/getWorkspaceKey\", {\n  getWorkspaceKey(v) {\n    getWorkspaceKey = v;\n  }\n\n}, 7);\nlet syncWorkspace;\nmodule.link(\"./functions/syncWorkspace\", {\n  syncWorkspace(v) {\n    syncWorkspace = v;\n  }\n\n}, 8);\nlet connectWorkspace;\nmodule.link(\"./functions/connectWorkspace\", {\n  connectWorkspace(v) {\n    connectWorkspace = v;\n  }\n\n}, 9);\nlet settings;\nmodule.link(\"../../settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 10);\nlet SystemLogger;\nmodule.link(\"../../../server/lib/logger/system\", {\n  SystemLogger(v) {\n    SystemLogger = v;\n  }\n\n}, 11);\nconst licenseCronName = 'Cloud Workspace Sync';\nMeteor.startup(function () {\n  // run token/license sync if registered\n  let TroubleshootDisableWorkspaceSync;\n  settings.watch('Troubleshoot_Disable_Workspace_Sync', value => {\n    if (TroubleshootDisableWorkspaceSync === value) {\n      return;\n    }\n\n    TroubleshootDisableWorkspaceSync = value;\n\n    if (value) {\n      return SyncedCron.remove(licenseCronName);\n    }\n\n    Meteor.defer(() => syncWorkspace());\n    SyncedCron.add({\n      name: licenseCronName,\n\n      schedule(parser) {\n        // Every 12 hours\n        return parser.cron('0 */12 * * *');\n      },\n\n      job: syncWorkspace\n    });\n  });\n  const {\n    workspaceRegistered\n  } = retrieveRegistrationStatus();\n\n  if (process.env.REG_TOKEN && process.env.REG_TOKEN !== '' && !workspaceRegistered) {\n    try {\n      SystemLogger.info('REG_TOKEN Provided. Attempting to register');\n\n      if (!connectWorkspace(process.env.REG_TOKEN)) {\n        throw new Error(\"Couldn't register with token.  Please make sure token is valid or hasn't already been used\");\n      }\n\n      console.log('Successfully registered with token provided by REG_TOKEN!');\n    } catch (e) {\n      SystemLogger.error('An error occured registering with token.', e.message);\n    }\n  }\n});","map":{"version":3,"sources":["app/cloud/server/index.js"],"names":["module","export","getWorkspaceAccessToken","getWorkspaceAccessTokenWithScope","getWorkspaceLicense","getWorkspaceKey","getUserCloudAccessToken","Meteor","link","v","SyncedCron","retrieveRegistrationStatus","syncWorkspace","connectWorkspace","settings","SystemLogger","licenseCronName","startup","TroubleshootDisableWorkspaceSync","watch","value","remove","defer","add","name","schedule","parser","cron","job","workspaceRegistered","process","env","REG_TOKEN","info","Error","console","log","e","error","message"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { SyncedCron } from 'meteor/littledata:synced-cron';\n\nimport './methods';\nimport { getWorkspaceAccessToken } from './functions/getWorkspaceAccessToken';\nimport { getWorkspaceAccessTokenWithScope } from './functions/getWorkspaceAccessTokenWithScope';\nimport { getWorkspaceLicense } from './functions/getWorkspaceLicense';\nimport { getUserCloudAccessToken } from './functions/getUserCloudAccessToken';\nimport { retrieveRegistrationStatus } from './functions/retrieveRegistrationStatus';\nimport { getWorkspaceKey } from './functions/getWorkspaceKey';\nimport { syncWorkspace } from './functions/syncWorkspace';\nimport { connectWorkspace } from './functions/connectWorkspace';\nimport { settings } from '../../settings/server';\nimport { SystemLogger } from '../../../server/lib/logger/system';\n\nconst licenseCronName = 'Cloud Workspace Sync';\n\nMeteor.startup(function () {\n\t// run token/license sync if registered\n\tlet TroubleshootDisableWorkspaceSync;\n\tsettings.watch('Troubleshoot_Disable_Workspace_Sync', (value) => {\n\t\tif (TroubleshootDisableWorkspaceSync === value) {\n\t\t\treturn;\n\t\t}\n\t\tTroubleshootDisableWorkspaceSync = value;\n\n\t\tif (value) {\n\t\t\treturn SyncedCron.remove(licenseCronName);\n\t\t}\n\n\t\tMeteor.defer(() => syncWorkspace());\n\n\t\tSyncedCron.add({\n\t\t\tname: licenseCronName,\n\t\t\tschedule(parser) {\n\t\t\t\t// Every 12 hours\n\t\t\t\treturn parser.cron('0 */12 * * *');\n\t\t\t},\n\t\t\tjob: syncWorkspace,\n\t\t});\n\t});\n\n\tconst { workspaceRegistered } = retrieveRegistrationStatus();\n\n\tif (process.env.REG_TOKEN && process.env.REG_TOKEN !== '' && !workspaceRegistered) {\n\t\ttry {\n\t\t\tSystemLogger.info('REG_TOKEN Provided. Attempting to register');\n\n\t\t\tif (!connectWorkspace(process.env.REG_TOKEN)) {\n\t\t\t\tthrow new Error(\"Couldn't register with token.  Please make sure token is valid or hasn't already been used\");\n\t\t\t}\n\n\t\t\tconsole.log('Successfully registered with token provided by REG_TOKEN!');\n\t\t} catch (e) {\n\t\t\tSystemLogger.error('An error occured registering with token.', e.message);\n\t\t}\n\t}\n});\n\nexport { getWorkspaceAccessToken, getWorkspaceAccessTokenWithScope, getWorkspaceLicense, getWorkspaceKey, getUserCloudAccessToken };\n"]},"sourceType":"module","hash":"12ed1d977d92fd62027dfa32121a86d9ba2369fb"}
