{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/ee/app/canned-responses/server/methods/saveCannedResponse.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"ee/app/canned-responses/server/methods/saveCannedResponse.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/ee/app/canned-responses/server/methods/saveCannedResponse.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/ee/app/canned-responses/server/methods/saveCannedResponse.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"ee/app/canned-responses/server/methods/saveCannedResponse.js"}},"code":"let _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n\n}, 0);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet Match, check;\nmodule.link(\"meteor/check\", {\n  Match(v) {\n    Match = v;\n  },\n\n  check(v) {\n    check = v;\n  }\n\n}, 1);\nlet hasPermission;\nmodule.link(\"../../../../../app/authorization\", {\n  hasPermission(v) {\n    hasPermission = v;\n  }\n\n}, 2);\nlet CannedResponse;\nmodule.link(\"../../../models/server/models/CannedResponse\", {\n  default(v) {\n    CannedResponse = v;\n  }\n\n}, 3);\nlet LivechatDepartment;\nmodule.link(\"../../../../../app/models/server/models/LivechatDepartment\", {\n  default(v) {\n    LivechatDepartment = v;\n  }\n\n}, 4);\nlet Users;\nmodule.link(\"../../../../../app/models\", {\n  Users(v) {\n    Users = v;\n  }\n\n}, 5);\nlet notifications;\nmodule.link(\"../../../../../app/notifications/server/lib/Notifications\", {\n  default(v) {\n    notifications = v;\n  }\n\n}, 6);\nMeteor.methods({\n  saveCannedResponse(_id, responseData) {\n    const userId = Meteor.userId();\n\n    if (!userId || !hasPermission(userId, 'save-canned-responses')) {\n      throw new Meteor.Error('error-not-allowed', 'Not allowed', {\n        method: 'saveCannedResponse'\n      });\n    }\n\n    check(_id, Match.Maybe(String));\n    check(responseData, {\n      shortcut: String,\n      text: String,\n      scope: String,\n      tags: Match.Maybe([String]),\n      departmentId: Match.Maybe(String)\n    });\n    const canSaveAll = hasPermission(userId, 'save-all-canned-responses');\n\n    if (!canSaveAll && ['global'].includes(responseData.scope)) {\n      throw new Meteor.Error('error-not-allowed', 'Not allowed to modify canned responses on *global* scope', {\n        method: 'saveCannedResponse'\n      });\n    }\n\n    const canSaveDepartment = hasPermission(userId, 'save-department-canned-responses');\n\n    if (!canSaveAll && !canSaveDepartment && ['department'].includes(responseData.scope)) {\n      throw new Meteor.Error('error-not-allowed', 'Not allowed to modify canned responses on *department* scope', {\n        method: 'saveCannedResponse'\n      });\n    } // to avoid inconsistencies\n\n\n    if (responseData.scope === 'user') {\n      delete responseData.departmentId;\n    } // TODO: check if the department i'm trying to save is a department i can interact with\n    // check if the response already exists and we're not updating one\n\n\n    const duplicateShortcut = CannedResponse.findOneByShortcut(responseData.shortcut, {\n      fields: {\n        _id: 1\n      }\n    });\n\n    if (!_id && duplicateShortcut || _id && duplicateShortcut && duplicateShortcut._id !== _id) {\n      throw new Meteor.Error('error-invalid-shortcut', 'Shortcut provided already exists', {\n        method: 'saveCannedResponse'\n      });\n    }\n\n    if (responseData.scope === 'department' && !responseData.departmentId) {\n      throw new Meteor.Error('error-invalid-department', 'Invalid department', {\n        method: 'saveCannedResponse'\n      });\n    }\n\n    if (responseData.departmentId && !LivechatDepartment.findOneById(responseData.departmentId)) {\n      throw new Meteor.Error('error-invalid-department', 'Invalid department', {\n        method: 'saveCannedResponse'\n      });\n    }\n\n    if (_id) {\n      const cannedResponse = CannedResponse.findOneById(_id);\n\n      if (!cannedResponse) {\n        throw new Meteor.Error('error-canned-response-not-found', 'Canned Response not found', {\n          method: 'saveCannedResponse'\n        });\n      }\n\n      responseData.createdBy = cannedResponse.createdBy;\n    } else {\n      const user = Users.findOneById(Meteor.userId());\n\n      if (responseData.scope === 'user') {\n        responseData.userId = user._id;\n      }\n\n      responseData.createdBy = {\n        _id: user._id,\n        username: user.username\n      };\n      responseData._createdAt = new Date();\n    }\n\n    const createdCannedResponse = CannedResponse.createOrUpdateCannedResponse(_id, responseData);\n    notifications.streamCannedResponses.emit('canned-responses', _objectSpread({\n      type: 'changed'\n    }, createdCannedResponse));\n    return createdCannedResponse;\n  }\n\n});","map":{"version":3,"sources":["ee/app/canned-responses/server/methods/saveCannedResponse.js"],"names":["_objectSpread","module","link","default","v","Meteor","Match","check","hasPermission","CannedResponse","LivechatDepartment","Users","notifications","methods","saveCannedResponse","_id","responseData","userId","Error","method","Maybe","String","shortcut","text","scope","tags","departmentId","canSaveAll","includes","canSaveDepartment","duplicateShortcut","findOneByShortcut","fields","findOneById","cannedResponse","createdBy","user","username","_createdAt","Date","createdCannedResponse","createOrUpdateCannedResponse","streamCannedResponses","emit","type"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { Match, check } from 'meteor/check';\n\nimport { hasPermission } from '../../../../../app/authorization';\nimport CannedResponse from '../../../models/server/models/CannedResponse';\nimport LivechatDepartment from '../../../../../app/models/server/models/LivechatDepartment';\nimport { Users } from '../../../../../app/models';\nimport notifications from '../../../../../app/notifications/server/lib/Notifications';\n\nMeteor.methods({\n\tsaveCannedResponse(_id, responseData) {\n\t\tconst userId = Meteor.userId();\n\t\tif (!userId || !hasPermission(userId, 'save-canned-responses')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'saveCannedResponse' });\n\t\t}\n\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(responseData, {\n\t\t\tshortcut: String,\n\t\t\ttext: String,\n\t\t\tscope: String,\n\t\t\ttags: Match.Maybe([String]),\n\t\t\tdepartmentId: Match.Maybe(String),\n\t\t});\n\n\t\tconst canSaveAll = hasPermission(userId, 'save-all-canned-responses');\n\t\tif (!canSaveAll && ['global'].includes(responseData.scope)) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed to modify canned responses on *global* scope', {\n\t\t\t\tmethod: 'saveCannedResponse',\n\t\t\t});\n\t\t}\n\n\t\tconst canSaveDepartment = hasPermission(userId, 'save-department-canned-responses');\n\t\tif (!canSaveAll && !canSaveDepartment && ['department'].includes(responseData.scope)) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed to modify canned responses on *department* scope', {\n\t\t\t\tmethod: 'saveCannedResponse',\n\t\t\t});\n\t\t}\n\n\t\t// to avoid inconsistencies\n\t\tif (responseData.scope === 'user') {\n\t\t\tdelete responseData.departmentId;\n\t\t}\n\t\t// TODO: check if the department i'm trying to save is a department i can interact with\n\n\t\t// check if the response already exists and we're not updating one\n\t\tconst duplicateShortcut = CannedResponse.findOneByShortcut(responseData.shortcut, {\n\t\t\tfields: { _id: 1 },\n\t\t});\n\t\tif ((!_id && duplicateShortcut) || (_id && duplicateShortcut && duplicateShortcut._id !== _id)) {\n\t\t\tthrow new Meteor.Error('error-invalid-shortcut', 'Shortcut provided already exists', {\n\t\t\t\tmethod: 'saveCannedResponse',\n\t\t\t});\n\t\t}\n\n\t\tif (responseData.scope === 'department' && !responseData.departmentId) {\n\t\t\tthrow new Meteor.Error('error-invalid-department', 'Invalid department', {\n\t\t\t\tmethod: 'saveCannedResponse',\n\t\t\t});\n\t\t}\n\n\t\tif (responseData.departmentId && !LivechatDepartment.findOneById(responseData.departmentId)) {\n\t\t\tthrow new Meteor.Error('error-invalid-department', 'Invalid department', {\n\t\t\t\tmethod: 'saveCannedResponse',\n\t\t\t});\n\t\t}\n\n\t\tif (_id) {\n\t\t\tconst cannedResponse = CannedResponse.findOneById(_id);\n\t\t\tif (!cannedResponse) {\n\t\t\t\tthrow new Meteor.Error('error-canned-response-not-found', 'Canned Response not found', {\n\t\t\t\t\tmethod: 'saveCannedResponse',\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tresponseData.createdBy = cannedResponse.createdBy;\n\t\t} else {\n\t\t\tconst user = Users.findOneById(Meteor.userId());\n\n\t\t\tif (responseData.scope === 'user') {\n\t\t\t\tresponseData.userId = user._id;\n\t\t\t}\n\t\t\tresponseData.createdBy = { _id: user._id, username: user.username };\n\t\t\tresponseData._createdAt = new Date();\n\t\t}\n\t\tconst createdCannedResponse = CannedResponse.createOrUpdateCannedResponse(_id, responseData);\n\t\tnotifications.streamCannedResponses.emit('canned-responses', {\n\t\t\ttype: 'changed',\n\t\t\t...createdCannedResponse,\n\t\t});\n\n\t\treturn createdCannedResponse;\n\t},\n});\n"]},"sourceType":"module","hash":"e97f46e5cad72c2335fec3efe126b739a5060650"}
