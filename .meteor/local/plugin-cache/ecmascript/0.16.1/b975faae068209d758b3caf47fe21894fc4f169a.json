{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/server/publications/room/index.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"server/publications/room/index.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/server/publications/room/index.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/server/publications/room/index.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/publications/room/index.js"}},"code":"let Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\n\nlet _;\n\nmodule.link(\"underscore\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 1);\nlet roomTypes;\nmodule.link(\"../../../app/utils/server\", {\n  roomTypes(v) {\n    roomTypes = v;\n  }\n\n}, 2);\nlet canAccessRoom, hasPermission;\nmodule.link(\"../../../app/authorization/server\", {\n  canAccessRoom(v) {\n    canAccessRoom = v;\n  },\n\n  hasPermission(v) {\n    hasPermission = v;\n  }\n\n}, 3);\nlet Rooms;\nmodule.link(\"../../../app/models/server\", {\n  Rooms(v) {\n    Rooms = v;\n  }\n\n}, 4);\nlet settings;\nmodule.link(\"../../../app/settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 5);\nlet roomFields;\nmodule.link(\"../../modules/watchers/publishFields\", {\n  roomFields(v) {\n    roomFields = v;\n  }\n\n}, 6);\n\nconst roomMap = record => {\n  if (record) {\n    return _.pick(record, ...Object.keys(roomFields));\n  }\n\n  return {};\n};\n\nMeteor.methods({\n  'rooms/get'(updatedAt) {\n    const options = {\n      fields: roomFields\n    };\n    const user = Meteor.userId();\n\n    if (!user) {\n      if (settings.get('Accounts_AllowAnonymousRead')) {\n        return Rooms.findByDefaultAndTypes(true, ['c'], options).fetch();\n      }\n\n      return [];\n    }\n\n    if (updatedAt instanceof Date) {\n      return {\n        update: Rooms.findBySubscriptionUserIdUpdatedAfter(user, updatedAt, options).fetch(),\n        remove: Rooms.trashFindDeletedAfter(updatedAt, {}, {\n          fields: {\n            _id: 1,\n            _deletedAt: 1\n          }\n        }).fetch()\n      };\n    }\n\n    return Rooms.findBySubscriptionUserId(user, options).fetch();\n  },\n\n  'getRoomByTypeAndName'(type, name) {\n    const userId = Meteor.userId();\n\n    if (!userId && settings.get('Accounts_AllowAnonymousRead') === false) {\n      throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n        method: 'getRoomByTypeAndName'\n      });\n    }\n\n    const roomFind = roomTypes.getRoomFind(type);\n    const room = roomFind ? roomFind.call(this, name) : Rooms.findByTypeAndNameOrId(type, name);\n\n    if (!room) {\n      throw new Meteor.Error('error-invalid-room', 'Invalid room', {\n        method: 'getRoomByTypeAndName'\n      });\n    }\n\n    if (!canAccessRoom(room, {\n      _id: userId\n    })) {\n      throw new Meteor.Error('error-no-permission', 'No permission', {\n        method: 'getRoomByTypeAndName'\n      });\n    }\n\n    if (settings.get('Store_Last_Message') && !hasPermission(userId, 'preview-c-room')) {\n      delete room.lastMessage;\n    }\n\n    return roomMap(room);\n  }\n\n});","map":{"version":3,"sources":["server/publications/room/index.js"],"names":["Meteor","module","link","v","_","default","roomTypes","canAccessRoom","hasPermission","Rooms","settings","roomFields","roomMap","record","pick","Object","keys","methods","updatedAt","options","fields","user","userId","get","findByDefaultAndTypes","fetch","Date","update","findBySubscriptionUserIdUpdatedAfter","remove","trashFindDeletedAfter","_id","_deletedAt","findBySubscriptionUserId","type","name","Error","method","roomFind","getRoomFind","room","call","findByTypeAndNameOrId","lastMessage"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport _ from 'underscore';\n\nimport { roomTypes } from '../../../app/utils/server';\nimport { canAccessRoom, hasPermission } from '../../../app/authorization/server';\nimport { Rooms } from '../../../app/models/server';\nimport { settings } from '../../../app/settings/server';\nimport { roomFields } from '../../modules/watchers/publishFields';\n\nconst roomMap = (record) => {\n\tif (record) {\n\t\treturn _.pick(record, ...Object.keys(roomFields));\n\t}\n\treturn {};\n};\n\nMeteor.methods({\n\t'rooms/get'(updatedAt) {\n\t\tconst options = { fields: roomFields };\n\t\tconst user = Meteor.userId();\n\n\t\tif (!user) {\n\t\t\tif (settings.get('Accounts_AllowAnonymousRead')) {\n\t\t\t\treturn Rooms.findByDefaultAndTypes(true, ['c'], options).fetch();\n\t\t\t}\n\t\t\treturn [];\n\t\t}\n\n\t\tif (updatedAt instanceof Date) {\n\t\t\treturn {\n\t\t\t\tupdate: Rooms.findBySubscriptionUserIdUpdatedAfter(user, updatedAt, options).fetch(),\n\t\t\t\tremove: Rooms.trashFindDeletedAfter(updatedAt, {}, { fields: { _id: 1, _deletedAt: 1 } }).fetch(),\n\t\t\t};\n\t\t}\n\n\t\treturn Rooms.findBySubscriptionUserId(user, options).fetch();\n\t},\n\n\t'getRoomByTypeAndName'(type, name) {\n\t\tconst userId = Meteor.userId();\n\n\t\tif (!userId && settings.get('Accounts_AllowAnonymousRead') === false) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'getRoomByTypeAndName',\n\t\t\t});\n\t\t}\n\n\t\tconst roomFind = roomTypes.getRoomFind(type);\n\n\t\tconst room = roomFind ? roomFind.call(this, name) : Rooms.findByTypeAndNameOrId(type, name);\n\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', {\n\t\t\t\tmethod: 'getRoomByTypeAndName',\n\t\t\t});\n\t\t}\n\n\t\tif (!canAccessRoom(room, { _id: userId })) {\n\t\t\tthrow new Meteor.Error('error-no-permission', 'No permission', {\n\t\t\t\tmethod: 'getRoomByTypeAndName',\n\t\t\t});\n\t\t}\n\n\t\tif (settings.get('Store_Last_Message') && !hasPermission(userId, 'preview-c-room')) {\n\t\t\tdelete room.lastMessage;\n\t\t}\n\n\t\treturn roomMap(room);\n\t},\n});\n"]},"sourceType":"module","hash":"b975faae068209d758b3caf47fe21894fc4f169a"}
