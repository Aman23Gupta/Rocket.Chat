{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/user-data-download/server/DataExport.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/user-data-download/server/DataExport.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/user-data-download/server/DataExport.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/user-data-download/server/DataExport.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/user-data-download/server/DataExport.js"}},"code":"module.export({\n  DataExport: () => DataExport\n});\nlet Cookies;\nmodule.link(\"meteor/ostrio:cookies\", {\n  Cookies(v) {\n    Cookies = v;\n  }\n\n}, 0);\nlet Users;\nmodule.link(\"../../models/server/models/Users\", {\n  default(v) {\n    Users = v;\n  }\n\n}, 1);\nlet FileUpload;\nmodule.link(\"../../file-upload/server\", {\n  FileUpload(v) {\n    FileUpload = v;\n  }\n\n}, 2);\nlet getURL;\nmodule.link(\"../../utils/lib/getURL\", {\n  getURL(v) {\n    getURL = v;\n  }\n\n}, 3);\nconst cookie = new Cookies();\nconst userDataStore = FileUpload.getStore('UserDataFiles');\nconst DataExport = {\n  handlers: {},\n\n  getPath() {\n    let path = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : '';\n    return \"/data-export/\".concat(path);\n  },\n\n  requestCanAccessFiles(_ref, userId) {\n    let {\n      headers = {},\n      query = {}\n    } = _ref;\n    let {\n      rc_uid,\n      rc_token\n    } = query;\n\n    if (!rc_uid && headers.cookie) {\n      rc_uid = cookie.get('rc_uid', headers.cookie);\n      rc_token = cookie.get('rc_token', headers.cookie);\n    }\n\n    const options = {\n      fields: {\n        _id: 1\n      }\n    };\n\n    if (rc_uid && rc_token && rc_uid === userId) {\n      return !!Users.findOneByIdAndLoginToken(rc_uid, rc_token, options);\n    }\n\n    if (headers['x-user-id'] && headers['x-auth-token'] && headers['x-user-id'] === userId) {\n      return !!Users.findOneByIdAndLoginToken(headers['x-user-id'], headers['x-auth-token'], options);\n    }\n\n    return false;\n  },\n\n  get(file, req, res, next) {\n    if (userDataStore && userDataStore.get) {\n      return userDataStore.get(file, req, res, next);\n    }\n\n    res.writeHead(404);\n    res.end();\n  },\n\n  getErrorPage(errorType, errorDescription) {\n    let errorHtml = Assets.getText('errors/error_template.html');\n    errorHtml = errorHtml.replace('$ERROR_TYPE$', errorType);\n    errorHtml = errorHtml.replace('$ERROR_DESCRIPTION$', errorDescription);\n    errorHtml = errorHtml.replace('$SERVER_URL$', getURL('/', {\n      full: true,\n      cdn: false\n    }));\n    return errorHtml;\n  }\n\n};","map":{"version":3,"sources":["app/user-data-download/server/DataExport.js"],"names":["module","export","DataExport","Cookies","link","v","Users","default","FileUpload","getURL","cookie","userDataStore","getStore","handlers","getPath","path","requestCanAccessFiles","userId","headers","query","rc_uid","rc_token","get","options","fields","_id","findOneByIdAndLoginToken","file","req","res","next","writeHead","end","getErrorPage","errorType","errorDescription","errorHtml","Assets","getText","replace","full","cdn"],"mappings":"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","sourcesContent":["import { Cookies } from 'meteor/ostrio:cookies';\n\nimport Users from '../../models/server/models/Users';\nimport { FileUpload } from '../../file-upload/server';\nimport { getURL } from '../../utils/lib/getURL';\n\nconst cookie = new Cookies();\nconst userDataStore = FileUpload.getStore('UserDataFiles');\n\nexport const DataExport = {\n\thandlers: {},\n\n\tgetPath(path = '') {\n\t\treturn `/data-export/${path}`;\n\t},\n\n\trequestCanAccessFiles({ headers = {}, query = {} }, userId) {\n\t\tlet { rc_uid, rc_token } = query;\n\n\t\tif (!rc_uid && headers.cookie) {\n\t\t\trc_uid = cookie.get('rc_uid', headers.cookie);\n\t\t\trc_token = cookie.get('rc_token', headers.cookie);\n\t\t}\n\n\t\tconst options = { fields: { _id: 1 } };\n\n\t\tif (rc_uid && rc_token && rc_uid === userId) {\n\t\t\treturn !!Users.findOneByIdAndLoginToken(rc_uid, rc_token, options);\n\t\t}\n\n\t\tif (headers['x-user-id'] && headers['x-auth-token'] && headers['x-user-id'] === userId) {\n\t\t\treturn !!Users.findOneByIdAndLoginToken(headers['x-user-id'], headers['x-auth-token'], options);\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tget(file, req, res, next) {\n\t\tif (userDataStore && userDataStore.get) {\n\t\t\treturn userDataStore.get(file, req, res, next);\n\t\t}\n\t\tres.writeHead(404);\n\t\tres.end();\n\t},\n\n\tgetErrorPage(errorType, errorDescription) {\n\t\tlet errorHtml = Assets.getText('errors/error_template.html');\n\t\terrorHtml = errorHtml.replace('$ERROR_TYPE$', errorType);\n\t\terrorHtml = errorHtml.replace('$ERROR_DESCRIPTION$', errorDescription);\n\t\terrorHtml = errorHtml.replace('$SERVER_URL$', getURL('/', { full: true, cdn: false }));\n\t\treturn errorHtml;\n\t},\n};\n"]},"sourceType":"module","hash":"21149da563c3270b304141a410a568116ba21e7d"}
