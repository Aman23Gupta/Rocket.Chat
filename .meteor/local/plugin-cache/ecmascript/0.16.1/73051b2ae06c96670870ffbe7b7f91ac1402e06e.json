{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/livechat/server/api/v1/agent.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/livechat/server/api/v1/agent.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/livechat/server/api/v1/agent.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/livechat/server/api/v1/agent.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/livechat/server/api/v1/agent.js"}},"code":"let Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet Match, check;\nmodule.link(\"meteor/check\", {\n  Match(v) {\n    Match = v;\n  },\n\n  check(v) {\n    check = v;\n  }\n\n}, 1);\nlet API;\nmodule.link(\"../../../../api/server\", {\n  API(v) {\n    API = v;\n  }\n\n}, 2);\nlet findRoom, findGuest, findAgent, findOpenRoom;\nmodule.link(\"../lib/livechat\", {\n  findRoom(v) {\n    findRoom = v;\n  },\n\n  findGuest(v) {\n    findGuest = v;\n  },\n\n  findAgent(v) {\n    findAgent = v;\n  },\n\n  findOpenRoom(v) {\n    findOpenRoom = v;\n  }\n\n}, 3);\nlet Livechat;\nmodule.link(\"../../lib/Livechat\", {\n  Livechat(v) {\n    Livechat = v;\n  }\n\n}, 4);\nAPI.v1.addRoute('livechat/agent.info/:rid/:token', {\n  get() {\n    try {\n      check(this.urlParams, {\n        rid: String,\n        token: String\n      });\n      const visitor = findGuest(this.urlParams.token);\n\n      if (!visitor) {\n        throw new Meteor.Error('invalid-token');\n      }\n\n      const room = findRoom(this.urlParams.token, this.urlParams.rid);\n\n      if (!room) {\n        throw new Meteor.Error('invalid-room');\n      }\n\n      const agent = room && room.servedBy && findAgent(room.servedBy._id);\n\n      if (!agent) {\n        throw new Meteor.Error('invalid-agent');\n      }\n\n      return API.v1.success({\n        agent\n      });\n    } catch (e) {\n      return API.v1.failure(e);\n    }\n  }\n\n});\nAPI.v1.addRoute('livechat/agent.next/:token', {\n  get() {\n    try {\n      check(this.urlParams, {\n        token: String\n      });\n      check(this.queryParams, {\n        department: Match.Maybe(String)\n      });\n      const {\n        token\n      } = this.urlParams;\n      const room = findOpenRoom(token);\n\n      if (room) {\n        return API.v1.success();\n      }\n\n      let {\n        department\n      } = this.queryParams;\n\n      if (!department) {\n        const requireDeparment = Livechat.getRequiredDepartment();\n\n        if (requireDeparment) {\n          department = requireDeparment._id;\n        }\n      }\n\n      const agentData = Promise.await(Livechat.getNextAgent(department));\n\n      if (!agentData) {\n        throw new Meteor.Error('agent-not-found');\n      }\n\n      const agent = findAgent(agentData.agentId);\n\n      if (!agent) {\n        throw new Meteor.Error('invalid-agent');\n      }\n\n      return API.v1.success({\n        agent\n      });\n    } catch (e) {\n      return API.v1.failure(e);\n    }\n  }\n\n});","map":{"version":3,"sources":["app/livechat/server/api/v1/agent.js"],"names":["Meteor","module","link","v","Match","check","API","findRoom","findGuest","findAgent","findOpenRoom","Livechat","v1","addRoute","get","urlParams","rid","String","token","visitor","Error","room","agent","servedBy","_id","success","e","failure","queryParams","department","Maybe","requireDeparment","getRequiredDepartment","agentData","Promise","await","getNextAgent","agentId"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { Match, check } from 'meteor/check';\n\nimport { API } from '../../../../api/server';\nimport { findRoom, findGuest, findAgent, findOpenRoom } from '../lib/livechat';\nimport { Livechat } from '../../lib/Livechat';\n\nAPI.v1.addRoute('livechat/agent.info/:rid/:token', {\n\tget() {\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\trid: String,\n\t\t\t\ttoken: String,\n\t\t\t});\n\n\t\t\tconst visitor = findGuest(this.urlParams.token);\n\t\t\tif (!visitor) {\n\t\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t\t}\n\n\t\t\tconst room = findRoom(this.urlParams.token, this.urlParams.rid);\n\t\t\tif (!room) {\n\t\t\t\tthrow new Meteor.Error('invalid-room');\n\t\t\t}\n\n\t\t\tconst agent = room && room.servedBy && findAgent(room.servedBy._id);\n\t\t\tif (!agent) {\n\t\t\t\tthrow new Meteor.Error('invalid-agent');\n\t\t\t}\n\n\t\t\treturn API.v1.success({ agent });\n\t\t} catch (e) {\n\t\t\treturn API.v1.failure(e);\n\t\t}\n\t},\n});\n\nAPI.v1.addRoute('livechat/agent.next/:token', {\n\tget() {\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttoken: String,\n\t\t\t});\n\n\t\t\tcheck(this.queryParams, {\n\t\t\t\tdepartment: Match.Maybe(String),\n\t\t\t});\n\n\t\t\tconst { token } = this.urlParams;\n\t\t\tconst room = findOpenRoom(token);\n\t\t\tif (room) {\n\t\t\t\treturn API.v1.success();\n\t\t\t}\n\n\t\t\tlet { department } = this.queryParams;\n\t\t\tif (!department) {\n\t\t\t\tconst requireDeparment = Livechat.getRequiredDepartment();\n\t\t\t\tif (requireDeparment) {\n\t\t\t\t\tdepartment = requireDeparment._id;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst agentData = Promise.await(Livechat.getNextAgent(department));\n\t\t\tif (!agentData) {\n\t\t\t\tthrow new Meteor.Error('agent-not-found');\n\t\t\t}\n\n\t\t\tconst agent = findAgent(agentData.agentId);\n\t\t\tif (!agent) {\n\t\t\t\tthrow new Meteor.Error('invalid-agent');\n\t\t\t}\n\n\t\t\treturn API.v1.success({ agent });\n\t\t} catch (e) {\n\t\t\treturn API.v1.failure(e);\n\t\t}\n\t},\n});\n"]},"sourceType":"module","hash":"73051b2ae06c96670870ffbe7b7f91ac1402e06e"}
