{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apps/client/orchestrator.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"app/apps/client/orchestrator.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apps/client/orchestrator.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apps/client/orchestrator.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/apps/client/orchestrator.js"}},"code":"let _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n\n}, 0);\nmodule.export({\n  Apps: () => Apps\n});\nlet AppClientManager;\nmodule.link(\"@rocket.chat/apps-engine/client/AppClientManager\", {\n  AppClientManager(v) {\n    AppClientManager = v;\n  }\n\n}, 0);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 1);\nlet Tracker;\nmodule.link(\"meteor/tracker\", {\n  Tracker(v) {\n    Tracker = v;\n  }\n\n}, 2);\nlet dispatchToastMessage;\nmodule.link(\"../../../client/lib/toast\", {\n  dispatchToastMessage(v) {\n    dispatchToastMessage = v;\n  }\n\n}, 3);\nlet hasAtLeastOnePermission;\nmodule.link(\"../../authorization\", {\n  hasAtLeastOnePermission(v) {\n    hasAtLeastOnePermission = v;\n  }\n\n}, 4);\nlet settings;\nmodule.link(\"../../settings/client\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 5);\nlet CachedCollectionManager;\nmodule.link(\"../../ui-cached-collection\", {\n  CachedCollectionManager(v) {\n    CachedCollectionManager = v;\n  }\n\n}, 6);\nlet APIClient;\nmodule.link(\"../../utils\", {\n  APIClient(v) {\n    APIClient = v;\n  }\n\n}, 7);\nlet AppWebsocketReceiver;\nmodule.link(\"./communication\", {\n  AppWebsocketReceiver(v) {\n    AppWebsocketReceiver = v;\n  }\n\n}, 8);\nlet handleI18nResources;\nmodule.link(\"./i18n\", {\n  handleI18nResources(v) {\n    handleI18nResources = v;\n  }\n\n}, 9);\nlet RealAppsEngineUIHost;\nmodule.link(\"./RealAppsEngineUIHost\", {\n  RealAppsEngineUIHost(v) {\n    RealAppsEngineUIHost = v;\n  }\n\n}, 10);\n\nconst createDeferredValue = () => {\n  let resolve;\n  let reject;\n  const promise = new Promise((_resolve, _reject) => {\n    resolve = _resolve;\n    reject = _reject;\n  });\n  return [promise, resolve, reject];\n};\n\nclass AppClientOrchestrator {\n  constructor() {\n    this.load = async isEnabled => {\n      if (!this.isLoaded) {\n        this.ws = new AppWebsocketReceiver();\n        this.isLoaded = true;\n      }\n\n      this.setEnabled(isEnabled); // Since the deferred value (a promise) is immutable after resolved,\n      // it need to be recreated to resolve a new value\n\n      [this.deferredIsEnabled, this.setEnabled] = createDeferredValue();\n      await handleI18nResources();\n      this.setEnabled(isEnabled);\n    };\n\n    this.getWsListener = () => this.ws;\n\n    this.getAppClientManager = () => this._manager;\n\n    this.handleError = error => {\n      console.error(error);\n\n      if (hasAtLeastOnePermission(['manage-apps'])) {\n        dispatchToastMessage({\n          type: 'error',\n          message: error.message\n        });\n      }\n    };\n\n    this.isEnabled = () => this.deferredIsEnabled;\n\n    this.getApps = async () => {\n      const {\n        apps\n      } = await APIClient.get('apps');\n      return apps;\n    };\n\n    this.getAppsFromMarketplace = async () => {\n      const appsOverviews = await APIClient.get('apps', {\n        marketplace: 'true'\n      });\n      return appsOverviews.map(_ref => {\n        let {\n          latest,\n          price,\n          pricingPlans,\n          purchaseType,\n          isEnterpriseOnly\n        } = _ref;\n        return _objectSpread(_objectSpread({}, latest), {}, {\n          price,\n          pricingPlans,\n          purchaseType,\n          isEnterpriseOnly\n        });\n      });\n    };\n\n    this.getAppsOnBundle = async bundleId => {\n      const {\n        apps\n      } = await APIClient.get(\"apps/bundles/\".concat(bundleId, \"/apps\"));\n      return apps;\n    };\n\n    this.getAppsLanguages = async () => {\n      const {\n        apps\n      } = await APIClient.get('apps/languages');\n      return apps;\n    };\n\n    this.getApp = async appId => {\n      const {\n        app\n      } = await APIClient.get(\"apps/\".concat(appId));\n      return app;\n    };\n\n    this.getAppFromMarketplace = async (appId, version) => {\n      const {\n        app\n      } = await APIClient.get(\"apps/\".concat(appId), {\n        marketplace: 'true',\n        version\n      });\n      return app;\n    };\n\n    this.getLatestAppFromMarketplace = async (appId, version) => {\n      const {\n        app\n      } = await APIClient.get(\"apps/\".concat(appId), {\n        marketplace: 'true',\n        update: 'true',\n        appVersion: version\n      });\n      return app;\n    };\n\n    this.getAppSettings = async appId => {\n      const {\n        settings\n      } = await APIClient.get(\"apps/\".concat(appId, \"/settings\"));\n      return settings;\n    };\n\n    this.setAppSettings = async (appId, settings) => {\n      const {\n        updated\n      } = await APIClient.post(\"apps/\".concat(appId, \"/settings\"), undefined, {\n        settings\n      });\n      return updated;\n    };\n\n    this.getAppApis = async appId => {\n      const {\n        apis\n      } = await APIClient.get(\"apps/\".concat(appId, \"/apis\"));\n      return apis;\n    };\n\n    this.getAppLanguages = async appId => {\n      const {\n        languages\n      } = await APIClient.get(\"apps/\".concat(appId, \"/languages\"));\n      return languages;\n    };\n\n    this.installApp = async (appId, version, permissionsGranted) => {\n      const {\n        app\n      } = await APIClient.post('apps/', {\n        appId,\n        marketplace: true,\n        version,\n        permissionsGranted\n      });\n      return app;\n    };\n\n    this.updateApp = async (appId, version, permissionsGranted) => {\n      const {\n        app\n      } = await APIClient.post(\"apps/\".concat(appId), {\n        appId,\n        marketplace: true,\n        version,\n        permissionsGranted\n      });\n      return app;\n    };\n\n    this.uninstallApp = appId => APIClient.delete(\"apps/\".concat(appId));\n\n    this.syncApp = appId => APIClient.post(\"apps/\".concat(appId, \"/sync\"));\n\n    this.setAppStatus = async (appId, status) => {\n      const {\n        status: effectiveStatus\n      } = await APIClient.post(\"apps/\".concat(appId, \"/status\"), {\n        status\n      });\n      return effectiveStatus;\n    };\n\n    this.enableApp = appId => this.setAppStatus(appId, 'manually_enabled');\n\n    this.disableApp = appId => this.setAppStatus(appId, 'manually_disabled');\n\n    this.buildExternalUrl = function (appId) {\n      let purchaseType = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'buy';\n      let details = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n      return APIClient.get('apps', {\n        buildExternalUrl: 'true',\n        appId,\n        purchaseType,\n        details\n      });\n    };\n\n    this.getCategories = async () => {\n      const categories = await APIClient.get('apps', {\n        categories: 'true'\n      });\n      return categories;\n    };\n\n    this.getUIHost = () => this._appClientUIHost;\n\n    this._appClientUIHost = new RealAppsEngineUIHost();\n    this._manager = new AppClientManager(this._appClientUIHost);\n    this.isLoaded = false;\n    [this.deferredIsEnabled, this.setEnabled] = createDeferredValue();\n  }\n\n}\n\nconst Apps = new AppClientOrchestrator();\nMeteor.startup(() => {\n  CachedCollectionManager.onLogin(() => {\n    Meteor.call('apps/is-enabled', (error, isEnabled) => {\n      if (error) {\n        Apps.handleError(error);\n        return;\n      }\n\n      Apps.getAppClientManager().initialize();\n      Apps.load(isEnabled);\n    });\n  });\n  Tracker.autorun(() => {\n    const isEnabled = settings.get('Apps_Framework_enabled');\n    Apps.load(isEnabled);\n  });\n});","map":{"version":3,"sources":["app/apps/client/orchestrator.js"],"names":["_objectSpread","module","link","default","v","export","Apps","AppClientManager","Meteor","Tracker","dispatchToastMessage","hasAtLeastOnePermission","settings","CachedCollectionManager","APIClient","AppWebsocketReceiver","handleI18nResources","RealAppsEngineUIHost","createDeferredValue","resolve","reject","promise","Promise","_resolve","_reject","AppClientOrchestrator","constructor","load","isEnabled","isLoaded","ws","setEnabled","deferredIsEnabled","getWsListener","getAppClientManager","_manager","handleError","error","console","type","message","getApps","apps","get","getAppsFromMarketplace","appsOverviews","marketplace","map","latest","price","pricingPlans","purchaseType","isEnterpriseOnly","getAppsOnBundle","bundleId","getAppsLanguages","getApp","appId","app","getAppFromMarketplace","version","getLatestAppFromMarketplace","update","appVersion","getAppSettings","setAppSettings","updated","post","undefined","getAppApis","apis","getAppLanguages","languages","installApp","permissionsGranted","updateApp","uninstallApp","delete","syncApp","setAppStatus","status","effectiveStatus","enableApp","disableApp","buildExternalUrl","details","getCategories","categories","getUIHost","_appClientUIHost","startup","onLogin","call","initialize","autorun"],"mappings":"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","sourcesContent":["import { AppClientManager } from '@rocket.chat/apps-engine/client/AppClientManager';\nimport { Meteor } from 'meteor/meteor';\nimport { Tracker } from 'meteor/tracker';\n\nimport { dispatchToastMessage } from '../../../client/lib/toast';\nimport { hasAtLeastOnePermission } from '../../authorization';\nimport { settings } from '../../settings/client';\nimport { CachedCollectionManager } from '../../ui-cached-collection';\nimport { APIClient } from '../../utils';\nimport { AppWebsocketReceiver } from './communication';\nimport { handleI18nResources } from './i18n';\nimport { RealAppsEngineUIHost } from './RealAppsEngineUIHost';\n\nconst createDeferredValue = () => {\n\tlet resolve;\n\tlet reject;\n\tconst promise = new Promise((_resolve, _reject) => {\n\t\tresolve = _resolve;\n\t\treject = _reject;\n\t});\n\n\treturn [promise, resolve, reject];\n};\n\nclass AppClientOrchestrator {\n\tconstructor() {\n\t\tthis._appClientUIHost = new RealAppsEngineUIHost();\n\t\tthis._manager = new AppClientManager(this._appClientUIHost);\n\t\tthis.isLoaded = false;\n\t\t[this.deferredIsEnabled, this.setEnabled] = createDeferredValue();\n\t}\n\n\tload = async (isEnabled) => {\n\t\tif (!this.isLoaded) {\n\t\t\tthis.ws = new AppWebsocketReceiver();\n\t\t\tthis.isLoaded = true;\n\t\t}\n\n\t\tthis.setEnabled(isEnabled);\n\n\t\t// Since the deferred value (a promise) is immutable after resolved,\n\t\t// it need to be recreated to resolve a new value\n\t\t[this.deferredIsEnabled, this.setEnabled] = createDeferredValue();\n\n\t\tawait handleI18nResources();\n\t\tthis.setEnabled(isEnabled);\n\t};\n\n\tgetWsListener = () => this.ws;\n\n\tgetAppClientManager = () => this._manager;\n\n\thandleError = (error) => {\n\t\tconsole.error(error);\n\t\tif (hasAtLeastOnePermission(['manage-apps'])) {\n\t\t\tdispatchToastMessage({\n\t\t\t\ttype: 'error',\n\t\t\t\tmessage: error.message,\n\t\t\t});\n\t\t}\n\t};\n\n\tisEnabled = () => this.deferredIsEnabled;\n\n\tgetApps = async () => {\n\t\tconst { apps } = await APIClient.get('apps');\n\t\treturn apps;\n\t};\n\n\tgetAppsFromMarketplace = async () => {\n\t\tconst appsOverviews = await APIClient.get('apps', { marketplace: 'true' });\n\t\treturn appsOverviews.map(({ latest, price, pricingPlans, purchaseType, isEnterpriseOnly }) => ({\n\t\t\t...latest,\n\t\t\tprice,\n\t\t\tpricingPlans,\n\t\t\tpurchaseType,\n\t\t\tisEnterpriseOnly,\n\t\t}));\n\t};\n\n\tgetAppsOnBundle = async (bundleId) => {\n\t\tconst { apps } = await APIClient.get(`apps/bundles/${bundleId}/apps`);\n\t\treturn apps;\n\t};\n\n\tgetAppsLanguages = async () => {\n\t\tconst { apps } = await APIClient.get('apps/languages');\n\t\treturn apps;\n\t};\n\n\tgetApp = async (appId) => {\n\t\tconst { app } = await APIClient.get(`apps/${appId}`);\n\t\treturn app;\n\t};\n\n\tgetAppFromMarketplace = async (appId, version) => {\n\t\tconst { app } = await APIClient.get(`apps/${appId}`, {\n\t\t\tmarketplace: 'true',\n\t\t\tversion,\n\t\t});\n\t\treturn app;\n\t};\n\n\tgetLatestAppFromMarketplace = async (appId, version) => {\n\t\tconst { app } = await APIClient.get(`apps/${appId}`, {\n\t\t\tmarketplace: 'true',\n\t\t\tupdate: 'true',\n\t\t\tappVersion: version,\n\t\t});\n\t\treturn app;\n\t};\n\n\tgetAppSettings = async (appId) => {\n\t\tconst { settings } = await APIClient.get(`apps/${appId}/settings`);\n\t\treturn settings;\n\t};\n\n\tsetAppSettings = async (appId, settings) => {\n\t\tconst { updated } = await APIClient.post(`apps/${appId}/settings`, undefined, { settings });\n\t\treturn updated;\n\t};\n\n\tgetAppApis = async (appId) => {\n\t\tconst { apis } = await APIClient.get(`apps/${appId}/apis`);\n\t\treturn apis;\n\t};\n\n\tgetAppLanguages = async (appId) => {\n\t\tconst { languages } = await APIClient.get(`apps/${appId}/languages`);\n\t\treturn languages;\n\t};\n\n\tinstallApp = async (appId, version, permissionsGranted) => {\n\t\tconst { app } = await APIClient.post('apps/', {\n\t\t\tappId,\n\t\t\tmarketplace: true,\n\t\t\tversion,\n\t\t\tpermissionsGranted,\n\t\t});\n\t\treturn app;\n\t};\n\n\tupdateApp = async (appId, version, permissionsGranted) => {\n\t\tconst { app } = await APIClient.post(`apps/${appId}`, {\n\t\t\tappId,\n\t\t\tmarketplace: true,\n\t\t\tversion,\n\t\t\tpermissionsGranted,\n\t\t});\n\t\treturn app;\n\t};\n\n\tuninstallApp = (appId) => APIClient.delete(`apps/${appId}`);\n\n\tsyncApp = (appId) => APIClient.post(`apps/${appId}/sync`);\n\n\tsetAppStatus = async (appId, status) => {\n\t\tconst { status: effectiveStatus } = await APIClient.post(`apps/${appId}/status`, { status });\n\t\treturn effectiveStatus;\n\t};\n\n\tenableApp = (appId) => this.setAppStatus(appId, 'manually_enabled');\n\n\tdisableApp = (appId) => this.setAppStatus(appId, 'manually_disabled');\n\n\tbuildExternalUrl = (appId, purchaseType = 'buy', details = false) =>\n\t\tAPIClient.get('apps', {\n\t\t\tbuildExternalUrl: 'true',\n\t\t\tappId,\n\t\t\tpurchaseType,\n\t\t\tdetails,\n\t\t});\n\n\tgetCategories = async () => {\n\t\tconst categories = await APIClient.get('apps', { categories: 'true' });\n\t\treturn categories;\n\t};\n\n\tgetUIHost = () => this._appClientUIHost;\n}\n\nexport const Apps = new AppClientOrchestrator();\n\nMeteor.startup(() => {\n\tCachedCollectionManager.onLogin(() => {\n\t\tMeteor.call('apps/is-enabled', (error, isEnabled) => {\n\t\t\tif (error) {\n\t\t\t\tApps.handleError(error);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tApps.getAppClientManager().initialize();\n\t\t\tApps.load(isEnabled);\n\t\t});\n\t});\n\n\tTracker.autorun(() => {\n\t\tconst isEnabled = settings.get('Apps_Framework_enabled');\n\t\tApps.load(isEnabled);\n\t});\n});\n"]},"sourceType":"module","hash":"d8a1c47c20ac5e0a95f24e1c40359ee55dfa0276"}
