{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/2fa/server/loginHandler.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/2fa/server/loginHandler.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/2fa/server/loginHandler.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/2fa/server/loginHandler.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/2fa/server/loginHandler.js"}},"code":"let Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet Accounts;\nmodule.link(\"meteor/accounts-base\", {\n  Accounts(v) {\n    Accounts = v;\n  }\n\n}, 1);\nlet OAuth;\nmodule.link(\"meteor/oauth\", {\n  OAuth(v) {\n    OAuth = v;\n  }\n\n}, 2);\nlet check;\nmodule.link(\"meteor/check\", {\n  check(v) {\n    check = v;\n  }\n\n}, 3);\nlet callbacks;\nmodule.link(\"../../../lib/callbacks\", {\n  callbacks(v) {\n    callbacks = v;\n  }\n\n}, 4);\nlet checkCodeForUser;\nmodule.link(\"./code/index\", {\n  checkCodeForUser(v) {\n    checkCodeForUser = v;\n  }\n\n}, 5);\nAccounts.registerLoginHandler('totp', function (options) {\n  if (!options.totp || !options.totp.code) {\n    return;\n  }\n\n  return Accounts._runLoginHandlers(this, options.totp.login);\n});\ncallbacks.add('onValidateLogin', login => {\n  if (login.type === 'resume' || login.type === 'proxy' || login.methodName === 'verifyEmail') {\n    return login;\n  }\n\n  const [loginArgs] = login.methodArguments; // CAS login doesn't yet support 2FA.\n\n  if (loginArgs.cas) {\n    return login;\n  }\n\n  const {\n    totp\n  } = loginArgs;\n  checkCodeForUser({\n    user: login.user,\n    code: totp && totp.code,\n    options: {\n      disablePasswordFallback: true\n    }\n  });\n  return login;\n}, callbacks.priority.MEDIUM, '2fa');\n\nconst recreateError = errorDoc => {\n  let error;\n\n  if (errorDoc.meteorError) {\n    error = new Meteor.Error();\n    delete errorDoc.meteorError;\n  } else {\n    error = new Error();\n  }\n\n  Object.getOwnPropertyNames(errorDoc).forEach(key => {\n    error[key] = errorDoc[key];\n  });\n  return error;\n};\n\nOAuth._retrievePendingCredential = function (key) {\n  const credentialSecret = (arguments.length <= 1 ? 0 : arguments.length - 1) > 0 && (arguments.length <= 1 ? undefined : arguments[1]) !== undefined ? arguments.length <= 1 ? undefined : arguments[1] : null;\n  check(key, String);\n\n  const pendingCredential = OAuth._pendingCredentials.findOne({\n    key,\n    credentialSecret\n  });\n\n  if (!pendingCredential) {\n    return;\n  }\n\n  if (pendingCredential.credential.error) {\n    OAuth._pendingCredentials.remove({\n      _id: pendingCredential._id\n    });\n\n    return recreateError(pendingCredential.credential.error);\n  } // Work-around to make the credentials reusable for 2FA\n\n\n  const future = new Date();\n  future.setMinutes(future.getMinutes() + 2);\n\n  OAuth._pendingCredentials.update({\n    _id: pendingCredential._id\n  }, {\n    $set: {\n      createdAt: future\n    }\n  });\n\n  return OAuth.openSecret(pendingCredential.credential);\n};","map":{"version":3,"sources":["app/2fa/server/loginHandler.js"],"names":["Meteor","module","link","v","Accounts","OAuth","check","callbacks","checkCodeForUser","registerLoginHandler","options","totp","code","_runLoginHandlers","login","add","type","methodName","loginArgs","methodArguments","cas","user","disablePasswordFallback","priority","MEDIUM","recreateError","errorDoc","error","meteorError","Error","Object","getOwnPropertyNames","forEach","key","_retrievePendingCredential","credentialSecret","undefined","String","pendingCredential","_pendingCredentials","findOne","credential","remove","_id","future","Date","setMinutes","getMinutes","update","$set","createdAt","openSecret"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { Accounts } from 'meteor/accounts-base';\nimport { OAuth } from 'meteor/oauth';\nimport { check } from 'meteor/check';\n\nimport { callbacks } from '../../../lib/callbacks';\nimport { checkCodeForUser } from './code/index';\n\nAccounts.registerLoginHandler('totp', function (options) {\n\tif (!options.totp || !options.totp.code) {\n\t\treturn;\n\t}\n\n\treturn Accounts._runLoginHandlers(this, options.totp.login);\n});\n\ncallbacks.add(\n\t'onValidateLogin',\n\t(login) => {\n\t\tif (login.type === 'resume' || login.type === 'proxy' || login.methodName === 'verifyEmail') {\n\t\t\treturn login;\n\t\t}\n\n\t\tconst [loginArgs] = login.methodArguments;\n\t\t// CAS login doesn't yet support 2FA.\n\t\tif (loginArgs.cas) {\n\t\t\treturn login;\n\t\t}\n\n\t\tconst { totp } = loginArgs;\n\n\t\tcheckCodeForUser({\n\t\t\tuser: login.user,\n\t\t\tcode: totp && totp.code,\n\t\t\toptions: { disablePasswordFallback: true },\n\t\t});\n\n\t\treturn login;\n\t},\n\tcallbacks.priority.MEDIUM,\n\t'2fa',\n);\n\nconst recreateError = (errorDoc) => {\n\tlet error;\n\n\tif (errorDoc.meteorError) {\n\t\terror = new Meteor.Error();\n\t\tdelete errorDoc.meteorError;\n\t} else {\n\t\terror = new Error();\n\t}\n\n\tObject.getOwnPropertyNames(errorDoc).forEach((key) => {\n\t\terror[key] = errorDoc[key];\n\t});\n\treturn error;\n};\n\nOAuth._retrievePendingCredential = function (key, ...args) {\n\tconst credentialSecret = args.length > 0 && args[0] !== undefined ? args[0] : null;\n\tcheck(key, String);\n\n\tconst pendingCredential = OAuth._pendingCredentials.findOne({\n\t\tkey,\n\t\tcredentialSecret,\n\t});\n\n\tif (!pendingCredential) {\n\t\treturn;\n\t}\n\n\tif (pendingCredential.credential.error) {\n\t\tOAuth._pendingCredentials.remove({\n\t\t\t_id: pendingCredential._id,\n\t\t});\n\t\treturn recreateError(pendingCredential.credential.error);\n\t}\n\n\t// Work-around to make the credentials reusable for 2FA\n\tconst future = new Date();\n\tfuture.setMinutes(future.getMinutes() + 2);\n\n\tOAuth._pendingCredentials.update(\n\t\t{\n\t\t\t_id: pendingCredential._id,\n\t\t},\n\t\t{\n\t\t\t$set: {\n\t\t\t\tcreatedAt: future,\n\t\t\t},\n\t\t},\n\t);\n\n\treturn OAuth.openSecret(pendingCredential.credential);\n};\n"]},"sourceType":"module","hash":"e9805219dfc7f0928b8280e56196806bee5623a2"}
