{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/videobridge/server/methods/jitsiSetTimeout.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/videobridge/server/methods/jitsiSetTimeout.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/videobridge/server/methods/jitsiSetTimeout.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/videobridge/server/methods/jitsiSetTimeout.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/videobridge/server/methods/jitsiSetTimeout.js"}},"code":"let _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n\n}, 0);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet TAPi18n;\nmodule.link(\"meteor/rocketchat:tap-i18n\", {\n  TAPi18n(v) {\n    TAPi18n = v;\n  }\n\n}, 1);\nlet Rooms, Messages, Users;\nmodule.link(\"../../../models/server\", {\n  Rooms(v) {\n    Rooms = v;\n  },\n\n  Messages(v) {\n    Messages = v;\n  },\n\n  Users(v) {\n    Users = v;\n  }\n\n}, 2);\nlet callbacks;\nmodule.link(\"../../../../lib/callbacks\", {\n  callbacks(v) {\n    callbacks = v;\n  }\n\n}, 3);\nlet metrics;\nmodule.link(\"../../../metrics/server\", {\n  metrics(v) {\n    metrics = v;\n  }\n\n}, 4);\nlet CONSTANTS;\nmodule.link(\"../../constants\", {\n  \"*\"(v) {\n    CONSTANTS = v;\n  }\n\n}, 5);\nlet canSendMessage;\nmodule.link(\"../../../authorization/server\", {\n  canSendMessage(v) {\n    canSendMessage = v;\n  }\n\n}, 6);\nlet SystemLogger;\nmodule.link(\"../../../../server/lib/logger/system\", {\n  SystemLogger(v) {\n    SystemLogger = v;\n  }\n\n}, 7);\nlet settings;\nmodule.link(\"../../../settings\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 8);\n\n// TODO: Access Token missing. This is just a partial solution, it doesn't handle access token generation logic as present in this file - client/views/room/contextualBar/Call/Jitsi/CallJitsWithData.js\nconst resolveJitsiCallUrl = room => {\n  const rname = settings.get('Jitsi_URL_Room_Hash') ? settings.get('uniqueID') + room._id : encodeURIComponent(room.t === 'd' ? room.usernames.join(' x ') : room.name);\n  return \"\".concat(settings.get('Jitsi_SSL') ? 'https://' : 'http://').concat(settings.get('Jitsi_Domain'), \"/\").concat(settings.get('Jitsi_URL_Room_Prefix')).concat(rname).concat(settings.get('Jitsi_URL_Room_Suffix'));\n};\n\nMeteor.methods({\n  'jitsi:updateTimeout': function (rid) {\n    let joiningNow = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;\n\n    if (!Meteor.userId()) {\n      throw new Meteor.Error('error-invalid-user', 'Invalid user', {\n        method: 'jitsi:updateTimeout'\n      });\n    }\n\n    const uid = Meteor.userId();\n    const user = Users.findOneById(uid, {\n      fields: {\n        username: 1,\n        type: 1\n      }\n    });\n\n    try {\n      const room = canSendMessage(rid, {\n        uid,\n        username: user.username,\n        type: user.type\n      });\n      const currentTime = new Date().getTime();\n      const jitsiTimeout = room.jitsiTimeout && new Date(room.jitsiTimeout).getTime();\n      const nextTimeOut = new Date(currentTime + CONSTANTS.TIMEOUT);\n\n      if (!jitsiTimeout || currentTime > jitsiTimeout - CONSTANTS.TIMEOUT / 2) {\n        Rooms.setJitsiTimeout(rid, nextTimeOut);\n      }\n\n      if (joiningNow && (!jitsiTimeout || currentTime > jitsiTimeout)) {\n        metrics.messagesSent.inc(); // TODO This line needs to be moved to it's proper place. See the comments on: https://github.com/RocketChat/Rocket.Chat/pull/5736\n\n        const message = Messages.createWithTypeRoomIdMessageAndUser('jitsi_call_started', rid, '', Meteor.user(), {\n          actionLinks: [{\n            icon: 'icon-videocam',\n            label: TAPi18n.__('Click_to_join'),\n            i18nLabel: 'Click_to_join',\n            method_id: 'joinJitsiCall',\n            params: ''\n          }],\n          customFields: _objectSpread(_objectSpread({}, room.customFields && _objectSpread({}, room.customFields)), room.t === 'l' && {\n            jitsiCallUrl: resolveJitsiCallUrl(room)\n          })\n        });\n        message.msg = TAPi18n.__('Started_a_video_call');\n        callbacks.run('afterSaveMessage', message, _objectSpread(_objectSpread({}, room), {}, {\n          jitsiTimeout: currentTime + CONSTANTS.TIMEOUT\n        }));\n      }\n\n      return jitsiTimeout || nextTimeOut;\n    } catch (error) {\n      SystemLogger.error('Error starting video call:', error.message);\n      throw new Meteor.Error('error-starting-video-call', error.message, {\n        method: 'jitsi:updateTimeout'\n      });\n    }\n  }\n});","map":{"version":3,"sources":["app/videobridge/server/methods/jitsiSetTimeout.js"],"names":["_objectSpread","module","link","default","v","Meteor","TAPi18n","Rooms","Messages","Users","callbacks","metrics","CONSTANTS","canSendMessage","SystemLogger","settings","resolveJitsiCallUrl","room","rname","get","_id","encodeURIComponent","t","usernames","join","name","methods","rid","joiningNow","userId","Error","method","uid","user","findOneById","fields","username","type","currentTime","Date","getTime","jitsiTimeout","nextTimeOut","TIMEOUT","setJitsiTimeout","messagesSent","inc","message","createWithTypeRoomIdMessageAndUser","actionLinks","icon","label","__","i18nLabel","method_id","params","customFields","jitsiCallUrl","msg","run","error"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { TAPi18n } from 'meteor/rocketchat:tap-i18n';\n\nimport { Rooms, Messages, Users } from '../../../models/server';\nimport { callbacks } from '../../../../lib/callbacks';\nimport { metrics } from '../../../metrics/server';\nimport * as CONSTANTS from '../../constants';\nimport { canSendMessage } from '../../../authorization/server';\nimport { SystemLogger } from '../../../../server/lib/logger/system';\nimport { settings } from '../../../settings';\n\n// TODO: Access Token missing. This is just a partial solution, it doesn't handle access token generation logic as present in this file - client/views/room/contextualBar/Call/Jitsi/CallJitsWithData.js\nconst resolveJitsiCallUrl = (room) => {\n\tconst rname = settings.get('Jitsi_URL_Room_Hash')\n\t\t? settings.get('uniqueID') + room._id\n\t\t: encodeURIComponent(room.t === 'd' ? room.usernames.join(' x ') : room.name);\n\treturn `${settings.get('Jitsi_SSL') ? 'https://' : 'http://'}${settings.get('Jitsi_Domain')}/${settings.get(\n\t\t'Jitsi_URL_Room_Prefix',\n\t)}${rname}${settings.get('Jitsi_URL_Room_Suffix')}`;\n};\n\nMeteor.methods({\n\t'jitsi:updateTimeout': (rid, joiningNow = true) => {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', {\n\t\t\t\tmethod: 'jitsi:updateTimeout',\n\t\t\t});\n\t\t}\n\n\t\tconst uid = Meteor.userId();\n\n\t\tconst user = Users.findOneById(uid, {\n\t\t\tfields: {\n\t\t\t\tusername: 1,\n\t\t\t\ttype: 1,\n\t\t\t},\n\t\t});\n\n\t\ttry {\n\t\t\tconst room = canSendMessage(rid, { uid, username: user.username, type: user.type });\n\n\t\t\tconst currentTime = new Date().getTime();\n\n\t\t\tconst jitsiTimeout = room.jitsiTimeout && new Date(room.jitsiTimeout).getTime();\n\n\t\t\tconst nextTimeOut = new Date(currentTime + CONSTANTS.TIMEOUT);\n\n\t\t\tif (!jitsiTimeout || currentTime > jitsiTimeout - CONSTANTS.TIMEOUT / 2) {\n\t\t\t\tRooms.setJitsiTimeout(rid, nextTimeOut);\n\t\t\t}\n\n\t\t\tif (joiningNow && (!jitsiTimeout || currentTime > jitsiTimeout)) {\n\t\t\t\tmetrics.messagesSent.inc(); // TODO This line needs to be moved to it's proper place. See the comments on: https://github.com/RocketChat/Rocket.Chat/pull/5736\n\n\t\t\t\tconst message = Messages.createWithTypeRoomIdMessageAndUser('jitsi_call_started', rid, '', Meteor.user(), {\n\t\t\t\t\tactionLinks: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ticon: 'icon-videocam',\n\t\t\t\t\t\t\tlabel: TAPi18n.__('Click_to_join'),\n\t\t\t\t\t\t\ti18nLabel: 'Click_to_join',\n\t\t\t\t\t\t\tmethod_id: 'joinJitsiCall',\n\t\t\t\t\t\t\tparams: '',\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t\tcustomFields: {\n\t\t\t\t\t\t...(room.customFields && { ...room.customFields }),\n\t\t\t\t\t\t...(room.t === 'l' && { jitsiCallUrl: resolveJitsiCallUrl(room) }), // Note: this is just a temporary solution for the jitsi calls to work in Livechat. In future we wish to create specific events for specific to livechat calls (eg: start, accept, decline, end, etc) and this url info will be passed via there\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t\tmessage.msg = TAPi18n.__('Started_a_video_call');\n\t\t\t\tcallbacks.run('afterSaveMessage', message, {\n\t\t\t\t\t...room,\n\t\t\t\t\tjitsiTimeout: currentTime + CONSTANTS.TIMEOUT,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn jitsiTimeout || nextTimeOut;\n\t\t} catch (error) {\n\t\t\tSystemLogger.error('Error starting video call:', error.message);\n\n\t\t\tthrow new Meteor.Error('error-starting-video-call', error.message, {\n\t\t\t\tmethod: 'jitsi:updateTimeout',\n\t\t\t});\n\t\t}\n\t},\n});\n"]},"sourceType":"module","hash":"18e370a0e567a16ca3db6faa2f4d3be0e83b197c"}
