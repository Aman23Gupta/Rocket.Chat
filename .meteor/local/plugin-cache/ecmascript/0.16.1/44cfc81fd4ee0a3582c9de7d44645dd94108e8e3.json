{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/file-upload/server/config/AmazonS3.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/file-upload/server/config/AmazonS3.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/file-upload/server/config/AmazonS3.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/file-upload/server/config/AmazonS3.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/file-upload/server/config/AmazonS3.js"}},"code":"let http;\nmodule.link(\"http\", {\n  default(v) {\n    http = v;\n  }\n\n}, 0);\nlet https;\nmodule.link(\"https\", {\n  default(v) {\n    https = v;\n  }\n\n}, 1);\n\nlet _;\n\nmodule.link(\"underscore\", {\n  default(v) {\n    _ = v;\n  }\n\n}, 2);\nlet settings;\nmodule.link(\"../../../settings\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 3);\nlet FileUploadClass, FileUpload;\nmodule.link(\"../lib/FileUpload\", {\n  FileUploadClass(v) {\n    FileUploadClass = v;\n  },\n\n  FileUpload(v) {\n    FileUpload = v;\n  }\n\n}, 4);\nmodule.link(\"../../ufs/AmazonS3/server.js\");\nlet SystemLogger;\nmodule.link(\"../../../../server/lib/logger/system\", {\n  SystemLogger(v) {\n    SystemLogger = v;\n  }\n\n}, 5);\n\nconst get = function (file, req, res) {\n  const forceDownload = typeof req.query.download !== 'undefined';\n  this.store.getRedirectURL(file, forceDownload, (err, fileUrl) => {\n    if (err) {\n      return SystemLogger.error(err);\n    }\n\n    if (!fileUrl) {\n      return res.end();\n    }\n\n    const storeType = file.store.split(':').pop();\n\n    if (settings.get(\"FileUpload_S3_Proxy_\".concat(storeType))) {\n      const request = /^https:/.test(fileUrl) ? https : http;\n      return FileUpload.proxyFile(file.name, fileUrl, forceDownload, request, req, res);\n    }\n\n    return FileUpload.redirectToFile(fileUrl, req, res);\n  });\n};\n\nconst copy = function (file, out) {\n  const fileUrl = this.store.getRedirectURL(file);\n\n  if (fileUrl) {\n    const request = /^https:/.test(fileUrl) ? https : http;\n    request.get(fileUrl, fileRes => fileRes.pipe(out));\n  } else {\n    out.end();\n  }\n};\n\nconst AmazonS3Uploads = new FileUploadClass({\n  name: 'AmazonS3:Uploads',\n  get,\n  copy // store setted bellow\n\n});\nconst AmazonS3Avatars = new FileUploadClass({\n  name: 'AmazonS3:Avatars',\n  get,\n  copy // store setted bellow\n\n});\nconst AmazonS3UserDataFiles = new FileUploadClass({\n  name: 'AmazonS3:UserDataFiles',\n  get,\n  copy // store setted bellow\n\n});\n\nconst configure = _.debounce(function () {\n  const Bucket = settings.get('FileUpload_S3_Bucket');\n  const Acl = settings.get('FileUpload_S3_Acl');\n  const AWSAccessKeyId = settings.get('FileUpload_S3_AWSAccessKeyId');\n  const AWSSecretAccessKey = settings.get('FileUpload_S3_AWSSecretAccessKey');\n  const URLExpiryTimeSpan = settings.get('FileUpload_S3_URLExpiryTimeSpan');\n  const Region = settings.get('FileUpload_S3_Region');\n  const SignatureVersion = settings.get('FileUpload_S3_SignatureVersion');\n  const ForcePathStyle = settings.get('FileUpload_S3_ForcePathStyle'); // const CDN = RocketChat.settings.get('FileUpload_S3_CDN');\n\n  const BucketURL = settings.get('FileUpload_S3_BucketURL');\n\n  if (!Bucket) {\n    return;\n  }\n\n  const config = {\n    connection: {\n      signatureVersion: SignatureVersion,\n      s3ForcePathStyle: ForcePathStyle,\n      params: {\n        Bucket,\n        ACL: Acl\n      },\n      region: Region\n    },\n    URLExpiryTimeSpan\n  };\n\n  if (AWSAccessKeyId) {\n    config.connection.accessKeyId = AWSAccessKeyId;\n  }\n\n  if (AWSSecretAccessKey) {\n    config.connection.secretAccessKey = AWSSecretAccessKey;\n  }\n\n  if (BucketURL) {\n    config.connection.endpoint = BucketURL;\n  }\n\n  AmazonS3Uploads.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3Uploads.name, config);\n  AmazonS3Avatars.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3Avatars.name, config);\n  AmazonS3UserDataFiles.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3UserDataFiles.name, config);\n}, 500);\n\nsettings.watchByRegex(/^FileUpload_S3_/, configure);","map":{"version":3,"sources":["app/file-upload/server/config/AmazonS3.js"],"names":["http","module","link","default","v","https","_","settings","FileUploadClass","FileUpload","SystemLogger","get","file","req","res","forceDownload","query","download","store","getRedirectURL","err","fileUrl","error","end","storeType","split","pop","request","test","proxyFile","name","redirectToFile","copy","out","fileRes","pipe","AmazonS3Uploads","AmazonS3Avatars","AmazonS3UserDataFiles","configure","debounce","Bucket","Acl","AWSAccessKeyId","AWSSecretAccessKey","URLExpiryTimeSpan","Region","SignatureVersion","ForcePathStyle","BucketURL","config","connection","signatureVersion","s3ForcePathStyle","params","ACL","region","accessKeyId","secretAccessKey","endpoint","configureUploadsStore","watchByRegex"],"mappings":"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","sourcesContent":["import http from 'http';\nimport https from 'https';\n\nimport _ from 'underscore';\n\nimport { settings } from '../../../settings';\nimport { FileUploadClass, FileUpload } from '../lib/FileUpload';\nimport '../../ufs/AmazonS3/server.js';\nimport { SystemLogger } from '../../../../server/lib/logger/system';\n\nconst get = function (file, req, res) {\n\tconst forceDownload = typeof req.query.download !== 'undefined';\n\n\tthis.store.getRedirectURL(file, forceDownload, (err, fileUrl) => {\n\t\tif (err) {\n\t\t\treturn SystemLogger.error(err);\n\t\t}\n\n\t\tif (!fileUrl) {\n\t\t\treturn res.end();\n\t\t}\n\n\t\tconst storeType = file.store.split(':').pop();\n\t\tif (settings.get(`FileUpload_S3_Proxy_${storeType}`)) {\n\t\t\tconst request = /^https:/.test(fileUrl) ? https : http;\n\n\t\t\treturn FileUpload.proxyFile(file.name, fileUrl, forceDownload, request, req, res);\n\t\t}\n\n\t\treturn FileUpload.redirectToFile(fileUrl, req, res);\n\t});\n};\n\nconst copy = function (file, out) {\n\tconst fileUrl = this.store.getRedirectURL(file);\n\n\tif (fileUrl) {\n\t\tconst request = /^https:/.test(fileUrl) ? https : http;\n\t\trequest.get(fileUrl, (fileRes) => fileRes.pipe(out));\n\t} else {\n\t\tout.end();\n\t}\n};\n\nconst AmazonS3Uploads = new FileUploadClass({\n\tname: 'AmazonS3:Uploads',\n\tget,\n\tcopy,\n\t// store setted bellow\n});\n\nconst AmazonS3Avatars = new FileUploadClass({\n\tname: 'AmazonS3:Avatars',\n\tget,\n\tcopy,\n\t// store setted bellow\n});\n\nconst AmazonS3UserDataFiles = new FileUploadClass({\n\tname: 'AmazonS3:UserDataFiles',\n\tget,\n\tcopy,\n\t// store setted bellow\n});\n\nconst configure = _.debounce(function () {\n\tconst Bucket = settings.get('FileUpload_S3_Bucket');\n\tconst Acl = settings.get('FileUpload_S3_Acl');\n\tconst AWSAccessKeyId = settings.get('FileUpload_S3_AWSAccessKeyId');\n\tconst AWSSecretAccessKey = settings.get('FileUpload_S3_AWSSecretAccessKey');\n\tconst URLExpiryTimeSpan = settings.get('FileUpload_S3_URLExpiryTimeSpan');\n\tconst Region = settings.get('FileUpload_S3_Region');\n\tconst SignatureVersion = settings.get('FileUpload_S3_SignatureVersion');\n\tconst ForcePathStyle = settings.get('FileUpload_S3_ForcePathStyle');\n\t// const CDN = RocketChat.settings.get('FileUpload_S3_CDN');\n\tconst BucketURL = settings.get('FileUpload_S3_BucketURL');\n\n\tif (!Bucket) {\n\t\treturn;\n\t}\n\n\tconst config = {\n\t\tconnection: {\n\t\t\tsignatureVersion: SignatureVersion,\n\t\t\ts3ForcePathStyle: ForcePathStyle,\n\t\t\tparams: {\n\t\t\t\tBucket,\n\t\t\t\tACL: Acl,\n\t\t\t},\n\t\t\tregion: Region,\n\t\t},\n\t\tURLExpiryTimeSpan,\n\t};\n\n\tif (AWSAccessKeyId) {\n\t\tconfig.connection.accessKeyId = AWSAccessKeyId;\n\t}\n\n\tif (AWSSecretAccessKey) {\n\t\tconfig.connection.secretAccessKey = AWSSecretAccessKey;\n\t}\n\n\tif (BucketURL) {\n\t\tconfig.connection.endpoint = BucketURL;\n\t}\n\n\tAmazonS3Uploads.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3Uploads.name, config);\n\tAmazonS3Avatars.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3Avatars.name, config);\n\tAmazonS3UserDataFiles.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3UserDataFiles.name, config);\n}, 500);\n\nsettings.watchByRegex(/^FileUpload_S3_/, configure);\n"]},"sourceType":"module","hash":"44cfc81fd4ee0a3582c9de7d44645dd94108e8e3"}
