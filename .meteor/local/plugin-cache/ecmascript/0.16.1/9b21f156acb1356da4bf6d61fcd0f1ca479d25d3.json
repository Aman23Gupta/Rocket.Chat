{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apps/server/communication/uikit.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/apps/server/communication/uikit.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apps/server/communication/uikit.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/apps/server/communication/uikit.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/apps/server/communication/uikit.js"}},"code":"let _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n\n}, 0);\nmodule.export({\n  AppUIKitInteractionApi: () => AppUIKitInteractionApi\n});\nlet express;\nmodule.link(\"express\", {\n  default(v) {\n    express = v;\n  }\n\n}, 0);\nlet cors;\nmodule.link(\"cors\", {\n  default(v) {\n    cors = v;\n  }\n\n}, 1);\nlet rateLimit;\nmodule.link(\"express-rate-limit\", {\n  default(v) {\n    rateLimit = v;\n  }\n\n}, 2);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 3);\nlet WebApp;\nmodule.link(\"meteor/webapp\", {\n  WebApp(v) {\n    WebApp = v;\n  }\n\n}, 4);\nlet UIKitIncomingInteractionType;\nmodule.link(\"@rocket.chat/apps-engine/definition/uikit\", {\n  UIKitIncomingInteractionType(v) {\n    UIKitIncomingInteractionType = v;\n  }\n\n}, 5);\nlet AppInterface;\nmodule.link(\"@rocket.chat/apps-engine/definition/metadata\", {\n  AppInterface(v) {\n    AppInterface = v;\n  }\n\n}, 6);\nlet Users;\nmodule.link(\"../../../models/server\", {\n  Users(v) {\n    Users = v;\n  }\n\n}, 7);\nlet settings;\nmodule.link(\"../../../settings/server\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 8);\nlet Apps;\nmodule.link(\"../orchestrator\", {\n  Apps(v) {\n    Apps = v;\n  }\n\n}, 9);\nlet UiKitCoreApp;\nmodule.link(\"../../../../server/sdk\", {\n  UiKitCoreApp(v) {\n    UiKitCoreApp = v;\n  }\n\n}, 10);\nconst apiServer = express();\napiServer.disable('x-powered-by');\nlet corsEnabled = false;\nlet allowListOrigins = [];\nsettings.watch('API_Enable_CORS', value => {\n  corsEnabled = value;\n});\nsettings.watch('API_CORS_Origin', value => {\n  allowListOrigins = value ? value.trim().split(',').map(origin => String(origin).trim().toLocaleLowerCase()) : [];\n});\nconst corsOptions = {\n  origin: (origin, callback) => {\n    if (!origin || !corsEnabled || allowListOrigins.includes('*') || allowListOrigins.includes(origin) || origin === settings.get('Site_Url')) {\n      callback(null, true);\n    } else {\n      callback('Not allowed by CORS', false);\n    }\n  }\n};\nWebApp.connectHandlers.use(apiServer); // eslint-disable-next-line new-cap\n\nconst router = express.Router();\n\nconst unauthorized = res => res.status(401).send({\n  status: 'error',\n  message: 'You must be logged in to do this.'\n});\n\nMeteor.startup(() => {\n  // use specific rate limit of 600 (which is 60 times the default limits) requests per minute (around 10/second)\n  const apiLimiter = rateLimit({\n    windowMs: settings.get('API_Enable_Rate_Limiter_Limit_Time_Default'),\n    max: settings.get('API_Enable_Rate_Limiter_Limit_Calls_Default') * 60,\n    skip: () => settings.get('API_Enable_Rate_Limiter') !== true || process.env.NODE_ENV === 'development' && settings.get('API_Enable_Rate_Limiter_Dev') !== true\n  });\n  router.use(apiLimiter);\n});\nrouter.use((req, res, next) => {\n  const {\n    'x-user-id': userId,\n    'x-auth-token': authToken,\n    'x-visitor-token': visitorToken\n  } = req.headers;\n\n  if (userId && authToken) {\n    req.user = Users.findOneByIdAndLoginToken(userId, authToken);\n    req.userId = req.user._id;\n  }\n\n  if (visitorToken) {\n    req.visitor = Apps.getConverters().get('visitors').convertByToken(visitorToken);\n  }\n\n  if (!req.user && !req.visitor) {\n    return unauthorized(res);\n  }\n\n  next();\n});\napiServer.use('/api/apps/ui.interaction/', cors(corsOptions), router);\n\nconst getPayloadForType = (type, req) => {\n  if (type === UIKitIncomingInteractionType.BLOCK) {\n    const {\n      type,\n      actionId,\n      triggerId,\n      mid,\n      rid,\n      payload,\n      container\n    } = req.body;\n    const {\n      visitor,\n      user\n    } = req;\n    const room = rid; // orch.getConverters().get('rooms').convertById(rid);\n\n    const message = mid;\n    return {\n      type,\n      container,\n      actionId,\n      message,\n      triggerId,\n      payload,\n      user,\n      visitor,\n      room\n    };\n  }\n\n  if (type === UIKitIncomingInteractionType.VIEW_CLOSED) {\n    const {\n      type,\n      actionId,\n      payload: {\n        view,\n        isCleared\n      }\n    } = req.body;\n    const {\n      user\n    } = req;\n    return {\n      type,\n      actionId,\n      user,\n      payload: {\n        view,\n        isCleared\n      }\n    };\n  }\n\n  if (type === UIKitIncomingInteractionType.VIEW_SUBMIT) {\n    const {\n      type,\n      actionId,\n      triggerId,\n      payload\n    } = req.body;\n    const {\n      user\n    } = req;\n    return {\n      type,\n      actionId,\n      triggerId,\n      payload,\n      user\n    };\n  }\n\n  throw new Error('Type not supported');\n};\n\nrouter.post('/:appId', (req, res, next) => Promise.asyncApply(() => {\n  const {\n    appId\n  } = req.params;\n  const isCore = Promise.await(UiKitCoreApp.isRegistered(appId));\n\n  if (!isCore) {\n    return next();\n  }\n\n  const {\n    type\n  } = req.body;\n\n  try {\n    const payload = _objectSpread(_objectSpread({}, getPayloadForType(type, req)), {}, {\n      appId\n    });\n\n    const result = Promise.await(UiKitCoreApp[type](payload));\n    res.send(result);\n  } catch (e) {\n    console.error('ops', e);\n    res.status(500).send({\n      error: e.message\n    });\n  }\n}));\n\nconst appsRoutes = orch => (req, res) => {\n  const {\n    appId\n  } = req.params;\n  const {\n    type\n  } = req.body;\n\n  switch (type) {\n    case UIKitIncomingInteractionType.BLOCK:\n      {\n        const {\n          type,\n          actionId,\n          triggerId,\n          mid,\n          rid,\n          payload,\n          container\n        } = req.body;\n        const {\n          visitor\n        } = req;\n        const room = orch.getConverters().get('rooms').convertById(rid);\n        const user = orch.getConverters().get('users').convertToApp(req.user);\n        const message = mid && orch.getConverters().get('messages').convertById(mid);\n        const action = {\n          type,\n          container,\n          appId,\n          actionId,\n          message,\n          triggerId,\n          payload,\n          user,\n          visitor,\n          room\n        };\n\n        try {\n          const eventInterface = !visitor ? AppInterface.IUIKitInteractionHandler : AppInterface.IUIKitLivechatInteractionHandler;\n          const result = Promise.await(orch.triggerEvent(eventInterface, action));\n          res.send(result);\n        } catch (e) {\n          res.status(500).send(e.message);\n        }\n\n        break;\n      }\n\n    case UIKitIncomingInteractionType.VIEW_CLOSED:\n      {\n        const {\n          type,\n          actionId,\n          payload: {\n            view,\n            isCleared\n          }\n        } = req.body;\n        const user = orch.getConverters().get('users').convertToApp(req.user);\n        const action = {\n          type,\n          appId,\n          actionId,\n          user,\n          payload: {\n            view,\n            isCleared\n          }\n        };\n\n        try {\n          Promise.await(orch.triggerEvent('IUIKitInteractionHandler', action));\n          res.sendStatus(200);\n        } catch (e) {\n          res.status(500).send(e.message);\n        }\n\n        break;\n      }\n\n    case UIKitIncomingInteractionType.VIEW_SUBMIT:\n      {\n        const {\n          type,\n          actionId,\n          triggerId,\n          payload\n        } = req.body;\n        const user = orch.getConverters().get('users').convertToApp(req.user);\n        const action = {\n          type,\n          appId,\n          actionId,\n          triggerId,\n          payload,\n          user\n        };\n\n        try {\n          const result = Promise.await(orch.triggerEvent('IUIKitInteractionHandler', action));\n          res.send(result);\n        } catch (e) {\n          res.status(500).send(e.message);\n        }\n\n        break;\n      }\n\n    case UIKitIncomingInteractionType.ACTION_BUTTON:\n      {\n        const {\n          type,\n          actionId,\n          triggerId,\n          rid,\n          mid,\n          payload: {\n            context\n          }\n        } = req.body;\n        const room = orch.getConverters().get('rooms').convertById(rid);\n        const user = orch.getConverters().get('users').convertToApp(req.user);\n        const message = mid && orch.getConverters().get('messages').convertById(mid);\n        const action = {\n          type,\n          appId,\n          actionId,\n          triggerId,\n          user,\n          room,\n          message,\n          payload: {\n            context\n          }\n        };\n\n        try {\n          const result = Promise.await(orch.triggerEvent('IUIKitInteractionHandler', action));\n          res.send(result);\n        } catch (e) {\n          res.status(500).send(e.message);\n        }\n\n        break;\n      }\n\n    default:\n      {\n        res.status(400).send({\n          error: 'Unknown action'\n        });\n      }\n  } // TODO: validate payloads per type\n\n};\n\nclass AppUIKitInteractionApi {\n  constructor(orch) {\n    this.orch = orch;\n    router.post('/:appId', appsRoutes(orch));\n  }\n\n}","map":{"version":3,"sources":["app/apps/server/communication/uikit.js"],"names":["_objectSpread","module","link","default","v","export","AppUIKitInteractionApi","express","cors","rateLimit","Meteor","WebApp","UIKitIncomingInteractionType","AppInterface","Users","settings","Apps","UiKitCoreApp","apiServer","disable","corsEnabled","allowListOrigins","watch","value","trim","split","map","origin","String","toLocaleLowerCase","corsOptions","callback","includes","get","connectHandlers","use","router","Router","unauthorized","res","status","send","message","startup","apiLimiter","windowMs","max","skip","process","env","NODE_ENV","req","next","userId","authToken","visitorToken","headers","user","findOneByIdAndLoginToken","_id","visitor","getConverters","convertByToken","getPayloadForType","type","BLOCK","actionId","triggerId","mid","rid","payload","container","body","room","VIEW_CLOSED","view","isCleared","VIEW_SUBMIT","Error","post","appId","params","isCore","isRegistered","result","e","console","error","appsRoutes","orch","convertById","convertToApp","action","eventInterface","IUIKitInteractionHandler","IUIKitLivechatInteractionHandler","Promise","await","triggerEvent","sendStatus","ACTION_BUTTON","context","constructor"],"mappings":"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","sourcesContent":["import express from 'express';\nimport cors from 'cors';\nimport rateLimit from 'express-rate-limit';\nimport { Meteor } from 'meteor/meteor';\nimport { WebApp } from 'meteor/webapp';\nimport { UIKitIncomingInteractionType } from '@rocket.chat/apps-engine/definition/uikit';\nimport { AppInterface } from '@rocket.chat/apps-engine/definition/metadata';\n\nimport { Users } from '../../../models/server';\nimport { settings } from '../../../settings/server';\nimport { Apps } from '../orchestrator';\nimport { UiKitCoreApp } from '../../../../server/sdk';\n\nconst apiServer = express();\n\napiServer.disable('x-powered-by');\n\nlet corsEnabled = false;\nlet allowListOrigins = [];\n\nsettings.watch('API_Enable_CORS', (value) => {\n\tcorsEnabled = value;\n});\n\nsettings.watch('API_CORS_Origin', (value) => {\n\tallowListOrigins = value\n\t\t? value\n\t\t\t\t.trim()\n\t\t\t\t.split(',')\n\t\t\t\t.map((origin) => String(origin).trim().toLocaleLowerCase())\n\t\t: [];\n});\n\nconst corsOptions = {\n\torigin: (origin, callback) => {\n\t\tif (\n\t\t\t!origin ||\n\t\t\t!corsEnabled ||\n\t\t\tallowListOrigins.includes('*') ||\n\t\t\tallowListOrigins.includes(origin) ||\n\t\t\torigin === settings.get('Site_Url')\n\t\t) {\n\t\t\tcallback(null, true);\n\t\t} else {\n\t\t\tcallback('Not allowed by CORS', false);\n\t\t}\n\t},\n};\n\nWebApp.connectHandlers.use(apiServer);\n\n// eslint-disable-next-line new-cap\nconst router = express.Router();\n\nconst unauthorized = (res) =>\n\tres.status(401).send({\n\t\tstatus: 'error',\n\t\tmessage: 'You must be logged in to do this.',\n\t});\n\nMeteor.startup(() => {\n\t// use specific rate limit of 600 (which is 60 times the default limits) requests per minute (around 10/second)\n\tconst apiLimiter = rateLimit({\n\t\twindowMs: settings.get('API_Enable_Rate_Limiter_Limit_Time_Default'),\n\t\tmax: settings.get('API_Enable_Rate_Limiter_Limit_Calls_Default') * 60,\n\t\tskip: () =>\n\t\t\tsettings.get('API_Enable_Rate_Limiter') !== true ||\n\t\t\t(process.env.NODE_ENV === 'development' && settings.get('API_Enable_Rate_Limiter_Dev') !== true),\n\t});\n\trouter.use(apiLimiter);\n});\n\nrouter.use((req, res, next) => {\n\tconst { 'x-user-id': userId, 'x-auth-token': authToken, 'x-visitor-token': visitorToken } = req.headers;\n\n\tif (userId && authToken) {\n\t\treq.user = Users.findOneByIdAndLoginToken(userId, authToken);\n\t\treq.userId = req.user._id;\n\t}\n\n\tif (visitorToken) {\n\t\treq.visitor = Apps.getConverters().get('visitors').convertByToken(visitorToken);\n\t}\n\n\tif (!req.user && !req.visitor) {\n\t\treturn unauthorized(res);\n\t}\n\n\tnext();\n});\n\napiServer.use('/api/apps/ui.interaction/', cors(corsOptions), router);\n\nconst getPayloadForType = (type, req) => {\n\tif (type === UIKitIncomingInteractionType.BLOCK) {\n\t\tconst { type, actionId, triggerId, mid, rid, payload, container } = req.body;\n\n\t\tconst { visitor, user } = req;\n\t\tconst room = rid; // orch.getConverters().get('rooms').convertById(rid);\n\t\tconst message = mid;\n\n\t\treturn {\n\t\t\ttype,\n\t\t\tcontainer,\n\t\t\tactionId,\n\t\t\tmessage,\n\t\t\ttriggerId,\n\t\t\tpayload,\n\t\t\tuser,\n\t\t\tvisitor,\n\t\t\troom,\n\t\t};\n\t}\n\n\tif (type === UIKitIncomingInteractionType.VIEW_CLOSED) {\n\t\tconst {\n\t\t\ttype,\n\t\t\tactionId,\n\t\t\tpayload: { view, isCleared },\n\t\t} = req.body;\n\n\t\tconst { user } = req;\n\n\t\treturn {\n\t\t\ttype,\n\t\t\tactionId,\n\t\t\tuser,\n\t\t\tpayload: {\n\t\t\t\tview,\n\t\t\t\tisCleared,\n\t\t\t},\n\t\t};\n\t}\n\n\tif (type === UIKitIncomingInteractionType.VIEW_SUBMIT) {\n\t\tconst { type, actionId, triggerId, payload } = req.body;\n\n\t\tconst { user } = req;\n\n\t\treturn {\n\t\t\ttype,\n\t\t\tactionId,\n\t\t\ttriggerId,\n\t\t\tpayload,\n\t\t\tuser,\n\t\t};\n\t}\n\n\tthrow new Error('Type not supported');\n};\n\nrouter.post('/:appId', async (req, res, next) => {\n\tconst { appId } = req.params;\n\n\tconst isCore = await UiKitCoreApp.isRegistered(appId);\n\tif (!isCore) {\n\t\treturn next();\n\t}\n\n\tconst { type } = req.body;\n\n\ttry {\n\t\tconst payload = {\n\t\t\t...getPayloadForType(type, req),\n\t\t\tappId,\n\t\t};\n\n\t\tconst result = await UiKitCoreApp[type](payload);\n\n\t\tres.send(result);\n\t} catch (e) {\n\t\tconsole.error('ops', e);\n\t\tres.status(500).send({ error: e.message });\n\t}\n});\n\nconst appsRoutes = (orch) => (req, res) => {\n\tconst { appId } = req.params;\n\n\tconst { type } = req.body;\n\n\tswitch (type) {\n\t\tcase UIKitIncomingInteractionType.BLOCK: {\n\t\t\tconst { type, actionId, triggerId, mid, rid, payload, container } = req.body;\n\n\t\t\tconst { visitor } = req;\n\t\t\tconst room = orch.getConverters().get('rooms').convertById(rid);\n\t\t\tconst user = orch.getConverters().get('users').convertToApp(req.user);\n\t\t\tconst message = mid && orch.getConverters().get('messages').convertById(mid);\n\n\t\t\tconst action = {\n\t\t\t\ttype,\n\t\t\t\tcontainer,\n\t\t\t\tappId,\n\t\t\t\tactionId,\n\t\t\t\tmessage,\n\t\t\t\ttriggerId,\n\t\t\t\tpayload,\n\t\t\t\tuser,\n\t\t\t\tvisitor,\n\t\t\t\troom,\n\t\t\t};\n\n\t\t\ttry {\n\t\t\t\tconst eventInterface = !visitor ? AppInterface.IUIKitInteractionHandler : AppInterface.IUIKitLivechatInteractionHandler;\n\n\t\t\t\tconst result = Promise.await(orch.triggerEvent(eventInterface, action));\n\n\t\t\t\tres.send(result);\n\t\t\t} catch (e) {\n\t\t\t\tres.status(500).send(e.message);\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tcase UIKitIncomingInteractionType.VIEW_CLOSED: {\n\t\t\tconst {\n\t\t\t\ttype,\n\t\t\t\tactionId,\n\t\t\t\tpayload: { view, isCleared },\n\t\t\t} = req.body;\n\n\t\t\tconst user = orch.getConverters().get('users').convertToApp(req.user);\n\n\t\t\tconst action = {\n\t\t\t\ttype,\n\t\t\t\tappId,\n\t\t\t\tactionId,\n\t\t\t\tuser,\n\t\t\t\tpayload: {\n\t\t\t\t\tview,\n\t\t\t\t\tisCleared,\n\t\t\t\t},\n\t\t\t};\n\n\t\t\ttry {\n\t\t\t\tPromise.await(orch.triggerEvent('IUIKitInteractionHandler', action));\n\n\t\t\t\tres.sendStatus(200);\n\t\t\t} catch (e) {\n\t\t\t\tres.status(500).send(e.message);\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tcase UIKitIncomingInteractionType.VIEW_SUBMIT: {\n\t\t\tconst { type, actionId, triggerId, payload } = req.body;\n\n\t\t\tconst user = orch.getConverters().get('users').convertToApp(req.user);\n\n\t\t\tconst action = {\n\t\t\t\ttype,\n\t\t\t\tappId,\n\t\t\t\tactionId,\n\t\t\t\ttriggerId,\n\t\t\t\tpayload,\n\t\t\t\tuser,\n\t\t\t};\n\n\t\t\ttry {\n\t\t\t\tconst result = Promise.await(orch.triggerEvent('IUIKitInteractionHandler', action));\n\n\t\t\t\tres.send(result);\n\t\t\t} catch (e) {\n\t\t\t\tres.status(500).send(e.message);\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tcase UIKitIncomingInteractionType.ACTION_BUTTON: {\n\t\t\tconst {\n\t\t\t\ttype,\n\t\t\t\tactionId,\n\t\t\t\ttriggerId,\n\t\t\t\trid,\n\t\t\t\tmid,\n\t\t\t\tpayload: { context },\n\t\t\t} = req.body;\n\n\t\t\tconst room = orch.getConverters().get('rooms').convertById(rid);\n\t\t\tconst user = orch.getConverters().get('users').convertToApp(req.user);\n\t\t\tconst message = mid && orch.getConverters().get('messages').convertById(mid);\n\n\t\t\tconst action = {\n\t\t\t\ttype,\n\t\t\t\tappId,\n\t\t\t\tactionId,\n\t\t\t\ttriggerId,\n\t\t\t\tuser,\n\t\t\t\troom,\n\t\t\t\tmessage,\n\t\t\t\tpayload: {\n\t\t\t\t\tcontext,\n\t\t\t\t},\n\t\t\t};\n\n\t\t\ttry {\n\t\t\t\tconst result = Promise.await(orch.triggerEvent('IUIKitInteractionHandler', action));\n\n\t\t\t\tres.send(result);\n\t\t\t} catch (e) {\n\t\t\t\tres.status(500).send(e.message);\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tdefault: {\n\t\t\tres.status(400).send({ error: 'Unknown action' });\n\t\t}\n\t}\n\n\t// TODO: validate payloads per type\n};\n\nexport class AppUIKitInteractionApi {\n\tconstructor(orch) {\n\t\tthis.orch = orch;\n\n\t\trouter.post('/:appId', appsRoutes(orch));\n\t}\n}\n"]},"sourceType":"module","hash":"9b21f156acb1356da4bf6d61fcd0f1ca479d25d3"}
