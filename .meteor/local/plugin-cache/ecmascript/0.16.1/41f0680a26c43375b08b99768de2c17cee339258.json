{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/invites/server/functions/findOrCreateInvite.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","logicalAssignment"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.arm64"},"sourceFileName":"app/invites/server/functions/findOrCreateInvite.js","filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/invites/server/functions/findOrCreateInvite.js","targets":{"android":"95.0.0","chrome":"95.0.0","edge":"95.0.0","firefox":"78.0.0","ie":"10.0.0","ios":"15.0.0","opera":"81.0.0","safari":"15.1.0","samsung":"14.0.0"},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","root":"/Users/amangupta/Documents/Open-Source/Rocket.Chat","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.16.5","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":true,"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]},"_verified":true},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"proposal-logical-assignment-operators","visitor":{"_exploded":{},"_verified":{},"AssignmentExpression":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/amangupta/Documents/Open-Source/Rocket.Chat/app/invites/server/functions/findOrCreateInvite.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"app/invites/server/functions/findOrCreateInvite.js"}},"code":"module.export({\n  findOrCreateInvite: () => findOrCreateInvite\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet Random;\nmodule.link(\"meteor/random\", {\n  Random(v) {\n    Random = v;\n  }\n\n}, 1);\nlet hasPermission;\nmodule.link(\"../../../authorization\", {\n  hasPermission(v) {\n    hasPermission = v;\n  }\n\n}, 2);\nlet Notifications;\nmodule.link(\"../../../notifications\", {\n  Notifications(v) {\n    Notifications = v;\n  }\n\n}, 3);\nlet Subscriptions, Rooms;\nmodule.link(\"../../../models/server\", {\n  Subscriptions(v) {\n    Subscriptions = v;\n  },\n\n  Rooms(v) {\n    Rooms = v;\n  }\n\n}, 4);\nlet Invites;\nmodule.link(\"../../../models/server/raw\", {\n  Invites(v) {\n    Invites = v;\n  }\n\n}, 5);\nlet settings;\nmodule.link(\"../../../settings\", {\n  settings(v) {\n    settings = v;\n  }\n\n}, 6);\nlet getURL;\nmodule.link(\"../../../utils/lib/getURL\", {\n  getURL(v) {\n    getURL = v;\n  }\n\n}, 7);\nlet roomTypes, RoomMemberActions;\nmodule.link(\"../../../utils/server\", {\n  roomTypes(v) {\n    roomTypes = v;\n  },\n\n  RoomMemberActions(v) {\n    RoomMemberActions = v;\n  }\n\n}, 8);\n\nfunction getInviteUrl(invite) {\n  const {\n    _id\n  } = invite;\n  const useDirectLink = settings.get('Accounts_Registration_InviteUrlType') === 'direct';\n  return getURL(\"invite/\".concat(_id), {\n    full: useDirectLink,\n    cloud: !useDirectLink,\n    cloud_route: 'invite'\n  });\n}\n\nconst possibleDays = [0, 1, 7, 15, 30];\nconst possibleUses = [0, 1, 5, 10, 25, 50, 100];\n\nconst findOrCreateInvite = (userId, invite) => Promise.asyncApply(() => {\n  if (!userId || !invite) {\n    return false;\n  }\n\n  if (!invite.rid) {\n    throw new Meteor.Error('error-the-field-is-required', 'The field rid is required', {\n      method: 'findOrCreateInvite',\n      field: 'rid'\n    });\n  }\n\n  if (!hasPermission(userId, 'create-invite-links', invite.rid)) {\n    throw new Meteor.Error('not_authorized');\n  }\n\n  const subscription = Subscriptions.findOneByRoomIdAndUserId(invite.rid, userId, {\n    fields: {\n      _id: 1\n    }\n  });\n\n  if (!subscription) {\n    throw new Meteor.Error('error-invalid-room', 'The rid field is invalid', {\n      method: 'findOrCreateInvite',\n      field: 'rid'\n    });\n  }\n\n  const room = Rooms.findOneById(invite.rid);\n\n  if (!roomTypes.getConfig(room.t).allowMemberAction(room, RoomMemberActions.INVITE)) {\n    throw new Meteor.Error('error-room-type-not-allowed', 'Cannot create invite links for this room type', {\n      method: 'findOrCreateInvite'\n    });\n  }\n\n  const {\n    days = 1,\n    maxUses = 0\n  } = invite;\n\n  if (!possibleDays.includes(days)) {\n    throw new Meteor.Error('invalid-number-of-days', 'Invite should expire in 1, 7, 15 or 30 days, or send 0 to never expire.');\n  }\n\n  if (!possibleUses.includes(maxUses)) {\n    throw new Meteor.Error('invalid-number-of-uses', 'Invite should be valid for 1, 5, 10, 25, 50, 100 or infinite (0) uses.');\n  } // Before anything, let's check if there's an existing invite with the same settings for the same channel and user and that has not yet expired.\n\n\n  const existing = Promise.await(Invites.findOneByUserRoomMaxUsesAndExpiration(userId, invite.rid, maxUses, days)); // If an existing invite was found, return it's _id instead of creating a new one.\n\n  if (existing) {\n    existing.url = getInviteUrl(existing);\n    return existing;\n  }\n\n  const _id = Random.id(6); // insert invite\n\n\n  const createdAt = new Date();\n  let expires = null;\n\n  if (days > 0) {\n    expires = new Date(createdAt);\n    expires.setDate(expires.getDate() + days);\n  }\n\n  const createInvite = {\n    _id,\n    days,\n    maxUses,\n    rid: invite.rid,\n    userId,\n    createdAt,\n    expires,\n    uses: 0\n  };\n  Promise.await(Invites.insertOne(createInvite));\n  Notifications.notifyUser(userId, 'updateInvites', {\n    invite: createInvite\n  });\n  createInvite.url = getInviteUrl(createInvite);\n  return createInvite;\n});","map":{"version":3,"sources":["app/invites/server/functions/findOrCreateInvite.js"],"names":["module","export","findOrCreateInvite","Meteor","link","v","Random","hasPermission","Notifications","Subscriptions","Rooms","Invites","settings","getURL","roomTypes","RoomMemberActions","getInviteUrl","invite","_id","useDirectLink","get","full","cloud","cloud_route","possibleDays","possibleUses","userId","rid","Error","method","field","subscription","findOneByRoomIdAndUserId","fields","room","findOneById","getConfig","t","allowMemberAction","INVITE","days","maxUses","includes","existing","findOneByUserRoomMaxUsesAndExpiration","url","id","createdAt","Date","expires","setDate","getDate","createInvite","uses","insertOne","notifyUser"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { Random } from 'meteor/random';\n\nimport { hasPermission } from '../../../authorization';\nimport { Notifications } from '../../../notifications';\nimport { Subscriptions, Rooms } from '../../../models/server';\nimport { Invites } from '../../../models/server/raw';\nimport { settings } from '../../../settings';\nimport { getURL } from '../../../utils/lib/getURL';\nimport { roomTypes, RoomMemberActions } from '../../../utils/server';\n\nfunction getInviteUrl(invite) {\n\tconst { _id } = invite;\n\n\tconst useDirectLink = settings.get('Accounts_Registration_InviteUrlType') === 'direct';\n\n\treturn getURL(`invite/${_id}`, {\n\t\tfull: useDirectLink,\n\t\tcloud: !useDirectLink,\n\t\tcloud_route: 'invite',\n\t});\n}\n\nconst possibleDays = [0, 1, 7, 15, 30];\nconst possibleUses = [0, 1, 5, 10, 25, 50, 100];\n\nexport const findOrCreateInvite = async (userId, invite) => {\n\tif (!userId || !invite) {\n\t\treturn false;\n\t}\n\n\tif (!invite.rid) {\n\t\tthrow new Meteor.Error('error-the-field-is-required', 'The field rid is required', {\n\t\t\tmethod: 'findOrCreateInvite',\n\t\t\tfield: 'rid',\n\t\t});\n\t}\n\n\tif (!hasPermission(userId, 'create-invite-links', invite.rid)) {\n\t\tthrow new Meteor.Error('not_authorized');\n\t}\n\n\tconst subscription = Subscriptions.findOneByRoomIdAndUserId(invite.rid, userId, {\n\t\tfields: { _id: 1 },\n\t});\n\tif (!subscription) {\n\t\tthrow new Meteor.Error('error-invalid-room', 'The rid field is invalid', {\n\t\t\tmethod: 'findOrCreateInvite',\n\t\t\tfield: 'rid',\n\t\t});\n\t}\n\n\tconst room = Rooms.findOneById(invite.rid);\n\tif (!roomTypes.getConfig(room.t).allowMemberAction(room, RoomMemberActions.INVITE)) {\n\t\tthrow new Meteor.Error('error-room-type-not-allowed', 'Cannot create invite links for this room type', {\n\t\t\tmethod: 'findOrCreateInvite',\n\t\t});\n\t}\n\n\tconst { days = 1, maxUses = 0 } = invite;\n\n\tif (!possibleDays.includes(days)) {\n\t\tthrow new Meteor.Error('invalid-number-of-days', 'Invite should expire in 1, 7, 15 or 30 days, or send 0 to never expire.');\n\t}\n\n\tif (!possibleUses.includes(maxUses)) {\n\t\tthrow new Meteor.Error('invalid-number-of-uses', 'Invite should be valid for 1, 5, 10, 25, 50, 100 or infinite (0) uses.');\n\t}\n\n\t// Before anything, let's check if there's an existing invite with the same settings for the same channel and user and that has not yet expired.\n\tconst existing = await Invites.findOneByUserRoomMaxUsesAndExpiration(userId, invite.rid, maxUses, days);\n\n\t// If an existing invite was found, return it's _id instead of creating a new one.\n\tif (existing) {\n\t\texisting.url = getInviteUrl(existing);\n\t\treturn existing;\n\t}\n\n\tconst _id = Random.id(6);\n\n\t// insert invite\n\tconst createdAt = new Date();\n\tlet expires = null;\n\tif (days > 0) {\n\t\texpires = new Date(createdAt);\n\t\texpires.setDate(expires.getDate() + days);\n\t}\n\n\tconst createInvite = {\n\t\t_id,\n\t\tdays,\n\t\tmaxUses,\n\t\trid: invite.rid,\n\t\tuserId,\n\t\tcreatedAt,\n\t\texpires,\n\t\tuses: 0,\n\t};\n\n\tawait Invites.insertOne(createInvite);\n\tNotifications.notifyUser(userId, 'updateInvites', { invite: createInvite });\n\n\tcreateInvite.url = getInviteUrl(createInvite);\n\treturn createInvite;\n};\n"]},"sourceType":"module","hash":"41f0680a26c43375b08b99768de2c17cee339258"}
