{"version":3,"sources":["meteor://ðŸ’»app/client/views/room/threads/ThreadComponent.tsx"],"names":[],"mappings":"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","file":"dynamic/client/views/room/threads/ThreadComponent.tsx","sourcesContent":["import { useLocalStorage } from '@rocket.chat/fuselage-hooks';\nimport { Blaze } from 'meteor/blaze';\nimport { Template } from 'meteor/templating';\nimport { Tracker } from 'meteor/tracker';\nimport React, { useEffect, useRef, useState, useCallback, useMemo, FC } from 'react';\n\nimport { ChatMessage } from '../../../../app/models/client';\nimport { normalizeThreadTitle } from '../../../../app/threads/client/lib/normalizeThreadTitle';\nimport { roomTypes } from '../../../../app/utils/client';\nimport { IMessage } from '../../../../definition/IMessage';\nimport { IRoom } from '../../../../definition/IRoom';\nimport { useRoute } from '../../../contexts/RouterContext';\nimport { useEndpoint, useMethod } from '../../../contexts/ServerContext';\nimport { useToastMessageDispatch } from '../../../contexts/ToastMessagesContext';\nimport { useUserId, useUserSubscription } from '../../../contexts/UserContext';\nimport { mapMessageFromApi } from '../../../lib/utils/mapMessageFromApi';\nimport { useTabBarOpenUserInfo } from '../providers/ToolboxProvider';\nimport ThreadSkeleton from './ThreadSkeleton';\nimport ThreadView from './ThreadView';\n\nconst subscriptionFields = {};\n\nconst useThreadMessage = (tmid: string): IMessage => {\n\tconst [message, setMessage] = useState<IMessage>(() => Tracker.nonreactive(() => ChatMessage.findOne({ _id: tmid })));\n\tconst getMessage = useEndpoint('GET', 'chat.getMessage');\n\tconst getMessageParsed = useCallback<(params: { msgId: IMessage['_id'] }) => Promise<IMessage>>(\n\t\tasync (params) => {\n\t\t\tconst { message } = await getMessage(params);\n\t\t\treturn mapMessageFromApi(message);\n\t\t},\n\t\t[getMessage],\n\t);\n\n\tuseEffect(() => {\n\t\tconst computation = Tracker.autorun(async (computation) => {\n\t\t\tconst msg = ChatMessage.findOne({ _id: tmid }) || (await getMessageParsed({ msgId: tmid }));\n\n\t\t\tif (!msg || computation.stopped) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tsetMessage((prevMsg) => {\n\t\t\t\tif (!prevMsg || prevMsg._id !== msg._id || prevMsg._updatedAt?.getTime() !== msg._updatedAt?.getTime()) {\n\t\t\t\t\treturn msg;\n\t\t\t\t}\n\n\t\t\t\treturn prevMsg;\n\t\t\t});\n\t\t});\n\n\t\treturn (): void => {\n\t\t\tcomputation.stop();\n\t\t};\n\t}, [getMessageParsed, tmid]);\n\n\treturn message;\n};\n\nconst ThreadComponent: FC<{\n\tmid: string;\n\tjump: unknown;\n\troom: IRoom;\n\tonClickBack: (e: unknown) => void;\n}> = ({ mid, jump, room, onClickBack }) => {\n\tconst subscription = useUserSubscription(room._id, subscriptionFields);\n\tconst channelRoute = useRoute(roomTypes.getConfig(room.t).route.name);\n\tconst threadMessage = useThreadMessage(mid);\n\n\tconst openUserInfo = useTabBarOpenUserInfo();\n\n\tconst ref = useRef<HTMLElement>(null);\n\tconst uid = useUserId();\n\n\tconst headerTitle = useMemo(() => (threadMessage ? normalizeThreadTitle(threadMessage) : null), [threadMessage]);\n\tconst [expanded, setExpand] = useLocalStorage('expand-threads', false);\n\tconst following = !uid ? false : threadMessage?.replies?.includes(uid) ?? false;\n\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst followMessage = useMethod('followMessage');\n\tconst unfollowMessage = useMethod('unfollowMessage');\n\n\tconst setFollowing = useCallback<(following: boolean) => void>(\n\t\tasync (following) => {\n\t\t\ttry {\n\t\t\t\tif (following) {\n\t\t\t\t\tawait followMessage({ mid });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tawait unfollowMessage({ mid });\n\t\t\t} catch (error) {\n\t\t\t\tdispatchToastMessage({\n\t\t\t\t\ttype: 'error',\n\t\t\t\t\tmessage: error,\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t\t[dispatchToastMessage, followMessage, unfollowMessage, mid],\n\t);\n\n\tconst handleClose = useCallback(() => {\n\t\tchannelRoute.push(room.t === 'd' ? { rid: room._id } : { name: room.name || room._id });\n\t}, [channelRoute, room._id, room.t, room.name]);\n\n\tconst [viewData, setViewData] = useState(() => ({\n\t\tmainMessage: threadMessage,\n\t\tjump,\n\t\tfollowing,\n\t\tsubscription,\n\t\trid: room._id,\n\t\ttabBar: { openUserInfo },\n\t}));\n\n\tuseEffect(() => {\n\t\tsetViewData((viewData) => {\n\t\t\tif (!threadMessage || viewData.mainMessage?._id === threadMessage._id) {\n\t\t\t\treturn viewData;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tmainMessage: threadMessage,\n\t\t\t\tjump,\n\t\t\t\tfollowing,\n\t\t\t\tsubscription,\n\t\t\t\trid: room._id,\n\t\t\t\ttabBar: { openUserInfo },\n\t\t\t};\n\t\t});\n\t}, [following, jump, openUserInfo, room._id, subscription, threadMessage]);\n\n\tuseEffect(() => {\n\t\tif (!ref.current || !viewData.mainMessage) {\n\t\t\treturn;\n\t\t}\n\t\tconst view = Blaze.renderWithData(Template.thread, viewData, ref.current);\n\n\t\treturn (): void => {\n\t\t\tBlaze.remove(view);\n\t\t};\n\t}, [viewData]);\n\n\tif (!threadMessage) {\n\t\treturn <ThreadSkeleton expanded={expanded} onClose={handleClose} />;\n\t}\n\n\treturn (\n\t\t<ThreadView\n\t\t\tref={ref}\n\t\t\ttitle={headerTitle}\n\t\t\texpanded={expanded}\n\t\t\tfollowing={following}\n\t\t\tonToggleExpand={(expanded): void => setExpand(!expanded)}\n\t\t\tonToggleFollow={(following): void => setFollowing(!following)}\n\t\t\tonClose={handleClose}\n\t\t\tonClickBack={onClickBack}\n\t\t/>\n\t);\n};\n\nexport default ThreadComponent;\n"]}