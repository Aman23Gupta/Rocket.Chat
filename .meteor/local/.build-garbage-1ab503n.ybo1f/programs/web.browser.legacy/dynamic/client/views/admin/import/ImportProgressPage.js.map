{"version":3,"sources":["meteor://ðŸ’»app/client/views/admin/import/ImportProgressPage.js"],"names":["_regeneratorRuntime","module","link","default","v","_slicedToArray","Box","Margins","Throbber","useSafely","Meteor","React","useEffect","useState","useMemo","s","ProgressStep","ImportingStartedStates","Page","useRoute","useEndpoint","useToastMessageDispatch","useTranslation","useErrorHandler","ImportProgressPage","t","dispatchToastMessage","handleError","importerKey","setImporterKey","step","setStep","completed","setCompleted","total","setTotal","getCurrentImportOperation","getImportProgress","importHistoryRoute","prepareImportRoute","loadCurrentOperation","operation","valid","push","includes","status","count","handleProgressUpdated","key","toLowerCase","DONE","type","message","toUpperCase","slice","ERROR","CANCELLED","streamer","Streamer","loadImportProgress","progress","on","removeListener","progressRate","numberFormat","exportDefault"],"mappings":"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","file":"dynamic/client/views/admin/import/ImportProgressPage.js","sourcesContent":["import { Box, Margins, Throbber } from '@rocket.chat/fuselage';\nimport { useSafely } from '@rocket.chat/fuselage-hooks';\nimport { Meteor } from 'meteor/meteor';\nimport React, { useEffect, useState, useMemo } from 'react';\nimport s from 'underscore.string';\n\nimport { ProgressStep, ImportingStartedStates } from '../../../../app/importer/lib/ImporterProgressStep';\nimport Page from '../../../components/Page';\nimport { useRoute } from '../../../contexts/RouterContext';\nimport { useEndpoint } from '../../../contexts/ServerContext';\nimport { useToastMessageDispatch } from '../../../contexts/ToastMessagesContext';\nimport { useTranslation } from '../../../contexts/TranslationContext';\nimport { useErrorHandler } from './useErrorHandler';\n\nfunction ImportProgressPage() {\n\tconst t = useTranslation();\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst handleError = useErrorHandler();\n\n\tconst [importerKey, setImporterKey] = useSafely(useState(null));\n\tconst [step, setStep] = useSafely(useState('Loading...'));\n\tconst [completed, setCompleted] = useSafely(useState(0));\n\tconst [total, setTotal] = useSafely(useState(0));\n\n\tconst getCurrentImportOperation = useEndpoint('GET', 'getCurrentImportOperation');\n\tconst getImportProgress = useEndpoint('GET', 'getImportProgress');\n\n\tconst importHistoryRoute = useRoute('admin-import');\n\tconst prepareImportRoute = useRoute('admin-import-prepare');\n\n\tuseEffect(() => {\n\t\tconst loadCurrentOperation = async () => {\n\t\t\ttry {\n\t\t\t\tconst { operation } = await getCurrentImportOperation();\n\n\t\t\t\tif (!operation.valid) {\n\t\t\t\t\timportHistoryRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!ImportingStartedStates.includes(operation.status)) {\n\t\t\t\t\tprepareImportRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tsetImporterKey(operation.importerKey);\n\t\t\t\tsetCompleted(operation.count.completed);\n\t\t\t\tsetTotal(operation.count.total);\n\t\t\t} catch (error) {\n\t\t\t\thandleError(error, t('Failed_To_Load_Import_Data'));\n\t\t\t\timportHistoryRoute.push();\n\t\t\t}\n\t\t};\n\n\t\tloadCurrentOperation();\n\t}, [getCurrentImportOperation, handleError, importHistoryRoute, prepareImportRoute, setCompleted, setImporterKey, setTotal, t]);\n\n\tuseEffect(() => {\n\t\tif (!importerKey) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleProgressUpdated = ({ key, step, count: { completed = 0, total = 0 } = {} }) => {\n\t\t\tif (key.toLowerCase() !== importerKey) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tswitch (step) {\n\t\t\t\tcase ProgressStep.DONE:\n\t\t\t\t\tdispatchToastMessage({\n\t\t\t\t\t\ttype: 'success',\n\t\t\t\t\t\tmessage: t(step[0].toUpperCase() + step.slice(1)),\n\t\t\t\t\t});\n\t\t\t\t\timportHistoryRoute.push();\n\t\t\t\t\treturn;\n\n\t\t\t\tcase ProgressStep.ERROR:\n\t\t\t\tcase ProgressStep.CANCELLED:\n\t\t\t\t\thandleError(t(step[0].toUpperCase() + step.slice(1)));\n\t\t\t\t\timportHistoryRoute.push();\n\t\t\t\t\treturn;\n\n\t\t\t\tdefault:\n\t\t\t\t\tsetStep(step);\n\t\t\t\t\tsetCompleted(completed);\n\t\t\t\t\tsetTotal(total);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t};\n\n\t\tconst streamer = new Meteor.Streamer('importers');\n\n\t\tconst loadImportProgress = async () => {\n\t\t\ttry {\n\t\t\t\tconst progress = await getImportProgress();\n\n\t\t\t\tif (!progress) {\n\t\t\t\t\tdispatchToastMessage({ type: 'warning', message: t('Importer_not_in_progress') });\n\t\t\t\t\tprepareImportRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tstreamer.on('progress', handleProgressUpdated);\n\t\t\t\thandleProgressUpdated(progress);\n\t\t\t} catch (error) {\n\t\t\t\thandleError(error, t('Failed_To_Load_Import_Data'));\n\t\t\t\timportHistoryRoute.push();\n\t\t\t}\n\t\t};\n\n\t\tloadImportProgress();\n\n\t\treturn () => {\n\t\t\tstreamer.removeListener('progress', handleProgressUpdated);\n\t\t};\n\t}, [\n\t\tdispatchToastMessage,\n\t\tgetImportProgress,\n\t\thandleError,\n\t\timportHistoryRoute,\n\t\timporterKey,\n\t\tprepareImportRoute,\n\t\tsetCompleted,\n\t\tsetStep,\n\t\tsetTotal,\n\t\tt,\n\t]);\n\n\tconst progressRate = useMemo(() => {\n\t\tif (total === 0) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn (completed / total) * 100;\n\t}, [completed, total]);\n\n\treturn (\n\t\t<Page>\n\t\t\t<Page.Header title={t('Importing_Data')} />\n\n\t\t\t<Page.ScrollableContentWithShadow>\n\t\t\t\t<Box marginInline='auto' marginBlock='neg-x24' width='full' maxWidth='x580'>\n\t\t\t\t\t<Margins block='x24'>\n\t\t\t\t\t\t<Box is='p' fontScale='p2'>\n\t\t\t\t\t\t\t{t(step[0].toUpperCase() + step.slice(1))}\n\t\t\t\t\t\t</Box>\n\t\t\t\t\t\t{progressRate ? (\n\t\t\t\t\t\t\t<Box display='flex' justifyContent='center'>\n\t\t\t\t\t\t\t\t<Box is='progress' value={completed} max={total} marginInlineEnd='x24' />\n\t\t\t\t\t\t\t\t<Box is='span' fontScale='p2'>\n\t\t\t\t\t\t\t\t\t{completed}/{total} ({s.numberFormat(progressRate, 0)}%)\n\t\t\t\t\t\t\t\t</Box>\n\t\t\t\t\t\t\t</Box>\n\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t<Throbber justifyContent='center' />\n\t\t\t\t\t\t)}\n\t\t\t\t\t</Margins>\n\t\t\t\t</Box>\n\t\t\t</Page.ScrollableContentWithShadow>\n\t\t</Page>\n\t);\n}\n\nexport default ImportProgressPage;\n"]}