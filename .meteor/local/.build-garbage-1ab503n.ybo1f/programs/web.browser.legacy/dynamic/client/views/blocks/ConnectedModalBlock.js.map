{"version":3,"sources":["meteor://ðŸ’»app/client/views/blocks/ConnectedModalBlock.js"],"names":["_objectSpread","module","link","default","v","_objectWithoutProperties","_slicedToArray","UIKitIncomingInteractionContainerType","useMutableCallback","kitContext","React","useEffect","useReducer","useState","ActionManager","ModalBlock","useActionManagerState","initialState","state","setState","viewId","handleUpdate","type","data","errors","on","off","useValues","view","reducer","values","actionId","payload","initializer","filterInputFields","element","elements","initialValue","length","map","filter","mapElementToState","blockId","value","blocks","reduce","obj","el","Array","isArray","Object","fromEntries","key","ConnectedModalBlock","props","appId","_mid","mid","updateValues","groupStateByBlockId","entries","prevent","e","nativeEvent","stopImmediatePropagation","stopPropagation","preventDefault","context","action","triggerBlockAction","container","VIEW","id","handleSubmit","triggerSubmitView","handleCancel","triggerCancel","handleClose","isCleared","exportDefault"],"mappings":"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","file":"dynamic/client/views/blocks/ConnectedModalBlock.js","sourcesContent":["import { UIKitIncomingInteractionContainerType } from '@rocket.chat/apps-engine/definition/uikit/UIKitIncomingInteractionContainer';\nimport { useMutableCallback } from '@rocket.chat/fuselage-hooks';\nimport { kitContext } from '@rocket.chat/fuselage-ui-kit';\nimport React, { useEffect, useReducer, useState } from 'react';\n\nimport * as ActionManager from '../../../app/ui-message/client/ActionManager';\nimport ModalBlock from './ModalBlock';\nimport './textParsers';\n\nconst useActionManagerState = (initialState) => {\n\tconst [state, setState] = useState(initialState);\n\n\tconst { viewId } = state;\n\n\tuseEffect(() => {\n\t\tconst handleUpdate = ({ type, ...data }) => {\n\t\t\tif (type === 'errors') {\n\t\t\t\tconst { errors } = data;\n\t\t\t\tsetState((state) => ({ ...state, errors }));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tsetState(data);\n\t\t};\n\n\t\tActionManager.on(viewId, handleUpdate);\n\n\t\treturn () => {\n\t\t\tActionManager.off(viewId, handleUpdate);\n\t\t};\n\t}, [viewId]);\n\n\treturn state;\n};\n\nconst useValues = (view) => {\n\tconst reducer = useMutableCallback((values, { actionId, payload }) => ({\n\t\t...values,\n\t\t[actionId]: payload,\n\t}));\n\n\tconst initializer = useMutableCallback(() => {\n\t\tconst filterInputFields = ({ element, elements = [] }) => {\n\t\t\tif (element && element.initialValue) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tif (elements.length && elements.map((element) => ({ element })).filter(filterInputFields).length) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t};\n\n\t\tconst mapElementToState = ({ element, blockId, elements = [] }) => {\n\t\t\tif (elements.length) {\n\t\t\t\treturn elements\n\t\t\t\t\t.map((element) => ({ element, blockId }))\n\t\t\t\t\t.filter(filterInputFields)\n\t\t\t\t\t.map(mapElementToState);\n\t\t\t}\n\t\t\treturn [element.actionId, { value: element.initialValue, blockId }];\n\t\t};\n\n\t\treturn view.blocks\n\t\t\t.filter(filterInputFields)\n\t\t\t.map(mapElementToState)\n\t\t\t.reduce((obj, el) => {\n\t\t\t\tif (Array.isArray(el[0])) {\n\t\t\t\t\treturn { ...obj, ...Object.fromEntries(el) };\n\t\t\t\t}\n\n\t\t\t\tconst [key, value] = el;\n\t\t\t\treturn { ...obj, [key]: value };\n\t\t\t}, {});\n\t});\n\n\treturn useReducer(reducer, null, initializer);\n};\n\nfunction ConnectedModalBlock(props) {\n\tconst state = useActionManagerState(props);\n\n\tconst { appId, viewId, mid: _mid, errors, view } = state;\n\n\tconst [values, updateValues] = useValues(view);\n\n\tconst groupStateByBlockId = (obj) =>\n\t\tObject.entries(obj).reduce((obj, [key, { blockId, value }]) => {\n\t\t\tobj[blockId] = obj[blockId] || {};\n\t\t\tobj[blockId][key] = value;\n\t\t\treturn obj;\n\t\t}, {});\n\n\tconst prevent = (e) => {\n\t\tif (e) {\n\t\t\t(e.nativeEvent || e).stopImmediatePropagation();\n\t\t\te.stopPropagation();\n\t\t\te.preventDefault();\n\t\t}\n\t};\n\n\tconst context = {\n\t\taction: ({ actionId, appId, value, blockId, mid = _mid }) =>\n\t\t\tActionManager.triggerBlockAction({\n\t\t\t\tcontainer: {\n\t\t\t\t\ttype: UIKitIncomingInteractionContainerType.VIEW,\n\t\t\t\t\tid: viewId,\n\t\t\t\t},\n\t\t\t\tactionId,\n\t\t\t\tappId,\n\t\t\t\tvalue,\n\t\t\t\tblockId,\n\t\t\t\tmid,\n\t\t\t}),\n\t\tstate: ({ actionId, value, /* ,appId, */ blockId = 'default' }) => {\n\t\t\tupdateValues({\n\t\t\t\tactionId,\n\t\t\t\tpayload: {\n\t\t\t\t\tblockId,\n\t\t\t\t\tvalue,\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t\t...state,\n\t\tvalues,\n\t};\n\n\tconst handleSubmit = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\tActionManager.triggerSubmitView({\n\t\t\tviewId,\n\t\t\tappId,\n\t\t\tpayload: {\n\t\t\t\tview: {\n\t\t\t\t\t...view,\n\t\t\t\t\tid: viewId,\n\t\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t});\n\n\tconst handleCancel = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\treturn ActionManager.triggerCancel({\n\t\t\tappId,\n\t\t\tviewId,\n\t\t\tview: {\n\t\t\t\t...view,\n\t\t\t\tid: viewId,\n\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t},\n\t\t});\n\t});\n\n\tconst handleClose = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\treturn ActionManager.triggerCancel({\n\t\t\tappId,\n\t\t\tviewId,\n\t\t\tview: {\n\t\t\t\t...view,\n\t\t\t\tid: viewId,\n\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t},\n\t\t\tisCleared: true,\n\t\t});\n\t});\n\n\treturn (\n\t\t<kitContext.Provider value={context}>\n\t\t\t<ModalBlock view={view} errors={errors} appId={appId} onSubmit={handleSubmit} onCancel={handleCancel} onClose={handleClose} />\n\t\t</kitContext.Provider>\n\t);\n}\n\nexport default ConnectedModalBlock;\n"]}