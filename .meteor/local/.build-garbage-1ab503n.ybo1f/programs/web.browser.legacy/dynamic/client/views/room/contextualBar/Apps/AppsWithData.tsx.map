{"version":3,"sources":["meteor://ðŸ’»app/client/views/room/contextualBar/Apps/AppsWithData.tsx"],"names":[],"mappings":"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","file":"dynamic/client/views/room/contextualBar/Apps/AppsWithData.tsx","sourcesContent":["import {\n\tIUIKitContextualBarInteraction,\n\tIUIKitErrorInteraction,\n\tIUIKitSurface,\n\tIInputElement,\n\tIInputBlock,\n\tIBlock,\n\tIBlockElement,\n\tIActionsBlock,\n} from '@rocket.chat/apps-engine/definition/uikit';\nimport { UIKitIncomingInteractionContainerType } from '@rocket.chat/apps-engine/definition/uikit/UIKitIncomingInteractionContainer';\nimport { useMutableCallback } from '@rocket.chat/fuselage-hooks';\nimport { kitContext } from '@rocket.chat/fuselage-ui-kit';\nimport React, { memo, useState, useEffect, useReducer, Dispatch, SyntheticEvent } from 'react';\n\nimport { triggerBlockAction, triggerCancel, triggerSubmitView, on, off } from '../../../../../app/ui-message/client/ActionManager';\nimport { App } from '../../../admin/apps/types';\nimport { useTabBarClose } from '../../providers/ToolboxProvider';\nimport Apps from './Apps';\n\ntype FieldStateValue = string | Array<string> | undefined;\ntype FieldState = { value: FieldStateValue; blockId: string };\ntype InputFieldStateTuple = [string, FieldState];\ntype InputFieldStateObject = { [key: string]: FieldState };\ntype InputFieldStateByBlockId = { [blockId: string]: { [actionId: string]: FieldStateValue } };\ntype ActionParams = {\n\tblockId: string;\n\tappId: string;\n\tactionId: string;\n\tvalue: unknown;\n\tviewId?: string;\n};\n\ntype ViewState = IUIKitContextualBarInteraction & {\n\terrors?: { [field: string]: string };\n};\n\nconst isInputBlock = (block: any): block is IInputBlock => block?.element?.initialValue;\n\nconst useValues = (view: IUIKitSurface): [any, Dispatch<any>] => {\n\tconst reducer = useMutableCallback((values, { actionId, payload }) => ({\n\t\t...values,\n\t\t[actionId]: payload,\n\t}));\n\n\tconst initializer = useMutableCallback(() => {\n\t\tconst filterInputFields = (block: IBlock): boolean => {\n\t\t\tif (isInputBlock(block)) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\t((block as IActionsBlock).elements as IInputElement[])?.filter((element) => filterInputFields({ element } as IInputBlock)).length\n\t\t\t) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\treturn false;\n\t\t};\n\n\t\tconst mapElementToState = (block: IBlock): InputFieldStateTuple | InputFieldStateTuple[] => {\n\t\t\tif (isInputBlock(block)) {\n\t\t\t\tconst { element, blockId } = block;\n\t\t\t\treturn [element.actionId, { value: element.initialValue, blockId } as FieldState];\n\t\t\t}\n\n\t\t\tconst { elements, blockId }: { elements: IBlockElement[]; blockId?: string } = block as IActionsBlock;\n\n\t\t\treturn elements\n\t\t\t\t.filter((element) => filterInputFields({ element } as IInputBlock))\n\t\t\t\t.map((element) => mapElementToState({ element, blockId } as IInputBlock)) as InputFieldStateTuple[];\n\t\t};\n\n\t\treturn view.blocks\n\t\t\t.filter(filterInputFields)\n\t\t\t.map(mapElementToState)\n\t\t\t.reduce((obj: InputFieldStateObject, el: InputFieldStateTuple | InputFieldStateTuple[]) => {\n\t\t\t\tif (Array.isArray(el[0])) {\n\t\t\t\t\treturn { ...obj, ...Object.fromEntries(el as InputFieldStateTuple[]) };\n\t\t\t\t}\n\n\t\t\t\tconst [key, value] = el as InputFieldStateTuple;\n\t\t\t\treturn { ...obj, [key]: value };\n\t\t\t}, {} as InputFieldStateObject);\n\t});\n\n\treturn useReducer(reducer, null, initializer);\n};\n\nconst AppsWithData = ({\n\tviewId,\n\troomId,\n\tpayload,\n\tappInfo,\n}: {\n\tviewId: string;\n\troomId: string;\n\tpayload: IUIKitContextualBarInteraction;\n\tappInfo: App;\n}): JSX.Element => {\n\tconst closeTabBar = useTabBarClose();\n\n\tconst { id: appId, name: appName } = appInfo;\n\tconst [state, setState] = useState<ViewState>(payload);\n\tconst { view } = state;\n\tconst [values, updateValues] = useValues(view);\n\n\tuseEffect(() => {\n\t\tconst handleUpdate = ({ type, ...data }: IUIKitContextualBarInteraction | IUIKitErrorInteraction): void => {\n\t\t\tif (type === 'errors') {\n\t\t\t\tconst { errors } = data as Omit<IUIKitErrorInteraction, 'type'>;\n\t\t\t\tsetState((state: ViewState) => ({ ...state, errors }));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tsetState(data as IUIKitContextualBarInteraction);\n\t\t};\n\n\t\ton(viewId, handleUpdate);\n\n\t\treturn (): void => {\n\t\t\toff(viewId, handleUpdate);\n\t\t};\n\t}, [state, viewId]);\n\n\tconst groupStateByBlockId = (obj: InputFieldStateObject): InputFieldStateByBlockId =>\n\t\tObject.entries(obj).reduce((obj: InputFieldStateByBlockId, [key, { blockId, value }]: InputFieldStateTuple) => {\n\t\t\tobj[blockId] = obj[blockId] || {};\n\t\t\tobj[blockId][key] = value;\n\t\t\treturn obj;\n\t\t}, {} as InputFieldStateByBlockId);\n\n\tconst prevent = (e: SyntheticEvent): void => {\n\t\tif (e) {\n\t\t\t(e.nativeEvent || e).stopImmediatePropagation();\n\t\t\te.stopPropagation();\n\t\t\te.preventDefault();\n\t\t}\n\t};\n\n\tconst context = {\n\t\taction: ({ actionId, appId, value, blockId }: ActionParams): Promise<void> =>\n\t\t\ttriggerBlockAction({\n\t\t\t\tcontainer: {\n\t\t\t\t\ttype: UIKitIncomingInteractionContainerType.VIEW,\n\t\t\t\t\tid: viewId,\n\t\t\t\t},\n\t\t\t\tactionId,\n\t\t\t\tappId,\n\t\t\t\trid: roomId,\n\t\t\t\tvalue,\n\t\t\t\tblockId,\n\t\t\t}),\n\t\tstate: ({ actionId, value, blockId = 'default' }: ActionParams): void => {\n\t\t\tupdateValues({\n\t\t\t\tactionId,\n\t\t\t\tpayload: {\n\t\t\t\t\tblockId,\n\t\t\t\t\tvalue,\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t\t...state,\n\t\tvalues,\n\t};\n\n\tconst handleSubmit = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\tcloseTabBar(e);\n\t\ttriggerSubmitView({\n\t\t\tviewId,\n\t\t\tappId,\n\t\t\tpayload: {\n\t\t\t\tview: {\n\t\t\t\t\t...view,\n\t\t\t\t\tid: viewId,\n\t\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t});\n\n\tconst handleCancel = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\tcloseTabBar(e);\n\t\treturn triggerCancel({\n\t\t\tappId,\n\t\t\tviewId,\n\t\t\tview: {\n\t\t\t\t...view,\n\t\t\t\tid: viewId,\n\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t},\n\t\t});\n\t});\n\n\tconst handleClose = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\tcloseTabBar(e);\n\t\treturn triggerCancel({\n\t\t\tappId,\n\t\t\tviewId,\n\t\t\tview: {\n\t\t\t\t...view,\n\t\t\t\tid: viewId,\n\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t},\n\t\t\tisCleared: true,\n\t\t});\n\t});\n\n\treturn (\n\t\t<kitContext.Provider value={context}>\n\t\t\t<Apps onClose={handleClose} onCancel={handleCancel} onSubmit={handleSubmit} view={view} appInfo={{ name: appName, id: appId }} />\n\t\t</kitContext.Provider>\n\t);\n};\n\nexport default memo(AppsWithData);\n"]}