{"version":3,"sources":["meteor://ðŸ’»app/app/livechat/client/views/app/tabbar/contactChatHistory.js"],"names":["_regeneratorRuntime","module","link","default","v","_objectSpread","Tracker","Template","moment","ReactiveVar","_","t","APIClient","HISTORY_LIMIT","contactChatHistory","helpers","isReady","instance","get","hasChatHistory","history","length","isLoading","isSearching","searchTerm","showChatHistoryMessages","chatHistoryMessagesContext","tabBar","clear","returnChatHistoryList","canSearch","onCreated","currentData","offset","visitorId","hasMore","limit","set","autorun","rid","baseUrl","v1","total","concat","room","_id","onRendered","computation","stop","events","throttle","e","target","scrollTop","scrollHeight","clientHeight","event","preventDefault","stopPropagation","name","username","closedAt","closedAtLabel","closedDay","format","label","debounce","keyCode","value"],"mappings":"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","file":"dynamic/app/livechat/client/views/app/tabbar/contactChatHistory.js","sourcesContent":["import { Tracker } from 'meteor/tracker';\nimport { Template } from 'meteor/templating';\nimport moment from 'moment';\nimport { ReactiveVar } from 'meteor/reactive-var';\nimport './contactChatHistory.html';\nimport './contactChatHistoryItem.html';\nimport _ from 'underscore';\n\nimport { t, APIClient } from '../../../../../utils/client';\n\nconst HISTORY_LIMIT = 50;\n\nTemplate.contactChatHistory.helpers({\n\tisReady() {\n\t\treturn Template.instance().isReady.get();\n\t},\n\thasChatHistory() {\n\t\treturn Template.instance().history.get().length > 0;\n\t},\n\thistory() {\n\t\treturn Template.instance().history.get();\n\t},\n\tisLoading() {\n\t\treturn Template.instance().isLoading.get();\n\t},\n\tisSearching() {\n\t\treturn Template.instance().searchTerm.get().length > 0;\n\t},\n\tshowChatHistoryMessages() {\n\t\treturn Template.instance().showChatHistoryMessages.get();\n\t},\n\tchatHistoryMessagesContext() {\n\t\treturn {\n\t\t\ttabBar: Template.instance().tabBar,\n\t\t\tclear: Template.instance().returnChatHistoryList,\n\t\t\t...Template.instance().chatHistoryMessagesContext.get(),\n\t\t};\n\t},\n\tcanSearch() {\n\t\treturn Template.instance().canSearch.get();\n\t},\n});\n\nTemplate.contactChatHistory.onCreated(async function () {\n\tconst currentData = Template.currentData();\n\tthis.offset = new ReactiveVar(0);\n\tthis.visitorId = new ReactiveVar();\n\tthis.history = new ReactiveVar([]);\n\tthis.searchTerm = new ReactiveVar('');\n\tthis.hasMore = new ReactiveVar(true);\n\tthis.isLoading = new ReactiveVar(true);\n\tthis.chatHistoryMessagesContext = new ReactiveVar();\n\tthis.showChatHistoryMessages = new ReactiveVar(false);\n\tthis.limit = new ReactiveVar(HISTORY_LIMIT);\n\tthis.isReady = new ReactiveVar(false);\n\tthis.canSearch = new ReactiveVar(false);\n\tthis.tabBar = currentData.tabBar;\n\n\tthis.returnChatHistoryList = () => {\n\t\tthis.showChatHistoryMessages.set(false);\n\t\tthis.chatHistoryMessagesContext.set();\n\t};\n\n\tthis.autorun(async () => {\n\t\tif (!this.visitorId.get() || !currentData || !currentData.rid) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst limit = this.limit.get();\n\t\tconst offset = this.offset.get();\n\t\tconst searchTerm = this.searchTerm.get();\n\n\t\tlet baseUrl = `livechat/visitors.searchChats/room/${\n\t\t\tcurrentData.rid\n\t\t}/visitor/${this.visitorId.get()}?count=${limit}&offset=${offset}&closedChatsOnly=true&servedChatsOnly=true`;\n\t\tif (searchTerm) {\n\t\t\tbaseUrl += `&searchText=${searchTerm}`;\n\t\t}\n\n\t\tthis.isLoading.set(true);\n\t\tconst { history, total } = await APIClient.v1.get(baseUrl);\n\t\tthis.history.set(offset === 0 ? history : this.history.get().concat(history));\n\t\tthis.hasMore.set(total > this.history.get().length);\n\t\tthis.isLoading.set(false);\n\t});\n\n\tthis.autorun(async () => {\n\t\tconst { room } = await APIClient.v1.get(`rooms.info?roomId=${currentData.rid}`);\n\t\tif (room?.v) {\n\t\t\tthis.visitorId.set(room.v._id);\n\t\t}\n\t});\n});\n\nTemplate.contactChatHistory.onRendered(function () {\n\tTracker.autorun((computation) => {\n\t\tif (this.isLoading.get()) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst history = this.history.get();\n\t\tthis.canSearch.set(history && history.length > 0);\n\t\tthis.isReady.set(true);\n\n\t\tcomputation.stop();\n\t});\n});\n\nTemplate.contactChatHistory.events({\n\t'scroll .js-list': _.throttle(function (e, instance) {\n\t\tif (e.target.scrollTop >= e.target.scrollHeight - e.target.clientHeight - 10 && instance.hasMore.get()) {\n\t\t\tinstance.offset.set(instance.offset.get() + instance.limit.get());\n\t\t}\n\t}, 200),\n\t'click .chat-history-item'(event, instance) {\n\t\tevent.preventDefault();\n\t\tevent.stopPropagation();\n\n\t\tconst { _id: rid, v: { name, username } = {}, closedAt } = this;\n\n\t\tconst closedAtLabel = t('Closed_At');\n\t\tconst closedDay = moment(closedAt).format('MMM D YYYY');\n\n\t\tinstance.chatHistoryMessagesContext.set({\n\t\t\tlabel: `${name || username}, ${closedAtLabel} ${closedDay}`,\n\t\t\trid,\n\t\t});\n\n\t\tinstance.showChatHistoryMessages.set(true);\n\t},\n\t'keyup #chat-search': _.debounce(function (e, instance) {\n\t\tif (e.keyCode === 13) {\n\t\t\treturn e.preventDefault();\n\t\t}\n\n\t\tconst { value } = e.target;\n\n\t\tif (e.keyCode === 40 || e.keyCode === 38) {\n\t\t\treturn e.preventDefault();\n\t\t}\n\n\t\tinstance.offset.set(0);\n\t\tinstance.searchTerm.set(value);\n\t}, 300),\n});\n"]}