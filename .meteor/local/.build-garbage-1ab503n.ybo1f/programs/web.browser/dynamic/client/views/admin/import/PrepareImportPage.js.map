{"version":3,"sources":["meteor://ðŸ’»app/client/views/admin/import/PrepareImportPage.js"],"names":["_objectSpread","module","link","default","v","Badge","Box","Button","ButtonGroup","Icon","Margins","Throbber","Tabs","useDebouncedValue","useSafely","Meteor","React","useEffect","useState","useMemo","s","ProgressStep","ImportWaitingStates","ImportFileReadyStates","ImportPreparingStartedStates","ImportingStartedStates","ImportingErrorStates","Page","useRoute","useEndpoint","useTranslation","PrepareChannels","PrepareUsers","useErrorHandler","waitFor","fn","predicate","Promise","resolve","reject","callPromise","then","result","setTimeout","PrepareImportPage","t","handleError","isPreparing","setPreparing","progressRate","setProgressRate","status","setStatus","messageCount","setMessageCount","users","setUsers","channels","setChannels","isImporting","setImporting","usersCount","filter","do_import","length","channelsCount","importHistoryRoute","newImportRoute","importProgressRoute","getImportFileData","getCurrentImportOperation","startImport","streamer","Streamer","handleProgressUpdated","rate","on","removeListener","loadImportFileData","data","waiting","push","step","message_count","map","user","channel","error","loadCurrentOperation","operation","valid","includes","USER_SELECTION","DONE","handleBackToImportsButtonClick","handleStartButtonClick","input","tab","setTab","handleTabClick","statusDebounced","replace","toFixed","numberFormat","exportDefault"],"mappings":"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","file":"dynamic/client/views/admin/import/PrepareImportPage.js","sourcesContent":["import { Badge, Box, Button, ButtonGroup, Icon, Margins, Throbber, Tabs } from '@rocket.chat/fuselage';\nimport { useDebouncedValue, useSafely } from '@rocket.chat/fuselage-hooks';\nimport { Meteor } from 'meteor/meteor';\nimport React, { useEffect, useState, useMemo } from 'react';\nimport s from 'underscore.string';\n\nimport {\n\tProgressStep,\n\tImportWaitingStates,\n\tImportFileReadyStates,\n\tImportPreparingStartedStates,\n\tImportingStartedStates,\n\tImportingErrorStates,\n} from '../../../../app/importer/lib/ImporterProgressStep';\nimport Page from '../../../components/Page';\nimport { useRoute } from '../../../contexts/RouterContext';\nimport { useEndpoint } from '../../../contexts/ServerContext';\nimport { useTranslation } from '../../../contexts/TranslationContext';\nimport PrepareChannels from './PrepareChannels';\nimport PrepareUsers from './PrepareUsers';\nimport { useErrorHandler } from './useErrorHandler';\n\nconst waitFor = (fn, predicate) =>\n\tnew Promise((resolve, reject) => {\n\t\tconst callPromise = () => {\n\t\t\tfn().then((result) => {\n\t\t\t\tif (predicate(result)) {\n\t\t\t\t\tresolve(result);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tsetTimeout(callPromise, 1000);\n\t\t\t}, reject);\n\t\t};\n\n\t\tcallPromise();\n\t});\n\nfunction PrepareImportPage() {\n\tconst t = useTranslation();\n\tconst handleError = useErrorHandler();\n\n\tconst [isPreparing, setPreparing] = useSafely(useState(true));\n\tconst [progressRate, setProgressRate] = useSafely(useState(null));\n\tconst [status, setStatus] = useSafely(useState(null));\n\tconst [messageCount, setMessageCount] = useSafely(useState(0));\n\tconst [users, setUsers] = useState([]);\n\tconst [channels, setChannels] = useState([]);\n\tconst [isImporting, setImporting] = useSafely(useState(false));\n\n\tconst usersCount = useMemo(() => users.filter(({ do_import }) => do_import).length, [users]);\n\tconst channelsCount = useMemo(() => channels.filter(({ do_import }) => do_import).length, [channels]);\n\n\tconst importHistoryRoute = useRoute('admin-import');\n\tconst newImportRoute = useRoute('admin-import-new');\n\tconst importProgressRoute = useRoute('admin-import-progress');\n\n\tconst getImportFileData = useEndpoint('GET', 'getImportFileData');\n\tconst getCurrentImportOperation = useEndpoint('GET', 'getCurrentImportOperation');\n\tconst startImport = useEndpoint('POST', 'startImport');\n\n\tuseEffect(() => {\n\t\tconst streamer = new Meteor.Streamer('importers');\n\n\t\tconst handleProgressUpdated = ({ rate }) => {\n\t\t\tsetProgressRate(rate);\n\t\t};\n\n\t\tstreamer.on('progress', handleProgressUpdated);\n\n\t\treturn () => {\n\t\t\tstreamer.removeListener('progress', handleProgressUpdated);\n\t\t};\n\t}, [setProgressRate]);\n\n\tuseEffect(() => {\n\t\tconst loadImportFileData = async () => {\n\t\t\ttry {\n\t\t\t\tconst data = await waitFor(getImportFileData, (data) => data && !data.waiting);\n\n\t\t\t\tif (!data) {\n\t\t\t\t\thandleError(t('Importer_not_setup'));\n\t\t\t\t\timportHistoryRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (data.step) {\n\t\t\t\t\thandleError(t('Failed_To_Load_Import_Data'));\n\t\t\t\t\timportHistoryRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tsetMessageCount(data.message_count);\n\t\t\t\tsetUsers(data.users.map((user) => ({ ...user, do_import: true })));\n\t\t\t\tsetChannels(data.channels.map((channel) => ({ ...channel, do_import: true })));\n\t\t\t\tsetPreparing(false);\n\t\t\t\tsetProgressRate(null);\n\t\t\t} catch (error) {\n\t\t\t\thandleError(error, t('Failed_To_Load_Import_Data'));\n\t\t\t\timportHistoryRoute.push();\n\t\t\t}\n\t\t};\n\n\t\tconst loadCurrentOperation = async () => {\n\t\t\ttry {\n\t\t\t\tconst { operation } = await waitFor(\n\t\t\t\t\tgetCurrentImportOperation,\n\t\t\t\t\t({ operation }) => operation.valid && !ImportWaitingStates.includes(operation.status),\n\t\t\t\t);\n\n\t\t\t\tif (!operation.valid) {\n\t\t\t\t\tnewImportRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (ImportingStartedStates.includes(operation.status)) {\n\t\t\t\t\timportProgressRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (\n\t\t\t\t\toperation.status === ProgressStep.USER_SELECTION ||\n\t\t\t\t\tImportPreparingStartedStates.includes(operation.status) ||\n\t\t\t\t\tImportFileReadyStates.includes(operation.status)\n\t\t\t\t) {\n\t\t\t\t\tsetStatus(operation.status);\n\t\t\t\t\tloadImportFileData();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (ImportingErrorStates.includes(operation.status)) {\n\t\t\t\t\thandleError(t('Import_Operation_Failed'));\n\t\t\t\t\timportHistoryRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (operation.status === ProgressStep.DONE) {\n\t\t\t\t\timportHistoryRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\thandleError(t('Unknown_Import_State'));\n\t\t\t\timportHistoryRoute.push();\n\t\t\t} catch (error) {\n\t\t\t\thandleError(t('Failed_To_Load_Import_Data'));\n\t\t\t\timportHistoryRoute.push();\n\t\t\t}\n\t\t};\n\n\t\tloadCurrentOperation();\n\t}, [\n\t\tgetCurrentImportOperation,\n\t\tgetImportFileData,\n\t\thandleError,\n\t\timportHistoryRoute,\n\t\timportProgressRoute,\n\t\tnewImportRoute,\n\t\tsetMessageCount,\n\t\tsetPreparing,\n\t\tsetProgressRate,\n\t\tsetStatus,\n\t\tt,\n\t]);\n\n\tconst handleBackToImportsButtonClick = () => {\n\t\timportHistoryRoute.push();\n\t};\n\n\tconst handleStartButtonClick = async () => {\n\t\tsetImporting(true);\n\n\t\ttry {\n\t\t\tawait startImport({ input: { users, channels } });\n\t\t\timportProgressRoute.push();\n\t\t} catch (error) {\n\t\t\thandleError(error, t('Failed_To_Start_Import'));\n\t\t\timportHistoryRoute.push();\n\t\t}\n\t};\n\n\tconst [tab, setTab] = useState('users');\n\tconst handleTabClick = useMemo(() => (tab) => () => setTab(tab), []);\n\n\tconst statusDebounced = useDebouncedValue(status, 100);\n\n\treturn (\n\t\t<Page>\n\t\t\t<Page.Header title={t('Importing_Data')}>\n\t\t\t\t<ButtonGroup>\n\t\t\t\t\t<Button ghost onClick={handleBackToImportsButtonClick}>\n\t\t\t\t\t\t<Icon name='back' /> {t('Back_to_imports')}\n\t\t\t\t\t</Button>\n\t\t\t\t\t<Button primary disabled={isImporting} onClick={handleStartButtonClick}>\n\t\t\t\t\t\t{t('Importer_Prepare_Start_Import')}\n\t\t\t\t\t</Button>\n\t\t\t\t</ButtonGroup>\n\t\t\t</Page.Header>\n\n\t\t\t<Page.ScrollableContentWithShadow>\n\t\t\t\t<Box marginInline='auto' marginBlock='x24' width='full' maxWidth='590px'>\n\t\t\t\t\t<Box is='h2' fontScale='p2m'>\n\t\t\t\t\t\t{statusDebounced && t(statusDebounced.replace('importer_', 'importer_status_'))}\n\t\t\t\t\t</Box>\n\t\t\t\t\t{!isPreparing && (\n\t\t\t\t\t\t<Tabs flexShrink={0}>\n\t\t\t\t\t\t\t<Tabs.Item disabled={usersCount === 0} selected={tab === 'users'} onClick={handleTabClick('users')}>\n\t\t\t\t\t\t\t\t{t('Users')} <Badge>{usersCount}</Badge>\n\t\t\t\t\t\t\t</Tabs.Item>\n\t\t\t\t\t\t\t<Tabs.Item selected={tab === 'channels'} onClick={handleTabClick('channels')}>\n\t\t\t\t\t\t\t\t{t('Channels')} <Badge>{channelsCount}</Badge>\n\t\t\t\t\t\t\t</Tabs.Item>\n\t\t\t\t\t\t\t<Tabs.Item disabled>\n\t\t\t\t\t\t\t\t{t('Messages')}\n\t\t\t\t\t\t\t\t<Badge>{messageCount}</Badge>\n\t\t\t\t\t\t\t</Tabs.Item>\n\t\t\t\t\t\t</Tabs>\n\t\t\t\t\t)}\n\t\t\t\t\t<Margins block='x24'>\n\t\t\t\t\t\t{isPreparing && (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t{progressRate ? (\n\t\t\t\t\t\t\t\t\t<Box display='flex' justifyContent='center' fontScale='p2'>\n\t\t\t\t\t\t\t\t\t\t<Box is='progress' value={(progressRate * 10).toFixed(0)} max='1000' marginInlineEnd='x24' />\n\t\t\t\t\t\t\t\t\t\t<Box is='span'>{s.numberFormat(progressRate, 0)}%</Box>\n\t\t\t\t\t\t\t\t\t</Box>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<Throbber justifyContent='center' />\n\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{!isPreparing && tab === 'users' && <PrepareUsers usersCount={usersCount} users={users} setUsers={setUsers} />}\n\t\t\t\t\t\t{!isPreparing && tab === 'channels' && (\n\t\t\t\t\t\t\t<PrepareChannels channels={channels} channelsCount={channelsCount} setChannels={setChannels} />\n\t\t\t\t\t\t)}\n\t\t\t\t\t</Margins>\n\t\t\t\t</Box>\n\t\t\t</Page.ScrollableContentWithShadow>\n\t\t</Page>\n\t);\n}\n\nexport default PrepareImportPage;\n"]}