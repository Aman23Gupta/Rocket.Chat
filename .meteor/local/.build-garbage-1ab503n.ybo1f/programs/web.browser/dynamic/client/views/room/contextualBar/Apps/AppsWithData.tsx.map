{"version":3,"sources":["meteor://ðŸ’»app/client/views/room/contextualBar/Apps/AppsWithData.tsx"],"names":[],"mappings":"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","file":"dynamic/client/views/room/contextualBar/Apps/AppsWithData.tsx","sourcesContent":["import {\n\tIUIKitContextualBarInteraction,\n\tIUIKitErrorInteraction,\n\tIUIKitSurface,\n\tIInputElement,\n\tIInputBlock,\n\tIBlock,\n\tIBlockElement,\n\tIActionsBlock,\n} from '@rocket.chat/apps-engine/definition/uikit';\nimport { UIKitIncomingInteractionContainerType } from '@rocket.chat/apps-engine/definition/uikit/UIKitIncomingInteractionContainer';\nimport { useMutableCallback } from '@rocket.chat/fuselage-hooks';\nimport { kitContext } from '@rocket.chat/fuselage-ui-kit';\nimport React, { memo, useState, useEffect, useReducer, Dispatch, SyntheticEvent } from 'react';\n\nimport { triggerBlockAction, triggerCancel, triggerSubmitView, on, off } from '../../../../../app/ui-message/client/ActionManager';\nimport { App } from '../../../admin/apps/types';\nimport { useTabBarClose } from '../../providers/ToolboxProvider';\nimport Apps from './Apps';\n\ntype FieldStateValue = string | Array<string> | undefined;\ntype FieldState = { value: FieldStateValue; blockId: string };\ntype InputFieldStateTuple = [string, FieldState];\ntype InputFieldStateObject = { [key: string]: FieldState };\ntype InputFieldStateByBlockId = { [blockId: string]: { [actionId: string]: FieldStateValue } };\ntype ActionParams = {\n\tblockId: string;\n\tappId: string;\n\tactionId: string;\n\tvalue: unknown;\n\tviewId?: string;\n};\n\ntype ViewState = IUIKitContextualBarInteraction & {\n\terrors?: { [field: string]: string };\n};\n\nconst isInputBlock = (block: any): block is IInputBlock => block?.element?.initialValue;\n\nconst useValues = (view: IUIKitSurface): [any, Dispatch<any>] => {\n\tconst reducer = useMutableCallback((values, { actionId, payload }) => ({\n\t\t...values,\n\t\t[actionId]: payload,\n\t}));\n\n\tconst initializer = useMutableCallback(() => {\n\t\tconst filterInputFields = (block: IBlock): boolean => {\n\t\t\tif (isInputBlock(block)) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\t((block as IActionsBlock).elements as IInputElement[])?.filter((element) => filterInputFields({ element } as IInputBlock)).length\n\t\t\t) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\treturn false;\n\t\t};\n\n\t\tconst mapElementToState = (block: IBlock): InputFieldStateTuple | InputFieldStateTuple[] => {\n\t\t\tif (isInputBlock(block)) {\n\t\t\t\tconst { element, blockId } = block;\n\t\t\t\treturn [element.actionId, { value: element.initialValue, blockId } as FieldState];\n\t\t\t}\n\n\t\t\tconst { elements, blockId }: { elements: IBlockElement[]; blockId?: string } = block as IActionsBlock;\n\n\t\t\treturn elements\n\t\t\t\t.filter((element) => filterInputFields({ element } as IInputBlock))\n\t\t\t\t.map((element) => mapElementToState({ element, blockId } as IInputBlock)) as InputFieldStateTuple[];\n\t\t};\n\n\t\treturn view.blocks\n\t\t\t.filter(filterInputFields)\n\t\t\t.map(mapElementToState)\n\t\t\t.reduce((obj: InputFieldStateObject, el: InputFieldStateTuple | InputFieldStateTuple[]) => {\n\t\t\t\tif (Array.isArray(el[0])) {\n\t\t\t\t\treturn { ...obj, ...Object.fromEntries(el as InputFieldStateTuple[]) };\n\t\t\t\t}\n\n\t\t\t\tconst [key, value] = el as InputFieldStateTuple;\n\t\t\t\treturn { ...obj, [key]: value };\n\t\t\t}, {} as InputFieldStateObject);\n\t});\n\n\treturn useReducer(reducer, null, initializer);\n};\n\nconst AppsWithData = ({\n\tviewId,\n\troomId,\n\tpayload,\n\tappInfo,\n}: {\n\tviewId: string;\n\troomId: string;\n\tpayload: IUIKitContextualBarInteraction;\n\tappInfo: App;\n}): JSX.Element => {\n\tconst closeTabBar = useTabBarClose();\n\n\tconst { id: appId, name: appName } = appInfo;\n\tconst [state, setState] = useState<ViewState>(payload);\n\tconst { view } = state;\n\tconst [values, updateValues] = useValues(view);\n\n\tuseEffect(() => {\n\t\tconst handleUpdate = ({ type, ...data }: IUIKitContextualBarInteraction | IUIKitErrorInteraction): void => {\n\t\t\tif (type === 'errors') {\n\t\t\t\tconst { errors } = data as Omit<IUIKitErrorInteraction, 'type'>;\n\t\t\t\tsetState((state: ViewState) => ({ ...state, errors }));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tsetState(data as IUIKitContextualBarInteraction);\n\t\t};\n\n\t\ton(viewId, handleUpdate);\n\n\t\treturn (): void => {\n\t\t\toff(viewId, handleUpdate);\n\t\t};\n\t}, [state, viewId]);\n\n\tconst groupStateByBlockId = (obj: InputFieldStateObject): InputFieldStateByBlockId =>\n\t\tObject.entries(obj).reduce((obj: InputFieldStateByBlockId, [key, { blockId, value }]: InputFieldStateTuple) => {\n\t\t\tobj[blockId] = obj[blockId] || {};\n\t\t\tobj[blockId][key] = value;\n\t\t\treturn obj;\n\t\t}, {} as InputFieldStateByBlockId);\n\n\tconst prevent = (e: SyntheticEvent): void => {\n\t\tif (e) {\n\t\t\t(e.nativeEvent || e).stopImmediatePropagation();\n\t\t\te.stopPropagation();\n\t\t\te.preventDefault();\n\t\t}\n\t};\n\n\tconst context = {\n\t\taction: ({ actionId, appId, value, blockId }: ActionParams): Promise<void> =>\n\t\t\ttriggerBlockAction({\n\t\t\t\tcontainer: {\n\t\t\t\t\ttype: UIKitIncomingInteractionContainerType.VIEW,\n\t\t\t\t\tid: viewId,\n\t\t\t\t},\n\t\t\t\tactionId,\n\t\t\t\tappId,\n\t\t\t\trid: roomId,\n\t\t\t\tvalue,\n\t\t\t\tblockId,\n\t\t\t}),\n\t\tstate: ({ actionId, value, blockId = 'default' }: ActionParams): void => {\n\t\t\tupdateValues({\n\t\t\t\tactionId,\n\t\t\t\tpayload: {\n\t\t\t\t\tblockId,\n\t\t\t\t\tvalue,\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t\t...state,\n\t\tvalues,\n\t};\n\n\tconst handleSubmit = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\tcloseTabBar(e);\n\t\ttriggerSubmitView({\n\t\t\tviewId,\n\t\t\tappId,\n\t\t\tpayload: {\n\t\t\t\tview: {\n\t\t\t\t\t...view,\n\t\t\t\t\tid: viewId,\n\t\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t});\n\n\tconst handleCancel = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\tcloseTabBar(e);\n\t\treturn triggerCancel({\n\t\t\tappId,\n\t\t\tviewId,\n\t\t\tview: {\n\t\t\t\t...view,\n\t\t\t\tid: viewId,\n\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t},\n\t\t});\n\t});\n\n\tconst handleClose = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\tcloseTabBar(e);\n\t\treturn triggerCancel({\n\t\t\tappId,\n\t\t\tviewId,\n\t\t\tview: {\n\t\t\t\t...view,\n\t\t\t\tid: viewId,\n\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t},\n\t\t\tisCleared: true,\n\t\t});\n\t});\n\n\treturn (\n\t\t<kitContext.Provider value={context}>\n\t\t\t<Apps onClose={handleClose} onCancel={handleCancel} onSubmit={handleSubmit} view={view} appInfo={{ name: appName, id: appId }} />\n\t\t</kitContext.Provider>\n\t);\n};\n\nexport default memo(AppsWithData);\n"]}