{"version":3,"sources":["meteor://ðŸ’»app/client/views/blocks/ConnectedModalBlock.js"],"names":["_objectSpread","module","link","default","v","_objectWithoutProperties","UIKitIncomingInteractionContainerType","useMutableCallback","kitContext","React","useEffect","useReducer","useState","ActionManager","ModalBlock","useActionManagerState","initialState","state","setState","viewId","handleUpdate","type","data","errors","on","off","useValues","view","reducer","values","actionId","payload","initializer","filterInputFields","element","elements","initialValue","length","map","filter","mapElementToState","blockId","value","blocks","reduce","obj","el","Array","isArray","Object","fromEntries","key","ConnectedModalBlock","props","appId","mid","_mid","updateValues","groupStateByBlockId","entries","prevent","e","nativeEvent","stopImmediatePropagation","stopPropagation","preventDefault","context","action","triggerBlockAction","container","VIEW","id","handleSubmit","triggerSubmitView","handleCancel","triggerCancel","handleClose","isCleared","exportDefault"],"mappings":"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","file":"dynamic/client/views/blocks/ConnectedModalBlock.js","sourcesContent":["import { UIKitIncomingInteractionContainerType } from '@rocket.chat/apps-engine/definition/uikit/UIKitIncomingInteractionContainer';\nimport { useMutableCallback } from '@rocket.chat/fuselage-hooks';\nimport { kitContext } from '@rocket.chat/fuselage-ui-kit';\nimport React, { useEffect, useReducer, useState } from 'react';\n\nimport * as ActionManager from '../../../app/ui-message/client/ActionManager';\nimport ModalBlock from './ModalBlock';\nimport './textParsers';\n\nconst useActionManagerState = (initialState) => {\n\tconst [state, setState] = useState(initialState);\n\n\tconst { viewId } = state;\n\n\tuseEffect(() => {\n\t\tconst handleUpdate = ({ type, ...data }) => {\n\t\t\tif (type === 'errors') {\n\t\t\t\tconst { errors } = data;\n\t\t\t\tsetState((state) => ({ ...state, errors }));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tsetState(data);\n\t\t};\n\n\t\tActionManager.on(viewId, handleUpdate);\n\n\t\treturn () => {\n\t\t\tActionManager.off(viewId, handleUpdate);\n\t\t};\n\t}, [viewId]);\n\n\treturn state;\n};\n\nconst useValues = (view) => {\n\tconst reducer = useMutableCallback((values, { actionId, payload }) => ({\n\t\t...values,\n\t\t[actionId]: payload,\n\t}));\n\n\tconst initializer = useMutableCallback(() => {\n\t\tconst filterInputFields = ({ element, elements = [] }) => {\n\t\t\tif (element && element.initialValue) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tif (elements.length && elements.map((element) => ({ element })).filter(filterInputFields).length) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t};\n\n\t\tconst mapElementToState = ({ element, blockId, elements = [] }) => {\n\t\t\tif (elements.length) {\n\t\t\t\treturn elements\n\t\t\t\t\t.map((element) => ({ element, blockId }))\n\t\t\t\t\t.filter(filterInputFields)\n\t\t\t\t\t.map(mapElementToState);\n\t\t\t}\n\t\t\treturn [element.actionId, { value: element.initialValue, blockId }];\n\t\t};\n\n\t\treturn view.blocks\n\t\t\t.filter(filterInputFields)\n\t\t\t.map(mapElementToState)\n\t\t\t.reduce((obj, el) => {\n\t\t\t\tif (Array.isArray(el[0])) {\n\t\t\t\t\treturn { ...obj, ...Object.fromEntries(el) };\n\t\t\t\t}\n\n\t\t\t\tconst [key, value] = el;\n\t\t\t\treturn { ...obj, [key]: value };\n\t\t\t}, {});\n\t});\n\n\treturn useReducer(reducer, null, initializer);\n};\n\nfunction ConnectedModalBlock(props) {\n\tconst state = useActionManagerState(props);\n\n\tconst { appId, viewId, mid: _mid, errors, view } = state;\n\n\tconst [values, updateValues] = useValues(view);\n\n\tconst groupStateByBlockId = (obj) =>\n\t\tObject.entries(obj).reduce((obj, [key, { blockId, value }]) => {\n\t\t\tobj[blockId] = obj[blockId] || {};\n\t\t\tobj[blockId][key] = value;\n\t\t\treturn obj;\n\t\t}, {});\n\n\tconst prevent = (e) => {\n\t\tif (e) {\n\t\t\t(e.nativeEvent || e).stopImmediatePropagation();\n\t\t\te.stopPropagation();\n\t\t\te.preventDefault();\n\t\t}\n\t};\n\n\tconst context = {\n\t\taction: ({ actionId, appId, value, blockId, mid = _mid }) =>\n\t\t\tActionManager.triggerBlockAction({\n\t\t\t\tcontainer: {\n\t\t\t\t\ttype: UIKitIncomingInteractionContainerType.VIEW,\n\t\t\t\t\tid: viewId,\n\t\t\t\t},\n\t\t\t\tactionId,\n\t\t\t\tappId,\n\t\t\t\tvalue,\n\t\t\t\tblockId,\n\t\t\t\tmid,\n\t\t\t}),\n\t\tstate: ({ actionId, value, /* ,appId, */ blockId = 'default' }) => {\n\t\t\tupdateValues({\n\t\t\t\tactionId,\n\t\t\t\tpayload: {\n\t\t\t\t\tblockId,\n\t\t\t\t\tvalue,\n\t\t\t\t},\n\t\t\t});\n\t\t},\n\t\t...state,\n\t\tvalues,\n\t};\n\n\tconst handleSubmit = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\tActionManager.triggerSubmitView({\n\t\t\tviewId,\n\t\t\tappId,\n\t\t\tpayload: {\n\t\t\t\tview: {\n\t\t\t\t\t...view,\n\t\t\t\t\tid: viewId,\n\t\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t});\n\n\tconst handleCancel = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\treturn ActionManager.triggerCancel({\n\t\t\tappId,\n\t\t\tviewId,\n\t\t\tview: {\n\t\t\t\t...view,\n\t\t\t\tid: viewId,\n\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t},\n\t\t});\n\t});\n\n\tconst handleClose = useMutableCallback((e) => {\n\t\tprevent(e);\n\t\treturn ActionManager.triggerCancel({\n\t\t\tappId,\n\t\t\tviewId,\n\t\t\tview: {\n\t\t\t\t...view,\n\t\t\t\tid: viewId,\n\t\t\t\tstate: groupStateByBlockId(values),\n\t\t\t},\n\t\t\tisCleared: true,\n\t\t});\n\t});\n\n\treturn (\n\t\t<kitContext.Provider value={context}>\n\t\t\t<ModalBlock view={view} errors={errors} appId={appId} onSubmit={handleSubmit} onCancel={handleCancel} onClose={handleClose} />\n\t\t</kitContext.Provider>\n\t);\n}\n\nexport default ConnectedModalBlock;\n"]}