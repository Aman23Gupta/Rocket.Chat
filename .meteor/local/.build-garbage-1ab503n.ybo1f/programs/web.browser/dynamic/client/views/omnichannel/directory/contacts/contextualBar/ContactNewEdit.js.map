{"version":3,"sources":["meteor://ðŸ’»app/client/views/omnichannel/directory/contacts/contextualBar/ContactNewEdit.js"],"names":["Field","TextInput","ButtonGroup","Button","module","link","v","useMutableCallback","React","useState","useMemo","default","useSubscription","hasAtLeastOnePermission","validateEmail","CustomFieldsForm","VerticalBar","useEndpoint","useToastMessageDispatch","useTranslation","AsyncStatePhase","useComponentDidUpdate","useEndpointData","useForm","createToken","formsSubscription","FormSkeleton","initialValues","token","name","email","phone","username","getInitialValues","data","contact","visitorEmails","livechatData","contactManager","address","phoneNumber","ContactNewEdit","id","close","t","canViewCustomFields","values","handlers","hasUnsavedChanges","hasUnsavedChangesContact","eeForms","useContactManager","ContactManager","handleName","handleEmail","handlePhone","handleUsername","valueCustom","handleValueCustom","hasUnsavedChangesCustomFields","handleLivechatData","nameError","setNameError","emailError","setEmailError","phoneError","setPhoneError","customFieldsError","setCustomFieldsError","value","allCustomFields","phase","state","jsonConverterToValidFormat","customFields","jsonObj","forEach","_id","label","visibility","options","scope","defaultValue","required","type","split","map","item","trim","jsonCustomField","saveContact","emailAlreadyExistsAction","phoneAlreadyExistsAction","checkEmailExists","checkPhoneExists","dispatchToastMessage","handleSave","e","preventDefault","error","payload","message","formIsValid","length","includes","LOADING","exportDefault"],"mappings":";;;;;;;;AAAA,IAAIA,KAAJ,EAAUC,SAAV,EAAoBC,WAApB,EAAgCC,MAAhC;AAAuCC,MAAM,CAACC,IAAP,CAAY,uBAAZ,EAAoC;AAACL,OAAK,CAACM,CAAD,EAAG;AAACN,SAAK,GAACM,CAAN;AAAQ,GAAlB;;AAAmBL,WAAS,CAACK,CAAD,EAAG;AAACL,aAAS,GAACK,CAAV;AAAY,GAA5C;;AAA6CJ,aAAW,CAACI,CAAD,EAAG;AAACJ,eAAW,GAACI,CAAZ;AAAc,GAA1E;;AAA2EH,QAAM,CAACG,CAAD,EAAG;AAACH,UAAM,GAACG,CAAP;AAAS;;AAA9F,CAApC,EAAoI,CAApI;AAAuI,IAAIC,kBAAJ;AAAuBH,MAAM,CAACC,IAAP,CAAY,6BAAZ,EAA0C;AAACE,oBAAkB,CAACD,CAAD,EAAG;AAACC,sBAAkB,GAACD,CAAnB;AAAqB;;AAA5C,CAA1C,EAAwF,CAAxF;AAA2F,IAAIE,KAAJ,EAAUC,QAAV,EAAmBC,OAAnB;AAA2BN,MAAM,CAACC,IAAP,CAAY,OAAZ,EAAoB;AAACM,SAAO,CAACL,CAAD,EAAG;AAACE,SAAK,GAACF,CAAN;AAAQ,GAApB;;AAAqBG,UAAQ,CAACH,CAAD,EAAG;AAACG,YAAQ,GAACH,CAAT;AAAW,GAA5C;;AAA6CI,SAAO,CAACJ,CAAD,EAAG;AAACI,WAAO,GAACJ,CAAR;AAAU;;AAAlE,CAApB,EAAwF,CAAxF;AAA2F,IAAIM,eAAJ;AAAoBR,MAAM,CAACC,IAAP,CAAY,kBAAZ,EAA+B;AAACO,iBAAe,CAACN,CAAD,EAAG;AAACM,mBAAe,GAACN,CAAhB;AAAkB;;AAAtC,CAA/B,EAAuE,CAAvE;AAA0E,IAAIO,uBAAJ;AAA4BT,MAAM,CAACC,IAAP,CAAY,4CAAZ,EAAyD;AAACQ,yBAAuB,CAACP,CAAD,EAAG;AAACO,2BAAuB,GAACP,CAAxB;AAA0B;;AAAtD,CAAzD,EAAiH,CAAjH;AAAoH,IAAIQ,aAAJ;AAAkBV,MAAM,CAACC,IAAP,CAAY,sCAAZ,EAAmD;AAACS,eAAa,CAACR,CAAD,EAAG;AAACQ,iBAAa,GAACR,CAAd;AAAgB;;AAAlC,CAAnD,EAAuF,CAAvF;AAA0F,IAAIS,gBAAJ;AAAqBX,MAAM,CAACC,IAAP,CAAY,4CAAZ,EAAyD;AAACM,SAAO,CAACL,CAAD,EAAG;AAACS,oBAAgB,GAACT,CAAjB;AAAmB;;AAA/B,CAAzD,EAA0F,CAA1F;AAA6F,IAAIU,WAAJ;AAAgBZ,MAAM,CAACC,IAAP,CAAY,uCAAZ,EAAoD;AAACM,SAAO,CAACL,CAAD,EAAG;AAACU,eAAW,GAACV,CAAZ;AAAc;;AAA1B,CAApD,EAAgF,CAAhF;AAAmF,IAAIW,WAAJ;AAAgBb,MAAM,CAACC,IAAP,CAAY,uCAAZ,EAAoD;AAACY,aAAW,CAACX,CAAD,EAAG;AAACW,eAAW,GAACX,CAAZ;AAAc;;AAA9B,CAApD,EAAoF,CAApF;AAAuF,IAAIY,uBAAJ;AAA4Bd,MAAM,CAACC,IAAP,CAAY,8CAAZ,EAA2D;AAACa,yBAAuB,CAACZ,CAAD,EAAG;AAACY,2BAAuB,GAACZ,CAAxB;AAA0B;;AAAtD,CAA3D,EAAmH,CAAnH;AAAsH,IAAIa,cAAJ;AAAmBf,MAAM,CAACC,IAAP,CAAY,4CAAZ,EAAyD;AAACc,gBAAc,CAACb,CAAD,EAAG;AAACa,kBAAc,GAACb,CAAf;AAAiB;;AAApC,CAAzD,EAA+F,EAA/F;AAAmG,IAAIc,eAAJ;AAAoBhB,MAAM,CAACC,IAAP,CAAY,oCAAZ,EAAiD;AAACe,iBAAe,CAACd,CAAD,EAAG;AAACc,mBAAe,GAACd,CAAhB;AAAkB;;AAAtC,CAAjD,EAAyF,EAAzF;AAA6F,IAAIe,qBAAJ;AAA0BjB,MAAM,CAACC,IAAP,CAAY,4CAAZ,EAAyD;AAACgB,uBAAqB,CAACf,CAAD,EAAG;AAACe,yBAAqB,GAACf,CAAtB;AAAwB;;AAAlD,CAAzD,EAA6G,EAA7G;AAAiH,IAAIgB,eAAJ;AAAoBlB,MAAM,CAACC,IAAP,CAAY,sCAAZ,EAAmD;AAACiB,iBAAe,CAAChB,CAAD,EAAG;AAACgB,mBAAe,GAAChB,CAAhB;AAAkB;;AAAtC,CAAnD,EAA2F,EAA3F;AAA+F,IAAIiB,OAAJ;AAAYnB,MAAM,CAACC,IAAP,CAAY,8BAAZ,EAA2C;AAACkB,SAAO,CAACjB,CAAD,EAAG;AAACiB,WAAO,GAACjB,CAAR;AAAU;;AAAtB,CAA3C,EAAmE,EAAnE;AAAuE,IAAIkB,WAAJ;AAAgBpB,MAAM,CAACC,IAAP,CAAY,sCAAZ,EAAmD;AAACmB,aAAW,CAAClB,CAAD,EAAG;AAACkB,eAAW,GAAClB,CAAZ;AAAc;;AAA9B,CAAnD,EAAmF,EAAnF;AAAuF,IAAImB,iBAAJ;AAAsBrB,MAAM,CAACC,IAAP,CAAY,0BAAZ,EAAuC;AAACoB,mBAAiB,CAACnB,CAAD,EAAG;AAACmB,qBAAiB,GAACnB,CAAlB;AAAoB;;AAA1C,CAAvC,EAAmF,EAAnF;AAAuF,IAAIoB,YAAJ;AAAiBtB,MAAM,CAACC,IAAP,CAAY,gBAAZ,EAA6B;AAACqB,cAAY,CAACpB,CAAD,EAAG;AAACoB,gBAAY,GAACpB,CAAb;AAAe;;AAAhC,CAA7B,EAA+D,EAA/D;AAoB39D,MAAMqB,aAAa,GAAG;AACrBC,OAAK,EAAE,EADc;AAErBC,MAAI,EAAE,EAFe;AAGrBC,OAAK,EAAE,EAHc;AAIrBC,OAAK,EAAE,EAJc;AAKrBC,UAAQ,EAAE;AALW,CAAtB;;AAQA,MAAMC,gBAAgB,GAAIC,IAAD,IAAU;AAAA;;AAClC,MAAI,CAACA,IAAL,EAAW;AACV,WAAOP,aAAP;AACA;;AAED,QAAM;AACLQ,WAAO,EAAE;AAAEN,UAAF;AAAQD,WAAR;AAAeG,WAAf;AAAsBK,mBAAtB;AAAqCC,kBAArC;AAAmDC;AAAnD;AADJ,MAEFJ,IAFJ;AAIA,SAAO;AACNN,SAAK,EAAEA,KAAF,aAAEA,KAAF,cAAEA,KAAF,GAAW,EADV;AAENC,QAAI,EAAEA,IAAF,aAAEA,IAAF,cAAEA,IAAF,GAAU,EAFR;AAGNC,SAAK,EAAEM,aAAa,GAAGA,aAAa,CAAC,CAAD,CAAb,CAAiBG,OAApB,GAA8B,EAH5C;AAINR,SAAK,EAAEA,KAAK,GAAGA,KAAK,CAAC,CAAD,CAAL,CAASS,WAAZ,GAA0B,EAJhC;AAKNH,gBAAY,EAAEA,YAAF,aAAEA,YAAF,cAAEA,YAAF,GAAkB,EALxB;AAMNL,YAAQ,2BAAEM,cAAF,aAAEA,cAAF,uBAAEA,cAAc,CAAEN,QAAlB,yEAA8B;AANhC,GAAP;AAQA,CAjBD;;AAmBA,SAASS,cAAT,OAA6C;AAAA,MAArB;AAAEC,MAAF;AAAMR,QAAN;AAAYS;AAAZ,GAAqB;AAC5C,QAAMC,CAAC,GAAGzB,cAAc,EAAxB;;AAEA,QAAM0B,mBAAmB,GAAG,MAAMhC,uBAAuB,CAAC,CAAC,iCAAD,EAAoC,iCAApC,CAAD,CAAzD;;AAEA,QAAM;AAAEiC,UAAF;AAAUC,YAAV;AAAoBC,qBAAiB,EAAEC;AAAvC,MAAoE1B,OAAO,CAACU,gBAAgB,CAACC,IAAD,CAAjB,CAAjF;AAEA,QAAMgB,OAAO,GAAGtC,eAAe,CAACa,iBAAD,CAA/B;AAEA,QAAM;AAAE0B,qBAAiB,GAAG,MAAM,CAAE;AAA9B,MAAmCD,OAAzC;AAEA,QAAME,cAAc,GAAGD,iBAAiB,EAAxC;AAEA,QAAM;AAAEE,cAAF;AAAcC,eAAd;AAA2BC,eAA3B;AAAwCC;AAAxC,MAA2DT,QAAjE;AACA,QAAM;AAAEnB,SAAF;AAASC,QAAT;AAAeC,SAAf;AAAsBC,SAAtB;AAA6BC;AAA7B,MAA0Cc,MAAhD;AAEA,QAAM;AACLA,UAAM,EAAEW,WADH;AAELV,YAAQ,EAAEW,iBAFL;AAGLV,qBAAiB,EAAEW;AAHd,MAIFpC,OAAO,CAAC;AACXc,gBAAY,EAAES,MAAM,CAACT;AADV,GAAD,CAJX;AAQA,QAAM;AAAEuB;AAAF,MAAyBF,iBAA/B;AACA,QAAM;AAAErB;AAAF,MAAmBoB,WAAzB;AAEA,QAAM,CAACI,SAAD,EAAYC,YAAZ,IAA4BrD,QAAQ,EAA1C;AACA,QAAM,CAACsD,UAAD,EAAaC,aAAb,IAA8BvD,QAAQ,EAA5C;AACA,QAAM,CAACwD,UAAD,EAAaC,aAAb,IAA8BzD,QAAQ,EAA5C;AACA,QAAM,CAAC0D,iBAAD,EAAoBC,oBAApB,IAA4C3D,QAAQ,CAAC,EAAD,CAA1D;AAEA,QAAM;AAAE4D,SAAK,EAAEC,eAAT;AAA0BC,SAAK,EAAEC;AAAjC,MAA2ClD,eAAe,CAAC,wBAAD,CAAhE;;AAEA,QAAMmD,0BAA0B,GAAIC,YAAD,IAAkB;AACpD,UAAMC,OAAO,GAAG,EAAhB;AACAD,gBAAY,CAACE,OAAb,CAAqB,SAAwE;AAAA,UAAvE;AAAEC,WAAF;AAAOC,aAAP;AAAcC,kBAAd;AAA0BC,eAA1B;AAAmCC,aAAnC;AAA0CC,oBAA1C;AAAwDC;AAAxD,OAAuE;AAC3FJ,gBAAU,KAAK,SAAhB,GAA8BE,KAAK,KAAK,SAAxC,KACEN,OAAO,CAACE,GAAD,CAAP,GAAe;AACfC,aADe;AAEfM,YAAI,EAAEJ,OAAO,GAAG,QAAH,GAAc,MAFZ;AAGfG,gBAHe;AAIfD,oBAJe;AAKfF,eAAO,EAAEA,OAAO,IAAIA,OAAO,CAACK,KAAR,CAAc,GAAd,EAAmBC,GAAnB,CAAwBC,IAAD,IAAUA,IAAI,CAACC,IAAL,EAAjC;AALL,OADjB;AAQA,KATD;AAUA,WAAOb,OAAP;AACA,GAbD;;AAeA,QAAMc,eAAe,GAAG/E,OAAO,CAC9B,MAAO4D,eAAe,IAAIA,eAAe,CAACI,YAAnC,GAAkDD,0BAA0B,CAACH,eAAe,CAACI,YAAjB,CAA5E,GAA6G,EADtF,EAE9B,CAACJ,eAAD,CAF8B,CAA/B;AAKA,QAAMoB,WAAW,GAAGzE,WAAW,CAAC,MAAD,EAAS,qBAAT,CAA/B;AACA,QAAM0E,wBAAwB,GAAG1E,WAAW,CAAC,KAAD,6CAA4Ca,KAA5C,EAA5C;AACA,QAAM8D,wBAAwB,GAAG3E,WAAW,CAAC,KAAD,6CAA4Cc,KAA5C,EAA5C;AAEA,QAAM8D,gBAAgB,GAAGtF,kBAAkB,CAAC,YAAY;AACvD,QAAI,CAACO,aAAa,CAACgB,KAAD,CAAlB,EAA2B;AAC1B;AACA;;AACD,UAAM;AAAEK;AAAF,QAAc,MAAMwD,wBAAwB,EAAlD;;AACA,QAAI,CAACxD,OAAD,IAAaO,EAAE,IAAIP,OAAO,CAAC0C,GAAR,KAAgBnC,EAAvC,EAA4C;AAC3C,aAAOsB,aAAa,CAAC,IAAD,CAApB;AACA;;AACDA,iBAAa,CAACpB,CAAC,CAAC,sBAAD,CAAF,CAAb;AACA,GAT0C,CAA3C;AAWA,QAAMkD,gBAAgB,GAAGvF,kBAAkB,CAAC,YAAY;AACvD,QAAI,CAACwB,KAAL,EAAY;AACX;AACA;;AACD,UAAM;AAAEI;AAAF,QAAc,MAAMyD,wBAAwB,EAAlD;;AACA,QAAI,CAACzD,OAAD,IAAaO,EAAE,IAAIP,OAAO,CAAC0C,GAAR,KAAgBnC,EAAvC,EAA4C;AAC3C,aAAOwB,aAAa,CAAC,IAAD,CAApB;AACA;;AACDA,iBAAa,CAACtB,CAAC,CAAC,sBAAD,CAAF,CAAb;AACA,GAT0C,CAA3C;AAWA,QAAMmD,oBAAoB,GAAG7E,uBAAuB,EAApD;AAEAG,uBAAqB,CAAC,MAAM;AAC3ByC,gBAAY,CAAC,CAACjC,IAAD,GAAQe,CAAC,CAAC,uBAAD,EAA0BA,CAAC,CAAC,MAAD,CAA3B,CAAT,GAAgD,EAAjD,CAAZ;AACA,GAFoB,EAElB,CAACA,CAAD,EAAIf,IAAJ,CAFkB,CAArB;AAGAR,uBAAqB,CAAC,MAAM;AAC3B2C,iBAAa,CAAClC,KAAK,IAAI,CAAChB,aAAa,CAACgB,KAAD,CAAvB,GAAiCc,CAAC,CAAC,wBAAD,CAAlC,GAA+D,IAAhE,CAAb;AACA,GAFoB,EAElB,CAACA,CAAD,EAAId,KAAJ,CAFkB,CAArB;AAGAT,uBAAqB,CAAC,MAAM;AAC3B,KAACU,KAAD,IAAUmC,aAAa,CAAC,IAAD,CAAvB;AACA,GAFoB,EAElB,CAACnC,KAAD,CAFkB,CAArB;AAIA,QAAMiE,UAAU,GAAGzF,kBAAkB,CAAC,MAAO0F,CAAP,IAAa;AAClDA,KAAC,CAACC,cAAF;AACA,QAAIC,KAAK,GAAG,KAAZ;;AACA,QAAI,CAACtE,IAAL,EAAW;AACViC,kBAAY,CAAClB,CAAC,CAAC,uBAAD,EAA0B,MAA1B,CAAF,CAAZ;AACAuD,WAAK,GAAG,IAAR;AACA;;AACD,QAAIrE,KAAK,IAAI,CAAChB,aAAa,CAACgB,KAAD,CAA3B,EAAoC;AACnCkC,mBAAa,CAACpB,CAAC,CAAC,wBAAD,CAAF,CAAb;AACAuD,WAAK,GAAG,IAAR;AACA;;AAED,QAAIA,KAAJ,EAAW;AACV;AACA;;AAED,UAAMC,OAAO,GAAG;AACfvE;AADe,KAAhB;AAGAuE,WAAO,CAACrE,KAAR,GAAgBA,KAAhB;AACAqE,WAAO,CAACtE,KAAR,GAAgBA,KAAhB;AACAsE,WAAO,CAAC1B,YAAR,GAAuBrC,YAAY,IAAI,EAAvC;AACA+D,WAAO,CAAC9D,cAAR,GAAyBN,QAAQ,GAAG;AAAEA;AAAF,KAAH,GAAkB,EAAnD;;AAEA,QAAIU,EAAJ,EAAQ;AACP0D,aAAO,CAACvB,GAAR,GAAcnC,EAAd;AACA0D,aAAO,CAACxE,KAAR,GAAgBA,KAAhB;AACA,KAHD,MAGO;AACNwE,aAAO,CAACxE,KAAR,GAAgBJ,WAAW,EAA3B;AACA;;AAED,QAAI;AACH,YAAMkE,WAAW,CAACU,OAAD,CAAjB;AACAL,0BAAoB,CAAC;AAAEX,YAAI,EAAE,SAAR;AAAmBiB,eAAO,EAAEzD,CAAC,CAAC,OAAD;AAA7B,OAAD,CAApB;AACAD,WAAK;AACL,KAJD,CAIE,OAAOwD,KAAP,EAAc;AACfJ,0BAAoB,CAAC;AAAEX,YAAI,EAAE,OAAR;AAAiBiB,eAAO,EAAEF;AAA1B,OAAD,CAApB;AACA;AACD,GAtCoC,CAArC;AAwCA,QAAMG,WAAW,GAChB,CAACrD,wBAAwB,IAAIU,6BAA7B,KAA+D9B,IAA/D,IAAuE,CAACkC,UAAxE,IAAsF,CAACE,UAAvF,IAAqGE,iBAAiB,CAACoC,MAAlB,KAA6B,CADnI;;AAGA,MAAI,CAAC/B,KAAD,EAAQgC,QAAR,CAAiBpF,eAAe,CAACqF,OAAjC,CAAJ,EAA+C;AAC9C,wBAAO,oBAAC,YAAD,OAAP;AACA;;AAED,sBACC,uDACC,oBAAC,WAAD,CAAa,iBAAb;AAA+B,MAAE,EAAC;AAAlC,kBACC,oBAAC,KAAD,qBACC,oBAAC,KAAD,CAAO,KAAP,QAAc7D,CAAC,CAAC,MAAD,CAAf,MADD,eAEC,oBAAC,KAAD,CAAO,GAAP,qBACC,oBAAC,SAAD;AAAW,SAAK,EAAEiB,SAAlB;AAA6B,YAAQ,EAAE,CAAvC;AAA0C,SAAK,EAAEhC,IAAjD;AAAuD,YAAQ,EAAEwB;AAAjE,IADD,CAFD,eAKC,oBAAC,KAAD,CAAO,KAAP,QAAcQ,SAAd,CALD,CADD,eAQC,oBAAC,KAAD,qBACC,oBAAC,KAAD,CAAO,KAAP,QAAcjB,CAAC,CAAC,OAAD,CAAf,CADD,eAEC,oBAAC,KAAD,CAAO,GAAP,qBACC,oBAAC,SAAD;AAAW,UAAM,EAAEiD,gBAAnB;AAAqC,SAAK,EAAE9B,UAA5C;AAAwD,YAAQ,EAAE,CAAlE;AAAqE,SAAK,EAAEjC,KAA5E;AAAmF,YAAQ,EAAEwB;AAA7F,IADD,CAFD,eAKC,oBAAC,KAAD,CAAO,KAAP,QAAcV,CAAC,CAACmB,UAAD,CAAf,CALD,CARD,eAeC,oBAAC,KAAD,qBACC,oBAAC,KAAD,CAAO,KAAP,QAAcnB,CAAC,CAAC,OAAD,CAAf,CADD,eAEC,oBAAC,KAAD,CAAO,GAAP,qBACC,oBAAC,SAAD;AAAW,UAAM,EAAEkD,gBAAnB;AAAqC,SAAK,EAAE7B,UAA5C;AAAwD,YAAQ,EAAE,CAAlE;AAAqE,SAAK,EAAElC,KAA5E;AAAmF,YAAQ,EAAEwB;AAA7F,IADD,CAFD,eAKC,oBAAC,KAAD,CAAO,KAAP,QAAcX,CAAC,CAACqB,UAAD,CAAf,CALD,CAfD,EAsBEpB,mBAAmB,MAAMyB,eAAzB,iBACA,oBAAC,gBAAD;AACC,oBAAgB,EAAEmB,eADnB;AAEC,oBAAgB,EAAEpD,YAFnB;AAGC,uBAAmB,EAAEuB,kBAHtB;AAIC,wBAAoB,EAAEQ;AAJvB,IAvBF,EA8BEhB,cAAc,iBAAI,oBAAC,cAAD;AAAgB,SAAK,EAAEpB,QAAvB;AAAiC,WAAO,EAAEwB;AAA1C,IA9BpB,CADD,eAiCC,oBAAC,WAAD,CAAa,MAAb,qBACC,oBAAC,WAAD;AAAa,WAAO;AAApB,kBACC,oBAAC,MAAD;AAAQ,YAAQ,EAAE,CAAlB;AAAqB,WAAO,EAAEb;AAA9B,KACEC,CAAC,CAAC,QAAD,CADH,CADD,eAIC,oBAAC,MAAD;AAAQ,OAAG,EAAC,MAAZ;AAAmB,YAAQ,EAAE,CAA7B;AAAgC,WAAO,EAAEoD,UAAzC;AAAqD,YAAQ,EAAE,CAACM,WAAhE;AAA6E,WAAO;AAApF,KACE1D,CAAC,CAAC,MAAD,CADH,CAJD,CADD,CAjCD,CADD;AA8CA;;AAxODxC,MAAM,CAACsG,aAAP,CA0OejE,cA1Of,E","file":"dynamic/client/views/omnichannel/directory/contacts/contextualBar/ContactNewEdit.js","sourcesContent":["import { Field, TextInput, ButtonGroup, Button } from '@rocket.chat/fuselage';\nimport { useMutableCallback } from '@rocket.chat/fuselage-hooks';\nimport React, { useState, useMemo } from 'react';\nimport { useSubscription } from 'use-subscription';\n\nimport { hasAtLeastOnePermission } from '../../../../../../app/authorization/client';\nimport { validateEmail } from '../../../../../../lib/emailValidator';\nimport CustomFieldsForm from '../../../../../components/CustomFieldsForm';\nimport VerticalBar from '../../../../../components/VerticalBar';\nimport { useEndpoint } from '../../../../../contexts/ServerContext';\nimport { useToastMessageDispatch } from '../../../../../contexts/ToastMessagesContext';\nimport { useTranslation } from '../../../../../contexts/TranslationContext';\nimport { AsyncStatePhase } from '../../../../../hooks/useAsyncState';\nimport { useComponentDidUpdate } from '../../../../../hooks/useComponentDidUpdate';\nimport { useEndpointData } from '../../../../../hooks/useEndpointData';\nimport { useForm } from '../../../../../hooks/useForm';\nimport { createToken } from '../../../../../lib/utils/createToken';\nimport { formsSubscription } from '../../../additionalForms';\nimport { FormSkeleton } from '../../Skeleton';\n\nconst initialValues = {\n\ttoken: '',\n\tname: '',\n\temail: '',\n\tphone: '',\n\tusername: '',\n};\n\nconst getInitialValues = (data) => {\n\tif (!data) {\n\t\treturn initialValues;\n\t}\n\n\tconst {\n\t\tcontact: { name, token, phone, visitorEmails, livechatData, contactManager },\n\t} = data;\n\n\treturn {\n\t\ttoken: token ?? '',\n\t\tname: name ?? '',\n\t\temail: visitorEmails ? visitorEmails[0].address : '',\n\t\tphone: phone ? phone[0].phoneNumber : '',\n\t\tlivechatData: livechatData ?? {},\n\t\tusername: contactManager?.username ?? '',\n\t};\n};\n\nfunction ContactNewEdit({ id, data, close }) {\n\tconst t = useTranslation();\n\n\tconst canViewCustomFields = () => hasAtLeastOnePermission(['view-livechat-room-customfields', 'edit-livechat-room-customfields']);\n\n\tconst { values, handlers, hasUnsavedChanges: hasUnsavedChangesContact } = useForm(getInitialValues(data));\n\n\tconst eeForms = useSubscription(formsSubscription);\n\n\tconst { useContactManager = () => {} } = eeForms;\n\n\tconst ContactManager = useContactManager();\n\n\tconst { handleName, handleEmail, handlePhone, handleUsername } = handlers;\n\tconst { token, name, email, phone, username } = values;\n\n\tconst {\n\t\tvalues: valueCustom,\n\t\thandlers: handleValueCustom,\n\t\thasUnsavedChanges: hasUnsavedChangesCustomFields,\n\t} = useForm({\n\t\tlivechatData: values.livechatData,\n\t});\n\n\tconst { handleLivechatData } = handleValueCustom;\n\tconst { livechatData } = valueCustom;\n\n\tconst [nameError, setNameError] = useState();\n\tconst [emailError, setEmailError] = useState();\n\tconst [phoneError, setPhoneError] = useState();\n\tconst [customFieldsError, setCustomFieldsError] = useState([]);\n\n\tconst { value: allCustomFields, phase: state } = useEndpointData('livechat/custom-fields');\n\n\tconst jsonConverterToValidFormat = (customFields) => {\n\t\tconst jsonObj = {};\n\t\tcustomFields.forEach(({ _id, label, visibility, options, scope, defaultValue, required }) => {\n\t\t\t(visibility === 'visible') & (scope === 'visitor') &&\n\t\t\t\t(jsonObj[_id] = {\n\t\t\t\t\tlabel,\n\t\t\t\t\ttype: options ? 'select' : 'text',\n\t\t\t\t\trequired,\n\t\t\t\t\tdefaultValue,\n\t\t\t\t\toptions: options && options.split(',').map((item) => item.trim()),\n\t\t\t\t});\n\t\t});\n\t\treturn jsonObj;\n\t};\n\n\tconst jsonCustomField = useMemo(\n\t\t() => (allCustomFields && allCustomFields.customFields ? jsonConverterToValidFormat(allCustomFields.customFields) : {}),\n\t\t[allCustomFields],\n\t);\n\n\tconst saveContact = useEndpoint('POST', 'omnichannel/contact');\n\tconst emailAlreadyExistsAction = useEndpoint('GET', `omnichannel/contact.search?email=${email}`);\n\tconst phoneAlreadyExistsAction = useEndpoint('GET', `omnichannel/contact.search?phone=${phone}`);\n\n\tconst checkEmailExists = useMutableCallback(async () => {\n\t\tif (!validateEmail(email)) {\n\t\t\treturn;\n\t\t}\n\t\tconst { contact } = await emailAlreadyExistsAction();\n\t\tif (!contact || (id && contact._id === id)) {\n\t\t\treturn setEmailError(null);\n\t\t}\n\t\tsetEmailError(t('Email_already_exists'));\n\t});\n\n\tconst checkPhoneExists = useMutableCallback(async () => {\n\t\tif (!phone) {\n\t\t\treturn;\n\t\t}\n\t\tconst { contact } = await phoneAlreadyExistsAction();\n\t\tif (!contact || (id && contact._id === id)) {\n\t\t\treturn setPhoneError(null);\n\t\t}\n\t\tsetPhoneError(t('Phone_already_exists'));\n\t});\n\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\n\tuseComponentDidUpdate(() => {\n\t\tsetNameError(!name ? t('The_field_is_required', t('Name')) : '');\n\t}, [t, name]);\n\tuseComponentDidUpdate(() => {\n\t\tsetEmailError(email && !validateEmail(email) ? t('Validate_email_address') : null);\n\t}, [t, email]);\n\tuseComponentDidUpdate(() => {\n\t\t!phone && setPhoneError(null);\n\t}, [phone]);\n\n\tconst handleSave = useMutableCallback(async (e) => {\n\t\te.preventDefault();\n\t\tlet error = false;\n\t\tif (!name) {\n\t\t\tsetNameError(t('The_field_is_required', 'name'));\n\t\t\terror = true;\n\t\t}\n\t\tif (email && !validateEmail(email)) {\n\t\t\tsetEmailError(t('Validate_email_address'));\n\t\t\terror = true;\n\t\t}\n\n\t\tif (error) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst payload = {\n\t\t\tname,\n\t\t};\n\t\tpayload.phone = phone;\n\t\tpayload.email = email;\n\t\tpayload.customFields = livechatData || {};\n\t\tpayload.contactManager = username ? { username } : {};\n\n\t\tif (id) {\n\t\t\tpayload._id = id;\n\t\t\tpayload.token = token;\n\t\t} else {\n\t\t\tpayload.token = createToken();\n\t\t}\n\n\t\ttry {\n\t\t\tawait saveContact(payload);\n\t\t\tdispatchToastMessage({ type: 'success', message: t('Saved') });\n\t\t\tclose();\n\t\t} catch (error) {\n\t\t\tdispatchToastMessage({ type: 'error', message: error });\n\t\t}\n\t});\n\n\tconst formIsValid =\n\t\t(hasUnsavedChangesContact || hasUnsavedChangesCustomFields) && name && !emailError && !phoneError && customFieldsError.length === 0;\n\n\tif ([state].includes(AsyncStatePhase.LOADING)) {\n\t\treturn <FormSkeleton />;\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<VerticalBar.ScrollableContent is='form'>\n\t\t\t\t<Field>\n\t\t\t\t\t<Field.Label>{t('Name')}*</Field.Label>\n\t\t\t\t\t<Field.Row>\n\t\t\t\t\t\t<TextInput error={nameError} flexGrow={1} value={name} onChange={handleName} />\n\t\t\t\t\t</Field.Row>\n\t\t\t\t\t<Field.Error>{nameError}</Field.Error>\n\t\t\t\t</Field>\n\t\t\t\t<Field>\n\t\t\t\t\t<Field.Label>{t('Email')}</Field.Label>\n\t\t\t\t\t<Field.Row>\n\t\t\t\t\t\t<TextInput onBlur={checkEmailExists} error={emailError} flexGrow={1} value={email} onChange={handleEmail} />\n\t\t\t\t\t</Field.Row>\n\t\t\t\t\t<Field.Error>{t(emailError)}</Field.Error>\n\t\t\t\t</Field>\n\t\t\t\t<Field>\n\t\t\t\t\t<Field.Label>{t('Phone')}</Field.Label>\n\t\t\t\t\t<Field.Row>\n\t\t\t\t\t\t<TextInput onBlur={checkPhoneExists} error={phoneError} flexGrow={1} value={phone} onChange={handlePhone} />\n\t\t\t\t\t</Field.Row>\n\t\t\t\t\t<Field.Error>{t(phoneError)}</Field.Error>\n\t\t\t\t</Field>\n\t\t\t\t{canViewCustomFields() && allCustomFields && (\n\t\t\t\t\t<CustomFieldsForm\n\t\t\t\t\t\tjsonCustomFields={jsonCustomField}\n\t\t\t\t\t\tcustomFieldsData={livechatData}\n\t\t\t\t\t\tsetCustomFieldsData={handleLivechatData}\n\t\t\t\t\t\tsetCustomFieldsError={setCustomFieldsError}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t\t{ContactManager && <ContactManager value={username} handler={handleUsername} />}\n\t\t\t</VerticalBar.ScrollableContent>\n\t\t\t<VerticalBar.Footer>\n\t\t\t\t<ButtonGroup stretch>\n\t\t\t\t\t<Button flexGrow={1} onClick={close}>\n\t\t\t\t\t\t{t('Cancel')}\n\t\t\t\t\t</Button>\n\t\t\t\t\t<Button mie='none' flexGrow={1} onClick={handleSave} disabled={!formIsValid} primary>\n\t\t\t\t\t\t{t('Save')}\n\t\t\t\t\t</Button>\n\t\t\t\t</ButtonGroup>\n\t\t\t</VerticalBar.Footer>\n\t\t</>\n\t);\n}\n\nexport default ContactNewEdit;\n"]}