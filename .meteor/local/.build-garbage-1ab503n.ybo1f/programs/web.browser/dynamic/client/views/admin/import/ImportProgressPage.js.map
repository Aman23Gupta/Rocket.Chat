{"version":3,"sources":["meteor://ðŸ’»app/client/views/admin/import/ImportProgressPage.js"],"names":["Box","Margins","Throbber","module","link","v","useSafely","Meteor","React","useEffect","useState","useMemo","default","s","ProgressStep","ImportingStartedStates","Page","useRoute","useEndpoint","useToastMessageDispatch","useTranslation","useErrorHandler","ImportProgressPage","t","dispatchToastMessage","handleError","importerKey","setImporterKey","step","setStep","completed","setCompleted","total","setTotal","getCurrentImportOperation","getImportProgress","importHistoryRoute","prepareImportRoute","loadCurrentOperation","operation","valid","push","includes","status","count","error","handleProgressUpdated","key","toLowerCase","DONE","type","message","toUpperCase","slice","ERROR","CANCELLED","streamer","Streamer","loadImportProgress","progress","on","removeListener","progressRate","numberFormat","exportDefault"],"mappings":"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","file":"dynamic/client/views/admin/import/ImportProgressPage.js","sourcesContent":["import { Box, Margins, Throbber } from '@rocket.chat/fuselage';\nimport { useSafely } from '@rocket.chat/fuselage-hooks';\nimport { Meteor } from 'meteor/meteor';\nimport React, { useEffect, useState, useMemo } from 'react';\nimport s from 'underscore.string';\n\nimport { ProgressStep, ImportingStartedStates } from '../../../../app/importer/lib/ImporterProgressStep';\nimport Page from '../../../components/Page';\nimport { useRoute } from '../../../contexts/RouterContext';\nimport { useEndpoint } from '../../../contexts/ServerContext';\nimport { useToastMessageDispatch } from '../../../contexts/ToastMessagesContext';\nimport { useTranslation } from '../../../contexts/TranslationContext';\nimport { useErrorHandler } from './useErrorHandler';\n\nfunction ImportProgressPage() {\n\tconst t = useTranslation();\n\tconst dispatchToastMessage = useToastMessageDispatch();\n\tconst handleError = useErrorHandler();\n\n\tconst [importerKey, setImporterKey] = useSafely(useState(null));\n\tconst [step, setStep] = useSafely(useState('Loading...'));\n\tconst [completed, setCompleted] = useSafely(useState(0));\n\tconst [total, setTotal] = useSafely(useState(0));\n\n\tconst getCurrentImportOperation = useEndpoint('GET', 'getCurrentImportOperation');\n\tconst getImportProgress = useEndpoint('GET', 'getImportProgress');\n\n\tconst importHistoryRoute = useRoute('admin-import');\n\tconst prepareImportRoute = useRoute('admin-import-prepare');\n\n\tuseEffect(() => {\n\t\tconst loadCurrentOperation = async () => {\n\t\t\ttry {\n\t\t\t\tconst { operation } = await getCurrentImportOperation();\n\n\t\t\t\tif (!operation.valid) {\n\t\t\t\t\timportHistoryRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!ImportingStartedStates.includes(operation.status)) {\n\t\t\t\t\tprepareImportRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tsetImporterKey(operation.importerKey);\n\t\t\t\tsetCompleted(operation.count.completed);\n\t\t\t\tsetTotal(operation.count.total);\n\t\t\t} catch (error) {\n\t\t\t\thandleError(error, t('Failed_To_Load_Import_Data'));\n\t\t\t\timportHistoryRoute.push();\n\t\t\t}\n\t\t};\n\n\t\tloadCurrentOperation();\n\t}, [getCurrentImportOperation, handleError, importHistoryRoute, prepareImportRoute, setCompleted, setImporterKey, setTotal, t]);\n\n\tuseEffect(() => {\n\t\tif (!importerKey) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst handleProgressUpdated = ({ key, step, count: { completed = 0, total = 0 } = {} }) => {\n\t\t\tif (key.toLowerCase() !== importerKey) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tswitch (step) {\n\t\t\t\tcase ProgressStep.DONE:\n\t\t\t\t\tdispatchToastMessage({\n\t\t\t\t\t\ttype: 'success',\n\t\t\t\t\t\tmessage: t(step[0].toUpperCase() + step.slice(1)),\n\t\t\t\t\t});\n\t\t\t\t\timportHistoryRoute.push();\n\t\t\t\t\treturn;\n\n\t\t\t\tcase ProgressStep.ERROR:\n\t\t\t\tcase ProgressStep.CANCELLED:\n\t\t\t\t\thandleError(t(step[0].toUpperCase() + step.slice(1)));\n\t\t\t\t\timportHistoryRoute.push();\n\t\t\t\t\treturn;\n\n\t\t\t\tdefault:\n\t\t\t\t\tsetStep(step);\n\t\t\t\t\tsetCompleted(completed);\n\t\t\t\t\tsetTotal(total);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t};\n\n\t\tconst streamer = new Meteor.Streamer('importers');\n\n\t\tconst loadImportProgress = async () => {\n\t\t\ttry {\n\t\t\t\tconst progress = await getImportProgress();\n\n\t\t\t\tif (!progress) {\n\t\t\t\t\tdispatchToastMessage({ type: 'warning', message: t('Importer_not_in_progress') });\n\t\t\t\t\tprepareImportRoute.push();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tstreamer.on('progress', handleProgressUpdated);\n\t\t\t\thandleProgressUpdated(progress);\n\t\t\t} catch (error) {\n\t\t\t\thandleError(error, t('Failed_To_Load_Import_Data'));\n\t\t\t\timportHistoryRoute.push();\n\t\t\t}\n\t\t};\n\n\t\tloadImportProgress();\n\n\t\treturn () => {\n\t\t\tstreamer.removeListener('progress', handleProgressUpdated);\n\t\t};\n\t}, [\n\t\tdispatchToastMessage,\n\t\tgetImportProgress,\n\t\thandleError,\n\t\timportHistoryRoute,\n\t\timporterKey,\n\t\tprepareImportRoute,\n\t\tsetCompleted,\n\t\tsetStep,\n\t\tsetTotal,\n\t\tt,\n\t]);\n\n\tconst progressRate = useMemo(() => {\n\t\tif (total === 0) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn (completed / total) * 100;\n\t}, [completed, total]);\n\n\treturn (\n\t\t<Page>\n\t\t\t<Page.Header title={t('Importing_Data')} />\n\n\t\t\t<Page.ScrollableContentWithShadow>\n\t\t\t\t<Box marginInline='auto' marginBlock='neg-x24' width='full' maxWidth='x580'>\n\t\t\t\t\t<Margins block='x24'>\n\t\t\t\t\t\t<Box is='p' fontScale='p2'>\n\t\t\t\t\t\t\t{t(step[0].toUpperCase() + step.slice(1))}\n\t\t\t\t\t\t</Box>\n\t\t\t\t\t\t{progressRate ? (\n\t\t\t\t\t\t\t<Box display='flex' justifyContent='center'>\n\t\t\t\t\t\t\t\t<Box is='progress' value={completed} max={total} marginInlineEnd='x24' />\n\t\t\t\t\t\t\t\t<Box is='span' fontScale='p2'>\n\t\t\t\t\t\t\t\t\t{completed}/{total} ({s.numberFormat(progressRate, 0)}%)\n\t\t\t\t\t\t\t\t</Box>\n\t\t\t\t\t\t\t</Box>\n\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t<Throbber justifyContent='center' />\n\t\t\t\t\t\t)}\n\t\t\t\t\t</Margins>\n\t\t\t\t</Box>\n\t\t\t</Page.ScrollableContentWithShadow>\n\t\t</Page>\n\t);\n}\n\nexport default ImportProgressPage;\n"]}