{"version":3,"sources":["meteor://ðŸ’»app/app/livechat/client/views/app/tabbar/visitorForward.js"],"names":["_objectSpread","module","link","default","v","Meteor","ReactiveVar","FlowRouter","Template","ChatRoom","t","APIClient","dispatchToastMessage","visitorForward","helpers","visitor","instance","get","agentName","name","username","onSelectAgents","agentModifier","filter","text","f","length","replace","RegExp","part","agentConditions","room","servedBy","_id","agentId","$ne","status","statusLivechat","selectedAgents","onClickTagAgent","departmentModifier","onClickTagDepartment","selectedDepartments","onSelectDepartments","departmentConditions","departmentForwardRestrictions","enabled","numAgents","$gt","onCreated","departments","item","department","set","agent","user","autorun","users","findOne","currentData","visitorId","roomId","departmentId","call","err","result","v1","events","event","preventDefault","transferData","comment","target","value","clientAction","userId","error","type","message","save","go","cancel"],"mappings":"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","file":"dynamic/app/livechat/client/views/app/tabbar/visitorForward.js","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { ReactiveVar } from 'meteor/reactive-var';\nimport { FlowRouter } from 'meteor/kadira:flow-router';\nimport { Template } from 'meteor/templating';\n\nimport { ChatRoom } from '../../../../../models';\nimport { t } from '../../../../../utils';\nimport './visitorForward.html';\nimport { APIClient } from '../../../../../utils/client';\nimport { dispatchToastMessage } from '../../../../../../client/lib/toast';\n\nTemplate.visitorForward.helpers({\n\tvisitor() {\n\t\treturn Template.instance().visitor.get();\n\t},\n\tagentName() {\n\t\treturn this.name || this.username;\n\t},\n\tonSelectAgents() {\n\t\treturn Template.instance().onSelectAgents;\n\t},\n\tagentModifier() {\n\t\treturn (filter, text = '') => {\n\t\t\tconst f = filter.get();\n\t\t\treturn `@${f.length === 0 ? text : text.replace(new RegExp(filter.get()), (part) => `<strong>${part}</strong>`)}`;\n\t\t};\n\t},\n\tagentConditions() {\n\t\tconst room = Template.instance().room.get();\n\t\tconst { servedBy: { _id: agentId } = {} } = room || {};\n\t\tconst _id = agentId && { $ne: agentId };\n\t\treturn { _id, status: { $ne: 'offline' }, statusLivechat: 'available' };\n\t},\n\tselectedAgents() {\n\t\treturn Template.instance().selectedAgents.get();\n\t},\n\tonClickTagAgent() {\n\t\treturn Template.instance().onClickTagAgent;\n\t},\n\tdepartmentModifier() {\n\t\treturn (filter, text = '') => {\n\t\t\tconst f = filter.get();\n\t\t\treturn `${f.length === 0 ? text : text.replace(new RegExp(filter.get(), 'i'), (part) => `<strong>${part}</strong>`)}`;\n\t\t};\n\t},\n\tonClickTagDepartment() {\n\t\treturn Template.instance().onClickTagDepartment;\n\t},\n\tselectedDepartments() {\n\t\treturn Template.instance().selectedDepartments.get();\n\t},\n\tonSelectDepartments() {\n\t\treturn Template.instance().onSelectDepartments;\n\t},\n\tdepartmentConditions() {\n\t\tconst departmentForwardRestrictions = Template.instance().departmentForwardRestrictions.get();\n\t\treturn { enabled: true, numAgents: { $gt: 0 }, ...departmentForwardRestrictions };\n\t},\n});\n\nTemplate.visitorForward.onCreated(async function () {\n\tthis.visitor = new ReactiveVar();\n\tthis.room = new ReactiveVar();\n\tthis.departments = new ReactiveVar([]);\n\tthis.selectedAgents = new ReactiveVar([]);\n\tthis.selectedDepartments = new ReactiveVar([]);\n\tthis.departmentForwardRestrictions = new ReactiveVar({});\n\n\tthis.onSelectDepartments = ({ item: department }) => {\n\t\tdepartment.text = department.name;\n\t\tthis.selectedDepartments.set([department]);\n\t\tthis.selectedAgents.set([]);\n\t};\n\n\tthis.onClickTagDepartment = () => {\n\t\tthis.selectedDepartments.set([]);\n\t};\n\n\tthis.onSelectAgents = ({ item: agent }) => {\n\t\tthis.selectedAgents.set([agent]);\n\t\tthis.selectedDepartments.set([]);\n\t};\n\n\tthis.onClickTagAgent = ({ username }) => {\n\t\tthis.selectedAgents.set(this.selectedAgents.get().filter((user) => user.username !== username));\n\t};\n\n\tthis.autorun(() => {\n\t\tthis.visitor.set(Meteor.users.findOne({ _id: Template.currentData().visitorId }));\n\t});\n\n\tthis.autorun(() => {\n\t\tthis.room.set(ChatRoom.findOne({ _id: Template.currentData().roomId }));\n\t\tconst { departmentId } = this.room.get();\n\t\tif (departmentId) {\n\t\t\tMeteor.call('livechat:getDepartmentForwardRestrictions', departmentId, (err, result) => {\n\t\t\t\tthis.departmentForwardRestrictions.set(result);\n\t\t\t});\n\t\t}\n\t});\n\n\tconst { departments } = await APIClient.v1.get('livechat/department');\n\tthis.departments.set(departments);\n});\n\nTemplate.visitorForward.events({\n\t'submit form'(event, instance) {\n\t\tevent.preventDefault();\n\n\t\tconst transferData = {\n\t\t\troomId: instance.room.get()._id,\n\t\t\tcomment: event.target.comment.value,\n\t\t\tclientAction: true,\n\t\t};\n\n\t\tconst [user] = instance.selectedAgents.get();\n\t\tif (user) {\n\t\t\ttransferData.userId = user._id;\n\t\t} else if (instance.selectedDepartments.get()) {\n\t\t\tconst [department] = instance.selectedDepartments.get();\n\t\t\ttransferData.departmentId = department && department._id;\n\t\t}\n\n\t\tif (!transferData.userId && !transferData.departmentId) {\n\t\t\treturn;\n\t\t}\n\n\t\tMeteor.call('livechat:transfer', transferData, (error, result) => {\n\t\t\tif (error) {\n\t\t\t\tdispatchToastMessage({\n\t\t\t\t\ttype: 'error',\n\t\t\t\t\tmessage: t(error.error),\n\t\t\t\t});\n\t\t\t} else if (result) {\n\t\t\t\tthis.save();\n\t\t\t\tdispatchToastMessage({\n\t\t\t\t\ttype: 'success',\n\t\t\t\t\tmessage: t('Transferred'),\n\t\t\t\t});\n\t\t\t\tFlowRouter.go('/');\n\t\t\t} else {\n\t\t\t\tdispatchToastMessage({\n\t\t\t\t\ttype: 'warning',\n\t\t\t\t\tmessage: t('No_available_agents_to_transfer'),\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t},\n\n\t'click .cancel'(event) {\n\t\tevent.preventDefault();\n\n\t\tthis.cancel();\n\t},\n});\n"]}